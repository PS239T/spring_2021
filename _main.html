<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Computational Thinking for Social Scientists</title>
  <meta name="description" content="Computational Thinking for Social Scientists. Online textbook for PS239T" />
  <meta name="generator" content="bookdown #bookdown:version# and GitBook 2.6.7" />

  <meta property="og:title" content="Computational Thinking for Social Scientists" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Computational Thinking for Social Scientists. Online textbook for PS239T" />
  <meta name="github-repo" content="jaeyk/PS239T" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Computational Thinking for Social Scientists" />
  <meta name="twitter:site" content="@JaeJaeykim2" />
  <meta name="twitter:description" content="Computational Thinking for Social Scientists. Online textbook for PS239T" />
  

<meta name="author" content="Jae Yeon Kim" />


<meta name="date" content="2020-09-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/header-attrs-2.3/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet" />
<script src="libs/tabwid-1.0.0/tabwid.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



<!--bookdown:title:start-->
<div id="header">
<h1 class="title">Computational Thinking for Social Scientists</h1>
<p class="author"><em>Jae Yeon Kim</em></p>
<p class="date"><em>2020-09-30</em></p>
</div>
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#ps239t"><span class="toc-section-number">1</span> PS239T</a>
<ul>
<li><a href="#textbook"><span class="toc-section-number">1.1</span> Textbook</a></li>
<li><a href="#objectives"><span class="toc-section-number">1.2</span> Objectives</a>
<ul>
<li><a href="#part-i-fundamentals"><span class="toc-section-number">1.2.1</span> Part I Fundamentals</a></li>
<li><a href="#part-ii-applications"><span class="toc-section-number">1.2.2</span> Part II Applications</a></li>
</ul></li>
<li><a href="#logistics"><span class="toc-section-number">1.3</span> Logistics</a>
<ul>
<li><a href="#contributors"><span class="toc-section-number">1.3.1</span> Contributors</a></li>
<li><a href="#time-and-location"><span class="toc-section-number">1.3.2</span> Time and location</a></li>
<li><a href="#office-hours"><span class="toc-section-number">1.3.3</span> Office hours</a></li>
<li><a href="#slack-github"><span class="toc-section-number">1.3.4</span> Slack &amp; GitHub</a></li>
<li><a href="#accessibility"><span class="toc-section-number">1.3.5</span> Accessibility</a></li>
<li><a href="#code-for-conduct"><span class="toc-section-number">1.3.6</span> Code for conduct</a></li>
<li><a href="#course-requirements-and-grades"><span class="toc-section-number">1.3.7</span> Course requirements and grades</a></li>
<li><a href="#class-activities-and-materials"><span class="toc-section-number">1.3.8</span> Class activities and materials</a></li>
</ul></li>
<li><a href="#course-schedule"><span class="toc-section-number">1.4</span> Course schedule</a>
<ul>
<li><a href="#part-i-fundamentals-1"><span class="toc-section-number">1.4.1</span> Part I Fundamentals</a></li>
<li><a href="#part-ii-applications-1"><span class="toc-section-number">1.4.2</span> Part II Applications</a></li>
</ul></li>
<li><a href="#questions-comments-or-suggestions"><span class="toc-section-number">1.5</span> Questions, comments, or suggestions</a></li>
<li><a href="#special-thanks"><span class="toc-section-number">1.6</span> Special thanks</a></li>
<li><a href="#license"><span class="toc-section-number">1.7</span> License</a></li>
</ul></li>
<li><a href="#motivation"><span class="toc-section-number">2</span> Computational thinking</a>
<ul>
<li><a href="#why-computational-thinking"><span class="toc-section-number">2.1</span> Why computational thinking</a></li>
<li><a href="#computational-way-of-thinking-about-data"><span class="toc-section-number">2.2</span> Computational way of thinking about data</a>
<ul>
<li><a href="#structure"><span class="toc-section-number">2.2.1</span> Structure</a></li>
<li><a href="#dimension"><span class="toc-section-number">2.2.2</span> Dimension</a></li>
<li><a href="#size"><span class="toc-section-number">2.2.3</span> Size</a></li>
</ul></li>
<li><a href="#computational-way-of-thinking-about-research-process"><span class="toc-section-number">2.3</span> Computational way of thinking about research process</a></li>
</ul></li>
<li><a href="#intro"><span class="toc-section-number">3</span> Managing data and code</a>
<ul>
<li><a href="#project-oriented-research"><span class="toc-section-number">3.1</span> Project-oriented research</a>
<ul>
<li><a href="#computational-reproducibility"><span class="toc-section-number">3.1.1</span> Computational reproducibility</a></li>
<li><a href="#version-control-git-and-bash"><span class="toc-section-number">3.1.2</span> Version control (Git and Bash)</a></li>
</ul></li>
<li><a href="#writing-code-how-to-code-like-a-professional"><span class="toc-section-number">3.2</span> Writing code: How to code like a professional</a>
<ul>
<li><a href="#write-readable-code"><span class="toc-section-number">3.2.1</span> Write readable code</a></li>
<li><a href="#write-reusable-code"><span class="toc-section-number">3.2.2</span> Write reusable code</a></li>
<li><a href="#test-your-code-systematically"><span class="toc-section-number">3.2.3</span> Test your code systematically</a></li>
</ul></li>
<li><a href="#asking-questions-minimal-reproducible-example"><span class="toc-section-number">3.3</span> Asking questions: Minimal reproducible example</a>
<ul>
<li><a href="#how-to-create-a-minimal-reproducible-example"><span class="toc-section-number">3.3.1</span> How to create a minimal reproducible example</a></li>
</ul></li>
<li><a href="#references"><span class="toc-section-number">3.4</span> References</a></li>
</ul></li>
<li><a href="#tidy_data"><span class="toc-section-number">4</span> Tidy data and its friends</a>
<ul>
<li><a href="#setup"><span class="toc-section-number">4.1</span> Setup</a></li>
<li><a href="#tidyverse"><span class="toc-section-number">4.2</span> Tidyverse</a></li>
<li><a href="#tidy-data"><span class="toc-section-number">4.3</span> Tidy data</a></li>
<li><a href="#reshaping"><span class="toc-section-number">4.4</span> Reshaping</a></li>
<li><a href="#rearranging"><span class="toc-section-number">4.5</span> Rearranging</a></li>
<li><a href="#subset-observations-rows"><span class="toc-section-number">4.6</span> Subset observations (rows)</a></li>
<li><a href="#subset-variables-columns"><span class="toc-section-number">4.7</span> Subset variables (columns)</a></li>
<li><a href="#counting"><span class="toc-section-number">4.8</span> Counting</a></li>
<li><a href="#summarizing"><span class="toc-section-number">4.9</span> Summarizing</a>
<ul>
<li><a href="#basic"><span class="toc-section-number">4.9.1</span> Basic</a></li>
<li><a href="#scoped-summaries"><span class="toc-section-number">4.9.2</span> Scoped summaries</a></li>
</ul></li>
<li><a href="#grouping"><span class="toc-section-number">4.10</span> Grouping</a>
<ul>
<li><a href="#grouped-summaries"><span class="toc-section-number">4.10.1</span> Grouped summaries</a></li>
</ul></li>
<li><a href="#nesting"><span class="toc-section-number">4.11</span> Nesting</a>
<ul>
<li><a href="#nest"><span class="toc-section-number">4.11.1</span> nest</a></li>
<li><a href="#unnest"><span class="toc-section-number">4.11.2</span> unnest</a></li>
</ul></li>
<li><a href="#mapping"><span class="toc-section-number">4.12</span> Mapping</a></li>
<li><a href="#joining"><span class="toc-section-number">4.13</span> Joining</a>
<ul>
<li><a href="#mutating-joins"><span class="toc-section-number">4.13.1</span> Mutating joins</a></li>
<li><a href="#filtering-joins"><span class="toc-section-number">4.13.2</span> Filtering joins</a></li>
</ul></li>
</ul></li>
<li><a href="#functional_programming"><span class="toc-section-number">5</span> Automating repeated things</a>
<ul>
<li><a href="#why-functional-programming"><span class="toc-section-number">5.1</span> Why functional programming</a>
<ul>
<li><a href="#why-map"><span class="toc-section-number">5.1.1</span> Why map?</a></li>
</ul></li>
<li><a href="#automote-2-or-2-tasks"><span class="toc-section-number">5.2</span> Automote 2 or 2+ tasks</a>
<ul>
<li><a href="#objectives-1"><span class="toc-section-number">5.2.1</span> Objectives</a></li>
<li><a href="#problem"><span class="toc-section-number">5.2.2</span> Problem</a></li>
<li><a href="#for-loop"><span class="toc-section-number">5.2.3</span> For loop</a></li>
<li><a href="#map2-pmap"><span class="toc-section-number">5.2.4</span> map2 &amp; pmap</a></li>
</ul></li>
<li><a href="#automate-plotting"><span class="toc-section-number">5.3</span> Automate plotting</a>
<ul>
<li><a href="#objective"><span class="toc-section-number">5.3.1</span> Objective</a></li>
<li><a href="#problem-1"><span class="toc-section-number">5.3.2</span> Problem</a></li>
<li><a href="#solution"><span class="toc-section-number">5.3.3</span> Solution</a></li>
</ul></li>
<li><a href="#automate-joining"><span class="toc-section-number">5.4</span> Automate joining</a>
<ul>
<li><a href="#objective-1"><span class="toc-section-number">5.4.1</span> Objective</a></li>
<li><a href="#problem-2"><span class="toc-section-number">5.4.2</span> Problem</a></li>
<li><a href="#copy-and-paste"><span class="toc-section-number">5.4.3</span> Copy and paste</a></li>
<li><a href="#reduce"><span class="toc-section-number">5.4.4</span> reduce</a></li>
</ul></li>
<li><a href="#make-automation-slower-or-faster"><span class="toc-section-number">5.5</span> Make automation slower or faster</a>
<ul>
<li><a href="#objectives-2"><span class="toc-section-number">5.5.1</span> Objectives</a></li>
<li><a href="#how-to-make-automation-slower"><span class="toc-section-number">5.5.2</span> How to make automation slower</a></li>
<li><a href="#for-loop-1"><span class="toc-section-number">5.5.3</span> For loop</a></li>
<li><a href="#map"><span class="toc-section-number">5.5.4</span> Map</a></li>
<li><a href="#how-to-make-automation-faster"><span class="toc-section-number">5.5.5</span> How to make automation Faster</a></li>
</ul></li>
<li><a href="#make-error-handling-easier"><span class="toc-section-number">5.6</span> Make error handling easier</a>
<ul>
<li><a href="#learning-objective"><span class="toc-section-number">5.6.1</span> Learning objective</a></li>
<li><a href="#solution-1"><span class="toc-section-number">5.6.2</span> Solution</a></li>
</ul></li>
<li><a href="#developing-your-own-data-tools"><span class="toc-section-number">5.7</span> Developing your own data tools</a>
<ul>
<li><a href="#why-developing-r-packages"><span class="toc-section-number">5.7.1</span> Why developing R packages?</a></li>
<li><a href="#workflow"><span class="toc-section-number">5.7.2</span> Workflow</a></li>
<li><a href="#developing-an-r-package"><span class="toc-section-number">5.7.3</span> Developing an R package</a></li>
<li><a href="#required-components"><span class="toc-section-number">5.7.4</span> Required Components</a></li>
<li><a href="#optional-components"><span class="toc-section-number">5.7.5</span> Optional Components</a></li>
<li><a href="#building-an-r-package"><span class="toc-section-number">5.7.6</span> Building an R package</a></li>
<li><a href="#distributing-an-r-package"><span class="toc-section-number">5.7.7</span> Distributing an R package</a></li>
</ul></li>
</ul></li>
<li><a href="#semi_structured_data"><span class="toc-section-number">6</span> Semi-structured data</a>
<ul>
<li><a href="#objectives"><span class="toc-section-number">6.1</span> Objectives</a></li>
<li><a href="#what-is-semi-structured-data"><span class="toc-section-number">6.2</span> What is semi-structured data?</a></li>
<li><a href="#workflow"><span class="toc-section-number">6.3</span> Workflow</a></li>
<li><a href="#htmlcss-web-scraping"><span class="toc-section-number">6.4</span> HTML/CSS: web scraping</a></li>
<li><a href="#xmljson-social-media-scraping"><span class="toc-section-number">6.5</span> XML/JSON: social media scraping</a>
<ul>
<li><a href="#api"><span class="toc-section-number">6.5.1</span> API</a></li>
<li><a href="#hydrating"><span class="toc-section-number">6.5.2</span> Hydrating</a></li>
<li><a href="#parsing-json"><span class="toc-section-number">6.5.3</span> Parsing JSON</a></li>
</ul></li>
</ul></li>
<li><a href="#machine_learning"><span class="toc-section-number">7</span> High-dimensional data</a>
<ul>
<li><a href="#overview"><span class="toc-section-number">7.1</span> Overview</a></li>
<li><a href="#dataset"><span class="toc-section-number">7.2</span> Dataset</a></li>
<li><a href="#workflow"><span class="toc-section-number">7.3</span> Workflow</a></li>
<li><a href="#tidymodels"><span class="toc-section-number">7.4</span> Tidymodels</a></li>
<li><a href="#pre-processing"><span class="toc-section-number">7.5</span> Pre-processing</a>
<ul>
<li><a href="#regression-setup"><span class="toc-section-number">7.5.1</span> Regression setup</a></li>
<li><a href="#classification-setup"><span class="toc-section-number">7.5.2</span> Classification setup</a></li>
</ul></li>
<li><a href="#supervised-learning"><span class="toc-section-number">7.6</span> Supervised learning</a>
<ul>
<li><a href="#ols-and-lasso"><span class="toc-section-number">7.6.1</span> OLS and Lasso</a></li>
<li><a href="#decision-tree"><span class="toc-section-number">7.6.2</span> Decision tree</a></li>
<li><a href="#random-forest"><span class="toc-section-number">7.6.3</span> Random forest</a></li>
<li><a href="#xgboost"><span class="toc-section-number">7.6.4</span> XGboost</a></li>
<li><a href="#applications"><span class="toc-section-number">7.6.5</span> Applications</a></li>
</ul></li>
<li><a href="#unsupervised-learning"><span class="toc-section-number">7.7</span> Unsupervised learning</a>
<ul>
<li><a href="#dimension-reduction"><span class="toc-section-number">7.7.1</span> Dimension reduction</a></li>
<li><a href="#topic-modeling"><span class="toc-section-number">7.7.2</span> Topic modeling</a></li>
</ul></li>
<li><a href="#bias-and-fairness-in-machine-learning"><span class="toc-section-number">7.8</span> Bias and fairness in machine learning</a></li>
<li><a href="#resources"><span class="toc-section-number">7.9</span> Resources</a>
<ul>
<li><a href="#books"><span class="toc-section-number">7.9.1</span> Books</a></li>
<li><a href="#lecture-slides"><span class="toc-section-number">7.9.2</span> Lecture slides</a></li>
<li><a href="#blog-posts"><span class="toc-section-number">7.9.3</span> Blog posts</a></li>
</ul></li>
</ul></li>
<li><a href="#big_data"><span class="toc-section-number">8</span> Big data</a>
<ul>
<li><a href="#motivation"><span class="toc-section-number">8.1</span> Motivation</a></li>
<li><a href="#what-is-sql"><span class="toc-section-number">8.2</span> What is SQL?</a></li>
<li><a href="#learning-objectives"><span class="toc-section-number">8.3</span> Learning objectives</a></li>
<li><a href="#quick-overview"><span class="toc-section-number">8.4</span> Quick overview</a></li>
<li><a href="#setup"><span class="toc-section-number">8.5</span> Setup</a></li>
<li><a href="#packages"><span class="toc-section-number">8.6</span> Packages</a></li>
<li><a href="#datasets"><span class="toc-section-number">8.7</span> Datasets</a></li>
<li><a href="#workflow"><span class="toc-section-number">8.8</span> Workflow</a>
<ul>
<li><a href="#create-a-database"><span class="toc-section-number">8.8.1</span> Create a database</a></li>
<li><a href="#copy-an-object-as-a-table-to-the-database-push"><span class="toc-section-number">8.8.2</span> Copy an object as a table to the database (push)</a></li>
<li><a href="#quick-demonstrations"><span class="toc-section-number">8.8.3</span> Quick demonstrations:</a></li>
<li><a href="#tidy-way-dplyr---sql"><span class="toc-section-number">8.8.4</span> Tidy-way: dplyr -&gt; SQL</a></li>
<li><a href="#collect-pull"><span class="toc-section-number">8.8.5</span> Collect (pull)</a></li>
<li><a href="#disconnect"><span class="toc-section-number">8.8.6</span> Disconnect</a></li>
</ul></li>
<li><a href="#references"><span class="toc-section-number">8.9</span> References</a></li>
</ul></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Computational Thinking for Social Scientists</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="ps239t" class="section level1" number="1">
<h1 number="1"><span class="header-section-number">1</span> PS239T</h1>
<p>Welcome to PS239T</p>
<hr />
<p>This course will help social science graduate students to think computationally and develop proficiency with computational tools and techniques, necessary to conduct research in computational social science. Mastering these tools and techniques not only enables students to collect, wrangle, analyze, and interpret data with less pain and more fun, but it also let students to work on research projects that would previously seem impossible.</p>
<div id="textbook" class="section level2" number="1.1">
<h2 number="1.1"><span class="header-section-number">1.1</span> Textbook</h2>
<p><a href="https://jaeyk.github.io/PS239T/">The online book version</a> of the course materials is currently work in progress. I am loosely aiming the completion of this book in 2020.</p>
</div>
<div id="objectives" class="section level2" number="1.2">
<h2 number="1.2"><span class="header-section-number">1.2</span> Objectives</h2>
<ul>
<li><p>The goal of this course is to help students become a more efficient and innovative researcher by leveraging the power of automation.</p></li>
<li><p>The course is currently divided into two main subjects (fundamentals and applications) and six main sessions.</p></li>
</ul>
<div id="part-i-fundamentals" class="section level3" number="1.2.1">
<h3 number="1.2.1"><span class="header-section-number">1.2.1</span> Part I Fundamentals</h3>
<ul>
<li><p>In the first section, students learn best practices in data and code management using Git and Bash.</p></li>
<li><p>In the second, students learn how to wrangle, model, and visualize data easier and faster.</p></li>
<li><p>In the third, students learn how to use functions to automate repeated things and develop their own data tools (e.g., packages).</p></li>
</ul>
</div>
<div id="part-ii-applications" class="section level3" number="1.2.2">
<h3 number="1.2.2"><span class="header-section-number">1.2.2</span> Part II Applications</h3>
<ul>
<li><p>In the fourth, students learn how to collect and parse semi-structured data at scale (e.g., using APIs and webscraping).</p></li>
<li><p>In the fifth, students learn how to analyze high-dimensional data (e.g., text) using machine learning.</p></li>
<li><p>In the final, students learn how to access, query, and manage big data using SQL.</p></li>
</ul>
<p>We will learn how to do all of the above mostly in <a href="https://www.r-project.org/about.html"><strong>R</strong></a>, and sometimes in <a href="https://www.gnu.org/software/bash/"><strong>bash</strong></a> and <a href="https://www.python.org/about/"><strong>Python</strong></a>.</p>
<ul>
<li>R is free, easy to learn (thanks to <a href="https://www.tidyverse.org/"><code>tidyverse</code></a> and <a href="https://rstudio.com/">RStudio</a>), fast (thanks to <a href="https://cran.r-project.org/web/packages/Rcpp/index.html"><code>rcpp</code></a>), runs everywhere, <strong>open</strong> (16,000+ packages; counting only ones <a href="https://cran.r-project.org/web/packages/">available at CRAN</a>), and has a growing massive and inclusive community (<a href="https://twitter.com/search?q=%23rstats&amp;src=typed_query"><code>#rstats</code></a>).</li>
</ul>
</div>
</div>
<div id="logistics" class="section level2" number="1.3">
<h2 number="1.3"><span class="header-section-number">1.3</span> Logistics</h2>
<div id="contributors" class="section level3" number="1.3.1">
<h3 number="1.3.1"><span class="header-section-number">1.3.1</span> Contributors</h3>
<p>Instructor and content developer: <a href="https://jaeyk.github.io/">Jae Yeon Kim</a>: <a href="mailto:jaeyeonkim@berkeley.edu" class="email">jaeyeonkim@berkeley.edu</a></p>
</div>
<div id="time-and-location" class="section level3" number="1.3.2">
<h3 number="1.3.2"><span class="header-section-number">1.3.2</span> Time and location</h3>
<ul>
<li><p>Lecture: TBD (Zoom)</p></li>
<li><p>Section: TBD (Zoom)</p></li>
</ul>
</div>
<div id="office-hours" class="section level3" number="1.3.3">
<h3 number="1.3.3"><span class="header-section-number">1.3.3</span> Office hours</h3>
<p>By appointment with …</p>
</div>
<div id="slack-github" class="section level3" number="1.3.4">
<h3 number="1.3.4"><span class="header-section-number">1.3.4</span> Slack &amp; GitHub</h3>
<ul>
<li><p><a href="https://slack.com/">Slack</a> for communication (announcements and questions). You should ask questions about class material and assignments through the Slack channels so that everyone can benefit from the discussion. We encourage you to respond to each other’s questions as well.</p></li>
<li><p><a href="https://github.com/">GitHub</a> for everything else, including turning in assignments (except final project proposals, which will be submitted to Slack). Students are required to use GitHub for their final projects, which will be publicly available, unless they have special considerations (e.g. proprietary data). All course materials will be posted on GitHub at <a href="https://github.com/jaeyk/PS239T" class="uri">https://github.com/jaeyk/PS239T</a>, including class notes, code demonstrations, sample data, and assignments.</p></li>
</ul>
</div>
<div id="accessibility" class="section level3" number="1.3.5">
<h3 number="1.3.5"><span class="header-section-number">1.3.5</span> Accessibility</h3>
<p>This class is committed to creating an environment in which everyone can participate, regardless of background, discipline, or disability. If you have a particular concern, please come to me as soon as possible so that we can make special arrangements.</p>
</div>
<div id="code-for-conduct" class="section level3" number="1.3.6">
<h3 number="1.3.6"><span class="header-section-number">1.3.6</span> Code for conduct</h3>
<p><strong>TBD</strong></p>
</div>
<div id="course-requirements-and-grades" class="section level3" number="1.3.7">
<h3 number="1.3.7"><span class="header-section-number">1.3.7</span> Course requirements and grades</h3>
<p>This is a graded class based on the following:</p>
<ul>
<li>Completion of assigned homework (50%)</li>
<li>Participation (25%)</li>
<li>Final project (25%)</li>
</ul>
<div id="assignments" class="section level4" number="1.3.7.1">
<h4 number="1.3.7.1"><span class="header-section-number">1.3.7.1</span> Assignments</h4>
<p>Assignments will be assigned at the end of every session. They will be due at the start of the following class unless otherwise noted. The assignments will be frequent but each of them should be fairly short.</p>
<p>You are encouraged to work in groups, but the work you turn in must be your own. Group submission of homework, or turning in copies of the same code or output, is not acceptable. Remember, the only way you actually learn how to write code is to write code.</p>
<p>Unless otherwise specified, assignments should be turned in as pdf documents via the bCourses site.</p>
</div>
<div id="class-participation" class="section level4" number="1.3.7.2">
<h4 number="1.3.7.2"><span class="header-section-number">1.3.7.2</span> Class participation</h4>
<p>The class participation portion of the grade can be satisfied in one or more of the following ways:</p>
<ul>
<li>attending the lecture and section (note that section is non-optional)</li>
<li>asking and answering questions in class</li>
<li>contributing to class discussion through the bCourse site, and/or</li>
<li>collaborating with the campus computing community, either by attending a D-Lab or BIDS workshop, submitting a pull request to a campus github repository (including the class repository), answering a question on StackExchange, or other involvement in the social computing / digital humanities community.</li>
</ul>
<p>Because we will be using laptops every class, the temptation to attend to other things during slow moments will be high. While you may choose to do so, I do request that you think of your laptop screen as in the public domain for the duration of classtime. Please do not load anything that will distract your classmates or is otherwise inappropriate to a classroom setting.</p>
</div>
<div id="final-project" class="section level4" number="1.3.7.3">
<h4 number="1.3.7.3"><span class="header-section-number">1.3.7.3</span> Final project</h4>
<p>The final project consists of using the tools we learned in class on your own data of interest. First- and second-year students in the political science department are encouraged to use this as an opportunity to gather data to be used for other courses or the second-year thesis. Students are required to write a short proposal by March (no more than 2 paragraphs) in order to get approval and feedback from the instructor.
During sections in April we will have <strong>lightning talk sessions</strong> where students present their projects in a maximum 5 minute talk, with 5 minutes for class Q&amp;A. Since there is no expectation of a formal paper, you should select a project that is completable by the end of the term. In other words, submitting a research design for your future dissertation that will use skills from the class but collects no data is not acceptable, but completing a viably small portion of a study or thesis is.</p>
<ul>
<li><p><a href="https://github.com/jaeyk/PS239T/blob/master/final_projects/rubric.md">Final project rubric</a></p></li>
<li><p><a href="https://github.com/jaeyk/PS239T/tree/master/final_projects/template">Final project template</a></p></li>
<li><p><a href="https://github.com/jaeyk/PS239T/blob/master/final_projects/template/past_projects.md">Final project examples</a></p></li>
</ul>
</div>
</div>
<div id="class-activities-and-materials" class="section level3" number="1.3.8">
<h3 number="1.3.8"><span class="header-section-number">1.3.8</span> Class activities and materials</h3>
<div id="lecture" class="section level4" number="1.3.8.1">
<h4 number="1.3.8.1"><span class="header-section-number">1.3.8.1</span> Lecture</h4>
<p>Classes will follow a “workshop” style, combining lecture and lab formats. The class is interactive, with students programming every session. During the “skills” parts of the class, we will be learning how to program in R, UNIX (bash), and Python by following course notes and tutorials. During the “applications” sections, we will follow a similar structure, with occasional guest speakers.</p>
</div>
<div id="section" class="section level4" number="1.3.8.2">
<h4 number="1.3.8.2"><span class="header-section-number">1.3.8.2</span> Section</h4>
<p>The “lab” section will generally be a less formal session dedicated to helping students with materials from lecture and homework. It will be mostly student led, so come with questions. If there are no questions, the lab turns into a “hackathon” where groups can work on the assignments together. Section is required unless prior permission to miss it is obtained from both the instructor and one’s groupmates. Attending office hours is not a substitute for attending section.</p>
</div>
<div id="computer-requirements" class="section level4" number="1.3.8.3">
<h4 number="1.3.8.3"><span class="header-section-number">1.3.8.3</span> Computer requirements</h4>
<p>The software needed for the course is as follows:</p>
<ul>
<li>Access to the UNIX command line (e.g., a Mac laptop, a Bash wrapper on Windows)</li>
<li>Git</li>
<li>R and RStudio (latest versions)</li>
<li>Anaconda and Python 3 (latest versions)</li>
<li>Pandoc and LaTeX</li>
</ul>
<p>This requires a computer that can handle all this software. Almost any Mac will do the job. Most Windows machines are fine too if they have enough space and memory.</p>
<p>You must have all the software downloaded and installed PRIOR to the first day of class. If there are issues with installation on your machine, please contact the section assistant, Julia Christensen, for assistance.</p>
<p>See <a href="https://github.com/jaeyk/PS239T/blob/master/B_Install.md">B_Install.md</a> for more information.</p>
</div>
</div>
</div>
<div id="course-schedule" class="section level2" number="1.4">
<h2 number="1.4"><span class="header-section-number">1.4</span> Course schedule</h2>
<div id="part-i-fundamentals-1" class="section level3" number="1.4.1">
<h3 number="1.4.1"><span class="header-section-number">1.4.1</span> Part I Fundamentals</h3>
<ul>
<li>Week 1 Computational thinking and setup</li>
<li>Week 2 Managing data and code</li>
<li>Week 3 Tidy data and why it matters</li>
<li>Week 4 Wrangling data</li>
<li>Week 5 Wrangling data at scale</li>
<li>Week 6 Modeling and visualizing tidy data</li>
<li>Week 7 From for loop to functional programming</li>
<li>Week 8 Developing your own data tools</li>
</ul>
</div>
<div id="part-ii-applications-1" class="section level3" number="1.4.2">
<h3 number="1.4.2"><span class="header-section-number">1.4.2</span> Part II Applications</h3>
<ul>
<li>Week 9 HTML/CSS: web scraping</li>
<li>Week 10 XML/JSON: social media scraping</li>
<li>Week 11 Supervised machine learning</li>
<li>Week 12 Unsupervised machine learning</li>
<li>Week 13 Database, SQL, MongoDB, and Spark</li>
<li>Week 14 Wrap-up</li>
<li>Week 15 Final presentation</li>
</ul>
</div>
</div>
<div id="questions-comments-or-suggestions" class="section level2" number="1.5">
<h2 number="1.5"><span class="header-section-number">1.5</span> Questions, comments, or suggestions</h2>
<p>Please <a href="https://github.com/jaeyk/PS239T/issues">create issues</a> [TBD: issue template], if you have questions, comments, or suggestions.</p>
</div>
<div id="special-thanks" class="section level2" number="1.6">
<h2 number="1.6"><span class="header-section-number">1.6</span> Special thanks</h2>
<p>This course is a remix version of <a href="https://github.com/rochelleterman/PS239T">the course</a> originally developed by <a href="http://rochelleterman.com/">Rochelle Terman</a> then revised by <a href="http://rachelbernhard.com/">Rachel Bernhard</a>. Other teaching materials draw from the workshops I created for <a href="https://dlab.berkeley.edu/">D-Lab</a> and <a href="https://data.berkeley.edu/research/discovery-program-home">Data Science Discovery Program</a> at UC Berkeley.</p>
</div>
<div id="license" class="section level2" number="1.7">
<h2 number="1.7"><span class="header-section-number">1.7</span> License</h2>
<p><img src="https://i.creativecommons.org/l/by/4.0/88x31.png" /> This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</p>
<!--chapter:end:index.Rmd-->
</div>
</div>
<div id="motivation" class="section level1" number="2">
<h1 number="2"><span class="header-section-number">2</span> Computational thinking</h1>
<div id="why-computational-thinking" class="section level2" number="2.1">
<h2 number="2.1"><span class="header-section-number">2.1</span> Why computational thinking</h2>
<ul>
<li><p>If social scientists want to know how to work smart and not just hard, they need to take full advantage of the power of modern programming languages, and that power is <strong>automation</strong>.</p></li>
<li><p>Let’s think about the following two cases.</p>
<ul>
<li><p>Case 1: Suppose a social scientist needs to collect data on civic organizations in the United States from websites, Internal Revenue Service reports, and social media posts. As the number of these organizations is large, the researcher could not collect a large volume of data from diverse sources, so they would hire undergraduates and distribute tasks among them. This is a typical data collection plan in social science research, and it is labor-intensive. Automation is not part of the game plan. Yet, it is critical for so many reasons. Because the process is costly, no one is likely to either replicate or update the data collection effort. Put differently, without making the process efficient, it is difficult for it to be reproducible and scalable.</p></li>
<li><p>Case 2: An alternative is to write computer programs that collect such data automatically, parse them, and store them in interconnected databases. Additionally, someone may need to maintain and validate the quality of the data infrastructure. Nevertheless, this approach lowers the cost of the data collection process, thereby substantially increasing the reproducibility and scalability of the process. Furthermore, the researcher can document their code and publicly share it using their GitHub repository or even gather some of the functions they used and distribute them as open-source libraries.</p></li>
</ul></li>
<li><p>Programming is as valuable a skill as writing in social science research. The extent to which a researcher can automate the research process can determine its efficiency, reproducibility, and scalability.</p></li>
</ul>
<blockquote>
<p>Every modern statistical and data analysis problem needs code to solve it. You shouldn’t learn just the basics of programming, spend some time gaining mastery. Improving your programming skills pays off because code is a <strong>force multiplier</strong>: once you’ve solved a problem once, code allows you to solve it much faster in the future. As your programming skill increases, the generality of your solutions improves: you solve not just the precise problem you encountered, but a wider class of related problems (in this way programming skill is very much like mathematical skill). Finally, sharing your code with others allows them to benefit from your experience. - <a href="https://imstat.org/2014/12/16/hadley-wickham-impact-the-world-by-being-useful/">Hadley Wickham</a></p>
</blockquote>
<ul>
<li>How can we automate our research process? How can we talk to and teach a machine so that it could become (hopefully) the most competent and reliable research assistant ever?</li>
</ul>
<div class="figure">
<img src="https://bam.files.bbci.co.uk/bam/live/content/znmb87h/large" alt="" />
<p class="caption">From BBC Bitesize</p>
</div>
</div>
<div id="computational-way-of-thinking-about-data" class="section level2" number="2.2">
<h2 number="2.2"><span class="header-section-number">2.2</span> Computational way of thinking about data</h2>
<div id="structure" class="section level3" number="2.2.1">
<h3 number="2.2.1"><span class="header-section-number">2.2.1</span> Structure</h3>
<ul>
<li>Structured data (Excel spreadsheets, CSVs)
<ul>
<li>Tidy data</li>
</ul></li>
<li>Semi-structured data
<ul>
<li>HTML/CSS: Websites</li>
<li>JSON/XML: APIs</li>
</ul></li>
</ul>
</div>
<div id="dimension" class="section level3" number="2.2.2">
<h3 number="2.2.2"><span class="header-section-number">2.2.2</span> Dimension</h3>
<ul>
<li>Low-dimensional data (n &gt; p)
<ul>
<li>Survey, experimental, and administrative data</li>
</ul></li>
<li>High-dimensional data (n &lt; p)
<ul>
<li>Text, speech, image, video, etc.</li>
</ul></li>
</ul>
</div>
<div id="size" class="section level3" number="2.2.3">
<h3 number="2.2.3"><span class="header-section-number">2.2.3</span> Size</h3>
<ul>
<li>Data fit in your laptop’s memory</li>
<li>Data don’t fit in your laptop’s memory (=big data)</li>
</ul>
</div>
</div>
<div id="computational-way-of-thinking-about-research-process" class="section level2" number="2.3">
<h2 number="2.3"><span class="header-section-number">2.3</span> Computational way of thinking about research process</h2>
<p>Computational tools and techniques make …</p>
<ul>
<li>Doing traditional research easier, faster, scalable, and more reproducible
<ul>
<li>Data wrangling</li>
<li>Modeling</li>
<li>Visualization</li>
</ul></li>
<li>Documentation and collaboration easier, faster, scalable, safer, and more experimental
<ul>
<li>Dynamic reporting (markdown)</li>
<li>Version control system (Git and GitHub)</li>
</ul></li>
<li>Collecting and analyzing large and complex data possible
<ul>
<li>Digital data collection (API and web scraping)
<ul>
<li>Building a data infrastructure (SQL)</li>
</ul></li>
<li>Machine learning</li>
</ul></li>
</ul>
<!--chapter:end:00_motivation.Rmd-->
</div>
</div>
<div id="intro" class="section level1" number="3">
<h1 number="3"><span class="header-section-number">3</span> Managing data and code</h1>
<div id="project-oriented-research" class="section level2" number="3.1">
<h2 number="3.1"><span class="header-section-number">3.1</span> Project-oriented research</h2>
<div id="computational-reproducibility" class="section level3" number="3.1.1">
<h3 number="3.1.1"><span class="header-section-number">3.1.1</span> Computational reproducibility</h3>
<div id="setup" class="section level4" number="3.1.1.1">
<h4 number="3.1.1.1"><span class="header-section-number">3.1.1.1</span> Setup</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2"></a>  tidyverse, <span class="co"># tidyverse</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  here <span class="co"># computational reproducibility</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>)</span></code></pre></div>
</div>
<div id="motivation" class="section level4" number="3.1.1.2">
<h4 number="3.1.1.2"><span class="header-section-number">3.1.1.2</span> Motivation</h4>
<p>Why do you need to make your research project computationally reproducible?</p>
<p>For your self-interest and public benefits.</p>
<p><img src="https://github.com/dlab-berkeley/efficient-reproducible-project-management-in-R/blob/master/misc/screenshot.png?raw=true" /></p>
</div>
<div id="how-to-organize-files-in-a-project" class="section level4" number="3.1.1.3">
<h4 number="3.1.1.3"><span class="header-section-number">3.1.1.3</span> How to organize files in a project</h4>
<p>You won’t be able to reproduce your project unless it is efficiently organized.</p>
<p>Step 1. <a href="https://environments.rstudio.com/"><strong>Environment</strong></a> is part of your project. If someone can’t reproduce your environment, they won’t be able to run your code.</p>
<ul>
<li>Launch R Studio. Choose Tools &gt; Global Options. You should not check <code>Restor .RData into workspace at startup</code> and set saving workspace option to <code>NEVER</code>.</li>
</ul>
<p>Step 2. For each project, create a project directory named after the project.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Don&#39;t name it a project. Use a name that&#39;s more informative. For instance, us_election not my_project.</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">dir.create</span>(<span class="st">&quot;../us_election&quot;</span>)</span></code></pre></div>
<p>Step 3. Launch R Studio. Choose File &gt; New project &gt; Browse existing directories &gt; Create project This allows each project has its own workspace.</p>
<p>Step 4. Organize files by putting them in separate subdirectories and naming them in a sensible way.</p>
<ul>
<li><p>Treat raw data as read only (raw data should be RAW!) and put in the <code>data</code> subdirectory.</p>
<ul>
<li>Note that version control does not need replace backup. You still need to backup your raw data.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">dir.create</span>(here<span class="op">::</span><span class="kw">here</span>(<span class="st">&quot;us_election&quot;</span>, <span class="st">&quot;data&quot;</span>))</span></code></pre></div>
<ul>
<li>Separate read-only data from processed data and put in the <code>processed_data</code> subdirectory.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">dir.create</span>(here<span class="op">::</span><span class="kw">here</span>(<span class="st">&quot;us_election&quot;</span>, <span class="st">&quot;processed_data&quot;</span>))</span></code></pre></div>
<ul>
<li>Put your code in the <code>src</code> subdirectory.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">dir.create</span>(here<span class="op">::</span><span class="kw">here</span>(<span class="st">&quot;us_election&quot;</span>, <span class="st">&quot;src&quot;</span>))</span></code></pre></div>
<ul>
<li>Put generated outputs (e.g., tables, figures) in the <code>outputs</code> subdirectory and treat them as disposable.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">dir.create</span>(here<span class="op">::</span><span class="kw">here</span>(<span class="st">&quot;us_election&quot;</span>, <span class="st">&quot;outputs&quot;</span>))</span></code></pre></div>
<ul>
<li>Put your custom functions in the <code>functions</code> subdirectory. You can gather some of these functions and distribute them as an open-source library.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">dir.create</span>(here<span class="op">::</span><span class="kw">here</span>(<span class="st">&quot;us_election&quot;</span>, <span class="st">&quot;src&quot;</span>))</span></code></pre></div>
<p><strong>Challenge 2</strong></p>
<p>Set a project structure for a project named “starwars”.</p>
</div>
<div id="how-to-organize-code-in-a-r-markdown-file" class="section level4" number="3.1.1.4">
<h4 number="3.1.1.4"><span class="header-section-number">3.1.1.4</span> How to organize code in a R markdown file</h4>
<ul>
<li><p>In addition to environment, <strong>workflow</strong> is an important component of project efficiency and reproducibility.</p></li>
<li><p>What is R markdown? An R package, developed by <a href="https://yihui.org/en/">Yihui Xie</a>, that provides an authoring framework for data science. Xie is also a developer of many widely popular R packages such as <code>knitr</code>, <a href="https://github.com/yihui/xaringan"><code>xaringan</code></a> (cool kids use xaringan not <a href="https://en.wikipedia.org/wiki/Beamer_(LaTeX)">Beamer</a> these days), <code>blogdown</code> (used to create <a href="https://jaeyk.github.io/">my personal website</a>), and <code>bookdown</code> (used to create this book) among many others.</p>
<ul>
<li>Many applications: <a href="https://rstudio.github.io/distill/basics.html">reports</a>, <a href="https://bookdown.org/yihui/rmarkdown/xaringan.html">presentations</a>, <a href="https://rmarkdown.rstudio.com/flexdashboard/">dashboards</a>, <a href="https://bookdown.org/yihui/rmarkdown/websites.html">websites</a><br />
</li>
<li>Check out <a href="https://ysc-rmarkdown.netlify.app/">Communicating with R markdown workshop</a> by <a href="https://alison.rbind.io/">Alison Hill</a> (RStudio)
<ul>
<li>Alison Hill is a co-author of <a href="https://bookdown.org/yihui/blogdown/"><code>blogdown: Creating Websites with R Markdown.</code></a></li>
</ul></li>
<li>Key strengths: dynamic reporting + reproducible science + easy deployment</li>
</ul></li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/s9aWmU0atlQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>R Markdown The bigger picture - Garrett Grolemund</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Xn5AmUf7gDQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>R-Ladies Oslo (English) - Reports to impress your boss! Rmarkdown magic - Athanasia Mowinckel</p>
<ul>
<li>R Markdown basic syntax</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Header 1</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co">## Header 2</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co">### Header 3</span></span></code></pre></div>
<ul>
<li>Use these section headers to indicate workflow.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># Import packages and data</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co"># Tidy data</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co"># Wrangle data</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co"># Model data</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co"># Visualize data</span></span></code></pre></div>
<ul>
<li><p>Press <code>ctrl + shift + o</code>. You can see a document outline based on these headers. This is a nice feature for finding code you need to focus.</p></li>
<li><p>If your project’s scale is large, then divide these sections into files, number, and save them in <code>code</code> subdirectory.</p>
<ul>
<li>01_wrangling.Rmd</li>
<li>02_modeling.Rmd
…</li>
</ul></li>
</ul>
</div>
<div id="making-a-project-computationally-reproducible" class="section level4" number="3.1.1.5">
<h4 number="3.1.1.5"><span class="header-section-number">3.1.1.5</span> Making a project computationally reproducible</h4>
<ul>
<li><p><code>setwd()</code>: set a working directory.</p></li>
<li><p>Note that using <code>setwd()</code> is not a reproducible way to set up your project. For instance, none will be able to run the following code except me.</p></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># Set a working directory </span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="kw">setwd</span>(<span class="st">&quot;/home/jae/starwars&quot;</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co"># Do something </span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="kw">ggplot</span>(mtcars, <span class="kw">aes</span>(<span class="dt">x =</span> mpg, <span class="dt">y =</span> wt)) <span class="op">+</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="st">   </span><span class="kw">geom_point</span>()</span>
<span id="cb10-7"><a href="#cb10-7"></a></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="co"># Export the object. </span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co"># dot means the working directory set by setwd()</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="kw">ggsave</span>(<span class="st">&quot;./outputs/example.png&quot;</span>) <span class="co"># This is called relative path </span></span></code></pre></div>
<ul>
<li><p>Instead, learn how to use <code>here()</code>’.</p>
<ul>
<li><p>Key idea: separate workflow (e.g., workspace information) from products (code and data). For more information, read Jenny Bryan’s wonderful piece on <a href="https://www.tidyverse.org/blog/2017/12/workflow-vs-script/">project-oriented workflow</a>.</p></li>
<li><p>Example</p></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># New: Reproducible </span></span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="kw">ggplot</span>(mtcars, <span class="kw">aes</span>(<span class="dt">x =</span> mpg, <span class="dt">y =</span> wt)) <span class="op">+</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">   </span><span class="kw">geom_point</span>()</span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="kw">ggsave</span>(<span class="kw">here</span>(<span class="st">&quot;project&quot;</span>, <span class="st">&quot;outputs&quot;</span>, <span class="st">&quot;example.png&quot;</span>))</span></code></pre></div>
<ul>
<li>How <code>here</code> works</li>
</ul>
<p><code>here()</code> function shows what’s the top-level project directory.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>here<span class="op">::</span><span class="kw">here</span>()</span></code></pre></div>
<ul>
<li>Build a path including subdirectories</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>here<span class="op">::</span><span class="kw">here</span>(<span class="st">&quot;project&quot;</span>, <span class="st">&quot;outputs&quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a>           <span class="co">#depth 1   #depth 2</span></span></code></pre></div>
<ul>
<li><p>How <code>here</code> defines the top-level project directory. The following list came from <a href="https://github.com/jennybc/here_here">the here package vignette</a>).</p>
<ul>
<li><p>Is a file named .here present?</p></li>
<li><p>Is this an RStudio Project? (<strong>Note that we already set up an RStudio Project!</strong> So, if you use RStudio’s project feature, then you are ready to use <code>here</code>.)</p></li>
<li><p>Is this an R package? Does it have a DESCRIPTION file?</p></li>
<li><p>Is this a remake project? Does it have a file named <code>remake.yml</code>?</p></li>
<li><p>Is this a projectile project? Does it have a file named <code>.projectile</code>?</p></li>
<li><p>Is this a checkout from a version control system? Does it have a directory named <code>.git</code> or <code>.svn</code>? Currently, only Git and Subversion are supported.</p></li>
<li><p>If there’s no match then use <code>set_here()</code> to create an empty <code>.here</code> file.</p></li>
</ul></li>
</ul>
<p><strong>Challenge 1</strong></p>
<ol style="list-style-type: decimal">
<li>Can you define computational reproducibility?</li>
<li>Can you explain why sharing code and data is not enough for computational reproducibility?</li>
</ol>
</div>
</div>
<div id="version-control-git-and-bash" class="section level3" number="3.1.2">
<h3 number="3.1.2"><span class="header-section-number">3.1.2</span> Version control (Git and Bash)</h3>
<p><img src="https://github.com/dlab-berkeley/BashGit/raw/master/octobash.png" /></p>
<div id="what-is-bash" class="section level4" number="3.1.2.1">
<h4 number="3.1.2.1"><span class="header-section-number">3.1.2.1</span> What Is Bash?</h4>
<div id="writing-your-first-shell-script" class="section level5" number="3.1.2.1.1">
<h5 number="3.1.2.1.1"><span class="header-section-number">3.1.2.1.1</span> Writing your first shell script</h5>
<p>Write a shell script that creates a directory called <code>/pdfs</code> under <code>/Download</code> directory, then find PDF files in <code>/Download</code> and copy those files to <code>pdfs</code>. This shell script creates a backup.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="co">#!/bin/sh</span></span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="fu">mkdir</span> /home/jae/Downloads/pdfs </span>
<span id="cb14-5"><a href="#cb14-5"></a></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="bu">cd</span> Download</span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="fu">cp</span> *.pdf pdfs/ </span>
<span id="cb14-9"><a href="#cb14-9"></a></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="bu">echo</span> <span class="st">&quot;Copied pdfs&quot;</span></span></code></pre></div>
</div>
</div>
<div id="what-are-git-and-github" class="section level4" number="3.1.2.2">
<h4 number="3.1.2.2"><span class="header-section-number">3.1.2.2</span> What Are Git and GitHub?</h4>
<div class="figure">
<img src="https://plain-text.co/figures/git-basic.png" alt="" />
<p class="caption">Figure 2.1. A schematic git workflow from Healy’s “The Plain Person’s Guide to Plain Text Social Science”</p>
</div>
<div id="basics-git-push-and-git-pull" class="section level5" number="3.1.2.2.1">
<h5 number="3.1.2.2.1"><span class="header-section-number">3.1.2.2.1</span> Basics: <code>git push</code> and <code>git pull</code></h5>
</div>
<div id="time-machine-git-revert" class="section level5" number="3.1.2.2.2">
<h5 number="3.1.2.2.2"><span class="header-section-number">3.1.2.2.2</span> Time machine: <code>git revert</code></h5>
</div>
<div id="parallel-universe-git-branch" class="section level5" number="3.1.2.2.3">
<h5 number="3.1.2.2.3"><span class="header-section-number">3.1.2.2.3</span> Parallel universe: <code>git branch</code></h5>
</div>
<div id="user-manual-readme" class="section level5" number="3.1.2.2.4">
<h5 number="3.1.2.2.4"><span class="header-section-number">3.1.2.2.4</span> User-manual: <code>readme</code></h5>
<ul>
<li>README.md</li>
</ul>
<p><img src="https://libapps.s3.amazonaws.com/accounts/125446/images/README_Sample.png" /></p>
<ul>
<li><p>In this simple markdown file, note some basic information about the project including the project structure.</p></li>
<li><p>This is how I used the <code>README.md</code> file for this course. Check out <a href="https://github.com/jaeyk">my GitHub account</a> to see how I manage my projects.</p></li>
</ul>
</div>
</div>
<div id="deployment-github-pages" class="section level4" number="3.1.2.3">
<h4 number="3.1.2.3"><span class="header-section-number">3.1.2.3</span> Deployment: GitHub Pages</h4>
</div>
<div id="tracking-progress-github-issues" class="section level4" number="3.1.2.4">
<h4 number="3.1.2.4"><span class="header-section-number">3.1.2.4</span> Tracking progress: GitHub Issues</h4>
</div>
<div id="project-management-github-dashboards" class="section level4" number="3.1.2.5">
<h4 number="3.1.2.5"><span class="header-section-number">3.1.2.5</span> Project management: GitHub Dashboards</h4>
</div>
</div>
</div>
<div id="writing-code-how-to-code-like-a-professional" class="section level2" number="3.2">
<h2 number="3.2"><span class="header-section-number">3.2</span> Writing code: How to code like a professional</h2>
<div id="write-readable-code" class="section level3" number="3.2.1">
<h3 number="3.2.1"><span class="header-section-number">3.2.1</span> Write readable code</h3>
<ul>
<li>What is code style?</li>
</ul>
<blockquote>
<p>Every major open-source project has its own style guide: a set of conventions (sometimes arbitrary) about how to write code for that project. It is much easier to understand a large codebase when all the code in it is in a consistent style. - <a href="https://google.github.io/styleguide/">Google Style Guides</a></p>
</blockquote>

<iframe width="560" height="315" src="https://www.youtube.com/embed/UjhX2sVf0eg" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
allowfullscreen></iframe>

<p>10 Tips For Clean Code - Michael Toppa</p>

<ul>
<li><p>How to avoid smelly code?</p>
<ul>
<li>Check out <a href="https://github.com/jennybc/code-smells-and-feels#readme">the code-smells Git repository</a> by Jenny Bryan.</li>
</ul></li>
</ul>
<iframe width="560" height="315" src="https://www.youtube.com/embed/7oyiPBjLAWY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p> Code smells and feels - Jenny Bryan</p>

<p> "Code smell" is an evocative term for that vague feeling of unease we get when reading certain bits of code. It's not necessarily wrong, but neither is it obviously correct. We may be reluctant to work on such code, because past experience suggests it's going to be fiddly and bug-prone. In contrast, there's another type of code that just feels good to read and work on. What's the difference? If we can be more precise about code smells and feels, we can be intentional about writing code that is easier and more pleasant to work on. I've been fortunate to spend the last couple years embedded in a group of developers working on the tidyverse and r-lib packages. Based on this experience, I'll talk about specific code smells and deodorizing strategies for R. - Jenny Bryan</p>
<ul>
<li><p>Naming matters</p>
<ul>
<li>When naming files:
<ul>
<li>Don’t use special characters. (Spaces make filenames awkward in the console/command-line.)</li>
<li>Don’t capitalize. (UNIX is case sensitive.)</li>
<li>Numbering them if files should be run in an order.</li>
</ul></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># Good</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>fit_models.R</span>
<span id="cb15-3"><a href="#cb15-3"></a></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co"># Bad</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>fit models.R</span></code></pre></div>
<ul>
<li>When naming objects:
<ul>
<li>Don’t use special characters.</li>
<li>Don’t capitalize.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Good </span></span>
<span id="cb16-2"><a href="#cb16-2"></a>day_one</span>
<span id="cb16-3"><a href="#cb16-3"></a>    </span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="co"># Bad </span></span>
<span id="cb16-5"><a href="#cb16-5"></a>DayOne</span></code></pre></div>
<ul>
<li>When naming functions:
<ul>
<li>Don’t use special characters.</li>
<li>Don’t capitalize.</li>
<li>Use <code>verbs</code> instead of <code>nouns</code>. (Functions do something!)</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># Good </span></span>
<span id="cb17-2"><a href="#cb17-2"></a>run_rdd </span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co"># Bad </span></span>
<span id="cb17-5"><a href="#cb17-5"></a>rdd</span></code></pre></div>
<ul>
<li>Spacing</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># Good</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>x[, <span class="dv">1</span>] </span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="kw">mean</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) </span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="co"># Bad</span></span>
<span id="cb18-7"><a href="#cb18-7"></a></span>
<span id="cb18-8"><a href="#cb18-8"></a>x[,<span class="dv">1</span>]</span>
<span id="cb18-9"><a href="#cb18-9"></a></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="kw">mean</span> (x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<ul>
<li>Indenting</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Good</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="cf">if</span> (y <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="kw">message</span>(<span class="st">&quot;y is negative&quot;</span>)</span>
<span id="cb19-4"><a href="#cb19-4"></a>}</span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co"># Bad</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="cf">if</span> (y <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="kw">message</span>(<span class="st">&quot;Y is negative&quot;</span>)}</span></code></pre></div>
<ul>
<li>Long lines</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># Good</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="kw">do_something_very_complicated</span>(</span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="dt">something =</span> <span class="st">&quot;that&quot;</span>,</span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="dt">requires =</span> many,</span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="dt">arguments =</span> <span class="st">&quot;some of which may be long&quot;</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>)</span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="co"># Bad</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="kw">do_something_very_complicated</span>(<span class="st">&quot;that&quot;</span>, <span class="dt">requires =</span> many, <span class="dt">arguments =</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>                              <span class="st">&quot;some of which may be long&quot;</span></span>
<span id="cb20-11"><a href="#cb20-11"></a>                              )</span></code></pre></div>
<ul>
<li>Comments
<ul>
<li>Use comments to explain your decisions.</li>
<li>But, show your code; Do not try to explain your code by comments.</li>
<li>Also, try to comment out rather than delete the code that you experiment with.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># Average sleep hours of Jae</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>jae <span class="op">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="st">  </span><span class="co"># By week</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="st">  </span><span class="kw">group_by</span>(week) <span class="op">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="st">  </span><span class="co"># Mean sleep hours </span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">week_sleep =</span> <span class="kw">mean</span>(sleep, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<ul>
<li>Pipes (chaining commands)</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># Good</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>iris <span class="op">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="st">  </span><span class="kw">group_by</span>(Species) <span class="op">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="st">  </span><span class="kw">summarize_if</span>(is.numeric, mean) <span class="op">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="st">  </span><span class="kw">gather</span>(measure, value, <span class="op">-</span>Species) <span class="op">%&gt;%</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="st">  </span><span class="kw">arrange</span>(value)</span>
<span id="cb22-8"><a href="#cb22-8"></a></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="co"># Bad</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Species) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize_all</span>(mean) <span class="op">%&gt;%</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>ungroup <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(measure, value, <span class="op">-</span>Species) <span class="op">%&gt;%</span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="kw">arrange</span>(value)</span></code></pre></div>
<ul>
<li><p>Additional tips</p></li>
<li><p>Use <code>lintr</code> to check whether your code complies with a recommended style guideline (e.g., <code>tidyverse</code>) and <code>styler</code> package to format your code according to the style guideline.</p></li>
</ul>
<div class="figure">
<img src="https://camo.githubusercontent.com/6cb80270269165a8d3046d2da03cbf2b8f19ee2f/687474703a2f2f692e696d6775722e636f6d2f61635632374e562e676966" alt="" />
<p class="caption">how lintr works</p>
</div>
</div>
<div id="write-reusable-code" class="section level3" number="3.2.2">
<h3 number="3.2.2"><span class="header-section-number">3.2.2</span> Write reusable code</h3>
<ul>
<li>Pasting</li>
</ul>
<blockquote>
<p>Copy-and-paste programming, sometimes referred to as just pasting, is the production of highly repetitive computer programming code, as produced by copy and paste operations. It is primarily a pejorative term; those who use the term are often implying a lack of programming competence. It may also be the result of technology limitations (e.g., an insufficiently expressive development environment) as subroutines or libraries would normally be used instead. However, there are occasions when copy-and-paste programming is considered acceptable or necessary, such as for boilerplate, loop unrolling (when not supported automatically by the compiler), or certain programming idioms, and it is supported by some source code editors in the form of snippets. - <a href="https://en.wikipedia.org/wiki/Copy-and-paste_programming">Wikipedia</a></p>
</blockquote>
<ul>
<li><p>It’s okay for pasting for the first attempt to solve a problem. But if you copy and paste three times (a.k.a. <a href="https://en.wikipedia.org/wiki/Rule_of_three_(computer_programming)">Rule of Three</a> in programming), something’s wrong. You’re working too hard. You need to be lazy. What do I mean and how can you do that?</p></li>
<li><p>Example</p></li>
<li><p>Let’s imagine <code>df</code> is a survey dataset.</p>
<ul>
<li><p><code>a, b, c, d</code> = Survey questions</p></li>
<li><p><code>-99</code>: non-responses</p></li>
<li><p>Your goal: replace <code>-99</code> with <code>NA</code></p></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># Data</span></span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>) <span class="co"># for reproducibility </span></span>
<span id="cb23-4"><a href="#cb23-4"></a></span>
<span id="cb23-5"><a href="#cb23-5"></a>df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="st">&quot;a&quot;</span> =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">99</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size =</span> <span class="dv">5</span> , <span class="dt">replace=</span> <span class="ot">TRUE</span>),</span>
<span id="cb23-6"><a href="#cb23-6"></a>             <span class="st">&quot;b&quot;</span> =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">99</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size =</span> <span class="dv">5</span> , <span class="dt">replace=</span> <span class="ot">TRUE</span>),</span>
<span id="cb23-7"><a href="#cb23-7"></a>             <span class="st">&quot;c&quot;</span> =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">99</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size =</span> <span class="dv">5</span> , <span class="dt">replace=</span> <span class="ot">TRUE</span>),</span>
<span id="cb23-8"><a href="#cb23-8"></a>             <span class="st">&quot;d&quot;</span> =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">99</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size =</span> <span class="dv">5</span> , <span class="dt">replace=</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># Copy and paste </span></span>
<span id="cb24-2"><a href="#cb24-2"></a>df<span class="op">$</span>a[df<span class="op">$</span>a <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>df<span class="op">$</span>b[df<span class="op">$</span>b <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb24-4"><a href="#cb24-4"></a>df<span class="op">$</span>c[df<span class="op">$</span>c <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>df<span class="op">$</span>d[df<span class="op">$</span>d <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb24-6"><a href="#cb24-6"></a></span>
<span id="cb24-7"><a href="#cb24-7"></a>df</span></code></pre></div>
<pre><code>## # A tibble: 5 x 4
##       a     b     c     d
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     3     3     3     1
## 2     3     2     3     1
## 3     1    NA     1     2
## 4     1    NA     2     1
## 5    NA     1     1     3</code></pre>
<ul>
<li>Using a function
<ul>
<li>function: input + computation + output</li>
<li>If you write a function, you gain efficiency because you don’t need to copy and paste the computation part.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># Create a custom function</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>fix_missing &lt;-<span class="st"> </span><span class="cf">function</span>(x) { <span class="co"># INPUT</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>  x[x <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span> <span class="co"># COMPUTATION</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>  x <span class="co"># OUTPUT </span></span>
<span id="cb26-5"><a href="#cb26-5"></a>}</span>
<span id="cb26-6"><a href="#cb26-6"></a></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="co"># Apply the function to each column (vector)</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="co"># This iterated part can and should be automated.</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>df<span class="op">$</span>a &lt;-<span class="st"> </span><span class="kw">fix_missing</span>(df<span class="op">$</span>a)</span>
<span id="cb26-10"><a href="#cb26-10"></a>df<span class="op">$</span>b &lt;-<span class="st"> </span><span class="kw">fix_missing</span>(df<span class="op">$</span>b)</span>
<span id="cb26-11"><a href="#cb26-11"></a>df<span class="op">$</span>c &lt;-<span class="st"> </span><span class="kw">fix_missing</span>(df<span class="op">$</span>c)</span>
<span id="cb26-12"><a href="#cb26-12"></a>df<span class="op">$</span>d &lt;-<span class="st"> </span><span class="kw">fix_missing</span>(df<span class="op">$</span>d)</span>
<span id="cb26-13"><a href="#cb26-13"></a></span>
<span id="cb26-14"><a href="#cb26-14"></a>df</span></code></pre></div>
<ul>
<li>Automation
<ul>
<li>Many options for automation in R: <code>for loop</code>, <code>apply</code> family, etc.</li>
<li>Here’s a tidy solution comes from <code>purrr</code> package.</li>
<li>The power and joy of one-liner.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>df &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map_df</span>(df, fix_missing) <span class="co"># What is this magic? We will unpack the blackbox (`map_df()`) later.</span></span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a>df</span></code></pre></div>
<ul>
<li>Takeaways</li>
</ul>
<ol style="list-style-type: decimal">
<li>Your code becomes more reusable, when it’s easier to <strong>change, debug, and scale up</strong>. Don’t repeat yourself and embrace the power of lazy programming.</li>
</ol>
<blockquote>
<p>Lazy, because only lazy programmers will want to write the kind of tools that might replace them in the end. Lazy, because only a lazy programmer will avoid writing monotonous, repetitive code—thus avoiding redundancy, the enemy of software maintenance and flexible refactoring. Mostly, the tools and processes that come out of this endeavor fired by laziness will speed up the production. - <a href="http://blogoscoped.com/archive/2005-08-24-n14.html">Philipp Lenssen</a></p>
</blockquote>
<ol start="2" style="list-style-type: decimal">
<li>Only when your code becomes <strong>reusable</strong>, you would become <strong>efficient</strong> in your data work. Otherwise, you need to start from scratch or copy and paste, when you work on a new project.</li>
</ol>
<blockquote>
<p>Code reuse aims to save time and resources and reduce redundancy by taking advantage of assets that have already been created in some form within the software product development process.[2] The key idea in reuse is that parts of a computer program written at one time can be or should be used in the construction of other programs written at a later time. - Wikipedia</p>
</blockquote>
</div>
<div id="test-your-code-systematically" class="section level3" number="3.2.3">
<h3 number="3.2.3"><span class="header-section-number">3.2.3</span> Test your code systematically</h3>
</div>
</div>
<div id="asking-questions-minimal-reproducible-example" class="section level2" number="3.3">
<h2 number="3.3"><span class="header-section-number">3.3</span> Asking questions: Minimal reproducible example</h2>
<div id="how-to-create-a-minimal-reproducible-example" class="section level3" number="3.3.1">
<h3 number="3.3.1"><span class="header-section-number">3.3.1</span> How to create a minimal reproducible example</h3>
</div>
</div>
<div id="references" class="section level2" number="3.4">
<h2 number="3.4"><span class="header-section-number">3.4</span> References</h2>
<ul>
<li><p>Project-oriented research</p>
<ul>
<li><p>Computational reproducibility</p>
<ul>
<li><p><a href="https://github.com/swcarpentry/good-enough-practices-in-scientific-computing/blob/gh-pages/good-enough-practices-for-scientific-computing.pdf">“Good Enough Practices in Scientific Computing”</a> by PLOS</p></li>
<li><p><a href="https://swcarpentry.github.io/r-novice-gapminder/02-project-intro/">Project Management with RStudio</a> by Software Carpentry</p></li>
<li><p><a href="https://kbroman.org/steps2rr/">Initial steps toward reproducible research</a> by Karl Broman</p></li>
</ul></li>
<li><p>Version control</p>
<ul>
<li><p><a href="https://swcarpentry.github.io/git-novice/">Version Control with Git</a> by Software Carpentry</p></li>
<li><p><a href="http://plain-text.co/">The Plain Person’s Guide to Plain Text Social Science</a> by Kieran Healy</p></li>
</ul></li>
</ul></li>
<li><p>Writing code</p>
<ul>
<li>Style guides
<ul>
<li>R
<ul>
<li><a href="https://google.github.io/styleguide/Rguide.xml">Google’s R style guide</a></li>
<li><a href="http://r-pkgs.had.co.nz/r.html">R code style guide</a> by Hadley Wickham</li>
<li><a href="http://style.tidyverse.org/">The tidyverse style guide</a> by Hadley Wickham</li>
</ul></li>
<li>Python
<ul>
<li><a href="https://github.com/google/styleguide/blob/gh-pages/pyguide.md">Google Python Style Guide</a></li>
<li><a href="https://docs.python-guide.org/writing/style/#zen-of-python">Code Style</a> by the Hitchhiker’s Guide to Python</li>
</ul></li>
</ul></li>
</ul></li>
<li><p>Asking questions</p></li>
</ul>
<!--chapter:end:01_intro.Rmd-->
</div>
</div>
<div id="tidy_data" class="section level1" number="4">
<h1 number="4"><span class="header-section-number">4</span> Tidy data and its friends</h1>
<div id="setup" class="section level2" number="4.1">
<h2 number="4.1"><span class="header-section-number">4.1</span> Setup</h2>
<ul>
<li>Check your <code>dplyr</code> package is up-to-date by typing <code>packageVersion("dplyr")</code>. If the current installed version is less than 1.0, then update by typing <code>update.packages("dplyr")</code>. You may need to restart R to make it work.</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="kw">ifelse</span>(<span class="kw">packageVersion</span>(<span class="st">&quot;dplyr&quot;</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>, </span>
<span id="cb28-2"><a href="#cb28-2"></a>       <span class="st">&quot;The installed version of dplyr package is greater than or equal to 1.0.0&quot;</span>, <span class="kw">update.packages</span>(<span class="st">&quot;dplyr&quot;</span>))</span></code></pre></div>
<pre><code>## [1] &quot;The installed version of dplyr package is greater than or equal to 1.0.0&quot;</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;pacman&quot;</span>)) <span class="kw">install.packages</span>(<span class="st">&quot;pacman&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: pacman</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(</span>
<span id="cb32-2"><a href="#cb32-2"></a>  tidyverse, <span class="co"># for the tidyverse framework</span></span>
<span id="cb32-3"><a href="#cb32-3"></a>  here, <span class="co"># for computational reproducibility</span></span>
<span id="cb32-4"><a href="#cb32-4"></a>  gapminder, <span class="co"># toy data</span></span>
<span id="cb32-5"><a href="#cb32-5"></a>  nycflights13 <span class="co"># for exercise </span></span>
<span id="cb32-6"><a href="#cb32-6"></a>  )</span></code></pre></div>
<p>The rest of the chapter follows the basic structure in <a href="https://rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">the Data Wrangling Cheat Sheet</a> created by RStudio.</p>
</div>
<div id="tidyverse" class="section level2" number="4.2">
<h2 number="4.2"><span class="header-section-number">4.2</span> Tidyverse</h2>
<ul>
<li><p><a href="https://design.tidyverse.org/unifying-principles.html">Tidyverse design guide</a></p>
<ul>
<li><p>Human centered</p></li>
<li><p>Consistent</p></li>
<li><p>Composable (modualized)</p></li>
<li><p>Inclusive</p></li>
<li><p>Influenced by the <a href="https://homepage.cs.uri.edu/~thenry/resources/unix_art/ch01s06.html">Basics of the Unix Philosophy</a>, <a href="https://www.python.org/dev/peps/pep-0020/">The Zen of Python</a>, and the <a href="https://refs.devinmcgloin.com/smalltalk/Design-Principles-Behind-Smalltalk.pdf">Design Principles Behind Smalltalk</a></p></li>
</ul></li>
</ul>
</div>
<div id="tidy-data" class="section level2" number="4.3">
<h2 number="4.3"><span class="header-section-number">4.3</span> Tidy data</h2>
<blockquote>
<p>“Tidy data sets are easy to manipulate, model and visualize, and have a specific structure: each variable is a column, each observation is a row, and each type of observational unit is a table.” - Hadley Wickham</p>
</blockquote>
<ol style="list-style-type: decimal">
<li>Variables -&gt; <strong>Columns</strong></li>
<li>Observations -&gt; <strong>Rows</strong></li>
<li>Values -&gt; <strong>Cells</strong></li>
</ol>
<div class="figure">
<img src="https://garrettgman.github.io/images/tidy-1.png" alt="" />
<p class="caption">Tidy Data Example (Source: R for Data Science)</p>
</div>
<p>If dataframes are tidy, it’s easy to transform, visualize, model, and program them using tidyverse packages (a whole workflow).</p>
<div class="figure">
<img src="https://miro.medium.com/max/960/0*mlPyX0NE0WQwEzpS.png" alt="" />
<p class="caption">Tidyverse: an opinionated collection of R packages</p>
</div>
<ul>
<li>Nevertheless, don’t be <strong>religious</strong>.</li>
</ul>
<blockquote>
<p>In summary, tidy data is a useful conceptual idea and is often the right way to go for general, small data sets, but may not be appropriate for all problems. - Jeff Leek</p>
</blockquote>
<p>For instance, in many data science applications, linear algebra-based computations are essential (e.g., <a href="https://www.math.upenn.edu/~kazdan/312S13/JJ/PCA-JJ.pdf">Principal Component Analysis</a>). These computations are optimized to work on matrices, not tidy data frames (for more information, read <a href="https://simplystatistics.org/2016/02/17/non-tidy-data/">Jeff Leek’s blog post</a>).</p>
<p>This is what a tidy data looks like.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a>table1</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   country      year  cases population
##   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
## 1 Afghanistan  1999    745   19987071
## 2 Afghanistan  2000   2666   20595360
## 3 Brazil       1999  37737  172006362
## 4 Brazil       2000  80488  174504898
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583</code></pre>
</div>
<div id="reshaping" class="section level2" number="4.4">
<h2 number="4.4"><span class="header-section-number">4.4</span> Reshaping</h2>
<p>Let’s take a look at the cases of untidy data.</p>
<div class="figure">
<img src="https://garrettgman.github.io/images/tidy-5.png" alt="" />
<p class="caption">Messy Data Case 1 (Source: R for Data Science)</p>
</div>
<ul>
<li>Make It Longer</li>
</ul>
<p><strong>Challenge</strong>: Why this data is not tidy?</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>table4a</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   country     `1999` `2000`
## * &lt;chr&gt;        &lt;int&gt;  &lt;int&gt;
## 1 Afghanistan    745   2666
## 2 Brazil       37737  80488
## 3 China       212258 213766</code></pre>
<ul>
<li><p>Let’s pivot (rotate by 90 degree).</p></li>
<li><p><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html"><code>pivot_longer()</code></a> increases the number of rows (longer) and decreases the number of columns. The inverse function is <code>pivot_wider()</code>. These functions improve the usability of <code>gather()</code> and <code>spread()</code>.</p></li>
</ul>
<div class="figure">
<img src="https://www.storybench.org/wp-content/uploads/2019/08/pivot-longer-image.png" alt="" />
<p class="caption">What pivot_longer() does (Source: <a href="https://www.storybench.org" class="uri">https://www.storybench.org</a>)</p>
</div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># Old way, less intuitive</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>table4a <span class="op">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">&quot;cases&quot;</span>, <span class="co"># Current column names</span></span>
<span id="cb37-4"><a href="#cb37-4"></a>         <span class="dt">value =</span> <span class="st">&quot;year&quot;</span>, <span class="co"># The values matched to cases</span></span>
<span id="cb37-5"><a href="#cb37-5"></a>         <span class="kw">c</span>(<span class="st">&quot;1999&quot;</span>, <span class="st">&quot;2000&quot;</span>)) <span class="co"># Selected columns</span></span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   country     cases   year
##   &lt;chr&gt;       &lt;chr&gt;  &lt;int&gt;
## 1 Afghanistan 1999     745
## 2 Brazil      1999   37737
## 3 China       1999  212258
## 4 Afghanistan 2000    2666
## 5 Brazil      2000   80488
## 6 China       2000  213766</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># New way, more intuitive</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>table4a <span class="op">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="st">  </span><span class="kw">pivot_longer</span>(</span>
<span id="cb39-4"><a href="#cb39-4"></a>    <span class="dt">cols =</span> <span class="kw">c</span>(<span class="st">&quot;1999&quot;</span>, <span class="st">&quot;2000&quot;</span>), <span class="co"># Selected columns</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>    <span class="dt">names_to =</span> <span class="st">&quot;year&quot;</span>, <span class="co"># Shorter columns (the columns going to be in one column called year)</span></span>
<span id="cb39-6"><a href="#cb39-6"></a>    <span class="dt">values_to =</span> <span class="st">&quot;cases&quot;</span>) <span class="co"># Longer rows (the values are going to be in a separate column called named cases)</span></span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   country     year   cases
##   &lt;chr&gt;       &lt;chr&gt;  &lt;int&gt;
## 1 Afghanistan 1999     745
## 2 Afghanistan 2000    2666
## 3 Brazil      1999   37737
## 4 Brazil      2000   80488
## 5 China       1999  212258
## 6 China       2000  213766</code></pre>
<ul>
<li><p>There’s another problem, did you catch it?</p></li>
<li><p>The data type of <code>year</code> variable should be <code>numeric</code> not <code>character</code>. By default, <code>pivot_longer()</code> transforms uninformative columns to character.</p></li>
<li><p>You can fix this problem by using <code>names_transform</code> argument.</p></li>
</ul>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>table4a <span class="op">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="st">  </span><span class="kw">pivot_longer</span>(</span>
<span id="cb41-3"><a href="#cb41-3"></a>    <span class="dt">cols =</span> <span class="kw">c</span>(<span class="st">&quot;1999&quot;</span>, <span class="st">&quot;2000&quot;</span>), <span class="co"># Put two columns together</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>    <span class="dt">names_to =</span> <span class="st">&quot;year&quot;</span>, <span class="co"># Shorter columns (the columns going to be in one column called year)</span></span>
<span id="cb41-5"><a href="#cb41-5"></a>    <span class="dt">values_to =</span> <span class="st">&quot;cases&quot;</span>, <span class="co"># Longer rows (the values are going to be in a separate column called named cases)</span></span>
<span id="cb41-6"><a href="#cb41-6"></a>    <span class="dt">names_transform =</span> <span class="kw">list</span>(<span class="dt">year =</span> readr<span class="op">::</span>parse_number)</span>
<span id="cb41-7"><a href="#cb41-7"></a>    ) <span class="co"># Transform the variable  </span></span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   country      year  cases
##   &lt;chr&gt;       &lt;dbl&gt;  &lt;int&gt;
## 1 Afghanistan  1999    745
## 2 Afghanistan  2000   2666
## 3 Brazil       1999  37737
## 4 Brazil       2000  80488
## 5 China        1999 212258
## 6 China        2000 213766</code></pre>
<p><strong>Additional tips</strong></p>
<p><code>parse_number()</code> also keeps only numeric information in a variable.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw">parse_number</span>(<span class="st">&quot;reply1994&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 1994</code></pre>
<p>A flat file (e.g., CSV) is a rectangular shaped combination of strings. <a href="https://cran.r-project.org/web/packages/readr/vignettes/readr.html">Parsing</a> determines the type of each column and turns into a vector of a more specific type. Tidyverse has <code>parse_</code> functions (from <code>readr</code> package) that are flexible and fast (e.g., <code>parse_integer()</code>, <code>parse_double()</code>, <code>parse_logical()</code>, <code>parse_datetime()</code>, <code>parse_date()</code>, <code>parse_time()</code>, <code>parse_factor()</code>, etc).</p>
<ul>
<li>Let’s do another practice.</li>
</ul>
<p><strong>Challenge</strong></p>
<ol style="list-style-type: decimal">
<li>Why this data is not tidy? (This exercise comes from <a href="https://tidyr.tidyverse.org/articles/pivot.html"><code>pivot</code> function vigenette</a>.) Too long or too wide?</li>
</ol>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>billboard</span></code></pre></div>
<pre><code>## # A tibble: 317 x 79
##    artist track date.entered   wk1   wk2   wk3   wk4   wk5   wk6   wk7   wk8
##    &lt;chr&gt;  &lt;chr&gt; &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 2 Pac  Baby… 2000-02-26      87    82    72    77    87    94    99    NA
##  2 2Ge+h… The … 2000-09-02      91    87    92    NA    NA    NA    NA    NA
##  3 3 Doo… Kryp… 2000-04-08      81    70    68    67    66    57    54    53
##  4 3 Doo… Loser 2000-10-21      76    76    72    69    67    65    55    59
##  5 504 B… Wobb… 2000-04-15      57    34    25    17    17    31    36    49
##  6 98^0   Give… 2000-08-19      51    39    34    26    26    19     2     2
##  7 A*Tee… Danc… 2000-07-08      97    97    96    95   100    NA    NA    NA
##  8 Aaliy… I Do… 2000-01-29      84    62    51    41    38    35    35    38
##  9 Aaliy… Try … 2000-03-18      59    53    38    28    21    18    16    14
## 10 Adams… Open… 2000-08-26      76    76    74    69    68    67    61    58
## # … with 307 more rows, and 68 more variables: wk9 &lt;dbl&gt;, wk10 &lt;dbl&gt;,
## #   wk11 &lt;dbl&gt;, wk12 &lt;dbl&gt;, wk13 &lt;dbl&gt;, wk14 &lt;dbl&gt;, wk15 &lt;dbl&gt;, wk16 &lt;dbl&gt;,
## #   wk17 &lt;dbl&gt;, wk18 &lt;dbl&gt;, wk19 &lt;dbl&gt;, wk20 &lt;dbl&gt;, wk21 &lt;dbl&gt;, wk22 &lt;dbl&gt;,
## #   wk23 &lt;dbl&gt;, wk24 &lt;dbl&gt;, wk25 &lt;dbl&gt;, wk26 &lt;dbl&gt;, wk27 &lt;dbl&gt;, wk28 &lt;dbl&gt;,
## #   wk29 &lt;dbl&gt;, wk30 &lt;dbl&gt;, wk31 &lt;dbl&gt;, wk32 &lt;dbl&gt;, wk33 &lt;dbl&gt;, wk34 &lt;dbl&gt;,
## #   wk35 &lt;dbl&gt;, wk36 &lt;dbl&gt;, wk37 &lt;dbl&gt;, wk38 &lt;dbl&gt;, wk39 &lt;dbl&gt;, wk40 &lt;dbl&gt;,
## #   wk41 &lt;dbl&gt;, wk42 &lt;dbl&gt;, wk43 &lt;dbl&gt;, wk44 &lt;dbl&gt;, wk45 &lt;dbl&gt;, wk46 &lt;dbl&gt;,
## #   wk47 &lt;dbl&gt;, wk48 &lt;dbl&gt;, wk49 &lt;dbl&gt;, wk50 &lt;dbl&gt;, wk51 &lt;dbl&gt;, wk52 &lt;dbl&gt;,
## #   wk53 &lt;dbl&gt;, wk54 &lt;dbl&gt;, wk55 &lt;dbl&gt;, wk56 &lt;dbl&gt;, wk57 &lt;dbl&gt;, wk58 &lt;dbl&gt;,
## #   wk59 &lt;dbl&gt;, wk60 &lt;dbl&gt;, wk61 &lt;dbl&gt;, wk62 &lt;dbl&gt;, wk63 &lt;dbl&gt;, wk64 &lt;dbl&gt;,
## #   wk65 &lt;dbl&gt;, wk66 &lt;lgl&gt;, wk67 &lt;lgl&gt;, wk68 &lt;lgl&gt;, wk69 &lt;lgl&gt;, wk70 &lt;lgl&gt;,
## #   wk71 &lt;lgl&gt;, wk72 &lt;lgl&gt;, wk73 &lt;lgl&gt;, wk74 &lt;lgl&gt;, wk75 &lt;lgl&gt;, wk76 &lt;lgl&gt;</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>How can you fix it? Which pivot?</li>
</ol>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># Old way</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>billboard <span class="op">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">&quot;week&quot;</span>,</span>
<span id="cb47-4"><a href="#cb47-4"></a>         <span class="dt">value =</span> <span class="st">&quot;rank&quot;</span>,</span>
<span id="cb47-5"><a href="#cb47-5"></a>         <span class="kw">starts_with</span>(<span class="st">&quot;wk&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Use regular expressions</span></span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="st">  </span><span class="kw">drop_na</span>() <span class="co"># Drop NAs</span></span></code></pre></div>
<pre><code>## # A tibble: 5,307 x 5
##    artist         track                   date.entered week   rank
##    &lt;chr&gt;          &lt;chr&gt;                   &lt;date&gt;       &lt;chr&gt; &lt;dbl&gt;
##  1 2 Pac          Baby Don&#39;t Cry (Keep... 2000-02-26   wk1      87
##  2 2Ge+her        The Hardest Part Of ... 2000-09-02   wk1      91
##  3 3 Doors Down   Kryptonite              2000-04-08   wk1      81
##  4 3 Doors Down   Loser                   2000-10-21   wk1      76
##  5 504 Boyz       Wobble Wobble           2000-04-15   wk1      57
##  6 98^0           Give Me Just One Nig... 2000-08-19   wk1      51
##  7 A*Teens        Dancing Queen           2000-07-08   wk1      97
##  8 Aaliyah        I Don&#39;t Wanna           2000-01-29   wk1      84
##  9 Aaliyah        Try Again               2000-03-18   wk1      59
## 10 Adams, Yolanda Open My Heart           2000-08-26   wk1      76
## # … with 5,297 more rows</code></pre>
<ul>
<li>Note that <code>pivot_longer()</code> is more versatile than <code>gather()</code>.</li>
</ul>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># New way</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>billboard <span class="op">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="st">  </span><span class="kw">pivot_longer</span>(</span>
<span id="cb49-4"><a href="#cb49-4"></a>    <span class="dt">cols =</span> <span class="kw">starts_with</span>(<span class="st">&quot;wk&quot;</span>), <span class="co"># Use regular expressions</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>    <span class="dt">names_to =</span> <span class="st">&quot;week&quot;</span>,</span>
<span id="cb49-6"><a href="#cb49-6"></a>    <span class="dt">values_to =</span> <span class="st">&quot;rank&quot;</span>,</span>
<span id="cb49-7"><a href="#cb49-7"></a>    <span class="dt">values_drop_na =</span> <span class="ot">TRUE</span> <span class="co"># Drop NAs</span></span>
<span id="cb49-8"><a href="#cb49-8"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 5,307 x 5
##    artist  track                   date.entered week   rank
##    &lt;chr&gt;   &lt;chr&gt;                   &lt;date&gt;       &lt;chr&gt; &lt;dbl&gt;
##  1 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk1      87
##  2 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk2      82
##  3 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk3      72
##  4 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk4      77
##  5 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk5      87
##  6 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk6      94
##  7 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk7      99
##  8 2Ge+her The Hardest Part Of ... 2000-09-02   wk1      91
##  9 2Ge+her The Hardest Part Of ... 2000-09-02   wk2      87
## 10 2Ge+her The Hardest Part Of ... 2000-09-02   wk3      92
## # … with 5,297 more rows</code></pre>
<ul>
<li><p>Make It Wider</p></li>
<li><p>Why this data is not tidy?</p></li>
</ul>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>table2</span></code></pre></div>
<pre><code>## # A tibble: 12 x 4
##    country      year type            count
##    &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;           &lt;int&gt;
##  1 Afghanistan  1999 cases             745
##  2 Afghanistan  1999 population   19987071
##  3 Afghanistan  2000 cases            2666
##  4 Afghanistan  2000 population   20595360
##  5 Brazil       1999 cases           37737
##  6 Brazil       1999 population  172006362
##  7 Brazil       2000 cases           80488
##  8 Brazil       2000 population  174504898
##  9 China        1999 cases          212258
## 10 China        1999 population 1272915272
## 11 China        2000 cases          213766
## 12 China        2000 population 1280428583</code></pre>
<ul>
<li><p>Each observation is spread across two rows.</p></li>
<li><p>How can you fix it?: <code>pivot_wider()</code>.</p></li>
</ul>
<p><strong>Two differences between <code>pivot_longer()</code> and <code>pivot_wider()</code></strong></p>
<ul>
<li><p>In <code>pivot_longer()</code>, the arguments are named <code>names_to</code> and <code>values_to</code> (<em>to</em>).</p></li>
<li><p>In <code>pivot_wider()</code>, this pattern is opposite. The arguments are named <code>names_from</code> and <code>values_from</code> (<em>from</em>).</p></li>
<li><p>The number of required arguments for <code>pivot_longer()</code> is 3 (col, names_to, values_to).</p></li>
<li><p>The number of required arguments for <code>pivot_wider()</code> is 2 (names_from, values_from).</p></li>
</ul>
<div class="figure">
<img src="https://www.storybench.org/wp-content/uploads/2019/08/pivot-wider-image.png" alt="" />
<p class="caption">What pivot_wider() does (Source: <a href="https://www.storybench.org" class="uri">https://www.storybench.org</a>)</p>
</div>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="co"># Old way</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>table2 <span class="op">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> type,</span>
<span id="cb53-4"><a href="#cb53-4"></a>         <span class="dt">value =</span> count)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   country      year  cases population
##   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
## 1 Afghanistan  1999    745   19987071
## 2 Afghanistan  2000   2666   20595360
## 3 Brazil       1999  37737  172006362
## 4 Brazil       2000  80488  174504898
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="co"># New way</span></span>
<span id="cb55-2"><a href="#cb55-2"></a>table2 <span class="op">%&gt;%</span></span>
<span id="cb55-3"><a href="#cb55-3"></a><span class="st">  </span><span class="kw">pivot_wider</span>(</span>
<span id="cb55-4"><a href="#cb55-4"></a>    <span class="dt">names_from =</span> type, <span class="co"># first</span></span>
<span id="cb55-5"><a href="#cb55-5"></a>    <span class="dt">values_from =</span> count <span class="co"># second</span></span>
<span id="cb55-6"><a href="#cb55-6"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   country      year  cases population
##   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
## 1 Afghanistan  1999    745   19987071
## 2 Afghanistan  2000   2666   20595360
## 3 Brazil       1999  37737  172006362
## 4 Brazil       2000  80488  174504898
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583</code></pre>
<p>Sometimes, a consultee came to me and asked: “I don’t have missing values in my original dataframe. Then R said that I have missing values after I’ve done some data transformations. What happened?”</p>
<p>Here’s an answer.</p>
<p>R defines missing values in two ways.</p>
<ul>
<li><p><em>Implicit missing values</em>: simply not present in the data.</p></li>
<li><p><em>Explicit missing values</em>: flagged with NA</p></li>
</ul>
<p><strong>Challenge</strong></p>
<p>The example comes from <a href="https://r4ds.had.co.nz/tidy-data.html"><em>R for Data Science</em></a>.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>stocks &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb57-2"><a href="#cb57-2"></a>  <span class="dt">year =</span> <span class="kw">c</span>(<span class="dv">2019</span>, <span class="dv">2019</span>, <span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2020</span>, <span class="dv">2020</span>),</span>
<span id="cb57-3"><a href="#cb57-3"></a>  <span class="dt">qtr =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), </span>
<span id="cb57-4"><a href="#cb57-4"></a>  <span class="dt">return =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="ot">NA</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb57-5"><a href="#cb57-5"></a>)</span>
<span id="cb57-6"><a href="#cb57-6"></a></span>
<span id="cb57-7"><a href="#cb57-7"></a>stocks</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##    year   qtr return
##   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1  2019     1      1
## 2  2019     2      2
## 3  2019     3      3
## 4  2020     2     NA
## 5  2020     3      2
## 6  2020     4      3</code></pre>
<ul>
<li><p>Where is explicit missing value?</p></li>
<li><p>Does <code>stocks</code> have implicit missing values?</p></li>
</ul>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="co"># implicit missing values become explicit </span></span>
<span id="cb59-2"><a href="#cb59-2"></a>stocks <span class="op">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3"></a><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> year, </span>
<span id="cb59-4"><a href="#cb59-4"></a>              <span class="dt">values_from =</span> return)</span></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     qtr `2019` `2020`
##   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1     1      1     NA
## 2     2      2     NA
## 3     3      3      2
## 4     4     NA      3</code></pre>
<p><strong>Challenge</strong></p>
<ul>
<li><p>This exercise comes from <a href="https://tidyr.tidyverse.org/articles/pivot.html"><code>pivot</code> function vigenette</a>.</p></li>
<li><p>Could you make <code>station</code> a series of dummy variables using <code>pivot_wider()</code>?</p></li>
</ul>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>fish_encounters </span></code></pre></div>
<pre><code>## # A tibble: 114 x 3
##    fish  station  seen
##    &lt;fct&gt; &lt;fct&gt;   &lt;int&gt;
##  1 4842  Release     1
##  2 4842  I80_1       1
##  3 4842  Lisbon      1
##  4 4842  Rstr        1
##  5 4842  Base_TD     1
##  6 4842  BCE         1
##  7 4842  BCW         1
##  8 4842  BCE2        1
##  9 4842  BCW2        1
## 10 4842  MAE         1
## # … with 104 more rows</code></pre>
<ol style="list-style-type: decimal">
<li><p>Which pivot you should use?</p></li>
<li><p>Are there explicit missing values?</p></li>
<li><p>How could you turn these NAs into 0s? Check <code>values_fill</code> argument in the <code>pivot_wider()</code> function.</p></li>
</ol>
<ul>
<li>Separate</li>
</ul>
<div class="figure">
<img src="https://garrettgman.github.io/images/tidy-6.png" alt="" />
<p class="caption">Messy Data Case 2 (Source: R for Data Science)</p>
</div>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a><span class="co"># Toy example</span></span>
<span id="cb63-2"><a href="#cb63-2"></a>df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&quot;Dad.apple&quot;</span>, <span class="st">&quot;Mom.orange&quot;</span>, <span class="st">&quot;Daughter.banana&quot;</span>))</span>
<span id="cb63-3"><a href="#cb63-3"></a></span>
<span id="cb63-4"><a href="#cb63-4"></a>df</span></code></pre></div>
<pre><code>##                 x
## 1            &lt;NA&gt;
## 2       Dad.apple
## 3      Mom.orange
## 4 Daughter.banana</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a><span class="co"># Separate</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>df <span class="op">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3"></a><span class="st">  </span><span class="kw">separate</span>(x, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;Name&quot;</span>, <span class="st">&quot;Preferred_fruit&quot;</span>))</span></code></pre></div>
<pre><code>##       Name Preferred_fruit
## 1     &lt;NA&gt;            &lt;NA&gt;
## 2      Dad           apple
## 3      Mom          orange
## 4 Daughter          banana</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="co"># Don&#39;t need the first variable</span></span>
<span id="cb67-2"><a href="#cb67-2"></a></span>
<span id="cb67-3"><a href="#cb67-3"></a>df <span class="op">%&gt;%</span></span>
<span id="cb67-4"><a href="#cb67-4"></a><span class="st">  </span><span class="kw">separate</span>(x, <span class="dt">into =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&quot;Preferred_fruit&quot;</span>))</span></code></pre></div>
<pre><code>##   Preferred_fruit
## 1            &lt;NA&gt;
## 2           apple
## 3          orange
## 4          banana</code></pre>
<p><strong>Practice</strong></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>table3</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   country      year rate             
## * &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;            
## 1 Afghanistan  1999 745/19987071     
## 2 Afghanistan  2000 2666/20595360    
## 3 Brazil       1999 37737/172006362  
## 4 Brazil       2000 80488/174504898  
## 5 China        1999 212258/1272915272
## 6 China        2000 213766/1280428583</code></pre>
<ul>
<li>Note <code>sep</code> argument. You can specify how to separate joined values.</li>
</ul>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a>table3 <span class="op">%&gt;%</span></span>
<span id="cb71-2"><a href="#cb71-2"></a><span class="st">  </span><span class="kw">separate</span>(rate,</span>
<span id="cb71-3"><a href="#cb71-3"></a>           <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;cases&quot;</span>, <span class="st">&quot;population&quot;</span>),</span>
<span id="cb71-4"><a href="#cb71-4"></a>           <span class="dt">sep =</span> <span class="st">&quot;/&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   country      year cases  population
##   &lt;chr&gt;       &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;     
## 1 Afghanistan  1999 745    19987071  
## 2 Afghanistan  2000 2666   20595360  
## 3 Brazil       1999 37737  172006362 
## 4 Brazil       2000 80488  174504898 
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583</code></pre>
<ul>
<li>Note <code>convert</code> argument. You can specify whether automatically convert the new values or not.</li>
</ul>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a>table3 <span class="op">%&gt;%</span></span>
<span id="cb73-2"><a href="#cb73-2"></a><span class="st">  </span><span class="kw">separate</span>(rate,</span>
<span id="cb73-3"><a href="#cb73-3"></a>           <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;cases&quot;</span>, <span class="st">&quot;population&quot;</span>),</span>
<span id="cb73-4"><a href="#cb73-4"></a>           <span class="dt">sep =</span> <span class="st">&quot;/&quot;</span>,</span>
<span id="cb73-5"><a href="#cb73-5"></a>           <span class="dt">convert =</span> <span class="ot">TRUE</span>) <span class="co"># cases and population become integers</span></span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   country      year  cases population
##   &lt;chr&gt;       &lt;int&gt;  &lt;int&gt;      &lt;int&gt;
## 1 Afghanistan  1999    745   19987071
## 2 Afghanistan  2000   2666   20595360
## 3 Brazil       1999  37737  172006362
## 4 Brazil       2000  80488  174504898
## 5 China        1999 212258 1272915272
## 6 China        2000 213766 1280428583</code></pre>
<ul>
<li>Unite</li>
</ul>
<p><code>pivot_longer()</code> &lt;-&gt; <code>pivot_wider()</code></p>
<p><code>separate()</code> &lt;-&gt; <code>unite()</code></p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a><span class="co"># Create a toy example</span></span>
<span id="cb75-2"><a href="#cb75-2"></a>df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb75-3"><a href="#cb75-3"></a>  <span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;Jae&quot;</span>, <span class="st">&quot;Sun&quot;</span>, <span class="st">&quot;Jane&quot;</span>, <span class="ot">NA</span>),</span>
<span id="cb75-4"><a href="#cb75-4"></a>  <span class="dt">birthmonth =</span> <span class="kw">c</span>(<span class="st">&quot;April&quot;</span>, <span class="st">&quot;April&quot;</span>, <span class="st">&quot;June&quot;</span>, <span class="ot">NA</span>))</span>
<span id="cb75-5"><a href="#cb75-5"></a></span>
<span id="cb75-6"><a href="#cb75-6"></a><span class="co"># Include missing values</span></span>
<span id="cb75-7"><a href="#cb75-7"></a>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="st">&quot;contact&quot;</span>,</span>
<span id="cb75-8"><a href="#cb75-8"></a>             <span class="kw">c</span>(<span class="st">&quot;name&quot;</span>, <span class="st">&quot;birthmonth&quot;</span>))</span></code></pre></div>
<pre><code>##     contact
## 1 Jae_April
## 2 Sun_April
## 3 Jane_June
## 4     NA_NA</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a><span class="co"># Do not include missing values</span></span>
<span id="cb77-2"><a href="#cb77-2"></a>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="st">&quot;contact&quot;</span>,</span>
<span id="cb77-3"><a href="#cb77-3"></a>             <span class="kw">c</span>(<span class="st">&quot;name&quot;</span>, <span class="st">&quot;birthmonth&quot;</span>),</span>
<span id="cb77-4"><a href="#cb77-4"></a>             <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>##     contact
## 1 Jae_April
## 2 Sun_April
## 3 Jane_June
## 4</code></pre>
</div>
<div id="rearranging" class="section level2" number="4.5">
<h2 number="4.5"><span class="header-section-number">4.5</span> Rearranging</h2>
<ul>
<li><p>Arrange</p></li>
<li><p>Order rows</p></li>
</ul>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a>dplyr<span class="op">::</span><span class="kw">arrange</span>(mtcars, mpg) <span class="co"># Low to High (default)</span></span></code></pre></div>
<pre><code>##                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
## Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
## Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## Merc 280C           17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## Valiant             18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## Merc 280            19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## Ferrari Dino        19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
## Mazda RX4           21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## Volvo 142E          21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
## Toyota Corona       21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## Datsun 710          22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## Merc 230            22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## Merc 240D           24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## Porsche 914-2       26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## Fiat X1-9           27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## Honda Civic         30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## Lotus Europa        30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## Fiat 128            32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## Toyota Corolla      33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a>dplyr<span class="op">::</span><span class="kw">arrange</span>(mtcars, <span class="kw">desc</span>(mpg)) <span class="co"># High to Row</span></span></code></pre></div>
<pre><code>##                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Toyota Corolla      33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## Fiat 128            32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## Honda Civic         30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## Lotus Europa        30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## Fiat X1-9           27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## Porsche 914-2       26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## Merc 240D           24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## Datsun 710          22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## Merc 230            22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## Toyota Corona       21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## Volvo 142E          21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
## Mazda RX4           21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## Ferrari Dino        19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
## Merc 280            19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## Valiant             18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## Merc 280C           17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
## Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4</code></pre>
<ul>
<li><p>Rename</p></li>
<li><p>Rename columns</p></li>
</ul>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">2011</span>, <span class="dv">2012</span>, <span class="dv">2013</span>))</span>
<span id="cb83-2"><a href="#cb83-2"></a></span>
<span id="cb83-3"><a href="#cb83-3"></a>df</span></code></pre></div>
<pre><code>## # A tibble: 3 x 1
##       y
##   &lt;dbl&gt;
## 1  2011
## 2  2012
## 3  2013</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">Year =</span> <span class="co"># OLD name</span></span>
<span id="cb85-2"><a href="#cb85-2"></a>                y) <span class="co"># NEW name</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 1
##    Year
##   &lt;dbl&gt;
## 1  2011
## 2  2012
## 3  2013</code></pre>
</div>
<div id="subset-observations-rows" class="section level2" number="4.6">
<h2 number="4.6"><span class="header-section-number">4.6</span> Subset observations (rows)</h2>
<ul>
<li><p>Choose row by logical condition</p></li>
<li><p>Single condition</p></li>
</ul>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb87-2"><a href="#cb87-2"></a><span class="st">  </span><span class="kw">filter</span>(gender <span class="op">==</span><span class="st"> &quot;female&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb87-3"><a href="#cb87-3"></a><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(height))</span></code></pre></div>
<pre><code>## # A tibble: 0 x 14
## # … with 14 variables: name &lt;chr&gt;, height &lt;int&gt;, mass &lt;dbl&gt;, hair_color &lt;chr&gt;,
## #   skin_color &lt;chr&gt;, eye_color &lt;chr&gt;, birth_year &lt;dbl&gt;, sex &lt;chr&gt;,
## #   gender &lt;chr&gt;, homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p>The following filtering example was inspired by <a href="https://suzan.rbind.io/2018/02/dplyr-tutorial-3/">the suzanbert’s dplyr blog post</a>.</p>
<ul>
<li>Multiple conditions (numeric)</li>
</ul>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="co"># First example</span></span>
<span id="cb89-2"><a href="#cb89-2"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb89-3"><a href="#cb89-3"></a><span class="st">  </span><span class="kw">filter</span>(height <span class="op">&lt;</span><span class="st"> </span><span class="dv">180</span>, height <span class="op">&gt;</span><span class="st"> </span><span class="dv">160</span>) <span class="op">%&gt;%</span></span>
<span id="cb89-4"><a href="#cb89-4"></a><span class="st">  </span><span class="kw">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 24</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a><span class="co"># Same as above</span></span>
<span id="cb91-2"><a href="#cb91-2"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb91-3"><a href="#cb91-3"></a><span class="st">  </span><span class="kw">filter</span>(height <span class="op">&lt;</span><span class="st"> </span><span class="dv">180</span> <span class="op">&amp;</span><span class="st"> </span>height <span class="op">&gt;</span><span class="st"> </span><span class="dv">160</span>) <span class="op">%&gt;%</span></span>
<span id="cb91-4"><a href="#cb91-4"></a><span class="st">  </span><span class="kw">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 24</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a><span class="co"># Not same as above</span></span>
<span id="cb93-2"><a href="#cb93-2"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb93-3"><a href="#cb93-3"></a><span class="st">  </span><span class="kw">filter</span>(height <span class="op">&lt;</span><span class="st"> </span><span class="dv">180</span> <span class="op">|</span><span class="st"> </span>height <span class="op">&gt;</span><span class="st"> </span><span class="dv">160</span>) <span class="op">%&gt;%</span></span>
<span id="cb93-4"><a href="#cb93-4"></a><span class="st">  </span><span class="kw">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 81</code></pre>
<p><strong>Challenge</strong></p>
<ol style="list-style-type: decimal">
<li>Use <code>filter(between())</code> to find characters whose heights are between 180 and 160 and (2) count the number of these observations.</li>
</ol>
<ul>
<li>Minimum reproducible example</li>
</ul>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a>df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb95-2"><a href="#cb95-2"></a>  <span class="dt">heights =</span> <span class="kw">c</span>(<span class="dv">160</span><span class="op">:</span><span class="dv">180</span>),</span>
<span id="cb95-3"><a href="#cb95-3"></a>  <span class="dt">char =</span> <span class="kw">rep</span>(<span class="st">&quot;none&quot;</span>, <span class="kw">length</span>(<span class="kw">c</span>(<span class="dv">160</span><span class="op">:</span><span class="dv">180</span>)))</span>
<span id="cb95-4"><a href="#cb95-4"></a>)</span>
<span id="cb95-5"><a href="#cb95-5"></a></span>
<span id="cb95-6"><a href="#cb95-6"></a>df <span class="op">%&gt;%</span></span>
<span id="cb95-7"><a href="#cb95-7"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">between</span>(heights, <span class="dv">161</span>, <span class="dv">179</span>))</span></code></pre></div>
<pre><code>## # A tibble: 19 x 2
##    heights char 
##      &lt;int&gt; &lt;chr&gt;
##  1     161 none 
##  2     162 none 
##  3     163 none 
##  4     164 none 
##  5     165 none 
##  6     166 none 
##  7     167 none 
##  8     168 none 
##  9     169 none 
## 10     170 none 
## 11     171 none 
## 12     172 none 
## 13     173 none 
## 14     174 none 
## 15     175 none 
## 16     176 none 
## 17     177 none 
## 18     178 none 
## 19     179 none</code></pre>
<ul>
<li>Multiple conditions (character)</li>
</ul>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="co"># Filter names include ars; `grepl` is a base R function  </span></span>
<span id="cb97-2"><a href="#cb97-2"></a></span>
<span id="cb97-3"><a href="#cb97-3"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb97-4"><a href="#cb97-4"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;ars&quot;</span>, <span class="kw">tolower</span>(name)))</span></code></pre></div>
<pre><code>## # A tibble: 4 x 14
##   name  height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Owen…    178   120 brown, gr… light      blue              52 male  mascu…
## 2 Beru…    165    75 brown      light      blue              47 fema… femin…
## 3 Quar…    183    NA black      dark       brown             62 &lt;NA&gt;  &lt;NA&gt;  
## 4 Clie…    183    NA brown      fair       blue              82 male  mascu…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a><span class="co"># Or, if you prefer dplyr way </span></span>
<span id="cb99-2"><a href="#cb99-2"></a></span>
<span id="cb99-3"><a href="#cb99-3"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb99-4"><a href="#cb99-4"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(<span class="kw">tolower</span>(name), <span class="st">&quot;ars&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 4 x 14
##   name  height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Owen…    178   120 brown, gr… light      blue              52 male  mascu…
## 2 Beru…    165    75 brown      light      blue              47 fema… femin…
## 3 Quar…    183    NA black      dark       brown             62 &lt;NA&gt;  &lt;NA&gt;  
## 4 Clie…    183    NA brown      fair       blue              82 male  mascu…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a><span class="co"># Filter brown and black hair_color</span></span>
<span id="cb101-2"><a href="#cb101-2"></a></span>
<span id="cb101-3"><a href="#cb101-3"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb101-4"><a href="#cb101-4"></a><span class="st">  </span><span class="kw">filter</span>(hair_color <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;brown&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 31 x 14
##    name  height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Leia…    150  49   brown      light      brown           19   fema… femin…
##  2 Beru…    165  75   brown      light      blue            47   fema… femin…
##  3 Bigg…    183  84   black      light      brown           24   male  mascu…
##  4 Chew…    228 112   brown      unknown    blue           200   male  mascu…
##  5 Han …    180  80   brown      fair       brown           29   male  mascu…
##  6 Wedg…    170  77   brown      fair       hazel           21   male  mascu…
##  7 Jek …    180 110   brown      fair       blue            NA   male  mascu…
##  8 Boba…    183  78.2 black      fair       brown           31.5 male  mascu…
##  9 Land…    177  79   black      dark       brown           31   male  mascu…
## 10 Arve…     NA  NA   brown      fair       brown           NA   male  mascu…
## # … with 21 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,
## #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p><strong>Challenge</strong></p>
<p>Use <code>str_detect()</code> to find characters whose names include “Han”.</p>
<ul>
<li>Choose row by position (row index)</li>
</ul>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb103-2"><a href="#cb103-2"></a><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(height)) <span class="op">%&gt;%</span></span>
<span id="cb103-3"><a href="#cb103-3"></a><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 14
##   name  height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Yara…    264    NA none       white      yellow            NA male  mascu…
## 2 Tarf…    234   136 brown      brown      blue              NA male  mascu…
## 3 Lama…    229    88 none       grey       black             NA male  mascu…
## 4 Chew…    228   112 brown      unknown    blue             200 male  mascu…
## 5 Roos…    224    82 none       grey       orange            NA male  mascu…
## 6 Grie…    216   159 none       brown, wh… green, y…         NA male  mascu…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<ul>
<li>Sample by fraction</li>
</ul>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1"></a><span class="co"># For reproducibility </span></span>
<span id="cb105-2"><a href="#cb105-2"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb105-3"><a href="#cb105-3"></a></span>
<span id="cb105-4"><a href="#cb105-4"></a><span class="co"># Old way </span></span>
<span id="cb105-5"><a href="#cb105-5"></a></span>
<span id="cb105-6"><a href="#cb105-6"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb105-7"><a href="#cb105-7"></a><span class="st">  </span><span class="kw">sample_frac</span>(<span class="fl">0.10</span>, </span>
<span id="cb105-8"><a href="#cb105-8"></a>              <span class="dt">replace =</span> <span class="ot">FALSE</span>) <span class="co"># Without replacement </span></span></code></pre></div>
<pre><code>## # A tibble: 9 x 14
##   name  height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Arve…     NA    NA brown      fair       brown           NA   male  mascu…
## 2 Sly …    178    48 none       pale       white           NA   &lt;NA&gt;  &lt;NA&gt;  
## 3 IG-88    200   140 none       metal      red             15   none  mascu…
## 4 Bigg…    183    84 black      light      brown           24   male  mascu…
## 5 Leia…    150    49 brown      light      brown           19   fema… femin…
## 6 Watto    137    NA black      blue, grey yellow          NA   male  mascu…
## 7 Jabb…    175  1358 &lt;NA&gt;       green-tan… orange         600   herm… mascu…
## 8 Dart…    202   136 none       white      yellow          41.9 male  mascu…
## 9 Taun…    213    NA none       grey       black           NA   fema… femin…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a><span class="co"># New way</span></span>
<span id="cb107-2"><a href="#cb107-2"></a></span>
<span id="cb107-3"><a href="#cb107-3"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb107-4"><a href="#cb107-4"></a><span class="st">  </span><span class="kw">slice_sample</span>(<span class="dt">prop =</span> <span class="fl">0.10</span>, </span>
<span id="cb107-5"><a href="#cb107-5"></a>             <span class="dt">replace =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 8 x 14
##   name  height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Raym…    188  79   brown      light      brown           NA   male  mascu…
## 2 Tarf…    234 136   brown      brown      blue            NA   male  mascu…
## 3 Han …    180  80   brown      fair       brown           29   male  mascu…
## 4 Mas …    196  NA   none       blue       blue            NA   male  mascu…
## 5 Barr…    166  50   black      yellow     blue            40   fema… femin…
## 6 Dart…    202 136   none       white      yellow          41.9 male  mascu…
## 7 Finn      NA  NA   black      dark       dark            NA   male  mascu…
## 8 Boba…    183  78.2 black      fair       brown           31.5 male  mascu…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<ul>
<li>Sample by number</li>
</ul>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a><span class="co"># Old way </span></span>
<span id="cb109-2"><a href="#cb109-2"></a></span>
<span id="cb109-3"><a href="#cb109-3"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb109-4"><a href="#cb109-4"></a><span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">20</span>, </span>
<span id="cb109-5"><a href="#cb109-5"></a>           <span class="dt">replace =</span> <span class="ot">FALSE</span>) <span class="co"># Without replacement </span></span></code></pre></div>
<pre><code>## # A tibble: 20 x 14
##    name  height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Quar…    183    NA black      dark       brown             62 &lt;NA&gt;  &lt;NA&gt;  
##  2 Poe …     NA    NA brown      light      brown             NA male  mascu…
##  3 Mas …    196    NA none       blue       blue              NA male  mascu…
##  4 Zam …    168    55 blonde     fair, gre… yellow            NA fema… femin…
##  5 Leia…    150    49 brown      light      brown             19 fema… femin…
##  6 Jang…    183    79 black      tan        brown             66 male  mascu…
##  7 Ben …    163    65 none       grey, gre… orange            NA male  mascu…
##  8 Padm…    165    45 brown      light      brown             46 fema… femin…
##  9 Mace…    188    84 none       dark       brown             72 male  mascu…
## 10 R2-D2     96    32 &lt;NA&gt;       white, bl… red               33 none  mascu…
## 11 Shmi…    163    NA black      fair       brown             72 fema… femin…
## 12 Ratt…     79    15 none       grey, blue unknown           NA male  mascu…
## 13 Nute…    191    90 none       mottled g… red               NA male  mascu…
## 14 Dart…    175    80 none       red        yellow            54 male  mascu…
## 15 Bib …    180    NA none       pale       pink              NA male  mascu…
## 16 C-3PO    167    75 &lt;NA&gt;       gold       yellow           112 none  mascu…
## 17 Yara…    264    NA none       white      yellow            NA male  mascu…
## 18 Ki-A…    198    82 white      pale       yellow            92 male  mascu…
## 19 BB8       NA    NA none       none       black             NA none  mascu…
## 20 Eeth…    171    NA black      brown      brown             NA male  mascu…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1"></a><span class="co"># New way</span></span>
<span id="cb111-2"><a href="#cb111-2"></a></span>
<span id="cb111-3"><a href="#cb111-3"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb111-4"><a href="#cb111-4"></a><span class="st">  </span><span class="kw">slice_sample</span>(<span class="dt">n =</span> <span class="dv">20</span>, </span>
<span id="cb111-5"><a href="#cb111-5"></a>             <span class="dt">replace =</span> <span class="ot">FALSE</span>) <span class="co"># Without replacement </span></span></code></pre></div>
<pre><code>## # A tibble: 20 x 14
##    name  height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Owen…    178   120 brown, gr… light      blue              52 male  mascu…
##  2 Ki-A…    198    82 white      pale       yellow            92 male  mascu…
##  3 Capt…     NA    NA unknown    unknown    unknown           NA &lt;NA&gt;  &lt;NA&gt;  
##  4 Greg…    185    85 black      dark       brown             NA male  mascu…
##  5 R5-D4     97    32 &lt;NA&gt;       white, red red               NA none  mascu…
##  6 Ackb…    180    83 none       brown mot… orange            41 male  mascu…
##  7 Wedg…    170    77 brown      fair       hazel             21 male  mascu…
##  8 Dormé    165    NA brown      light      brown             NA fema… femin…
##  9 Rey       NA    NA brown      light      hazel             NA fema… femin…
## 10 IG-88    200   140 none       metal      red               15 none  mascu…
## 11 Roos…    224    82 none       grey       orange            NA male  mascu…
## 12 Shmi…    163    NA black      fair       brown             72 fema… femin…
## 13 R2-D2     96    32 &lt;NA&gt;       white, bl… red               33 none  mascu…
## 14 Poe …     NA    NA brown      light      brown             NA male  mascu…
## 15 Obi-…    182    77 auburn, w… fair       blue-gray         57 male  mascu…
## 16 Plo …    188    80 none       orange     black             22 male  mascu…
## 17 Tarf…    234   136 brown      brown      blue              NA male  mascu…
## 18 Lobot    175    79 none       light      blue              37 male  mascu…
## 19 San …    191    NA none       grey       gold              NA male  mascu…
## 20 Kit …    196    87 none       green      black             NA male  mascu…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<ul>
<li>Top 10 rows orderd by height</li>
</ul>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1"></a><span class="co"># Old way </span></span>
<span id="cb113-2"><a href="#cb113-2"></a>starwars <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb113-3"><a href="#cb113-3"></a><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, height) </span></code></pre></div>
<pre><code>## # A tibble: 10 x 14
##    name  height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Dart…    202   136 none       white      yellow          41.9 male  mascu…
##  2 Chew…    228   112 brown      unknown    blue           200   male  mascu…
##  3 Roos…    224    82 none       grey       orange          NA   male  mascu…
##  4 Rugo…    206    NA none       green      orange          NA   male  mascu…
##  5 Yara…    264    NA none       white      yellow          NA   male  mascu…
##  6 Lama…    229    88 none       grey       black           NA   male  mascu…
##  7 Taun…    213    NA none       grey       black           NA   fema… femin…
##  8 Grie…    216   159 none       brown, wh… green, y…       NA   male  mascu…
##  9 Tarf…    234   136 brown      brown      blue            NA   male  mascu…
## 10 Tion…    206    80 none       grey       black           NA   male  mascu…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1"></a><span class="co"># New way</span></span>
<span id="cb115-2"><a href="#cb115-2"></a>starwars <span class="op">%&gt;%</span></span>
<span id="cb115-3"><a href="#cb115-3"></a><span class="st">  </span><span class="kw">slice_max</span>(height, <span class="dt">n =</span> <span class="dv">10</span>) <span class="co"># Variable first, Argument second </span></span></code></pre></div>
<pre><code>## # A tibble: 10 x 14
##    name  height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Yara…    264    NA none       white      yellow          NA   male  mascu…
##  2 Tarf…    234   136 brown      brown      blue            NA   male  mascu…
##  3 Lama…    229    88 none       grey       black           NA   male  mascu…
##  4 Chew…    228   112 brown      unknown    blue           200   male  mascu…
##  5 Roos…    224    82 none       grey       orange          NA   male  mascu…
##  6 Grie…    216   159 none       brown, wh… green, y…       NA   male  mascu…
##  7 Taun…    213    NA none       grey       black           NA   fema… femin…
##  8 Rugo…    206    NA none       green      orange          NA   male  mascu…
##  9 Tion…    206    80 none       grey       black           NA   male  mascu…
## 10 Dart…    202   136 none       white      yellow          41.9 male  mascu…
## # … with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
</div>
<div id="subset-variables-columns" class="section level2" number="4.7">
<h2 number="4.7"><span class="header-section-number">4.7</span> Subset variables (columns)</h2>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1"></a><span class="kw">names</span>(msleep)</span></code></pre></div>
<pre><code>##  [1] &quot;name&quot;         &quot;genus&quot;        &quot;vore&quot;         &quot;order&quot;        &quot;conservation&quot;
##  [6] &quot;sleep_total&quot;  &quot;sleep_rem&quot;    &quot;sleep_cycle&quot;  &quot;awake&quot;        &quot;brainwt&quot;     
## [11] &quot;bodywt&quot;</code></pre>
<ul>
<li>Select only numeric columns</li>
</ul>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a><span class="co"># Only numeric </span></span>
<span id="cb119-2"><a href="#cb119-2"></a>msleep <span class="op">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">where</span>(is.numeric))</span></code></pre></div>
<pre><code>## # A tibble: 83 x 6
##    sleep_total sleep_rem sleep_cycle awake  brainwt  bodywt
##          &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
##  1        12.1      NA        NA      11.9 NA        50    
##  2        17         1.8      NA       7    0.0155    0.48 
##  3        14.4       2.4      NA       9.6 NA         1.35 
##  4        14.9       2.3       0.133   9.1  0.00029   0.019
##  5         4         0.7       0.667  20    0.423   600    
##  6        14.4       2.2       0.767   9.6 NA         3.85 
##  7         8.7       1.4       0.383  15.3 NA        20.5  
##  8         7        NA        NA      17   NA         0.045
##  9        10.1       2.9       0.333  13.9  0.07     14    
## 10         3        NA        NA      21    0.0982   14.8  
## # … with 73 more rows</code></pre>
<p><strong>Challenge</strong></p>
<p>Use <code>select(where())</code> to find only non-numeric columns</p>
<ul>
<li>Select the columns that include “sleep” in their names</li>
</ul>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1"></a>msleep <span class="op">%&gt;%</span></span>
<span id="cb121-2"><a href="#cb121-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">contains</span>(<span class="st">&quot;sleep&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 83 x 3
##    sleep_total sleep_rem sleep_cycle
##          &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;
##  1        12.1      NA        NA    
##  2        17         1.8      NA    
##  3        14.4       2.4      NA    
##  4        14.9       2.3       0.133
##  5         4         0.7       0.667
##  6        14.4       2.2       0.767
##  7         8.7       1.4       0.383
##  8         7        NA        NA    
##  9        10.1       2.9       0.333
## 10         3        NA        NA    
## # … with 73 more rows</code></pre>
<ul>
<li><p>Select the columns that include either “sleep” or “wt” in their names</p></li>
<li><p>Basic R way</p></li>
</ul>
<p><code>grepl</code> is one of the R base pattern matching functions.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1"></a>msleep[<span class="kw">grepl</span>(<span class="st">&#39;sleep|wt&#39;</span>, <span class="kw">names</span>(msleep))]</span></code></pre></div>
<pre><code>## # A tibble: 83 x 5
##    sleep_total sleep_rem sleep_cycle  brainwt  bodywt
##          &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
##  1        12.1      NA        NA     NA        50    
##  2        17         1.8      NA      0.0155    0.48 
##  3        14.4       2.4      NA     NA         1.35 
##  4        14.9       2.3       0.133  0.00029   0.019
##  5         4         0.7       0.667  0.423   600    
##  6        14.4       2.2       0.767 NA         3.85 
##  7         8.7       1.4       0.383 NA        20.5  
##  8         7        NA        NA     NA         0.045
##  9        10.1       2.9       0.333  0.07     14    
## 10         3        NA        NA      0.0982   14.8  
## # … with 73 more rows</code></pre>
<p><strong>Challenge</strong></p>
<p>Use <code>select(match())</code> to find columns whose names include either “sleep” or “wt”.</p>
<ul>
<li>Select the columns that starts with “b”</li>
</ul>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1"></a>msleep <span class="op">%&gt;%</span></span>
<span id="cb125-2"><a href="#cb125-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;b&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 83 x 2
##     brainwt  bodywt
##       &lt;dbl&gt;   &lt;dbl&gt;
##  1 NA        50    
##  2  0.0155    0.48 
##  3 NA         1.35 
##  4  0.00029   0.019
##  5  0.423   600    
##  6 NA         3.85 
##  7 NA        20.5  
##  8 NA         0.045
##  9  0.07     14    
## 10  0.0982   14.8  
## # … with 73 more rows</code></pre>
<ul>
<li>Select the columns that ends with “wt”</li>
</ul>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1"></a>msleep <span class="op">%&gt;%</span></span>
<span id="cb127-2"><a href="#cb127-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;wt&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 83 x 2
##     brainwt  bodywt
##       &lt;dbl&gt;   &lt;dbl&gt;
##  1 NA        50    
##  2  0.0155    0.48 
##  3 NA         1.35 
##  4  0.00029   0.019
##  5  0.423   600    
##  6 NA         3.85 
##  7 NA        20.5  
##  8 NA         0.045
##  9  0.07     14    
## 10  0.0982   14.8  
## # … with 73 more rows</code></pre>
<ul>
<li>Select the columns using both beginning and end string patterns</li>
</ul>
<p>The key idea is you can use Boolean operators (<code>!</code>, <code>&amp;</code>, <code>|</code>)to combine different string pattern matching statements.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1"></a>msleep <span class="op">%&gt;%</span></span>
<span id="cb129-2"><a href="#cb129-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;b&quot;</span>) <span class="op">&amp;</span><span class="st"> </span><span class="kw">ends_with</span>(<span class="st">&quot;wt&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 83 x 2
##     brainwt  bodywt
##       &lt;dbl&gt;   &lt;dbl&gt;
##  1 NA        50    
##  2  0.0155    0.48 
##  3 NA         1.35 
##  4  0.00029   0.019
##  5  0.423   600    
##  6 NA         3.85 
##  7 NA        20.5  
##  8 NA         0.045
##  9  0.07     14    
## 10  0.0982   14.8  
## # … with 73 more rows</code></pre>
<ul>
<li>Select order and move it before everything</li>
</ul>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1"></a><span class="co"># By specifying a column </span></span>
<span id="cb131-2"><a href="#cb131-2"></a>msleep <span class="op">%&gt;%</span></span>
<span id="cb131-3"><a href="#cb131-3"></a><span class="st">  </span><span class="kw">select</span>(order, <span class="kw">everything</span>())</span></code></pre></div>
<pre><code>## # A tibble: 83 x 11
##    order name  genus vore  conservation sleep_total sleep_rem sleep_cycle awake
##    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;
##  1 Carn… Chee… Acin… carni lc                  12.1      NA        NA      11.9
##  2 Prim… Owl … Aotus omni  &lt;NA&gt;                17         1.8      NA       7  
##  3 Rode… Moun… Aplo… herbi nt                  14.4       2.4      NA       9.6
##  4 Sori… Grea… Blar… omni  lc                  14.9       2.3       0.133   9.1
##  5 Arti… Cow   Bos   herbi domesticated         4         0.7       0.667  20  
##  6 Pilo… Thre… Brad… herbi &lt;NA&gt;                14.4       2.2       0.767   9.6
##  7 Carn… Nort… Call… carni vu                   8.7       1.4       0.383  15.3
##  8 Rode… Vesp… Calo… &lt;NA&gt;  &lt;NA&gt;                 7        NA        NA      17  
##  9 Carn… Dog   Canis carni domesticated        10.1       2.9       0.333  13.9
## 10 Arti… Roe … Capr… herbi lc                   3        NA        NA      21  
## # … with 73 more rows, and 2 more variables: brainwt &lt;dbl&gt;, bodywt &lt;dbl&gt;</code></pre>
<ul>
<li>Select variables from a character vector.</li>
</ul>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1"></a>msleep <span class="op">%&gt;%</span></span>
<span id="cb133-2"><a href="#cb133-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">any_of</span>(<span class="kw">c</span>(<span class="st">&quot;name&quot;</span>, <span class="st">&quot;order&quot;</span>))) <span class="op">%&gt;%</span></span>
<span id="cb133-3"><a href="#cb133-3"></a><span class="st">  </span><span class="kw">colnames</span>()</span></code></pre></div>
<pre><code>## [1] &quot;name&quot;  &quot;order&quot;</code></pre>
<ul>
<li>Select the variables named in the character + number pattern</li>
</ul>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1"></a>msleep<span class="op">$</span>week8 &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb135-2"><a href="#cb135-2"></a></span>
<span id="cb135-3"><a href="#cb135-3"></a>msleep<span class="op">$</span>week12 &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb135-4"><a href="#cb135-4"></a></span>
<span id="cb135-5"><a href="#cb135-5"></a>msleep<span class="op">$</span>week_extra &lt;-<span class="st"> </span><span class="dv">0</span> </span>
<span id="cb135-6"><a href="#cb135-6"></a></span>
<span id="cb135-7"><a href="#cb135-7"></a>msleep <span class="op">%&gt;%</span></span>
<span id="cb135-8"><a href="#cb135-8"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">num_range</span>(<span class="st">&quot;week&quot;</span>, <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">12</span>)))</span></code></pre></div>
<pre><code>## # A tibble: 83 x 2
##    week8 week12
##    &lt;lgl&gt; &lt;lgl&gt; 
##  1 NA    NA    
##  2 NA    NA    
##  3 NA    NA    
##  4 NA    NA    
##  5 NA    NA    
##  6 NA    NA    
##  7 NA    NA    
##  8 NA    NA    
##  9 NA    NA    
## 10 NA    NA    
## # … with 73 more rows</code></pre>
</div>
<div id="counting" class="section level2" number="4.8">
<h2 number="4.8"><span class="header-section-number">4.8</span> Counting</h2>
<ul>
<li>How may countries in each continent?</li>
</ul>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb137-2"><a href="#cb137-2"></a><span class="st">  </span><span class="kw">count</span>(continent)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 2
##   continent     n
##   &lt;fct&gt;     &lt;int&gt;
## 1 Africa      624
## 2 Americas    300
## 3 Asia        396
## 4 Europe      360
## 5 Oceania      24</code></pre>
<ul>
<li>Let’s arrange the result.</li>
</ul>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1"></a><span class="co"># Just add a new argument `sort = TRUE`</span></span>
<span id="cb139-2"><a href="#cb139-2"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb139-3"><a href="#cb139-3"></a><span class="st">  </span><span class="kw">count</span>(continent, <span class="dt">sort =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 2
##   continent     n
##   &lt;fct&gt;     &lt;int&gt;
## 1 Africa      624
## 2 Asia        396
## 3 Europe      360
## 4 Americas    300
## 5 Oceania      24</code></pre>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1"></a><span class="co"># Same as above; How nice!</span></span>
<span id="cb141-2"><a href="#cb141-2"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb141-3"><a href="#cb141-3"></a><span class="st">  </span><span class="kw">count</span>(continent) <span class="op">%&gt;%</span></span>
<span id="cb141-4"><a href="#cb141-4"></a><span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n))</span></code></pre></div>
<pre><code>## # A tibble: 5 x 2
##   continent     n
##   &lt;fct&gt;     &lt;int&gt;
## 1 Africa      624
## 2 Asia        396
## 3 Europe      360
## 4 Americas    300
## 5 Oceania      24</code></pre>
<p><strong>Challenge</strong></p>
<p>Count the number of observations per <code>continent</code> as well as <code>year</code> and arrange them with descending order.</p>
<p>Let’s take a deeper look at how things work under the hood.</p>
<ul>
<li><p><code>tally()</code> works similar to <code>nrow()</code>: Calculate the total number of cases in a dataframe</p></li>
<li><p><code>count</code> = <code>group_by()</code> + <code>tally()</code></p></li>
</ul>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb143-2"><a href="#cb143-2"></a><span class="st">  </span><span class="kw">tally</span>()</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1  1704</code></pre>
<ul>
<li><code>add_tally()</code> = <code>mutate(n = n())</code></li>
</ul>
<p><strong>Challenge</strong></p>
<p>What does n in the below example represent?</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb145-2"><a href="#cb145-2"></a><span class="st">  </span><span class="kw">select</span>(continent, country) <span class="op">%&gt;%</span></span>
<span id="cb145-3"><a href="#cb145-3"></a><span class="st">  </span><span class="kw">add_tally</span>()</span></code></pre></div>
<pre><code>## # A tibble: 1,704 x 3
##    continent country         n
##    &lt;fct&gt;     &lt;fct&gt;       &lt;int&gt;
##  1 Asia      Afghanistan  1704
##  2 Asia      Afghanistan  1704
##  3 Asia      Afghanistan  1704
##  4 Asia      Afghanistan  1704
##  5 Asia      Afghanistan  1704
##  6 Asia      Afghanistan  1704
##  7 Asia      Afghanistan  1704
##  8 Asia      Afghanistan  1704
##  9 Asia      Afghanistan  1704
## 10 Asia      Afghanistan  1704
## # … with 1,694 more rows</code></pre>
<ul>
<li><code>add_count</code></li>
</ul>
<p>Add count as a column</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1"></a><span class="co"># Add count as a column</span></span>
<span id="cb147-2"><a href="#cb147-2"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb147-3"><a href="#cb147-3"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span></span>
<span id="cb147-4"><a href="#cb147-4"></a><span class="st">  </span><span class="kw">add_count</span>(year)</span></code></pre></div>
<pre><code>## # A tibble: 1,704 x 7
## # Groups:   continent [5]
##    country     continent  year lifeExp      pop gdpPercap     n
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt; &lt;int&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779.    33
##  2 Afghanistan Asia       1957    30.3  9240934      821.    33
##  3 Afghanistan Asia       1962    32.0 10267083      853.    33
##  4 Afghanistan Asia       1967    34.0 11537966      836.    33
##  5 Afghanistan Asia       1972    36.1 13079460      740.    33
##  6 Afghanistan Asia       1977    38.4 14880372      786.    33
##  7 Afghanistan Asia       1982    39.9 12881816      978.    33
##  8 Afghanistan Asia       1987    40.8 13867957      852.    33
##  9 Afghanistan Asia       1992    41.7 16317921      649.    33
## 10 Afghanistan Asia       1997    41.8 22227415      635.    33
## # … with 1,694 more rows</code></pre>
<p><strong>Challenge</strong></p>
<p>Do the cases 1 and 2 in the below code chunk produce same outputs? If so, why?</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1"></a><span class="co"># Case 1</span></span>
<span id="cb149-2"><a href="#cb149-2"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb149-3"><a href="#cb149-3"></a><span class="st">  </span><span class="kw">group_by</span>(continent, year) <span class="op">%&gt;%</span></span>
<span id="cb149-4"><a href="#cb149-4"></a><span class="st">  </span><span class="kw">count</span>()</span></code></pre></div>
<pre><code>## # A tibble: 60 x 3
## # Groups:   continent, year [60]
##    continent  year     n
##    &lt;fct&gt;     &lt;int&gt; &lt;int&gt;
##  1 Africa     1952    52
##  2 Africa     1957    52
##  3 Africa     1962    52
##  4 Africa     1967    52
##  5 Africa     1972    52
##  6 Africa     1977    52
##  7 Africa     1982    52
##  8 Africa     1987    52
##  9 Africa     1992    52
## 10 Africa     1997    52
## # … with 50 more rows</code></pre>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1"></a><span class="co"># Case 2</span></span>
<span id="cb151-2"><a href="#cb151-2"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb151-3"><a href="#cb151-3"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span></span>
<span id="cb151-4"><a href="#cb151-4"></a><span class="st">  </span><span class="kw">count</span>(year)</span></code></pre></div>
<pre><code>## # A tibble: 60 x 3
## # Groups:   continent [5]
##    continent  year     n
##    &lt;fct&gt;     &lt;int&gt; &lt;int&gt;
##  1 Africa     1952    52
##  2 Africa     1957    52
##  3 Africa     1962    52
##  4 Africa     1967    52
##  5 Africa     1972    52
##  6 Africa     1977    52
##  7 Africa     1982    52
##  8 Africa     1987    52
##  9 Africa     1992    52
## 10 Africa     1997    52
## # … with 50 more rows</code></pre>
</div>
<div id="summarizing" class="section level2" number="4.9">
<h2 number="4.9"><span class="header-section-number">4.9</span> Summarizing</h2>
<div id="basic" class="section level3" number="4.9.1">
<h3 number="4.9.1"><span class="header-section-number">4.9.1</span> Basic</h3>
<ul>
<li>Create a summary</li>
</ul>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb153-2"><a href="#cb153-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span></span>
<span id="cb153-3"><a href="#cb153-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>(), </span>
<span id="cb153-4"><a href="#cb153-4"></a>            <span class="dt">mean_gdp =</span> <span class="kw">mean</span>(gdpPercap),</span>
<span id="cb153-5"><a href="#cb153-5"></a>            <span class="dt">sd_gdp =</span> <span class="kw">sd</span>(gdpPercap))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 4
##   continent     n mean_gdp sd_gdp
##   &lt;fct&gt;     &lt;int&gt;    &lt;dbl&gt;  &lt;dbl&gt;
## 1 Africa      624    2194.  2828.
## 2 Americas    300    7136.  6397.
## 3 Asia        396    7902. 14045.
## 4 Europe      360   14469.  9355.
## 5 Oceania      24   18622.  6359.</code></pre>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1"></a>tablea &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span></span>
<span id="cb156-2"><a href="#cb156-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span></span>
<span id="cb156-3"><a href="#cb156-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>(), </span>
<span id="cb156-4"><a href="#cb156-4"></a>            <span class="dt">mean_gdp =</span> <span class="kw">mean</span>(gdpPercap),</span>
<span id="cb156-5"><a href="#cb156-5"></a>            <span class="dt">sd_gdp =</span> <span class="kw">sd</span>(gdpPercap))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<ul>
<li>Produce publishable tables</li>
</ul>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1"></a><span class="co"># For HTML and LaTeX</span></span>
<span id="cb158-2"><a href="#cb158-2"></a>tablea <span class="op">%&gt;%</span><span class="st"> </span>kableExtra<span class="op">::</span><span class="kw">kable</span>()</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
continent
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
mean_gdp
</th>
<th style="text-align:right;">
sd_gdp
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Africa
</td>
<td style="text-align:right;">
624
</td>
<td style="text-align:right;">
2193.755
</td>
<td style="text-align:right;">
2827.930
</td>
</tr>
<tr>
<td style="text-align:left;">
Americas
</td>
<td style="text-align:right;">
300
</td>
<td style="text-align:right;">
7136.110
</td>
<td style="text-align:right;">
6396.764
</td>
</tr>
<tr>
<td style="text-align:left;">
Asia
</td>
<td style="text-align:right;">
396
</td>
<td style="text-align:right;">
7902.150
</td>
<td style="text-align:right;">
14045.373
</td>
</tr>
<tr>
<td style="text-align:left;">
Europe
</td>
<td style="text-align:right;">
360
</td>
<td style="text-align:right;">
14469.476
</td>
<td style="text-align:right;">
9355.213
</td>
</tr>
<tr>
<td style="text-align:left;">
Oceania
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
18621.609
</td>
<td style="text-align:right;">
6358.983
</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1"></a><span class="co"># For HTML and MS Office suite </span></span>
<span id="cb159-2"><a href="#cb159-2"></a>tablea <span class="op">%&gt;%</span><span class="st"> </span>flextable<span class="op">::</span><span class="kw">flextable</span>()</span></code></pre></div>
<div class="tabwid"><style>.cl-47694374{font-family:'Roboto';font-size:11px;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(17, 17, 17, 1.00);background-color:transparent;}.cl-47695602{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:2px;padding-top:2px;padding-left:5px;padding-right:5px;line-height: 1.00;background-color:transparent;}.cl-47695616{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:2px;padding-top:2px;padding-left:5px;padding-right:5px;line-height: 1.00;background-color:transparent;}.cl-47697d6c{width:54px;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-47697d80{width:54px;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-47697d94{width:54px;background-color:transparent;vertical-align: middle;border-bottom: 2.00px solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-47697d9e{width:54px;background-color:transparent;vertical-align: middle;border-bottom: 2.00px solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-47697da8{width:54px;background-color:transparent;vertical-align: middle;border-bottom: 2.00px solid rgba(0, 0, 0, 1.00);border-top: 2.00px solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-47697db2{width:54px;background-color:transparent;vertical-align: middle;border-bottom: 2.00px solid rgba(0, 0, 0, 1.00);border-top: 2.00px solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table style='border-collapse:collapse;'><thead><tr style="overflow-wrap:break-word;"><td class="cl-47697da8"><p class="cl-47695602"><span class="cl-47694374">continent</span></p></td><td class="cl-47697db2"><p class="cl-47695616"><span class="cl-47694374">n</span></p></td><td class="cl-47697db2"><p class="cl-47695616"><span class="cl-47694374">mean_gdp</span></p></td><td class="cl-47697db2"><p class="cl-47695616"><span class="cl-47694374">sd_gdp</span></p></td></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-47697d6c"><p class="cl-47695602"><span class="cl-47694374">Africa</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">624</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">2193.755</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">2827.930</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-47697d6c"><p class="cl-47695602"><span class="cl-47694374">Americas</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">300</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">7136.110</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">6396.764</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-47697d6c"><p class="cl-47695602"><span class="cl-47694374">Asia</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">396</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">7902.150</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">14045.373</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-47697d6c"><p class="cl-47695602"><span class="cl-47694374">Europe</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">360</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">14469.476</span></p></td><td class="cl-47697d80"><p class="cl-47695616"><span class="cl-47694374">9355.213</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-47697d94"><p class="cl-47695602"><span class="cl-47694374">Oceania</span></p></td><td class="cl-47697d9e"><p class="cl-47695616"><span class="cl-47694374">24</span></p></td><td class="cl-47697d9e"><p class="cl-47695616"><span class="cl-47694374">18621.609</span></p></td><td class="cl-47697d9e"><p class="cl-47695616"><span class="cl-47694374">6358.983</span></p></td></tr></tbody></table></div>
</div>
<div id="scoped-summaries" class="section level3" number="4.9.2">
<h3 number="4.9.2"><span class="header-section-number">4.9.2</span> Scoped summaries</h3>
<ul>
<li><p>Old way</p></li>
<li><p><code>summarise_all()</code></p></li>
</ul>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1"></a><span class="co"># Create a wide-shaped data example </span></span>
<span id="cb160-2"><a href="#cb160-2"></a>wide_gapminder &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span></span>
<span id="cb160-3"><a href="#cb160-3"></a><span class="st">  </span><span class="kw">filter</span>(continent <span class="op">==</span><span class="st"> &quot;Europe&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb160-4"><a href="#cb160-4"></a><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> country, </span>
<span id="cb160-5"><a href="#cb160-5"></a>              <span class="dt">values_from =</span> gdpPercap)</span>
<span id="cb160-6"><a href="#cb160-6"></a></span>
<span id="cb160-7"><a href="#cb160-7"></a><span class="co"># Apply summarise_all </span></span>
<span id="cb160-8"><a href="#cb160-8"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb160-9"><a href="#cb160-9"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)) <span class="op">%&gt;%</span></span>
<span id="cb160-10"><a href="#cb160-10"></a><span class="st">  </span><span class="kw">summarise_all</span>(mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 30
##   Albania Austria Belgium `Bosnia and Her… Bulgaria Croatia `Czech Republic`
##     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;
## 1   3255.  20412.  19901.            3485.    6384.   9332.           13920.
## # … with 23 more variables: Denmark &lt;dbl&gt;, Finland &lt;dbl&gt;, France &lt;dbl&gt;,
## #   Germany &lt;dbl&gt;, Greece &lt;dbl&gt;, Hungary &lt;dbl&gt;, Iceland &lt;dbl&gt;, Ireland &lt;dbl&gt;,
## #   Italy &lt;dbl&gt;, Montenegro &lt;dbl&gt;, Netherlands &lt;dbl&gt;, Norway &lt;dbl&gt;,
## #   Poland &lt;dbl&gt;, Portugal &lt;dbl&gt;, Romania &lt;dbl&gt;, Serbia &lt;dbl&gt;, `Slovak
## #   Republic` &lt;dbl&gt;, Slovenia &lt;dbl&gt;, Spain &lt;dbl&gt;, Sweden &lt;dbl&gt;,
## #   Switzerland &lt;dbl&gt;, Turkey &lt;dbl&gt;, `United Kingdom` &lt;dbl&gt;</code></pre>
<ul>
<li><code>summarise_if()</code>: using a logical condition</li>
</ul>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb162-2"><a href="#cb162-2"></a><span class="st">  </span><span class="kw">summarise_if</span>(is.double, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 31
##   lifeExp Albania Austria Belgium `Bosnia and Her… Bulgaria Croatia
##     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
## 1    71.9   3255.  20412.  19901.            3485.    6384.   9332.
## # … with 24 more variables: `Czech Republic` &lt;dbl&gt;, Denmark &lt;dbl&gt;,
## #   Finland &lt;dbl&gt;, France &lt;dbl&gt;, Germany &lt;dbl&gt;, Greece &lt;dbl&gt;, Hungary &lt;dbl&gt;,
## #   Iceland &lt;dbl&gt;, Ireland &lt;dbl&gt;, Italy &lt;dbl&gt;, Montenegro &lt;dbl&gt;,
## #   Netherlands &lt;dbl&gt;, Norway &lt;dbl&gt;, Poland &lt;dbl&gt;, Portugal &lt;dbl&gt;,
## #   Romania &lt;dbl&gt;, Serbia &lt;dbl&gt;, `Slovak Republic` &lt;dbl&gt;, Slovenia &lt;dbl&gt;,
## #   Spain &lt;dbl&gt;, Sweden &lt;dbl&gt;, Switzerland &lt;dbl&gt;, Turkey &lt;dbl&gt;, `United
## #   Kingdom` &lt;dbl&gt;</code></pre>
<ul>
<li><p><code>summarise_at()</code></p></li>
<li><p><code>vars() = select()</code></p></li>
</ul>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb164-2"><a href="#cb164-2"></a><span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)), </span>
<span id="cb164-3"><a href="#cb164-3"></a>               mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 30
##   Albania Austria Belgium `Bosnia and Her… Bulgaria Croatia `Czech Republic`
##     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;
## 1   3255.  20412.  19901.            3485.    6384.   9332.           13920.
## # … with 23 more variables: Denmark &lt;dbl&gt;, Finland &lt;dbl&gt;, France &lt;dbl&gt;,
## #   Germany &lt;dbl&gt;, Greece &lt;dbl&gt;, Hungary &lt;dbl&gt;, Iceland &lt;dbl&gt;, Ireland &lt;dbl&gt;,
## #   Italy &lt;dbl&gt;, Montenegro &lt;dbl&gt;, Netherlands &lt;dbl&gt;, Norway &lt;dbl&gt;,
## #   Poland &lt;dbl&gt;, Portugal &lt;dbl&gt;, Romania &lt;dbl&gt;, Serbia &lt;dbl&gt;, `Slovak
## #   Republic` &lt;dbl&gt;, Slovenia &lt;dbl&gt;, Spain &lt;dbl&gt;, Sweden &lt;dbl&gt;,
## #   Switzerland &lt;dbl&gt;, Turkey &lt;dbl&gt;, `United Kingdom` &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb166-2"><a href="#cb166-2"></a><span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(<span class="kw">contains</span>(<span class="st">&quot;life&quot;</span>)), </span>
<span id="cb166-3"><a href="#cb166-3"></a>               mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   lifeExp
##     &lt;dbl&gt;
## 1    71.9</code></pre>
<ul>
<li><p>New way</p></li>
<li><p><code>summarise()</code> + <code>across()</code></p></li>
<li><p>If you find using <code>summarise_all()</code>, <code>summarise_if()</code> and <code>summarise_at()</code> confusing, here’s a solution: use <code>summarise()</code> with <code>across()</code>.</p></li>
<li><p><code>summarise_all()</code></p></li>
</ul>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb168-2"><a href="#cb168-2"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">across</span>(Albania<span class="op">:</span><span class="st">`</span><span class="dt">United Kingdom</span><span class="st">`</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 30
##   Albania Austria Belgium `Bosnia and Her… Bulgaria Croatia `Czech Republic`
##     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;
## 1   3255.  20412.  19901.            3485.    6384.   9332.           13920.
## # … with 23 more variables: Denmark &lt;dbl&gt;, Finland &lt;dbl&gt;, France &lt;dbl&gt;,
## #   Germany &lt;dbl&gt;, Greece &lt;dbl&gt;, Hungary &lt;dbl&gt;, Iceland &lt;dbl&gt;, Ireland &lt;dbl&gt;,
## #   Italy &lt;dbl&gt;, Montenegro &lt;dbl&gt;, Netherlands &lt;dbl&gt;, Norway &lt;dbl&gt;,
## #   Poland &lt;dbl&gt;, Portugal &lt;dbl&gt;, Romania &lt;dbl&gt;, Serbia &lt;dbl&gt;, `Slovak
## #   Republic` &lt;dbl&gt;, Slovenia &lt;dbl&gt;, Spain &lt;dbl&gt;, Sweden &lt;dbl&gt;,
## #   Switzerland &lt;dbl&gt;, Turkey &lt;dbl&gt;, `United Kingdom` &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb170-2"><a href="#cb170-2"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">across</span>(<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>), mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 30
##   Albania Austria Belgium `Bosnia and Her… Bulgaria Croatia `Czech Republic`
##     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;
## 1   3255.  20412.  19901.            3485.    6384.   9332.           13920.
## # … with 23 more variables: Denmark &lt;dbl&gt;, Finland &lt;dbl&gt;, France &lt;dbl&gt;,
## #   Germany &lt;dbl&gt;, Greece &lt;dbl&gt;, Hungary &lt;dbl&gt;, Iceland &lt;dbl&gt;, Ireland &lt;dbl&gt;,
## #   Italy &lt;dbl&gt;, Montenegro &lt;dbl&gt;, Netherlands &lt;dbl&gt;, Norway &lt;dbl&gt;,
## #   Poland &lt;dbl&gt;, Portugal &lt;dbl&gt;, Romania &lt;dbl&gt;, Serbia &lt;dbl&gt;, `Slovak
## #   Republic` &lt;dbl&gt;, Slovenia &lt;dbl&gt;, Spain &lt;dbl&gt;, Sweden &lt;dbl&gt;,
## #   Switzerland &lt;dbl&gt;, Turkey &lt;dbl&gt;, `United Kingdom` &lt;dbl&gt;</code></pre>
<ul>
<li><code>summarise_if()</code></li>
</ul>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb172-2"><a href="#cb172-2"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">across</span>(is.double, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## Warning: Predicate functions must be wrapped in `where()`.
## 
##   # Bad
##   data %&gt;% select(is.double)
## 
##   # Good
##   data %&gt;% select(where(is.double))
## 
## ℹ Please update your code.
## This message is displayed once per session.</code></pre>
<pre><code>## # A tibble: 1 x 31
##   lifeExp Albania Austria Belgium `Bosnia and Her… Bulgaria Croatia
##     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
## 1    71.9   3255.  20412.  19901.            3485.    6384.   9332.
## # … with 24 more variables: `Czech Republic` &lt;dbl&gt;, Denmark &lt;dbl&gt;,
## #   Finland &lt;dbl&gt;, France &lt;dbl&gt;, Germany &lt;dbl&gt;, Greece &lt;dbl&gt;, Hungary &lt;dbl&gt;,
## #   Iceland &lt;dbl&gt;, Ireland &lt;dbl&gt;, Italy &lt;dbl&gt;, Montenegro &lt;dbl&gt;,
## #   Netherlands &lt;dbl&gt;, Norway &lt;dbl&gt;, Poland &lt;dbl&gt;, Portugal &lt;dbl&gt;,
## #   Romania &lt;dbl&gt;, Serbia &lt;dbl&gt;, `Slovak Republic` &lt;dbl&gt;, Slovenia &lt;dbl&gt;,
## #   Spain &lt;dbl&gt;, Sweden &lt;dbl&gt;, Switzerland &lt;dbl&gt;, Turkey &lt;dbl&gt;, `United
## #   Kingdom` &lt;dbl&gt;</code></pre>
<ul>
<li><code>summarise_at()</code></li>
</ul>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb175-2"><a href="#cb175-2"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">across</span>(<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>), </span>
<span id="cb175-3"><a href="#cb175-3"></a>               mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 30
##   Albania Austria Belgium `Bosnia and Her… Bulgaria Croatia `Czech Republic`
##     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;
## 1   3255.  20412.  19901.            3485.    6384.   9332.           13920.
## # … with 23 more variables: Denmark &lt;dbl&gt;, Finland &lt;dbl&gt;, France &lt;dbl&gt;,
## #   Germany &lt;dbl&gt;, Greece &lt;dbl&gt;, Hungary &lt;dbl&gt;, Iceland &lt;dbl&gt;, Ireland &lt;dbl&gt;,
## #   Italy &lt;dbl&gt;, Montenegro &lt;dbl&gt;, Netherlands &lt;dbl&gt;, Norway &lt;dbl&gt;,
## #   Poland &lt;dbl&gt;, Portugal &lt;dbl&gt;, Romania &lt;dbl&gt;, Serbia &lt;dbl&gt;, `Slovak
## #   Republic` &lt;dbl&gt;, Slovenia &lt;dbl&gt;, Spain &lt;dbl&gt;, Sweden &lt;dbl&gt;,
## #   Switzerland &lt;dbl&gt;, Turkey &lt;dbl&gt;, `United Kingdom` &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb177-2"><a href="#cb177-2"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">across</span>(<span class="kw">contains</span>(<span class="st">&quot;life&quot;</span>), </span>
<span id="cb177-3"><a href="#cb177-3"></a>               mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   lifeExp
##     &lt;dbl&gt;
## 1    71.9</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1"></a>wide_gapminder <span class="op">%&gt;%</span></span>
<span id="cb179-2"><a href="#cb179-2"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">across</span>(<span class="kw">contains</span>(<span class="st">&quot;A&quot;</span>, <span class="dt">ignore.case =</span> <span class="ot">FALSE</span>)))</span></code></pre></div>
<pre><code>## # A tibble: 360 x 2
##    Albania Austria
##      &lt;dbl&gt;   &lt;dbl&gt;
##  1   1601.      NA
##  2   1942.      NA
##  3   2313.      NA
##  4   2760.      NA
##  5   3313.      NA
##  6   3533.      NA
##  7   3631.      NA
##  8   3739.      NA
##  9   2497.      NA
## 10   3193.      NA
## # … with 350 more rows</code></pre>
<p>Note that this workshop does not cover creating and manipulating variables using <code>mutate()</code> because many techniques you learned from playing with <code>summarise()</code> can be directly applied to <code>mutate()</code>.</p>
<p><strong>Challenge</strong></p>
<ol style="list-style-type: decimal">
<li><p>Summarize average GDP of countries whose names starting with alphabet “A”.</p></li>
<li><p>Turn the summary dataframe into a publishable table using either <code>kableExtra</code> or <code>flextable</code> package.</p></li>
</ol>
</div>
</div>
<div id="grouping" class="section level2" number="4.10">
<h2 number="4.10"><span class="header-section-number">4.10</span> Grouping</h2>
<div id="grouped-summaries" class="section level3" number="4.10.1">
<h3 number="4.10.1"><span class="header-section-number">4.10.1</span> Grouped summaries</h3>
<ul>
<li>Calculate the mean of <code>gdpPercap</code>.</li>
</ul>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb181-2"><a href="#cb181-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># </span></span>
<span id="cb181-3"><a href="#cb181-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_gdp =</span> <span class="kw">mean</span>(gdpPercap))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 2
##   continent mean_gdp
##   &lt;fct&gt;        &lt;dbl&gt;
## 1 Africa       2194.
## 2 Americas     7136.
## 3 Asia         7902.
## 4 Europe      14469.
## 5 Oceania     18622.</code></pre>
<ul>
<li>Calculate multiple summary statistics.</li>
</ul>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb184-2"><a href="#cb184-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># </span></span>
<span id="cb184-3"><a href="#cb184-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_gdp =</span> <span class="kw">mean</span>(gdpPercap),</span>
<span id="cb184-4"><a href="#cb184-4"></a>            <span class="dt">count =</span> <span class="kw">n</span>())</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 3
##   continent mean_gdp count
##   &lt;fct&gt;        &lt;dbl&gt; &lt;int&gt;
## 1 Africa       2194.   624
## 2 Americas     7136.   300
## 3 Asia         7902.   396
## 4 Europe      14469.   360
## 5 Oceania     18622.    24</code></pre>
<p><strong>Optional</strong></p>
<ul>
<li>Other summary statistics</li>
</ul>
<ol style="list-style-type: decimal">
<li>Measures of spread: <code>median(x)</code>, <code>sd(x)</code>, <code>IQR(x)</code>, <code>mad(x)</code> (the median absolute deviation)</li>
</ol>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1"></a><span class="co"># The Interquartile Range = The Difference Between 75t and 25t Percentiles </span></span>
<span id="cb187-2"><a href="#cb187-2"></a></span>
<span id="cb187-3"><a href="#cb187-3"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb187-4"><a href="#cb187-4"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># </span></span>
<span id="cb187-5"><a href="#cb187-5"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">IQR_gdp =</span> <span class="kw">IQR</span>(gdpPercap))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 2
##   continent IQR_gdp
##   &lt;fct&gt;       &lt;dbl&gt;
## 1 Africa      1616.
## 2 Americas    4402.
## 3 Asia        7492.
## 4 Europe     13248.
## 5 Oceania     8072.</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Measures of rank: <code>min(x)</code>, <code>quantile(x, 0.25)</code>, <code>max(x)</code></li>
</ol>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb190-2"><a href="#cb190-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># </span></span>
<span id="cb190-3"><a href="#cb190-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">min_gdp =</span> <span class="kw">min</span>(gdpPercap),</span>
<span id="cb190-4"><a href="#cb190-4"></a>            <span class="dt">max_gdp =</span> <span class="kw">max</span>(gdpPercap))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 3
##   continent min_gdp max_gdp
##   &lt;fct&gt;       &lt;dbl&gt;   &lt;dbl&gt;
## 1 Africa       241.  21951.
## 2 Americas    1202.  42952.
## 3 Asia         331  113523.
## 4 Europe       974.  49357.
## 5 Oceania    10040.  34435.</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Measures of position: <code>first(x)</code>, <code>last(x)</code>, <code>nth(x, 2)</code></li>
</ol>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb193-2"><a href="#cb193-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb193-3"><a href="#cb193-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">first_gdp =</span> <span class="kw">first</span>(gdpPercap),</span>
<span id="cb193-4"><a href="#cb193-4"></a>            <span class="dt">last_gdp =</span> <span class="kw">last</span>(gdpPercap))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 3
##   continent first_gdp last_gdp
##   &lt;fct&gt;         &lt;dbl&gt;    &lt;dbl&gt;
## 1 Africa        2449.     470.
## 2 Americas      5911.   11416.
## 3 Asia           779.    2281.
## 4 Europe        1601.   33203.
## 5 Oceania      10040.   25185.</code></pre>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb196-2"><a href="#cb196-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb196-3"><a href="#cb196-3"></a><span class="st">  </span><span class="kw">arrange</span>(gdpPercap) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Adding arrange</span></span>
<span id="cb196-4"><a href="#cb196-4"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">first_gdp =</span> <span class="kw">first</span>(gdpPercap),</span>
<span id="cb196-5"><a href="#cb196-5"></a>            <span class="dt">last_gdp =</span> <span class="kw">last</span>(gdpPercap))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 3
##   continent first_gdp last_gdp
##   &lt;fct&gt;         &lt;dbl&gt;    &lt;dbl&gt;
## 1 Africa         241.   21951.
## 2 Americas      1202.   42952.
## 3 Asia           331   113523.
## 4 Europe         974.   49357.
## 5 Oceania      10040.   34435.</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Measures of counts: <code>n(x)</code> (all rows), <code>sum(!is.na(x))</code> (only non-missing rows) = <code>n_distinct(x)</code></li>
</ol>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb199-2"><a href="#cb199-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span></span>
<span id="cb199-3"><a href="#cb199-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">ns =</span> <span class="kw">n</span>())</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 2
##   continent    ns
##   &lt;fct&gt;     &lt;int&gt;
## 1 Africa      624
## 2 Americas    300
## 3 Asia        396
## 4 Europe      360
## 5 Oceania      24</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Counts and proportions of logical values: <code>sum(condition about x)</code> (the number of TRUEs in x), <code>mean(condition about x)</code> (the proportion of TRUEs in x)</li>
</ol>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1"></a>gapminder <span class="op">%&gt;%</span></span>
<span id="cb202-2"><a href="#cb202-2"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb202-3"><a href="#cb202-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">rich_countries =</span> <span class="kw">mean</span>(gdpPercap <span class="op">&gt;</span><span class="st"> </span><span class="dv">20000</span>))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 5 x 2
##   continent rich_countries
##   &lt;fct&gt;              &lt;dbl&gt;
## 1 Africa           0.00481
## 2 Americas         0.05   
## 3 Asia             0.111  
## 4 Europe           0.261  
## 5 Oceania          0.333</code></pre>
</div>
</div>
<div id="nesting" class="section level2" number="4.11">
<h2 number="4.11"><span class="header-section-number">4.11</span> Nesting</h2>
<div id="nest" class="section level3" number="4.11.1">
<h3 number="4.11.1"><span class="header-section-number">4.11.1</span> nest</h3>
<p>The following example comes from <a href="https://r4ds.had.co.nz/many-models.html">R for Data Science</a> by by Garrett Grolemund and Hadley Wickham.</p>
<ul>
<li><p>How can you run multiple models simultaneously? Using a nested data frame.</p></li>
<li><p><strong>Grouped data: each row = an observation</strong></p></li>
<li><p><strong>Nested data: each row = a group</strong></p></li>
</ul>
<p><strong>Challenge</strong></p>
<p>In the following example, why did we use <code>country</code> and <code>continent</code> for nesting variables?</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1"></a>nested &lt;-<span class="st"> </span>gapminder <span class="op">%&gt;%</span></span>
<span id="cb205-2"><a href="#cb205-2"></a><span class="st">  </span><span class="kw">group_by</span>(country, continent) <span class="op">%&gt;%</span></span>
<span id="cb205-3"><a href="#cb205-3"></a><span class="st">  </span><span class="kw">nest</span>() </span>
<span id="cb205-4"><a href="#cb205-4"></a></span>
<span id="cb205-5"><a href="#cb205-5"></a><span class="kw">head</span>(nested)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
## # Groups:   country, continent [6]
##   country     continent data             
##   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           
## 1 Afghanistan Asia      &lt;tibble [12 × 4]&gt;
## 2 Albania     Europe    &lt;tibble [12 × 4]&gt;
## 3 Algeria     Africa    &lt;tibble [12 × 4]&gt;
## 4 Angola      Africa    &lt;tibble [12 × 4]&gt;
## 5 Argentina   Americas  &lt;tibble [12 × 4]&gt;
## 6 Australia   Oceania   &lt;tibble [12 × 4]&gt;</code></pre>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1"></a>nested<span class="op">$</span>data[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## # A tibble: 12 x 4
##     year lifeExp      pop gdpPercap
##    &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1  1952    28.8  8425333      779.
##  2  1957    30.3  9240934      821.
##  3  1962    32.0 10267083      853.
##  4  1967    34.0 11537966      836.
##  5  1972    36.1 13079460      740.
##  6  1977    38.4 14880372      786.
##  7  1982    39.9 12881816      978.
##  8  1987    40.8 13867957      852.
##  9  1992    41.7 16317921      649.
## 10  1997    41.8 22227415      635.
## 11  2002    42.1 25268405      727.
## 12  2007    43.8 31889923      975.</code></pre>
<ul>
<li>Custom function</li>
</ul>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1"></a>lm_model &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</span>
<span id="cb209-2"><a href="#cb209-2"></a>  </span>
<span id="cb209-3"><a href="#cb209-3"></a>  <span class="kw">lm</span>(lifeExp <span class="op">~</span><span class="st"> </span>year, <span class="dt">data =</span> df)</span>
<span id="cb209-4"><a href="#cb209-4"></a>}</span></code></pre></div>
<ul>
<li>Apply function to the nested data</li>
</ul>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1"></a><span class="co"># Apply m_model to the nested data </span></span>
<span id="cb210-2"><a href="#cb210-2"></a></span>
<span id="cb210-3"><a href="#cb210-3"></a>nested &lt;-<span class="st"> </span>nested <span class="op">%&gt;%</span></span>
<span id="cb210-4"><a href="#cb210-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">models =</span> <span class="kw">map</span>(data, lm_model)) <span class="co"># Add the list object as a new column</span></span>
<span id="cb210-5"><a href="#cb210-5"></a></span>
<span id="cb210-6"><a href="#cb210-6"></a><span class="kw">head</span>(nested)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
## # Groups:   country, continent [6]
##   country     continent data              models
##   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;
## 1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
## 2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
## 3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
## 4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
## 5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
## 6 Australia   Oceania   &lt;tibble [12 × 4]&gt; &lt;lm&gt;</code></pre>
<p>S3 is part of R’s object oriented systems. If you need more information, check <a href="http://adv-r.had.co.nz/S3.html">this section</a> in Hadley’s Advanced R out.</p>
</div>
<div id="unnest" class="section level3" number="4.11.2">
<h3 number="4.11.2"><span class="header-section-number">4.11.2</span> unnest</h3>
<p><code>glance()</code> function from <code>broom</code> package inspects the quality of a statistical model.</p>
<p><strong>Additional tips</strong></p>
<ul>
<li><code>broom::glance(model)</code>: for evaluating model quality and/or complexity</li>
<li><code>broom::tidy(model)</code>: for extracting each coefficient in the model (the estimates + its variability)</li>
<li><code>broom::augment(model, data)</code>: for getting extra values (residuals, and influence statistics)</li>
</ul>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1"></a>glanced &lt;-<span class="st"> </span>nested <span class="op">%&gt;%</span></span>
<span id="cb212-2"><a href="#cb212-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">glance =</span> <span class="kw">map</span>(models, broom<span class="op">::</span>glance))</span>
<span id="cb212-3"><a href="#cb212-3"></a></span>
<span id="cb212-4"><a href="#cb212-4"></a>glanced<span class="op">$</span>glance[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## # A tibble: 1 x 12
##   r.squared adj.r.squared sigma statistic p.value    df logLik   AIC   BIC
##       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     0.948         0.942  1.22      181. 9.84e-8     1  -18.3  42.7  44.1
## # … with 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
<p><code>unnest()</code> unpacks the list objects stored in glance column</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1"></a>glanced <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb214-2"><a href="#cb214-2"></a><span class="st">  </span><span class="kw">unnest</span>(glance) <span class="op">%&gt;%</span></span>
<span id="cb214-3"><a href="#cb214-3"></a><span class="st">  </span><span class="kw">arrange</span>(BIC) <span class="co"># Low to High; Lower BIC indicates a better model fit </span></span></code></pre></div>
<pre><code>## # A tibble: 142 x 16
## # Groups:   country, continent [142]
##    country continent data  models r.squared adj.r.squared sigma statistic
##    &lt;fct&gt;   &lt;fct&gt;     &lt;lis&gt; &lt;list&gt;     &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
##  1 Sweden  Europe    &lt;tib… &lt;lm&gt;       0.995         0.995 0.212     2203.
##  2 Switze… Europe    &lt;tib… &lt;lm&gt;       0.997         0.997 0.215     3823.
##  3 France  Europe    &lt;tib… &lt;lm&gt;       0.998         0.997 0.220     4200.
##  4 Canada  Americas  &lt;tib… &lt;lm&gt;       0.996         0.996 0.249     2757.
##  5 Argent… Americas  &lt;tib… &lt;lm&gt;       0.996         0.995 0.292     2246.
##  6 Belgium Europe    &lt;tib… &lt;lm&gt;       0.995         0.994 0.293     1822.
##  7 Brazil  Americas  &lt;tib… &lt;lm&gt;       0.998         0.998 0.326     5111.
##  8 Equato… Africa    &lt;tib… &lt;lm&gt;       0.997         0.997 0.329     3184.
##  9 Nether… Europe    &lt;tib… &lt;lm&gt;       0.982         0.980 0.348      552.
## 10 Finland Europe    &lt;tib… &lt;lm&gt;       0.994         0.993 0.354     1613.
## # … with 132 more rows, and 8 more variables: p.value &lt;dbl&gt;, df &lt;dbl&gt;,
## #   logLik &lt;dbl&gt;, AIC &lt;dbl&gt;, BIC &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;,
## #   nobs &lt;int&gt;</code></pre>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1"></a>glanced <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-2"><a href="#cb216-2"></a><span class="st">  </span><span class="kw">unnest</span>(glance) <span class="op">%&gt;%</span></span>
<span id="cb216-3"><a href="#cb216-3"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(continent, BIC)) <span class="op">+</span></span>
<span id="cb216-4"><a href="#cb216-4"></a><span class="st">    </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="02_tidy_data_files/figure-html/unnamed-chunk-68-1.png" width="672" /></p>
</div>
</div>
<div id="mapping" class="section level2" number="4.12">
<h2 number="4.12"><span class="header-section-number">4.12</span> Mapping</h2>
<p>We tasted a little bit about how <code>map()</code> function works. Let’s dig into it deeper as this family of functions is really useful. For more information, see Rebecca Barter’s wonderful tutorial on the <code>purrr</code> package. In her words, this is “the tidyverse’s answer to apply functions for iteration”. <code>map()</code> function can take a vector (of any type), a list, and a dataframe for input.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1"></a>multiply &lt;-<span class="st"> </span><span class="cf">function</span>(x){</span>
<span id="cb217-2"><a href="#cb217-2"></a>  x<span class="op">*</span>x </span>
<span id="cb217-3"><a href="#cb217-3"></a>}</span>
<span id="cb217-4"><a href="#cb217-4"></a></span>
<span id="cb217-5"><a href="#cb217-5"></a>df &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">first_obs =</span> <span class="kw">rnorm</span>(<span class="dv">7</span>, <span class="dv">1</span>, <span class="dt">sd =</span><span class="dv">1</span>),</span>
<span id="cb217-6"><a href="#cb217-6"></a>           <span class="dt">second_obs =</span> <span class="kw">rnorm</span>(<span class="dv">7</span>, <span class="dv">2</span>, <span class="dt">sd =</span> <span class="dv">2</span>)) <span class="co"># normal distribution </span></span></code></pre></div>
<p><strong>Challenge</strong></p>
<p>Try <code>map_df(.x = df, .f = multiply)</code> and tell me what’s the difference between the output you got and what you saw earlier.</p>
<p>If you want to know more about the power and joy of functional programming in R (e.g., <code>purrr::map()</code>), then please take <a href="https://github.com/dlab-berkeley/R-functional-programming">“How to Automate Repeated Things in R”</a> workshop.</p>
</div>
<div id="joining" class="section level2" number="4.13">
<h2 number="4.13"><span class="header-section-number">4.13</span> Joining</h2>
<div id="mutating-joins" class="section level3" number="4.13.1">
<h3 number="4.13.1"><span class="header-section-number">4.13.1</span> Mutating joins</h3>
<blockquote>
<p>Add new variables to one data frame from matching observations in another"</p>
</blockquote>
<p>Using a simple toy example is great because it is easy to see how things work in that much narrow context.</p>
<ul>
<li>Toy example</li>
</ul>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1"></a><span class="co"># Table 1 </span></span>
<span id="cb218-2"><a href="#cb218-2"></a>x &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">key =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>),</span>
<span id="cb218-3"><a href="#cb218-3"></a>            <span class="dt">val_x =</span> <span class="kw">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>, <span class="st">&quot;x3&quot;</span>, <span class="st">&quot;x4&quot;</span>))</span>
<span id="cb218-4"><a href="#cb218-4"></a></span>
<span id="cb218-5"><a href="#cb218-5"></a><span class="co"># Table 2</span></span>
<span id="cb218-6"><a href="#cb218-6"></a>y &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">key =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>),</span>
<span id="cb218-7"><a href="#cb218-7"></a>            <span class="dt">val_y =</span> <span class="kw">c</span>(<span class="st">&quot;y1&quot;</span>, <span class="st">&quot;y2&quot;</span>, <span class="st">&quot;y3&quot;</span>, <span class="st">&quot;y4&quot;</span>, <span class="st">&quot;y5&quot;</span>))</span></code></pre></div>
<ul>
<li>Inner Join</li>
</ul>
<p><code>inner_join()</code> keeps the matched values in both tables. If the left table is a subset of the right table, then the result of <code>left_join()</code> is same as <code>inner_join()</code>.</p>
<p><strong>Challenge</strong></p>
<p>What are going to be the shared keys?</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1"></a><span class="kw">inner_join</span>(x, y)</span></code></pre></div>
<pre><code>## Joining, by = &quot;key&quot;</code></pre>
<pre><code>## # A tibble: 4 x 3
##     key val_x val_y
##   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
## 1     1 x1    y1   
## 2     2 x2    y2   
## 3     3 x3    y3   
## 4     4 x4    y4</code></pre>
<div class="figure">
<img src="https://d33wubrfki0l68.cloudfront.net/aeab386461820b029b7e7606ccff1286f623bae1/ef0d4/diagrams/join-venn.png" alt="" />
<p class="caption">Mutating joins</p>
</div>
<ul>
<li>Left Join</li>
</ul>
<p><code>left_join()</code>, <code>right_join()</code> and <code>full_join()</code> are outer join functions. Unlike <code>inner_join()</code>, outer join functions keep observations that appear in at least one of the tables.</p>
<p><code>left_join()</code> keeps only the matched observations in the right table.</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1"></a><span class="kw">left_join</span>(x, y)</span></code></pre></div>
<pre><code>## Joining, by = &quot;key&quot;</code></pre>
<pre><code>## # A tibble: 4 x 3
##     key val_x val_y
##   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
## 1     1 x1    y1   
## 2     2 x2    y2   
## 3     3 x3    y3   
## 4     4 x4    y4</code></pre>
<ul>
<li>Right Join</li>
</ul>
<p><code>right_join()</code> does the opposite.</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1"></a><span class="kw">right_join</span>(x, y)</span></code></pre></div>
<pre><code>## Joining, by = &quot;key&quot;</code></pre>
<pre><code>## # A tibble: 5 x 3
##     key val_x val_y
##   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
## 1     1 x1    y1   
## 2     2 x2    y2   
## 3     3 x3    y3   
## 4     4 x4    y4   
## 5     5 &lt;NA&gt;  y5</code></pre>
<ul>
<li>Full Join</li>
</ul>
<p><code>full_join()</code> keeps the observations from both tables. If they were unmatched, then NAs were recoded in one of the two tables.</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1"></a><span class="kw">full_join</span>(x, y)</span></code></pre></div>
<pre><code>## Joining, by = &quot;key&quot;</code></pre>
<pre><code>## # A tibble: 5 x 3
##     key val_x val_y
##   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
## 1     1 x1    y1   
## 2     2 x2    y2   
## 3     3 x3    y3   
## 4     4 x4    y4   
## 5     5 &lt;NA&gt;  y5</code></pre>
</div>
<div id="filtering-joins" class="section level3" number="4.13.2">
<h3 number="4.13.2"><span class="header-section-number">4.13.2</span> Filtering joins</h3>
<blockquote>
<p>Filter observations from one data frame based on whether or not they match an observation in the other table.</p>
</blockquote>
<ul>
<li>Semi Join</li>
</ul>
<p>In SQL, this type of query is also called subqueries.</p>
<ul>
<li>Filtering without joining</li>
</ul>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1"></a><span class="co"># Create the list of the top 10 destinations </span></span>
<span id="cb231-2"><a href="#cb231-2"></a>top_dest &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span></span>
<span id="cb231-3"><a href="#cb231-3"></a><span class="st">  </span><span class="kw">count</span>(dest, <span class="dt">sort =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></span>
<span id="cb231-4"><a href="#cb231-4"></a><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>)</span></code></pre></div>
<pre><code>## Selecting by n</code></pre>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1"></a><span class="co"># Filter</span></span>
<span id="cb233-2"><a href="#cb233-2"></a>filtered &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span></span>
<span id="cb233-3"><a href="#cb233-3"></a><span class="st">  </span><span class="kw">filter</span>(dest <span class="op">%in%</span><span class="st"> </span>top_dest<span class="op">$</span>dest)</span></code></pre></div>
<ul>
<li>Using semi join: only keep (INCLUDE) the rows that were matched between the two tables</li>
</ul>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1"></a>joined &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span></span>
<span id="cb234-2"><a href="#cb234-2"></a><span class="st">  </span><span class="kw">semi_join</span>(top_dest)</span></code></pre></div>
<pre><code>## Joining, by = &quot;dest&quot;</code></pre>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1"></a><span class="kw">head</span>(filtered <span class="op">==</span><span class="st"> </span>joined)</span></code></pre></div>
<pre><code>##      year month  day dep_time sched_dep_time dep_delay arr_time sched_arr_time
## [1,] TRUE  TRUE TRUE     TRUE           TRUE      TRUE     TRUE           TRUE
## [2,] TRUE  TRUE TRUE     TRUE           TRUE      TRUE     TRUE           TRUE
## [3,] TRUE  TRUE TRUE     TRUE           TRUE      TRUE     TRUE           TRUE
## [4,] TRUE  TRUE TRUE     TRUE           TRUE      TRUE     TRUE           TRUE
## [5,] TRUE  TRUE TRUE     TRUE           TRUE      TRUE     TRUE           TRUE
## [6,] TRUE  TRUE TRUE     TRUE           TRUE      TRUE     TRUE           TRUE
##      arr_delay carrier flight tailnum origin dest air_time distance hour minute
## [1,]      TRUE    TRUE   TRUE    TRUE   TRUE TRUE     TRUE     TRUE TRUE   TRUE
## [2,]      TRUE    TRUE   TRUE    TRUE   TRUE TRUE     TRUE     TRUE TRUE   TRUE
## [3,]      TRUE    TRUE   TRUE    TRUE   TRUE TRUE     TRUE     TRUE TRUE   TRUE
## [4,]      TRUE    TRUE   TRUE    TRUE   TRUE TRUE     TRUE     TRUE TRUE   TRUE
## [5,]      TRUE    TRUE   TRUE    TRUE   TRUE TRUE     TRUE     TRUE TRUE   TRUE
## [6,]      TRUE    TRUE   TRUE    TRUE   TRUE TRUE     TRUE     TRUE TRUE   TRUE
##      time_hour
## [1,]      TRUE
## [2,]      TRUE
## [3,]      TRUE
## [4,]      TRUE
## [5,]      TRUE
## [6,]      TRUE</code></pre>
<ul>
<li>Anti Join</li>
</ul>
<p><code>anti_join()</code> dose the opposite. Exclude the rows that were matched between the two tables. Great technique to filter stopwords when you do a computational text analysis.</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1"></a>flights <span class="op">%&gt;%</span></span>
<span id="cb238-2"><a href="#cb238-2"></a><span class="st">  </span><span class="kw">anti_join</span>(planes, <span class="dt">by =</span> <span class="st">&quot;tailnum&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb238-3"><a href="#cb238-3"></a><span class="st">  </span><span class="kw">count</span>(tailnum, <span class="dt">sort =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 722 x 2
##    tailnum     n
##    &lt;chr&gt;   &lt;int&gt;
##  1 &lt;NA&gt;     2512
##  2 N725MQ    575
##  3 N722MQ    513
##  4 N723MQ    507
##  5 N713MQ    483
##  6 N735MQ    396
##  7 N0EGMQ    371
##  8 N534MQ    364
##  9 N542MQ    363
## 10 N531MQ    349
## # … with 712 more rows</code></pre>
<!--chapter:end:02_tidy_data.Rmd-->
</div>
</div>
</div>
<div id="functional_programming" class="section level1" number="5">
<h1 number="5"><span class="header-section-number">5</span> Automating repeated things</h1>
<blockquote>
<p>Anything that can be automated should be automated. Do as little as possible by hand. Do as much as possible with functions.
- Hadley Wickam</p>
</blockquote>
<div id="why-functional-programming" class="section level2" number="5.1">
<h2 number="5.1"><span class="header-section-number">5.1</span> Why functional programming</h2>
<ul>
<li>Setup</li>
</ul>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1"></a><span class="co"># Install packages</span></span>
<span id="cb240-2"><a href="#cb240-2"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;pacman&quot;</span>)) {</span>
<span id="cb240-3"><a href="#cb240-3"></a>  <span class="kw">install.packages</span>(<span class="st">&quot;pacman&quot;</span>)</span>
<span id="cb240-4"><a href="#cb240-4"></a>}</span></code></pre></div>
<pre><code>## Loading required package: pacman</code></pre>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(</span>
<span id="cb242-2"><a href="#cb242-2"></a>  tidyverse, <span class="co"># tidyverse pkgs including purrr</span></span>
<span id="cb242-3"><a href="#cb242-3"></a>  tictoc, <span class="co"># performance test</span></span>
<span id="cb242-4"><a href="#cb242-4"></a>  broom, <span class="co"># tidy modeling</span></span>
<span id="cb242-5"><a href="#cb242-5"></a>  glue, <span class="co"># paste string and objects</span></span>
<span id="cb242-6"><a href="#cb242-6"></a>  furrr, <span class="co"># parallel processing</span></span>
<span id="cb242-7"><a href="#cb242-7"></a>  rvest, <span class="co"># web scraping</span></span>
<span id="cb242-8"><a href="#cb242-8"></a>  devtools, <span class="co"># dev tools </span></span>
<span id="cb242-9"><a href="#cb242-9"></a>  usethis, <span class="co"># workflow     </span></span>
<span id="cb242-10"><a href="#cb242-10"></a>  roxygen2, <span class="co"># documentation </span></span>
<span id="cb242-11"><a href="#cb242-11"></a>            </span>
<span id="cb242-12"><a href="#cb242-12"></a>  testthat) <span class="co"># testing </span></span></code></pre></div>
<div id="why-map" class="section level3" number="5.1.1">
<h3 number="5.1.1"><span class="header-section-number">5.1.1</span> Why map?</h3>
<div id="objectives" class="section level4" number="5.1.1.1">
<h4 number="5.1.1.1"><span class="header-section-number">5.1.1.1</span> Objectives</h4>
<ul>
<li>How to use <code>purrr</code> to automate workflow in a cleaner, faster, and more extendable way</li>
</ul>
</div>
<div id="copy-and-paste-programming" class="section level4" number="5.1.1.2">
<h4 number="5.1.1.2"><span class="header-section-number">5.1.1.2</span> Copy-and-paste programming</h4>
<blockquote>
<p>Copy-and-paste programming, sometimes referred to as just pasting, is the production of highly repetitive computer programming code, as produced by copy and paste operations. It is primarily a pejorative term; those who use the term are often implying a lack of programming competence. It may also be the result of technology limitations (e.g., an insufficiently expressive development environment) as subroutines or libraries would normally be used instead. However, there are occasions when copy-and-paste programming is considered acceptable or necessary, such as for boilerplate, loop unrolling (when not supported automatically by the compiler), or certain programming idioms, and it is supported by some source code editors in the form of snippets. - Wikipedia</p>
</blockquote>
<ul>
<li><p>Example</p></li>
<li><p>Let’s imagine <code>df</code> is a survey dataset.</p>
<ul>
<li><p><code>a, b, c, d</code> = Survey questions</p></li>
<li><p><code>-99</code>: non-responses</p></li>
<li><p>Your goal: replace <code>-99</code> with <code>NA</code></p></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1"></a><span class="co"># Data</span></span>
<span id="cb243-2"><a href="#cb243-2"></a></span>
<span id="cb243-3"><a href="#cb243-3"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>) <span class="co"># for reproducibility</span></span>
<span id="cb243-4"><a href="#cb243-4"></a></span>
<span id="cb243-5"><a href="#cb243-5"></a>df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb243-6"><a href="#cb243-6"></a>  <span class="st">&quot;a&quot;</span> =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">99</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size =</span> <span class="dv">5</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb243-7"><a href="#cb243-7"></a>  <span class="st">&quot;b&quot;</span> =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">99</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size =</span> <span class="dv">5</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb243-8"><a href="#cb243-8"></a>  <span class="st">&quot;c&quot;</span> =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">99</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size =</span> <span class="dv">5</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb243-9"><a href="#cb243-9"></a>  <span class="st">&quot;d&quot;</span> =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">99</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size =</span> <span class="dv">5</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb243-10"><a href="#cb243-10"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1"></a><span class="co"># Copy and paste</span></span>
<span id="cb244-2"><a href="#cb244-2"></a>df<span class="op">$</span>a[df<span class="op">$</span>a <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb244-3"><a href="#cb244-3"></a>df<span class="op">$</span>b[df<span class="op">$</span>b <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb244-4"><a href="#cb244-4"></a>df<span class="op">$</span>c[df<span class="op">$</span>c <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb244-5"><a href="#cb244-5"></a>df<span class="op">$</span>d[df<span class="op">$</span>d <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb244-6"><a href="#cb244-6"></a></span>
<span id="cb244-7"><a href="#cb244-7"></a>df</span></code></pre></div>
<pre><code>## # A tibble: 5 x 4
##       a     b     c     d
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     3     3     3     1
## 2     3     2     3     1
## 3     1    NA     1     2
## 4     1    NA     2     1
## 5    NA     1     1     3</code></pre>
<ul>
<li><strong>Challenge</strong>. Explain why this solution is not very efficient (Hint: If <code>df$a[df$a == -99] &lt;- NA</code> has an error, how are you going to fix it? A solution is not scalable if it’s not automatable.</li>
</ul>
</div>
<div id="using-a-function" class="section level4" number="5.1.1.3">
<h4 number="5.1.1.3"><span class="header-section-number">5.1.1.3</span> Using a function</h4>
<ul>
<li><p>Let’s recall what’s function in R: <code>input + computation + output</code></p></li>
<li><p>If you write a function, you gain efficiency because you don’t need to copy and paste the computation part.</p></li>
</ul>
<p>`
function(input){</p>
<p>computation</p>
<p>return(output)
}
`</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1"></a><span class="co"># Function</span></span>
<span id="cb246-2"><a href="#cb246-2"></a></span>
<span id="cb246-3"><a href="#cb246-3"></a>fix_missing &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb246-4"><a href="#cb246-4"></a>  x[x <span class="op">==</span><span class="st"> </span><span class="dv">-99</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb246-5"><a href="#cb246-5"></a>  x</span>
<span id="cb246-6"><a href="#cb246-6"></a>}</span>
<span id="cb246-7"><a href="#cb246-7"></a></span>
<span id="cb246-8"><a href="#cb246-8"></a><span class="co"># Apply function to each column (vector)</span></span>
<span id="cb246-9"><a href="#cb246-9"></a></span>
<span id="cb246-10"><a href="#cb246-10"></a>df<span class="op">$</span>a &lt;-<span class="st"> </span><span class="kw">fix_missing</span>(df<span class="op">$</span>a)</span>
<span id="cb246-11"><a href="#cb246-11"></a>df<span class="op">$</span>b &lt;-<span class="st"> </span><span class="kw">fix_missing</span>(df<span class="op">$</span>b)</span>
<span id="cb246-12"><a href="#cb246-12"></a>df<span class="op">$</span>c &lt;-<span class="st"> </span><span class="kw">fix_missing</span>(df<span class="op">$</span>c)</span>
<span id="cb246-13"><a href="#cb246-13"></a>df<span class="op">$</span>d &lt;-<span class="st"> </span><span class="kw">fix_missing</span>(df<span class="op">$</span>d)</span>
<span id="cb246-14"><a href="#cb246-14"></a></span>
<span id="cb246-15"><a href="#cb246-15"></a>df</span></code></pre></div>
<pre><code>## # A tibble: 5 x 4
##       a     b     c     d
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     3     3     3     1
## 2     3     2     3     1
## 3     1    NA     1     2
## 4     1    NA     2     1
## 5    NA     1     1     3</code></pre>
<ul>
<li><p><strong>Challenge</strong> Why using function is more efficient than 100% copying and pasting? Can you think about a way we can automate the process?</p></li>
<li><p>Many options for automation in R: <code>for loop</code>, <code>apply</code> family, etc.</p></li>
<li><p>Here’s a tidy solution comes from <code>purrr</code> package.</p></li>
<li><p>The power and joy of one-liner.</p></li>
</ul>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1"></a>df &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map_df</span>(df, fix_missing)</span>
<span id="cb248-2"><a href="#cb248-2"></a></span>
<span id="cb248-3"><a href="#cb248-3"></a>df</span></code></pre></div>
<pre><code>## # A tibble: 5 x 4
##       a     b     c     d
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     3     3     3     1
## 2     3     2     3     1
## 3     1    NA     1     2
## 4     1    NA     2     1
## 5    NA     1     1     3</code></pre>
<p><code>map()</code> is a <a href="https://en.wikipedia.org/wiki/Map_(higher-order_function)">higher-order function</a> that applies a given function to each element of a list/vector.</p>
<div class="figure">
<img src="https://d33wubrfki0l68.cloudfront.net/f0494d020aa517ae7b1011cea4c4a9f21702df8b/2577b/diagrams/functionals/map.png" alt="" />
<p class="caption">This is how map() works. It’s easier to understand with a picture.</p>
</div>
<pre><code>- Input: Takes a vector/list. 

- Computation: Calls the function once for each element of the vector 

- Output: Returns in a list or whatever data format you prefer (e.g., `_df helper: dataframe`)</code></pre>
<ul>
<li><strong>Challenge</strong> If you run the code below, what’s going to be the data type of the output?</li>
</ul>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1"></a><span class="kw">map</span>(df, fix_missing)</span></code></pre></div>
<pre><code>## $a
## [1]  3  3  1  1 NA
## 
## $b
## [1]  3  2 NA NA  1
## 
## $c
## [1] 3 3 1 2 1
## 
## $d
## [1] 1 1 2 1 3</code></pre>
<ul>
<li>Why <code>map()</code> is a good alternative to <code>for loop</code>.</li>
</ul>

<iframe width="560" height="315" src="https://www.youtube.com/embed/bzUmK0Y07ck" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>The Joy of Functional Programming (for Data Science) - Hadley Wickham</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1"></a><span class="co"># Built-in data</span></span>
<span id="cb253-2"><a href="#cb253-2"></a><span class="kw">data</span>(<span class="st">&quot;airquality&quot;</span>)</span>
<span id="cb253-3"><a href="#cb253-3"></a></span>
<span id="cb253-4"><a href="#cb253-4"></a><span class="kw">tic</span>()</span>
<span id="cb253-5"><a href="#cb253-5"></a></span>
<span id="cb253-6"><a href="#cb253-6"></a><span class="co"># Placeholder</span></span>
<span id="cb253-7"><a href="#cb253-7"></a>out1 &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;double&quot;</span>, <span class="kw">ncol</span>(airquality))</span>
<span id="cb253-8"><a href="#cb253-8"></a><span class="co"># Sequence variable</span></span>
<span id="cb253-9"><a href="#cb253-9"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(airquality)) { <span class="co">#</span></span>
<span id="cb253-10"><a href="#cb253-10"></a></span>
<span id="cb253-11"><a href="#cb253-11"></a>  <span class="co"># Assign a computation result to each element</span></span>
<span id="cb253-12"><a href="#cb253-12"></a>  out1[[i]] &lt;-<span class="st"> </span><span class="kw">mean</span>(airquality[[i]], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb253-13"><a href="#cb253-13"></a>}</span>
<span id="cb253-14"><a href="#cb253-14"></a><span class="kw">toc</span>()</span></code></pre></div>
<pre><code>## 0.007 sec elapsed</code></pre>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1"></a><span class="kw">tic</span>()</span>
<span id="cb255-2"><a href="#cb255-2"></a>out1 &lt;-<span class="st"> </span>airquality <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">map_dbl</span>(mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb255-3"><a href="#cb255-3"></a><span class="kw">toc</span>()</span></code></pre></div>
<pre><code>## 0.002 sec elapsed</code></pre>
<ul>
<li><p>In short, <code>map()</code> is more readable, faster, and easily extendable with other data science tasks (e.g., wrangling, modeling, and visualization) using <code>%&gt;%</code>.</p></li>
<li><p>Final point: Why not base R <code>apply</code> family?</p></li>
<li><p>Short answer: <code>purrr::map()</code> is simpler to write. For instance,</p></li>
</ul>
<p><code>map_dbl(x, mean, na.rm = TRUE)</code> = <code>vapply(x, mean, na.rm = TRUE, FUN.VALUE = double(1))</code></p>
</div>
<div id="application-many-models" class="section level4" number="5.1.1.4">
<h4 number="5.1.1.4"><span class="header-section-number">5.1.1.4</span> Application (many models)</h4>
<ul>
<li>One popular application of <code>map()</code> is to run regression models (or whatever model you want to run) on list-columns. No more copying and pasting for running many regression models on subgroups!</li>
</ul>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1"></a><span class="co"># Have you ever tried this?</span></span>
<span id="cb257-2"><a href="#cb257-2"></a>lm_A &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="kw">subset</span>(data, subgroup <span class="op">==</span><span class="st"> &quot;group_A&quot;</span>))</span>
<span id="cb257-3"><a href="#cb257-3"></a>lm_B &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="kw">subset</span>(data, subgroup <span class="op">==</span><span class="st"> &quot;group_B&quot;</span>))</span>
<span id="cb257-4"><a href="#cb257-4"></a>lm_C &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="kw">subset</span>(data, subgroup <span class="op">==</span><span class="st"> &quot;group_C&quot;</span>))</span>
<span id="cb257-5"><a href="#cb257-5"></a>lm_D &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="kw">subset</span>(data, subgroup <span class="op">==</span><span class="st"> &quot;group_D&quot;</span>))</span>
<span id="cb257-6"><a href="#cb257-6"></a>lm_E &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="kw">subset</span>(data, subgroup <span class="op">==</span><span class="st"> &quot;group_E&quot;</span>))</span></code></pre></div>
<ul>
<li>For more information on this technique, read the Many Models subchapter of the <a href="https://r4ds.had.co.nz/many-models.html#creating-list-columns">R for Data Science</a>.</li>
</ul>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1"></a><span class="co"># Function</span></span>
<span id="cb258-2"><a href="#cb258-2"></a>lm_model &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</span>
<span id="cb258-3"><a href="#cb258-3"></a>  <span class="kw">lm</span>(Temp <span class="op">~</span><span class="st"> </span>Ozone, <span class="dt">data =</span> df)</span>
<span id="cb258-4"><a href="#cb258-4"></a>}</span>
<span id="cb258-5"><a href="#cb258-5"></a></span>
<span id="cb258-6"><a href="#cb258-6"></a><span class="co"># Map</span></span>
<span id="cb258-7"><a href="#cb258-7"></a>models &lt;-<span class="st"> </span>airquality <span class="op">%&gt;%</span></span>
<span id="cb258-8"><a href="#cb258-8"></a><span class="st">  </span><span class="kw">group_by</span>(Month) <span class="op">%&gt;%</span></span>
<span id="cb258-9"><a href="#cb258-9"></a><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Create list-columns</span></span>
<span id="cb258-10"><a href="#cb258-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ols =</span> <span class="kw">map</span>(data, lm_model)) <span class="co"># Map</span></span>
<span id="cb258-11"><a href="#cb258-11"></a>models<span class="op">$</span>ols[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:
## lm(formula = Temp ~ Ozone, data = df)
## 
## Coefficients:
## (Intercept)        Ozone  
##     62.8842       0.1629</code></pre>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1"></a><span class="co"># Add tidying</span></span>
<span id="cb260-2"><a href="#cb260-2"></a>tidy_lm_model &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">compose</span>( <span class="co"># compose multiple functions</span></span>
<span id="cb260-3"><a href="#cb260-3"></a>  broom<span class="op">::</span>tidy, <span class="co"># convert lm objects into tidy tibbles</span></span>
<span id="cb260-4"><a href="#cb260-4"></a>  lm_model</span>
<span id="cb260-5"><a href="#cb260-5"></a>)</span>
<span id="cb260-6"><a href="#cb260-6"></a></span>
<span id="cb260-7"><a href="#cb260-7"></a>tidied_models &lt;-<span class="st"> </span>airquality <span class="op">%&gt;%</span></span>
<span id="cb260-8"><a href="#cb260-8"></a><span class="st">  </span><span class="kw">group_by</span>(Month) <span class="op">%&gt;%</span></span>
<span id="cb260-9"><a href="#cb260-9"></a><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Create list-columns</span></span>
<span id="cb260-10"><a href="#cb260-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ols =</span> <span class="kw">map</span>(data, tidy_lm_model))</span>
<span id="cb260-11"><a href="#cb260-11"></a></span>
<span id="cb260-12"><a href="#cb260-12"></a>tidied_models<span class="op">$</span>ols[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [[1]]
## # A tibble: 2 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)   62.9      1.61       39.2  2.88e-23
## 2 Ozone          0.163    0.0500      3.26 3.31e- 3</code></pre>
</div>
</div>
</div>
<div id="automote-2-or-2-tasks" class="section level2" number="5.2">
<h2 number="5.2"><span class="header-section-number">5.2</span> Automote 2 or 2+ tasks</h2>
<div id="objectives-1" class="section level3" number="5.2.1">
<h3 number="5.2.1"><span class="header-section-number">5.2.1</span> Objectives</h3>
<ul>
<li>Learning how to use <code>map2()</code> and <code>pmap()</code> to avoid writing nested loops.</li>
</ul>
</div>
<div id="problem" class="section level3" number="5.2.2">
<h3 number="5.2.2"><span class="header-section-number">5.2.2</span> Problem</h3>
<ul>
<li>Problem: How can you create something like below?</li>
</ul>
<p>[1] “University = Berkeley | Department = waterbenders”</p>
<p>[1] “University = Berkeley | Department = earthbenders”</p>
<p>[1] “University = Berkeley | Department = firebenders”</p>
<p>[1] “University = Berkeley | Department = airbenders”</p>
<p>[1] “University = Stanford | Department = waterbenders”</p>
<p>[1] “University = Stanford | Department = earthbenders”</p>
<p>[1] “University = Stanford | Department = firebenders”</p>
<p>[1] “University = Stanford | Department = airbenders”</p>
<ul>
<li>The most manual way: You can copy and paste eight times.</li>
</ul>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1"></a><span class="kw">paste</span>(<span class="st">&quot;University = Berkeley | Department = CS&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;University = Berkeley | Department = CS&quot;</code></pre>
</div>
<div id="for-loop" class="section level3" number="5.2.3">
<h3 number="5.2.3"><span class="header-section-number">5.2.3</span> For loop</h3>
<ul>
<li><p>A slightly more efficient way: using a for loop.</p></li>
<li><p>Think about which part of the statement is constant and which part varies ( = parameters).</p></li>
<li><p>Do we need a placeholder? No. We don’t need a placeholder because we don’t store the result of iterations.</p></li>
<li><p><strong>Challenge</strong>: How many parameters do you need to solve the problem below?</p></li>
</ul>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1"></a><span class="co"># Outer loop</span></span>
<span id="cb264-2"><a href="#cb264-2"></a></span>
<span id="cb264-3"><a href="#cb264-3"></a><span class="cf">for</span> (univ <span class="cf">in</span> <span class="kw">c</span>(<span class="st">&quot;Berkeley&quot;</span>, <span class="st">&quot;Stanford&quot;</span>)) {</span>
<span id="cb264-4"><a href="#cb264-4"></a></span>
<span id="cb264-5"><a href="#cb264-5"></a>  <span class="co"># Inner loop</span></span>
<span id="cb264-6"><a href="#cb264-6"></a></span>
<span id="cb264-7"><a href="#cb264-7"></a>  <span class="cf">for</span> (dept <span class="cf">in</span> <span class="kw">c</span>(<span class="st">&quot;waterbenders&quot;</span>, <span class="st">&quot;earthbenders&quot;</span>, <span class="st">&quot;firebenders&quot;</span>, <span class="st">&quot;airbenders&quot;</span>)) {</span>
<span id="cb264-8"><a href="#cb264-8"></a>    <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;University = &quot;</span>, univ, <span class="st">&quot;|&quot;</span>, <span class="st">&quot;Department = &quot;</span>, dept))</span>
<span id="cb264-9"><a href="#cb264-9"></a>  }</span>
<span id="cb264-10"><a href="#cb264-10"></a>}</span></code></pre></div>
<pre><code>## [1] &quot;University =  Berkeley | Department =  waterbenders&quot;
## [1] &quot;University =  Berkeley | Department =  earthbenders&quot;
## [1] &quot;University =  Berkeley | Department =  firebenders&quot;
## [1] &quot;University =  Berkeley | Department =  airbenders&quot;
## [1] &quot;University =  Stanford | Department =  waterbenders&quot;
## [1] &quot;University =  Stanford | Department =  earthbenders&quot;
## [1] &quot;University =  Stanford | Department =  firebenders&quot;
## [1] &quot;University =  Stanford | Department =  airbenders&quot;</code></pre>
<ul>
<li>This is not bad, but … <code>n</code> arguments -&gt; <code>n-nested for loops</code>. As a scale of your problem grows, your code gets really complicated.</li>
</ul>
<blockquote>
<p>To become significantly more reliable, code must become more transparent. In particular, nested conditions and loops must be viewed with great suspicion. Complicated control flows confuse programmers. Messy code often hides bugs. — <a href="https://en.wikipedia.org/wiki/Bjarne_Stroustrup">Bjarne Stroustrup</a></p>
</blockquote>
</div>
<div id="map2-pmap" class="section level3" number="5.2.4">
<h3 number="5.2.4"><span class="header-section-number">5.2.4</span> map2 &amp; pmap</h3>
<ul>
<li><p>Step 1: Define inputs and a function.</p></li>
<li><p><strong>Challenge</strong> Why are we using <code>rep()</code> to create input vectors? For instance, for <code>univ_list</code> why not just use <code>c("Berkeley", "Stanford")</code>?</p></li>
</ul>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1"></a><span class="co"># Inputs (remember the length of these inputs should be identical)</span></span>
<span id="cb266-2"><a href="#cb266-2"></a></span>
<span id="cb266-3"><a href="#cb266-3"></a>univ_list &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Berkeley&quot;</span>, <span class="st">&quot;Stanford&quot;</span>), <span class="dv">4</span>)</span>
<span id="cb266-4"><a href="#cb266-4"></a>dept_list &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;waterbenders&quot;</span>, <span class="st">&quot;earthbenders&quot;</span>, <span class="st">&quot;firebenders&quot;</span>, <span class="st">&quot;airbenders&quot;</span>), <span class="dv">2</span>)</span>
<span id="cb266-5"><a href="#cb266-5"></a></span>
<span id="cb266-6"><a href="#cb266-6"></a><span class="co"># Function</span></span>
<span id="cb266-7"><a href="#cb266-7"></a></span>
<span id="cb266-8"><a href="#cb266-8"></a>print_lists &lt;-<span class="st"> </span><span class="cf">function</span>(univ, dept) {</span>
<span id="cb266-9"><a href="#cb266-9"></a>  <span class="kw">print</span>(<span class="kw">paste</span>(</span>
<span id="cb266-10"><a href="#cb266-10"></a>    <span class="st">&quot;University = &quot;</span>, univ, <span class="st">&quot;|&quot;</span>,</span>
<span id="cb266-11"><a href="#cb266-11"></a>    <span class="st">&quot;Department = &quot;</span>, dept</span>
<span id="cb266-12"><a href="#cb266-12"></a>  ))</span>
<span id="cb266-13"><a href="#cb266-13"></a>}</span>
<span id="cb266-14"><a href="#cb266-14"></a></span>
<span id="cb266-15"><a href="#cb266-15"></a><span class="co"># Test</span></span>
<span id="cb266-16"><a href="#cb266-16"></a></span>
<span id="cb266-17"><a href="#cb266-17"></a><span class="kw">print_lists</span>(univ_list[<span class="dv">1</span>], dept_list[<span class="dv">1</span>])</span></code></pre></div>
<pre><code>## [1] &quot;University =  Berkeley | Department =  waterbenders&quot;</code></pre>
<ul>
<li>Step2: Using <code>map2()</code> or <code>pmap()</code></li>
</ul>
<p><img src="https://dcl-prog.stanford.edu/images/map2.png" /></p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1"></a><span class="co"># 2 arguments</span></span>
<span id="cb268-2"><a href="#cb268-2"></a>map2_output &lt;-<span class="st"> </span><span class="kw">map2</span>(univ_list, dept_list, print_lists)</span></code></pre></div>
<pre><code>## [1] &quot;University =  Berkeley | Department =  waterbenders&quot;
## [1] &quot;University =  Stanford | Department =  earthbenders&quot;
## [1] &quot;University =  Berkeley | Department =  firebenders&quot;
## [1] &quot;University =  Stanford | Department =  airbenders&quot;
## [1] &quot;University =  Berkeley | Department =  waterbenders&quot;
## [1] &quot;University =  Stanford | Department =  earthbenders&quot;
## [1] &quot;University =  Berkeley | Department =  firebenders&quot;
## [1] &quot;University =  Stanford | Department =  airbenders&quot;</code></pre>
<p><img src="https://d33wubrfki0l68.cloudfront.net/e426c5755e2e65bdcc073d387775db79791f32fd/92902/diagrams/functionals/pmap.png" /></p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1"></a><span class="co"># 3+ arguments</span></span>
<span id="cb270-2"><a href="#cb270-2"></a>pmap_output &lt;-<span class="st"> </span><span class="kw">pmap</span>(<span class="kw">list</span>(univ_list, dept_list), print_lists)</span></code></pre></div>
<pre><code>## [1] &quot;University =  Berkeley | Department =  waterbenders&quot;
## [1] &quot;University =  Stanford | Department =  earthbenders&quot;
## [1] &quot;University =  Berkeley | Department =  firebenders&quot;
## [1] &quot;University =  Stanford | Department =  airbenders&quot;
## [1] &quot;University =  Berkeley | Department =  waterbenders&quot;
## [1] &quot;University =  Stanford | Department =  earthbenders&quot;
## [1] &quot;University =  Berkeley | Department =  firebenders&quot;
## [1] &quot;University =  Stanford | Department =  airbenders&quot;</code></pre>
<ul>
<li><strong>Challenge</strong> Have you noticed that we used a slightly different input for <code>pmap()</code> compared to <code>map()</code> or <code>map2()</code>? What is the difference?</li>
</ul>
</div>
</div>
<div id="automate-plotting" class="section level2" number="5.3">
<h2 number="5.3"><span class="header-section-number">5.3</span> Automate plotting</h2>
<div id="objective" class="section level3" number="5.3.1">
<h3 number="5.3.1"><span class="header-section-number">5.3.1</span> Objective</h3>
<ul>
<li>Learning how to use <code>map()</code> and <code>glue()</code> to automate creating multiple plots</li>
</ul>
</div>
<div id="problem-1" class="section level3" number="5.3.2">
<h3 number="5.3.2"><span class="header-section-number">5.3.2</span> Problem</h3>
<ul>
<li>Making the following data visualization process more efficient.</li>
</ul>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1"></a><span class="kw">data</span>(<span class="st">&quot;airquality&quot;</span>)</span>
<span id="cb272-2"><a href="#cb272-2"></a></span>
<span id="cb272-3"><a href="#cb272-3"></a>airquality <span class="op">%&gt;%</span></span>
<span id="cb272-4"><a href="#cb272-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Ozone, <span class="dt">y =</span> Solar.R)) <span class="op">+</span></span>
<span id="cb272-5"><a href="#cb272-5"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb272-6"><a href="#cb272-6"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb272-7"><a href="#cb272-7"></a>    <span class="dt">title =</span> <span class="st">&quot;Relationship between Ozone and Solar.R&quot;</span>,</span>
<span id="cb272-8"><a href="#cb272-8"></a>    <span class="dt">y =</span> <span class="st">&quot;Solar.R&quot;</span></span>
<span id="cb272-9"><a href="#cb272-9"></a>  )</span></code></pre></div>
<pre><code>## Warning: Removed 42 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1"></a>airquality <span class="op">%&gt;%</span></span>
<span id="cb274-2"><a href="#cb274-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Ozone, <span class="dt">y =</span> Wind)) <span class="op">+</span></span>
<span id="cb274-3"><a href="#cb274-3"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb274-4"><a href="#cb274-4"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb274-5"><a href="#cb274-5"></a>    <span class="dt">title =</span> <span class="st">&quot;Relationship between Ozone and Wind&quot;</span>,</span>
<span id="cb274-6"><a href="#cb274-6"></a>    <span class="dt">y =</span> <span class="st">&quot;Wind&quot;</span></span>
<span id="cb274-7"><a href="#cb274-7"></a>  )</span></code></pre></div>
<pre><code>## Warning: Removed 37 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-16-2.png" width="672" /></p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1"></a>airquality <span class="op">%&gt;%</span></span>
<span id="cb276-2"><a href="#cb276-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Ozone, <span class="dt">y =</span> Temp)) <span class="op">+</span></span>
<span id="cb276-3"><a href="#cb276-3"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb276-4"><a href="#cb276-4"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb276-5"><a href="#cb276-5"></a>    <span class="dt">title =</span> <span class="st">&quot;Relationship between Ozone and Temp&quot;</span>,</span>
<span id="cb276-6"><a href="#cb276-6"></a>    <span class="dt">y =</span> <span class="st">&quot;Temp&quot;</span></span>
<span id="cb276-7"><a href="#cb276-7"></a>  )</span></code></pre></div>
<pre><code>## Warning: Removed 37 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-16-3.png" width="672" /></p>
</div>
<div id="solution" class="section level3" number="5.3.3">
<h3 number="5.3.3"><span class="header-section-number">5.3.3</span> Solution</h3>
<ul>
<li><p>Learn how <code>glue()</code> works.</p></li>
<li><p><code>glue()</code> combines strings and objects and it works simpler and faster than <code>paste()</code> or <code>sprintif()</code>.</p></li>
</ul>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1"></a>names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Jae&quot;</span>, <span class="st">&quot;Aniket&quot;</span>, <span class="st">&quot;Avery&quot;</span>)</span>
<span id="cb278-2"><a href="#cb278-2"></a></span>
<span id="cb278-3"><a href="#cb278-3"></a>fields &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Political Science&quot;</span>, <span class="st">&quot;Law&quot;</span>, <span class="st">&quot;Public Health&quot;</span>)</span>
<span id="cb278-4"><a href="#cb278-4"></a></span>
<span id="cb278-5"><a href="#cb278-5"></a><span class="kw">glue</span>(<span class="st">&quot;{names} studies {fields}.&quot;</span>)</span></code></pre></div>
<pre><code>## Jae studies Political Science.
## Aniket studies Law.
## Avery studies Public Health.</code></pre>
<ul>
<li><p>So, our next step is to combine <code>glue()</code> and <code>map()</code>.</p></li>
<li><p>Let’s first think about writing a function that includes <code>glue()</code>.</p></li>
<li><p><strong>Challenge</strong>
How can you create the character vector of column names?</p></li>
<li><p><strong>Challenge</strong>
How can you make <code>ggplot2()</code> take strings as x and y variable names? (Hint: Type <code>?aes_string()</code>)</p></li>
</ul>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1"></a>airquality <span class="op">%&gt;%</span></span>
<span id="cb280-2"><a href="#cb280-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="kw">names</span>(airquality)[<span class="dv">1</span>], <span class="dt">y =</span> <span class="kw">names</span>(airquality)[<span class="dv">2</span>])) <span class="op">+</span></span>
<span id="cb280-3"><a href="#cb280-3"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb280-4"><a href="#cb280-4"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb280-5"><a href="#cb280-5"></a>    <span class="dt">title =</span> <span class="kw">glue</span>(<span class="st">&quot;Relationship between Ozone and {names(airquality)[2]}&quot;</span>),</span>
<span id="cb280-6"><a href="#cb280-6"></a>    <span class="dt">y =</span> <span class="kw">glue</span>(<span class="st">&quot;{names(airquality)[2]}&quot;</span>)</span>
<span id="cb280-7"><a href="#cb280-7"></a>  )</span></code></pre></div>
<pre><code>## Warning: Removed 42 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<ul>
<li><p>The next step is to write an automatic plotting function.</p>
<ul>
<li>Note that in the function argument <code>i</code> (abstract) replaced 2 (specific): abstraction</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1"></a>create_point_plot &lt;-<span class="st"> </span><span class="cf">function</span>(i) {</span>
<span id="cb282-2"><a href="#cb282-2"></a>  airquality <span class="op">%&gt;%</span></span>
<span id="cb282-3"><a href="#cb282-3"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="kw">names</span>(airquality)[<span class="dv">1</span>], <span class="dt">y =</span> <span class="kw">names</span>(airquality)[i])) <span class="op">+</span></span>
<span id="cb282-4"><a href="#cb282-4"></a><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb282-5"><a href="#cb282-5"></a><span class="st">    </span><span class="kw">labs</span>(</span>
<span id="cb282-6"><a href="#cb282-6"></a>      <span class="dt">title =</span> <span class="kw">glue</span>(<span class="st">&quot;Relationship between Ozone and {names(airquality)[i]}&quot;</span>),</span>
<span id="cb282-7"><a href="#cb282-7"></a>      <span class="dt">y =</span> <span class="kw">glue</span>(<span class="st">&quot;{names(airquality)[i]}&quot;</span>)</span>
<span id="cb282-8"><a href="#cb282-8"></a>    )</span>
<span id="cb282-9"><a href="#cb282-9"></a>}</span></code></pre></div>
<ul>
<li>The final step is to put the function in <code>map()</code>.</li>
</ul>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1"></a><span class="kw">map</span>(<span class="dv">2</span><span class="op">:</span><span class="kw">ncol</span>(airquality), create_point_plot)</span></code></pre></div>
<pre><code>## [[1]]</code></pre>
<pre><code>## Warning: Removed 42 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<pre><code>## Warning: Removed 37 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-20-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<pre><code>## Warning: Removed 37 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-20-3.png" width="672" /></p>
<pre><code>## 
## [[4]]</code></pre>
<pre><code>## Warning: Removed 37 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-20-4.png" width="672" /></p>
<pre><code>## 
## [[5]]</code></pre>
<pre><code>## Warning: Removed 37 rows containing missing values (geom_point).</code></pre>
<p><img src="03_functional_programming_files/figure-html/unnamed-chunk-20-5.png" width="672" /></p>
</div>
</div>
<div id="automate-joining" class="section level2" number="5.4">
<h2 number="5.4"><span class="header-section-number">5.4</span> Automate joining</h2>
<div id="objective-1" class="section level3" number="5.4.1">
<h3 number="5.4.1"><span class="header-section-number">5.4.1</span> Objective</h3>
<ul>
<li>Learning how to use <code>reduce()</code> to automate joining multiple dataframes</li>
</ul>
</div>
<div id="problem-2" class="section level3" number="5.4.2">
<h3 number="5.4.2"><span class="header-section-number">5.4.2</span> Problem</h3>
<ul>
<li><p>How can you make joining multiple dataframes more efficient?</p></li>
<li><p>Note that we will use <code>dplyr::left_join() = merge(x, y, all.x = TRUE)</code>.</p></li>
</ul>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="#cb294-1"></a>df1 &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb294-2"><a href="#cb294-2"></a>  <span class="dt">x =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb294-3"><a href="#cb294-3"></a>  <span class="dt">y =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb294-4"><a href="#cb294-4"></a>  <span class="dt">z =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb294-5"><a href="#cb294-5"></a>)</span>
<span id="cb294-6"><a href="#cb294-6"></a></span>
<span id="cb294-7"><a href="#cb294-7"></a>df2 &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb294-8"><a href="#cb294-8"></a>  <span class="dt">x =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb294-9"><a href="#cb294-9"></a>  <span class="dt">y =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb294-10"><a href="#cb294-10"></a>  <span class="dt">z =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb294-11"><a href="#cb294-11"></a>)</span>
<span id="cb294-12"><a href="#cb294-12"></a></span>
<span id="cb294-13"><a href="#cb294-13"></a>df3 &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb294-14"><a href="#cb294-14"></a>  <span class="dt">x =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb294-15"><a href="#cb294-15"></a>  <span class="dt">y =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</span>
<span id="cb294-16"><a href="#cb294-16"></a>  <span class="dt">z =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb294-17"><a href="#cb294-17"></a>)</span></code></pre></div>
</div>
<div id="copy-and-paste" class="section level3" number="5.4.3">
<h3 number="5.4.3"><span class="header-section-number">5.4.3</span> Copy and paste</h3>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="#cb295-1"></a>first_join &lt;-<span class="st"> </span><span class="kw">left_join</span>(df1, df2)</span></code></pre></div>
<pre><code>## Joining, by = c(&quot;x&quot;, &quot;y&quot;, &quot;z&quot;)</code></pre>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="#cb297-1"></a>second_join &lt;-<span class="st"> </span><span class="kw">left_join</span>(first_join, df3)</span></code></pre></div>
<pre><code>## Joining, by = c(&quot;x&quot;, &quot;y&quot;, &quot;z&quot;)</code></pre>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="#cb299-1"></a>second_join</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##       x     y     z
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     8     5     8
## 2     4     8     3
## 3     4     4     4</code></pre>
<ul>
<li><strong>Challenge</strong>
Why the above solution is not efficient?</li>
</ul>
</div>
<div id="reduce" class="section level3" number="5.4.4">
<h3 number="5.4.4"><span class="header-section-number">5.4.4</span> reduce</h3>
<div class="figure">
<img src="https://d33wubrfki0l68.cloudfront.net/9c239e1227c69b7a2c9c2df234c21f3e1c74dd57/eec0e/diagrams/functionals/reduce.png" alt="" />
<p class="caption">How reduce() works.</p>
</div>
<pre><code>- Input: Takes a vector of length n

- Computation: Calls a function with a pair of values at a time

- Output: Returns a vector of length 1</code></pre>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="#cb302-1"></a>reduced &lt;-<span class="st"> </span><span class="kw">reduce</span>(<span class="kw">list</span>(df1, df2, df3), left_join)</span></code></pre></div>
<pre><code>## Joining, by = c(&quot;x&quot;, &quot;y&quot;, &quot;z&quot;)
## Joining, by = c(&quot;x&quot;, &quot;y&quot;, &quot;z&quot;)</code></pre>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="#cb304-1"></a>reduced</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##       x     y     z
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     8     5     8
## 2     4     8     3
## 3     4     4     4</code></pre>
</div>
</div>
<div id="make-automation-slower-or-faster" class="section level2" number="5.5">
<h2 number="5.5"><span class="header-section-number">5.5</span> Make automation slower or faster</h2>
<div id="objectives-2" class="section level3" number="5.5.1">
<h3 number="5.5.1"><span class="header-section-number">5.5.1</span> Objectives</h3>
<ul>
<li>Learning how to use <code>slowly()</code> and <code>future_</code> to make automation process either slower or faster</li>
</ul>
</div>
<div id="how-to-make-automation-slower" class="section level3" number="5.5.2">
<h3 number="5.5.2"><span class="header-section-number">5.5.2</span> How to make automation slower</h3>
<ul>
<li>Scraping 50 pages from a website and you don’t want to overload the server. How can you do that?</li>
</ul>
</div>
<div id="for-loop-1" class="section level3" number="5.5.3">
<h3 number="5.5.3"><span class="header-section-number">5.5.3</span> For loop</h3>
</div>
<div id="map" class="section level3" number="5.5.4">
<h3 number="5.5.4"><span class="header-section-number">5.5.4</span> Map</h3>
<ul>
<li><p><code>walk()</code> works same as <code>map()</code> but doesn’t store its output.</p></li>
<li><p>If you’re web scraping, one problem with this approach is it’s too fast by human standards.</p></li>
<li><p>If you want to make the function run slowly …</p></li>
</ul>
<blockquote>
<p>slowly() takes a function and modifies it to wait a given amount of time between each call. - <code>purrr</code> package vignette
- If a function is a verb, then a helper function is an adverb (modifying the behavior of the verb).</p>
</blockquote>
</div>
<div id="how-to-make-automation-faster" class="section level3" number="5.5.5">
<h3 number="5.5.5"><span class="header-section-number">5.5.5</span> How to make automation Faster</h3>
<p>In a different situation, you want to make your function run faster. This is a common situation when you collect and analyze data at large-scale. You can solve this problem using parallel processing. For more on the parallel processing in R, read <a href="https://yxue-me.com/post/2019-05-12-a-glossary-of-parallel-computing-packages-in-r-2019/">this review</a>.</p>
<ul>
<li><p>Parallel processing setup</p>
<ul>
<li><p>Step1: Determine the number of max workers (<code>availableCores()</code>)</p></li>
<li><p>Step2: Determine the parallel processing mode (<code>plan()</code>)</p></li>
</ul></li>
</ul>
</div>
</div>
<div id="make-error-handling-easier" class="section level2" number="5.6">
<h2 number="5.6"><span class="header-section-number">5.6</span> Make error handling easier</h2>
<div id="learning-objective" class="section level3" number="5.6.1">
<h3 number="5.6.1"><span class="header-section-number">5.6.1</span> Learning objective</h3>
<ul>
<li><p>Learning how to use <code>safely()</code> and <code>possibly()</code> to make error handling easier
### Problem</p></li>
<li><p><strong>Challenge</strong></p></li>
<li><p>Explain why we can’t run <code>map(url_lists, read_html)</code></p></li>
</ul>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1"></a>url_lists &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb306-2"><a href="#cb306-2"></a>  <span class="st">&quot;https://en.wikipedia.org/wiki/University_of_California,_Berkeley&quot;</span>,</span>
<span id="cb306-3"><a href="#cb306-3"></a>  <span class="st">&quot;https://en.wikipedia.org/wiki/Stanford_University&quot;</span>,</span>
<span id="cb306-4"><a href="#cb306-4"></a>  <span class="st">&quot;https://en.wikipedia.org/wiki/Carnegie_Mellon_University&quot;</span>,</span>
<span id="cb306-5"><a href="#cb306-5"></a>  <span class="st">&quot;https://DLAB&quot;</span></span>
<span id="cb306-6"><a href="#cb306-6"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="#cb307-1"></a><span class="kw">map</span>(url_lists, read_html)</span></code></pre></div>
<ul>
<li>This is a very simple problem so it’s easy to tell where the problem is. How can you make your error more informative?</li>
</ul>
</div>
<div id="solution-1" class="section level3" number="5.6.2">
<h3 number="5.6.2"><span class="header-section-number">5.6.2</span> Solution</h3>
<div id="try-catch" class="section level4" number="5.6.2.1">
<h4 number="5.6.2.1"><span class="header-section-number">5.6.2.1</span> Try-catch</h4>
<ul>
<li><p>There are three kinds of messages you will run into, if your code has an error based on the following functions.</p>
<ul>
<li><code>stop()</code>: errors; Functions must stop.</li>
<li><code>warning()</code>: warnings; Functions may still work. Nonetheless, something is possibly messed up.</li>
<li><code>message()</code>: messages; Some actions happened.</li>
</ul></li>
<li><p>The basic logic of <code>try-catch</code>, R’s basic error handling function, works like the following.</p></li>
</ul>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="#cb308-1"></a><span class="kw">tryCatch</span>(</span>
<span id="cb308-2"><a href="#cb308-2"></a>  {</span>
<span id="cb308-3"><a href="#cb308-3"></a>    <span class="kw">map</span>(url_lists, read_html)</span>
<span id="cb308-4"><a href="#cb308-4"></a>  },</span>
<span id="cb308-5"><a href="#cb308-5"></a>  <span class="dt">warning =</span> <span class="cf">function</span>(w) {</span>
<span id="cb308-6"><a href="#cb308-6"></a>    <span class="st">&quot;Warning&quot;</span></span>
<span id="cb308-7"><a href="#cb308-7"></a>  },</span>
<span id="cb308-8"><a href="#cb308-8"></a>  <span class="dt">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb308-9"><a href="#cb308-9"></a>    <span class="st">&quot;Error&quot;</span></span>
<span id="cb308-10"><a href="#cb308-10"></a>  },</span>
<span id="cb308-11"><a href="#cb308-11"></a>  <span class="dt">finally =</span> {</span>
<span id="cb308-12"><a href="#cb308-12"></a>    <span class="st">&quot;Message&quot;</span></span>
<span id="cb308-13"><a href="#cb308-13"></a>  }</span>
<span id="cb308-14"><a href="#cb308-14"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;Error&quot;</code></pre>
<ul>
<li>Here’s <code>purrr</code> version of the <code>try-catch</code> mechanism (evaluates code and assigns exception handlers).</li>
</ul>
</div>
<div id="safely" class="section level4" number="5.6.2.2">
<h4 number="5.6.2.2"><span class="header-section-number">5.6.2.2</span> safely</h4>
<p><strong>Outputs</strong></p>
<ul>
<li>result: result or <code>NULL</code></li>
<li>error: <code>NULL</code> or <code>error</code></li>
</ul>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="#cb310-1"></a><span class="kw">map</span>(url_lists, <span class="kw">safely</span>(read_html))</span></code></pre></div>
<pre><code>## [[1]]
## [[1]]$result
## NULL
## 
## [[1]]$error
## &lt;simpleError in open.connection(x, &quot;rb&quot;): Timeout was reached: [en.wikipedia.org] Connection timed out after 10001 milliseconds&gt;
## 
## 
## [[2]]
## [[2]]$result
## NULL
## 
## [[2]]$error
## &lt;simpleError in open.connection(x, &quot;rb&quot;): Timeout was reached: [en.wikipedia.org] Connection timed out after 10002 milliseconds&gt;
## 
## 
## [[3]]
## [[3]]$result
## NULL
## 
## [[3]]$error
## &lt;simpleError in open.connection(x, &quot;rb&quot;): Timeout was reached: [en.wikipedia.org] Connection timed out after 10001 milliseconds&gt;
## 
## 
## [[4]]
## [[4]]$result
## NULL
## 
## [[4]]$error
## &lt;simpleError in open.connection(x, &quot;rb&quot;): Could not resolve host: DLAB&gt;</code></pre>
<ul>
<li>The easier way to solve this problem is just avoiding the error.</li>
</ul>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="#cb312-1"></a><span class="kw">map</span>(url_lists, <span class="kw">safely</span>(read_html)) <span class="op">%&gt;%</span></span>
<span id="cb312-2"><a href="#cb312-2"></a><span class="st">  </span><span class="kw">map</span>(<span class="st">&quot;result&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb312-3"><a href="#cb312-3"></a><span class="st">  </span><span class="co"># = map(function(x) x[[&quot;result&quot;]]) = map(~.x[[&quot;name&quot;]])</span></span>
<span id="cb312-4"><a href="#cb312-4"></a><span class="st">  </span>purrr<span class="op">::</span><span class="kw">compact</span>() <span class="co"># Remove empty elements</span></span></code></pre></div>
<pre><code>## list()</code></pre>
</div>
<div id="possibly" class="section level4" number="5.6.2.3">
<h4 number="5.6.2.3"><span class="header-section-number">5.6.2.3</span> possibly</h4>
<p>What if the best way to solve the problem is not ignoring the error …</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="#cb314-1"></a><span class="co"># If error occurred, &quot;The URL is broken.&quot; will be stored in that element(s).</span></span>
<span id="cb314-2"><a href="#cb314-2"></a>out &lt;-<span class="st"> </span><span class="kw">map</span>(</span>
<span id="cb314-3"><a href="#cb314-3"></a>  url_lists,</span>
<span id="cb314-4"><a href="#cb314-4"></a>  <span class="kw">possibly</span>(read_html,</span>
<span id="cb314-5"><a href="#cb314-5"></a>    <span class="dt">otherwise =</span> <span class="st">&quot;The URL is broken.&quot;</span></span>
<span id="cb314-6"><a href="#cb314-6"></a>  )</span>
<span id="cb314-7"><a href="#cb314-7"></a>)</span>
<span id="cb314-8"><a href="#cb314-8"></a></span>
<span id="cb314-9"><a href="#cb314-9"></a><span class="co"># Let&#39;s find the broken URL.</span></span>
<span id="cb314-10"><a href="#cb314-10"></a>url_lists[out[<span class="kw">seq</span>(out)] <span class="op">==</span><span class="st"> &quot;The URL is broken.&quot;</span>]</span></code></pre></div>
<pre><code>## [1] &quot;https://en.wikipedia.org/wiki/University_of_California,_Berkeley&quot;
## [2] &quot;https://en.wikipedia.org/wiki/Stanford_University&quot;               
## [3] &quot;https://en.wikipedia.org/wiki/Carnegie_Mellon_University&quot;        
## [4] &quot;https://DLAB&quot;</code></pre>
</div>
</div>
</div>
<div id="developing-your-own-data-tools" class="section level2" number="5.7">
<h2 number="5.7"><span class="header-section-number">5.7</span> Developing your own data tools</h2>
<div id="why-developing-r-packages" class="section level3" number="5.7.1">
<h3 number="5.7.1"><span class="header-section-number">5.7.1</span> Why developing R packages?</h3>
<ol style="list-style-type: decimal">
<li>Reuse your code</li>
<li>Automate your workflow</li>
<li>Help others (be part of an open source development community)</li>
</ol>
</div>
<div id="workflow" class="section level3" number="5.7.2">
<h3 number="5.7.2"><span class="header-section-number">5.7.2</span> Workflow</h3>
<ol style="list-style-type: decimal">
<li>Write code in <code>\R</code></li>
<li>Document code in <code>\man</code> (automated by <code>roxygen2</code> package)</li>
</ol>
<ul>
<li><code>devtools::document()</code></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Check dependencies in <code>NAMESPACE</code></li>
</ol>
<ul>
<li><code>devtools::update()</code> updates the documentation</li>
<li><code>devtools::check()</code> to see whether your package is ready to be submitted to CRAN</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Build a package (for more information, read <a href="http://r-pkgs.had.co.nz/package.html">this section</a> in Hadley’s R package development book)</li>
</ol>
<ul>
<li><code>devtools::build()</code></li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li>(Optional) Test (<code>devtools::test()</code>), teach in <code>\vignettes</code>, and add data in <code>\data</code></li>
<li>Distribute the package either via CRAN or GitHub</li>
</ol>
<p>[]<a href="http://r-pkgs.had.co.nz/diagrams/package-files.png" class="uri">http://r-pkgs.had.co.nz/diagrams/package-files.png</a></p>
</div>
<div id="developing-an-r-package" class="section level3" number="5.7.3">
<h3 number="5.7.3"><span class="header-section-number">5.7.3</span> Developing an R package</h3>
<p>The 4 required components are necessary to build and distribute a minimally viable R package. The other steps are optional.</p>
</div>
<div id="required-components" class="section level3" number="5.7.4">
<h3 number="5.7.4"><span class="header-section-number">5.7.4</span> Required Components</h3>
<ul>
<li>Package
<ul>
<li><code>\R</code>: R functions</li>
<li><code>\man</code>: function documentations</li>
<li>DESCRIPTION: provides meta data about the package (e.g., author)</li>
<li>LICENSE
<ul>
<li>GNU, MIT, etc.</li>
</ul></li>
<li>NAMESPACE: package dependencies (to make your package self-contained)</li>
<li>README (optional)</li>
</ul></li>
</ul>
<ol style="list-style-type: decimal">
<li>Setup (<strong>DESCRIPTION</strong>)</li>
</ol>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="#cb316-1"></a><span class="co"># This function creates DESCRIPTION file </span></span>
<span id="cb316-2"><a href="#cb316-2"></a>usethis<span class="op">::</span><span class="kw">create_package</span>(<span class="kw">here</span>(<span class="st">&quot;mypkg&quot;</span>))</span>
<span id="cb316-3"><a href="#cb316-3"></a></span>
<span id="cb316-4"><a href="#cb316-4"></a><span class="co"># Initialize git repo </span></span>
<span id="cb316-5"><a href="#cb316-5"></a>usethis<span class="op">::</span><span class="kw">use_git</span>()</span>
<span id="cb316-6"><a href="#cb316-6"></a></span>
<span id="cb316-7"><a href="#cb316-7"></a><span class="co"># License the package </span></span>
<span id="cb316-8"><a href="#cb316-8"></a><span class="co"># You can use the MIT license by typing devtools::use_mit_license(&quot;author name&quot;). The function produces MIT license related files (LICENSE, LICENSE.md).</span></span>
<span id="cb316-9"><a href="#cb316-9"></a><span class="kw">use_mit_license</span>(<span class="st">&quot;Jae Yeon Kim&quot;</span>)</span>
<span id="cb316-10"><a href="#cb316-10"></a></span>
<span id="cb316-11"><a href="#cb316-11"></a><span class="co"># Add README (optional)</span></span>
<span id="cb316-12"><a href="#cb316-12"></a><span class="co"># Makes the package more use-friendly </span></span>
<span id="cb316-13"><a href="#cb316-13"></a><span class="kw">use_readme_md</span>()</span>
<span id="cb316-14"><a href="#cb316-14"></a></span>
<span id="cb316-15"><a href="#cb316-15"></a><span class="co"># Add news (optional) </span></span>
<span id="cb316-16"><a href="#cb316-16"></a><span class="co"># Helps track changes </span></span>
<span id="cb316-17"><a href="#cb316-17"></a><span class="kw">use_news_md</span>() </span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Write code (<strong>R</strong>)</li>
</ol>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="#cb317-1"></a>usethis<span class="op">::</span><span class="kw">use_r</span>(<span class="st">&quot;rbind_mutate&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="#cb318-1"></a><span class="co">#&#39; Add two numbers</span></span>
<span id="cb318-2"><a href="#cb318-2"></a><span class="co">#&#39;</span></span>
<span id="cb318-3"><a href="#cb318-3"></a><span class="co">#&#39; @param x A number</span></span>
<span id="cb318-4"><a href="#cb318-4"></a><span class="co">#&#39; @param y A number</span></span>
<span id="cb318-5"><a href="#cb318-5"></a><span class="co">#&#39; @return The sum of x and y </span></span>
<span id="cb318-6"><a href="#cb318-6"></a><span class="co">#&#39; @export</span></span>
<span id="cb318-7"><a href="#cb318-7"></a></span>
<span id="cb318-8"><a href="#cb318-8"></a>add &lt;-<span class="st"> </span><span class="cf">function</span>(x, y){</span>
<span id="cb318-9"><a href="#cb318-9"></a>  </span>
<span id="cb318-10"><a href="#cb318-10"></a>  x <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb318-11"><a href="#cb318-11"></a>  </span>
<span id="cb318-12"><a href="#cb318-12"></a>}</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Document (<strong>man</strong>)</li>
</ol>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="#cb319-1"></a><span class="co"># Document </span></span>
<span id="cb319-2"><a href="#cb319-2"></a><span class="co"># The function creates documentation related files (NAMESPACE, function_name.rd)</span></span>
<span id="cb319-3"><a href="#cb319-3"></a>devtools<span class="op">::</span><span class="kw">document</span>()</span>
<span id="cb319-4"><a href="#cb319-4"></a></span>
<span id="cb319-5"><a href="#cb319-5"></a><span class="co"># Load all </span></span>
<span id="cb319-6"><a href="#cb319-6"></a>devtools<span class="op">::</span><span class="kw">load_all</span>()</span>
<span id="cb319-7"><a href="#cb319-7"></a></span>
<span id="cb319-8"><a href="#cb319-8"></a><span class="co"># Check </span></span>
<span id="cb319-9"><a href="#cb319-9"></a>devtools<span class="op">::</span><span class="kw">check</span>()</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Organize (<strong>NAMESPACE</strong>)</li>
</ol>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="#cb320-1"></a>usethis<span class="op">::</span><span class="kw">use_package</span>(<span class="st">&quot;dplyr&quot;</span>)</span></code></pre></div>
</div>
<div id="optional-components" class="section level3" number="5.7.5">
<h3 number="5.7.5"><span class="header-section-number">5.7.5</span> Optional Components</h3>
<ol style="list-style-type: decimal">
<li>Test (<strong>test</strong>)</li>
</ol>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="#cb321-1"></a>usethis<span class="op">::</span><span class="kw">use_testthat</span>()</span>
<span id="cb321-2"><a href="#cb321-2"></a></span>
<span id="cb321-3"><a href="#cb321-3"></a>usethis<span class="op">::</span><span class="kw">use_test</span>(<span class="st">&quot;rbind_mutate&quot;</span>)</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Add data (<strong>data</strong>)</li>
</ol>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="#cb322-1"></a>x &lt;-<span class="st"> &quot;Jae&quot;</span></span>
<span id="cb322-2"><a href="#cb322-2"></a>y &lt;-<span class="st"> &quot;Sun&quot;</span></span>
<span id="cb322-3"><a href="#cb322-3"></a>z &lt;-<span class="st"> &quot;Jane&quot;</span></span>
<span id="cb322-4"><a href="#cb322-4"></a></span>
<span id="cb322-5"><a href="#cb322-5"></a>usethis<span class="op">::</span><span class="kw">use_data</span>(x, y, z, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Teach (<strong>vignetts</strong>)</li>
</ol>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="#cb323-1"></a>usethis<span class="op">::</span><span class="kw">use_vignette</span>(<span class="st">&quot;rbind_mutate&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="#cb324-1"></a>title<span class="op">:</span><span class="st"> &quot;Vignette title&quot;</span></span>
<span id="cb324-2"><a href="#cb324-2"></a>author<span class="op">:</span><span class="st"> &quot;Vignette author&quot;</span></span>
<span id="cb324-3"><a href="#cb324-3"></a>date<span class="op">:</span><span class="st"> &quot;2020-09-30&quot;</span></span>
<span id="cb324-4"><a href="#cb324-4"></a>output<span class="op">:</span><span class="st"> </span>rmarkdown<span class="op">::</span>html_vignette</span>
<span id="cb324-5"><a href="#cb324-5"></a>vignette<span class="op">:</span><span class="st"> </span>blah blah</span></code></pre></div>
<ul>
<li>You can build a package website using <code>pkgdown</code></li>
</ul>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="#cb325-1"></a><span class="co"># install.packages(&quot;pkgdown&quot;)</span></span>
<span id="cb325-2"><a href="#cb325-2"></a>usethis<span class="op">::</span><span class="kw">use_pkgdown</span>()</span>
<span id="cb325-3"><a href="#cb325-3"></a>pkgdown<span class="op">::</span><span class="kw">build_site</span>()</span></code></pre></div>
<ul>
<li>A package site includes information on METADATA, Function references, Articles, News, etc.</li>
</ul>
</div>
<div id="building-an-r-package" class="section level3" number="5.7.6">
<h3 number="5.7.6"><span class="header-section-number">5.7.6</span> Building an R package</h3>
<ul>
<li>CMD (in the terminal)</li>
</ul>
<p>You can run R commands in the terminal using R CMD.</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb326-1"><a href="#cb326-1"></a><span class="ex">R</span> CMD build mypkg </span>
<span id="cb326-2"><a href="#cb326-2"></a><span class="ex">R</span> CMD INSTALL mypkg </span></code></pre></div>
<ul>
<li>devtools</li>
</ul>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="#cb327-1"></a><span class="co"># Build </span></span>
<span id="cb327-2"><a href="#cb327-2"></a>devtools<span class="op">::</span><span class="kw">build</span>()</span>
<span id="cb327-3"><a href="#cb327-3"></a></span>
<span id="cb327-4"><a href="#cb327-4"></a><span class="co"># Install </span></span>
<span id="cb327-5"><a href="#cb327-5"></a>devtools<span class="op">::</span><span class="kw">install</span>()</span></code></pre></div>
</div>
<div id="distributing-an-r-package" class="section level3" number="5.7.7">
<h3 number="5.7.7"><span class="header-section-number">5.7.7</span> Distributing an R package</h3>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="#cb328-1"></a><span class="co"># Version update </span></span>
<span id="cb328-2"><a href="#cb328-2"></a>usethis<span class="op">::</span><span class="kw">use_version</span>()</span>
<span id="cb328-3"><a href="#cb328-3"></a></span>
<span id="cb328-4"><a href="#cb328-4"></a><span class="co"># Spell check</span></span>
<span id="cb328-5"><a href="#cb328-5"></a>usethis<span class="op">::</span><span class="kw">use_spell_check</span>()</span></code></pre></div>
<ol style="list-style-type: decimal">
<li><a href="https://cran.r-project.org/">CRAN (The Comprehensive R Archive Network)</a></li>
</ol>
<ul>
<li>R package submission should comply with <a href="https://cran.r-project.org/">the CRAN Repository Policy</a></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>GitHub</li>
</ol>
<ul>
<li>Push everything to the Git repository (you can do it using command-line interface or RStudio).</li>
</ul>
<div class="sourceCode" id="cb329"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb329-1"><a href="#cb329-1"></a><span class="fu">git</span> add . </span>
<span id="cb329-2"><a href="#cb329-2"></a><span class="fu">git</span> commit -m <span class="st">&quot;first push&quot;</span></span>
<span id="cb329-3"><a href="#cb329-3"></a><span class="fu">git</span> push </span></code></pre></div>
<ul>
<li>Don’t forget that your repository should be <code>public</code>.</li>
<li>I highly recommend connecting GitHub with SSH. For more information, visit <a href="https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh">this link</a>.</li>
</ul>
<div class="sourceCode" id="cb330"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb330-1"><a href="#cb330-1"></a><span class="fu">git</span> remote set-url origin git@github.com:user/repo </span></code></pre></div>
<!--chapter:end:03_functional_programming.Rmd-->
</div>
</div>
</div>
<div id="semi_structured_data" class="section level1" number="6">
<h1 number="6"><span class="header-section-number">6</span> Semi-structured data</h1>
<div id="objectives" class="section level2" number="6.1">
<h2 number="6.1"><span class="header-section-number">6.1</span> Objectives</h2>
<ul>
<li>Automating the process of turning semi-structured data (input) into structured data (output)</li>
</ul>
</div>
<div id="what-is-semi-structured-data" class="section level2" number="6.2">
<h2 number="6.2"><span class="header-section-number">6.2</span> What is semi-structured data?</h2>
<blockquote>
<p>Semi-structured data is a form of structured data that does not obey the tabular structure of data models associated with relational databases or other forms of data tables, but nonetheless contains tags or other markers to separate semantic elements and enforce hierarchies of records and fields within the data. Therefore, it is also known as self-describing structure. - <a href="https://en.wikipedia.org/wiki/Semi-structured_data#:~:text=Semi%2Dstructured%20data%20is%20a,and%20fields%20within%20the%20data.">Wikipedia</a></p>
</blockquote>
<ul>
<li><p>Examples: <code>HTML (Hypertext Markup Language)</code> files (e.g., websites) and <code>JSON (JavaScript Object Notation)</code> files (e.g., tweets)</p></li>
<li><p>Why should we care semi-structured data?</p>
<ul>
<li>Because this is what the data frontier looks like: # of unstructured data &gt; # of semi-structured data &gt; # of structured data</li>
<li>There are easy and fast ways to turn semi-structured data into structured data (ideally in a tidy format) using R, Python, and command-line tools. See my own examples (<a href="https://github.com/jaeyk/tidyethnicnews">tidyethnicnews</a> and <a href="https://github.com/jaeyk/tidytweetjson">tidytweetjson</a>).</li>
</ul></li>
</ul>
</div>
<div id="workflow" class="section level2" number="6.3">
<h2 number="6.3"><span class="header-section-number">6.3</span> Workflow</h2>
<ol style="list-style-type: decimal">
<li><p>Import/connect to a semi-structured file using <code>rvest,</code> <code>jsonlite,</code> <code>xml2,</code> <code>pdftools,</code> <code>tidyjson</code>, etc.</p></li>
<li><p>Define target elements in the single file and extract them</p></li>
</ol>
<ul>
<li><p><a href="https://readr.tidyverse.org/"><code>readr</code></a> package providers <code>parse_</code> functions that are useful for vector parsing.</p></li>
<li><p><a href="https://stringr.tidyverse.org/"><code>stringr</code></a> package for string manipulations (e.g., using regular expressions in a tidy way). Quite useful for parsing PDF files (see <a href="https://themockup.blog/posts/2020-04-03-beer-and-pdftools-a-vignette/">this example</a>).</p></li>
<li><p><a href="https://github.com/tidyverse/rvest"><code>rvest</code></a> package for parsing HTML (R equivalent to <code>beautiful soup</code> in Python)</p></li>
<li><p><a href="https://github.com/sailthru/tidyjson"><code>tidyjson</code></a> package for parsing JSON data</p></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><p>Create a list of files (in this case URLs) to parse</p></li>
<li><p>Write a parsing function</p></li>
<li><p>Automate parsing process</p></li>
</ol>
</div>
<div id="htmlcss-web-scraping" class="section level2" number="6.4">
<h2 number="6.4"><span class="header-section-number">6.4</span> HTML/CSS: web scraping</h2>
</div>
<div id="xmljson-social-media-scraping" class="section level2" number="6.5">
<h2 number="6.5"><span class="header-section-number">6.5</span> XML/JSON: social media scraping</h2>
<div id="api" class="section level3" number="6.5.1">
<h3 number="6.5.1"><span class="header-section-number">6.5.1</span> API</h3>
<div id="objectives-1" class="section level4" number="6.5.1.1">
<h4 number="6.5.1.1"><span class="header-section-number">6.5.1.1</span> Objectives</h4>
<ul>
<li>Learning what kind of social media data are accessible through application programming interfaces (APIs)</li>
</ul>
<p><strong>Review question</strong></p>
<p>In the previous session, we learned the difference between semi-structured data and structured data. Can anyone tell us the difference between them?</p>
</div>
<div id="the-big-picture-for-digital-data-collection" class="section level4" number="6.5.1.2">
<h4 number="6.5.1.2"><span class="header-section-number">6.5.1.2</span> The big picture for digital data collection</h4>
<ol style="list-style-type: decimal">
<li><p>Input: semi-structured data</p></li>
<li><p>Output: structured data</p></li>
<li><p>Process:</p>
<ul>
<li>Getting <strong>target data</strong> from a remote server
<ul>
<li>The target data is usually huge (&gt;10GB) by the traditional social science standard.</li>
</ul></li>
<li>Parsing the target data your laptop/database
<ul>
<li>Laptop (sample-parse): Downsamle the large target data and parse it on your laptop. This is just one option to <a href="https://rviews.rstudio.com/2019/07/17/3-big-data-strategies-for-r/">deal with big data in R</a>. It’s a simple strategy as it doesn’t require storing target data in your own database.</li>
</ul></li>
<li>Database (push-parse): Push the large target data to a database, then explore, select, and filter it. If you were interested in using this option, then check out my <a href="https://github.com/dlab-berkeley/sql-for-r-users">SQL for R Users</a> workshop.</li>
</ul></li>
</ol>
<div class="figure">
<img src="https://rviews.rstudio.com/post/2019-07-01-3-big-data-paradigms-for-r_files/sample_model.png" alt="" />
<p class="caption">Sample-Parse. From RStudio.</p>
</div>
<div class="figure">
<img src="https://rviews.rstudio.com/post/2019-07-01-3-big-data-paradigms-for-r_files/push_data.png" alt="" />
<p class="caption">Push-Parse. From RStudio.</p>
</div>
<ul>
<li><p>But what exactly is this target data?</p>
<ul>
<li><p>When you scrape websites, you mostly deal with HTML (defines a structure of a website), CSS (its style), and JavaScript (its dynamic interactions).</p></li>
<li><p>When you access social media data through API, you deal with either XML or JSON (major formats for storing and transporting data; they are light and flexible).</p></li>
<li><p>XML and JSON have tree-like (nested; a root and branches) structures and keys and values (or elements and attributes).</p></li>
<li><p>If HTML, CSS, and JavaScript are storefronts, then XML and JSON are warehouses.</p></li>
</ul></li>
</ul>
<div class="figure">
<img src="https://upload.wikimedia.org/wikipedia/commons/9/97/Automatisches_Kleinteilelager.jpg" alt="" />
<p class="caption">By Andreas Praefcke (Own work), via Wikimedia Commons</p>
</div>
</div>
<div id="opportunities-and-challenges-for-parsing-social-media-data" class="section level4" number="6.5.1.3">
<h4 number="6.5.1.3"><span class="header-section-number">6.5.1.3</span> Opportunities and challenges for parsing social media data</h4>
<p>This explanation draws on Pablo Barbara’s <a href="http://pablobarbera.com/social-media-workshop/social-media-slides.pdf">LSE social media workshop slides</a>.</p>
<p><strong>Basic information</strong></p>
<ul>
<li>What is an API?: An interface (you can think of it as something akin to a restaurant menu. API parameters are menu items.)
<ul>
<li><a href="https://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> (Representational state transfer) API: static information (e.g., user profiles, list of followers and friends)
<ul>
<li>R packages: <a href="https://github.com/pablobarbera/twitter_ideology/tree/master/pkg/tweetscores">tweetscores</a>, <a href="https://cran.r-project.org/web/packages/twitteR/twitteR.pdf">twitteR</a>, <a href="https://github.com/ropensci/rtweet">rtweet</a></li>
</ul></li>
<li><a href="https://blog.axway.com/amplify/api-management/streaming-apis#:~:text=Streaming%20APIs%20are%20used%20to,a%20subset%20of%20Streaming%20APIS.">Streaming API</a>: dynamic information (e..g, new tweets)
<ul>
<li>This streaming data is filtered by (1) keywords, (2) location, and (3) sample (1% of the total tweets)</li>
<li>R packages: <a href="https://github.com/pablobarbera/streamR">streamR</a></li>
</ul></li>
</ul></li>
</ul>
<p><strong>Status</strong></p>
<ul>
<li>Twitter API is still widely accessible (<a href="https://developer.twitter.com/en/docs/twitter-api/early-access">v2</a> recently released; new fields available such as <a href="https://developer.twitter.com/en/docs/twitter-api/conversation-id">conversation threads</a>).</li>
</ul>
<blockquote>
<p>Twitter data is unique from data shared by most other social platforms because it reflects information that users <em>choose</em> to share publicly. Our API platform provides broad access to public Twitter data that users have chosen to share with the world. - Twitter Help Center</p>
</blockquote>
<ul>
<li><p>What does this policy mean? If Twitter users don’t share the locations of their tweets (e.g., GPS), you can’t collect them.</p></li>
<li><p>Facebook API access has become much constrained with <a href="https://socialscience.one/blog/unprecedented-facebook-urls-dataset-now-available-research-through-social-science-one">the exception of Social Science One</a> since the 2016 U.S. election.</p></li>
<li><p><a href="https://developers.google.com/youtube/v3">YouTube API</a> access is somewhat limited (but you need to check as I’m not updated on this).</p></li>
</ul>
<p><strong>Upside</strong></p>
<ul>
<li>Legal and well-documented.</li>
</ul>
<p>Web scraping (Wild Wild West) &lt;&gt; API (Big Gated Garden)</p>
<ul>
<li><p>You have legal but limited access to (growing) big data that can be divided into text, image, and video and transformed into cross-sectional (geocodes), longitudinal (timestamps), and event historical data (hashtags). For more information, see Zachary C. Steinert-Threlkeld’s <a href="https://github.com/ZacharyST/APSA2020_EventDataFromSocialMedia">2020 APSA Short Course Generating Event Data From Social Media</a>.</p></li>
<li><p>Social media data are also well-organized, managed, and curated data. It’s easy to navigate because XML and JSON have keys and values. If you find keys, you will find observations you look for.</p></li>
</ul>
<p><strong>Downside</strong></p>
<ol style="list-style-type: decimal">
<li><p>Rate-limited.</p></li>
<li><p>If you want to access to more and various data than those available, you need to pay for premium access.</p></li>
</ol>
</div>
<div id="next-steps" class="section level4" number="6.5.1.4">
<h4 number="6.5.1.4"><span class="header-section-number">6.5.1.4</span> Next steps</h4>
<ul>
<li><p>If you want to know how to sign up a new Twitter developer account and access Twitter API, then see Steinert-Threlkeld’s <a href="https://github.com/ZacharyST/APSA2020_EventDataFromSocialMedia/blob/master/Presentation/02_AccessTwitter.pdf">APSA workshop slides</a>.</p></li>
<li><p>If you want to know about how to use <code>tweetscore</code> package, then see Pablo Barbara’s R markdown file for <a href="http://pablobarbera.com/social-media-workshop/code/02-twitter-REST-data-collection.html">scraping data from Twitter’s REST API</a></p></li>
</ul>
</div>
</div>
<div id="hydrating" class="section level3" number="6.5.2">
<h3 number="6.5.2"><span class="header-section-number">6.5.2</span> Hydrating</h3>
<div id="objectives-2" class="section level4" number="6.5.2.1">
<h4 number="6.5.2.1"><span class="header-section-number">6.5.2.1</span> Objectives</h4>
<ul>
<li>Learning how hydrating works</li>
<li>Learning how to use <a href="https://github.com/DocNow/twarc">Twarc</a> to communicate with Twitter’s API</li>
</ul>
<p><strong>Review question</strong></p>
<p>What are the main two types of Twitter’s API?</p>
</div>
<div id="hydrating-an-alternative-way-to-collect-historical-twitter-data" class="section level4" number="6.5.2.2">
<h4 number="6.5.2.2"><span class="header-section-number">6.5.2.2</span> Hydrating: An Alternative Way to Collect Historical Twitter Data</h4>
<ul>
<li><p>You can collect Twitter data using Twitter’s API or you can hydrate Tweet IDs collected by other researchers. This is a good resource to collect historical Twitter data.</p></li>
<li><p><a href="http://www.panacealab.org/covid19/">Covid-19 Twitter chatter dataset for scientic use</a> by Panacealab</p></li>
<li><p><a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/5ZVMOR">Women’s March Dataset</a> by Littman and Park</p></li>
<li><p>Harvard Dataverse has a number of dehydrated Tweet IDs that could be of interest to social scientists.</p></li>
</ul>
<div class="figure">
<img src="https://github.com/jaeyk/digital_data_collection_workshop/raw/master/misc/dehydrated_tweets.png" alt="" />
<p class="caption">Dehydrated Tweet IDs</p>
</div>
</div>
<div id="twarc-one-solution-to-almost-all-twitters-api-problems" class="section level4" number="6.5.2.3">
<h4 number="6.5.2.3"><span class="header-section-number">6.5.2.3</span> Twarc: one solution to (almost) all Twitter’s API problems</h4>
<ul>
<li><p>Why Twarc?</p>
<ul>
<li>A command-line tool and Python library that works for almost every Twitter’s API related problem.</li>
<li>It’s really well-documented, tested, and maintained.
<ul>
<li><a href="https://scholarslab.github.io/learn-twarc/06-twarc-command-basics">Twarc documentation</a> covers basic commands.</li>
<li><a href="https://twarc-cloud.readthedocs.io/_/downloads/en/stable/pdf/">Tward-cloud documentation</a> explains how to collect data from Twitter’s API using Twarc running in <a href="https://aws.amazon.com/">Amazon Web Services</a> (AWS).</li>
</ul></li>
<li>Twarc was developed as part of the <a href="https://www.docnow.io/">Documenting the Now</a> project which was funded by the Mellon Foundation.</li>
</ul></li>
</ul>
<div class="figure">
<img src="https://vignette.wikia.nocookie.net/lotr/images/8/8b/DOiAi2WUEAE3A1Y.0.jpg/revision/latest/scale-to-width-down/699?cb=20200305221819" alt="" />
<p class="caption">One ring that rules them all.</p>
</div>
<ul>
<li><p>There’s no reason to be afraid of using a command-line tool and Python library, even though you primarily use R. It’s easy to embed <a href="https://bookdown.org/yihui/rmarkdown/language-engines.html#python">Python code</a> and <a href="https://bookdown.org/yihui/rmarkdown/language-engines.html#shell-scripts">shell scripts</a> in R Markdown.</p></li>
<li><p>Even though you don’t know how to write Python code or shell scripts, it’s really useful to know how to integrate them in your R workflow.</p></li>
<li><p>I assume that you have already installed <a href="https://www.python.org/download/releases/3.0/">Python 3</a>.</p></li>
</ul>
<div class="sourceCode" id="cb331"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb331-1"><a href="#cb331-1"></a><span class="ex">pip3</span> install twarc</span></code></pre></div>
<div id="applications" class="section level5" number="6.5.2.3.1">
<h5 number="6.5.2.3.1"><span class="header-section-number">6.5.2.3.1</span> Applications</h5>
<p>The following examples are created by <a href="http://digitalcollecting.lib.virginia.edu/toolkit/docs/social-media/twarc-commands/">the University of Virginia library</a>.</p>
<div id="search" class="section level6" number="6.5.2.3.1.1">
<h6 number="6.5.2.3.1.1"><span class="header-section-number">6.5.2.3.1.1</span> Search</h6>
<ul>
<li><p>Download pre-existing tweets (7-day window) matching certain conditions</p></li>
<li><p>In command-line, <code>&gt;</code> = Create a file</p></li>
<li><p>I recommend running the following commands in the terminal because it’s more stable than doing so in R Markdown.</p></li>
</ul>
<div class="figure">
<img src="https://github.com/jaeyk/digital_data_collection_workshop/raw/master/misc/terminal.png" alt="" />
<p class="caption">You can type commands in the Terminal in R Studio.</p>
</div>
<div class="sourceCode" id="cb332"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb332-1"><a href="#cb332-1"></a><span class="co"># Key word </span></span>
<span id="cb332-2"><a href="#cb332-2"></a><span class="ex">twarc</span> search blacklivesmatter <span class="op">&gt;</span> blm_tweets.jsonl</span></code></pre></div>
<div class="sourceCode" id="cb333"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb333-1"><a href="#cb333-1"></a><span class="co"># Hashtag </span></span>
<span id="cb333-2"><a href="#cb333-2"></a><span class="ex">twarc</span> search <span class="st">&#39;#blacklivesmatter&#39;</span> <span class="op">&gt;</span> blm_tweets_hash.jsonl</span></code></pre></div>
<div class="sourceCode" id="cb334"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb334-1"><a href="#cb334-1"></a><span class="co"># Hashtag + Language </span></span>
<span id="cb334-2"><a href="#cb334-2"></a><span class="ex">twarc</span> search <span class="st">&#39;#blacklivesmatter&#39;</span> --lang en <span class="op">&gt;</span> blm_tweets_hash.jsonl</span></code></pre></div>
<ul>
<li>It is really important to <strong>save these tweets into a <code>jsonl</code> format;</strong> <code>jsonl</code> extension refers to JSON <strong>Lines</strong> files. This structure is useful for splitting JSON data into smaller chunks, if it is too large.</li>
</ul>
</div>
<div id="filter" class="section level6" number="6.5.2.3.1.2">
<h6 number="6.5.2.3.1.2"><span class="header-section-number">6.5.2.3.1.2</span> Filter</h6>
<ul>
<li>Download tweets meeting certain conditions as they happen.</li>
</ul>
<div class="sourceCode" id="cb335"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb335-1"><a href="#cb335-1"></a><span class="co"># Key word</span></span>
<span id="cb335-2"><a href="#cb335-2"></a><span class="ex">twarc</span> filter blacklivesmatter <span class="op">&gt;</span> blm_tweets.jsonl</span></code></pre></div>
</div>
<div id="sample" class="section level6" number="6.5.2.3.1.3">
<h6 number="6.5.2.3.1.3"><span class="header-section-number">6.5.2.3.1.3</span> Sample</h6>
<ul>
<li>Use Twitter’s random sample of recent tweets.</li>
</ul>
<div class="sourceCode" id="cb336"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb336-1"><a href="#cb336-1"></a><span class="ex">twarc</span> sample <span class="op">&gt;</span> tweets.jsonl </span></code></pre></div>
</div>
<div id="hydrate" class="section level6" number="6.5.2.3.1.4">
<h6 number="6.5.2.3.1.4"><span class="header-section-number">6.5.2.3.1.4</span> Hydrate</h6>
<ul>
<li>Tweet IDs -&gt; Tweets</li>
</ul>
<div class="sourceCode" id="cb337"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb337-1"><a href="#cb337-1"></a><span class="ex">twarc</span> hydrate tweet_ids.txt <span class="op">&gt;</span> tweets.jsonl </span></code></pre></div>
</div>
<div id="dehydrate" class="section level6" number="6.5.2.3.1.5">
<h6 number="6.5.2.3.1.5"><span class="header-section-number">6.5.2.3.1.5</span> Dehydrate</h6>
<ul>
<li>Hydrate &lt;&gt; Dehydrate</li>
<li>Tweets -&gt; Tweet IDs</li>
</ul>
<div class="sourceCode" id="cb338"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb338-1"><a href="#cb338-1"></a><span class="ex">twarc</span> dehydrate tweets.jsonl <span class="op">&gt;</span> tweet_ids.txt</span></code></pre></div>
<p><strong>Challenge</strong></p>
<ol style="list-style-type: decimal">
<li><p>Collect tweets contain some key words of your choice using <code>twarc search</code> and save them as <code>tweets.jsonl</code>.</p></li>
<li><p>Using <code>less</code> command in the terminal, inspect <code>twarc.log</code>.</p></li>
<li><p>Using <code>less</code> command in the terminal, inspect <code>tweets.json</code>.</p></li>
</ol>
</div>
</div>
</div>
</div>
<div id="parsing-json" class="section level3" number="6.5.3">
<h3 number="6.5.3"><span class="header-section-number">6.5.3</span> Parsing JSON</h3>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="#cb339-1"></a><span class="co"># Install packages </span></span>
<span id="cb339-2"><a href="#cb339-2"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;pacman&quot;</span>)) <span class="kw">install.packages</span>(<span class="st">&quot;pacman&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: pacman</code></pre>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="#cb341-1"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(tidyverse, <span class="co"># tidyverse pkgs including purrr</span></span>
<span id="cb341-2"><a href="#cb341-2"></a>               furrr, <span class="co"># parallel processing </span></span>
<span id="cb341-3"><a href="#cb341-3"></a>               tictoc, <span class="co"># performance test  </span></span>
<span id="cb341-4"><a href="#cb341-4"></a>               tcltk, <span class="co"># GUI for choosing a dir path </span></span>
<span id="cb341-5"><a href="#cb341-5"></a>               tidyjson) <span class="co"># tidying JSON files </span></span>
<span id="cb341-6"><a href="#cb341-6"></a></span>
<span id="cb341-7"><a href="#cb341-7"></a><span class="co">## Install the current development version from GitHub</span></span>
<span id="cb341-8"><a href="#cb341-8"></a>devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;jaeyk/tidytweetjson&quot;</span>,</span>
<span id="cb341-9"><a href="#cb341-9"></a>                         <span class="dt">dependencies =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## Skipping install of &#39;tidytweetjson&#39; from a github remote, the SHA1 (3ab642b2) has not changed since last install.
##   Use `force = TRUE` to force installation</code></pre>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="#cb343-1"></a><span class="kw">library</span>(tidytweetjson)</span></code></pre></div>
<pre><code>## Warning: replacing previous import &#39;maps::map&#39; by &#39;purrr::map&#39; when loading
## &#39;tidytweetjson&#39;</code></pre>
<div id="objectives-3" class="section level4" number="6.5.3.1">
<h4 number="6.5.3.1"><span class="header-section-number">6.5.3.1</span> Objectives</h4>
<ul>
<li>Learning chunk and pull strategy</li>
<li>Learning how <code>tidyjson</code> works</li>
<li>Learning how to apply <code>tidyjson</code> to tweets</li>
</ul>
</div>
<div id="chunk-and-pull" class="section level4" number="6.5.3.2">
<h4 number="6.5.3.2"><span class="header-section-number">6.5.3.2</span> Chunk and Pull</h4>
<div id="problem" class="section level5" number="6.5.3.2.1">
<h5 number="6.5.3.2.1"><span class="header-section-number">6.5.3.2.1</span> Problem</h5>
<ul>
<li>What if the size of the Twitter data you downloaded is too big (e.g., &gt;10GB) to do complex wrangling in R?</li>
</ul>
</div>
<div id="solution" class="section level5" number="6.5.3.2.2">
<h5 number="6.5.3.2.2"><span class="header-section-number">6.5.3.2.2</span> Solution</h5>
<div class="figure">
<img src="https://rviews.rstudio.com/post/2019-07-01-3-big-data-paradigms-for-r_files/chunk_pull.png" alt="" />
<p class="caption">Chunk and Pull. From Studio.</p>
</div>
<p>Step1: Split the large JSON file in small chunks.</p>
<div class="sourceCode" id="cb345"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb345-1"><a href="#cb345-1"></a><span class="co">#Divide the JSON file by 100 lines (tweets)</span></span>
<span id="cb345-2"><a href="#cb345-2"></a></span>
<span id="cb345-3"><a href="#cb345-3"></a><span class="co"># Linux and Windows (in Bash)</span></span>
<span id="cb345-4"><a href="#cb345-4"></a>$ <span class="fu">split</span> -100 search.jsonl</span>
<span id="cb345-5"><a href="#cb345-5"></a></span>
<span id="cb345-6"><a href="#cb345-6"></a><span class="co"># macOS</span></span>
<span id="cb345-7"><a href="#cb345-7"></a>$ <span class="ex">gsplit</span> -100 search.jsonl</span></code></pre></div>
<ul>
<li>After that, you will see several files appeared in the directory. Each of these files should have 100 tweets or fewer. All of these file names <strong>should start with “x”, as in “xaa”.</strong></li>
</ul>
<p>Step 2: Apply the parsing function to each chunk and pull all of these chunks together.</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="#cb346-1"></a><span class="co"># You need to choose a Tweet JSON file</span></span>
<span id="cb346-2"><a href="#cb346-2"></a>filepath &lt;-<span class="st"> </span><span class="kw">file.choose</span>()</span>
<span id="cb346-3"><a href="#cb346-3"></a></span>
<span id="cb346-4"><a href="#cb346-4"></a><span class="co"># Assign the parsed result to the `df` object</span></span>
<span id="cb346-5"><a href="#cb346-5"></a><span class="co"># 11.28 sec elapsed to parse 17,928 tweets </span></span>
<span id="cb346-6"><a href="#cb346-6"></a><span class="kw">tic</span>()</span>
<span id="cb346-7"><a href="#cb346-7"></a>df &lt;-<span class="st"> </span><span class="kw">jsonl_to_df</span>(filepath)</span>
<span id="cb346-8"><a href="#cb346-8"></a><span class="kw">toc</span>()</span></code></pre></div>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb347-1"><a href="#cb347-1"></a><span class="co"># Setup </span></span>
<span id="cb347-2"><a href="#cb347-2"></a>n_cores &lt;-<span class="st"> </span><span class="kw">availableCores</span>() <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb347-3"><a href="#cb347-3"></a></span>
<span id="cb347-4"><a href="#cb347-4"></a>n_cores <span class="co"># This number depends on your computer spec.</span></span>
<span id="cb347-5"><a href="#cb347-5"></a></span>
<span id="cb347-6"><a href="#cb347-6"></a><span class="kw">plan</span>(multiprocess, <span class="co"># multicore, if supported, otherwise multisession</span></span>
<span id="cb347-7"><a href="#cb347-7"></a>     <span class="dt">workers =</span> n_cores) <span class="co"># the maximum number of workers</span></span>
<span id="cb347-8"><a href="#cb347-8"></a></span>
<span id="cb347-9"><a href="#cb347-9"></a><span class="co"># You need to designate a directory path where you saved the list of JSON files.</span></span>
<span id="cb347-10"><a href="#cb347-10"></a></span>
<span id="cb347-11"><a href="#cb347-11"></a><span class="co"># 9.385 sec elapsed to parse 17,928 tweets </span></span>
<span id="cb347-12"><a href="#cb347-12"></a></span>
<span id="cb347-13"><a href="#cb347-13"></a>dirpath &lt;-<span class="st"> </span>tcltk<span class="op">::</span><span class="kw">tk_choose.dir</span>()</span>
<span id="cb347-14"><a href="#cb347-14"></a></span>
<span id="cb347-15"><a href="#cb347-15"></a><span class="kw">tic</span>()</span>
<span id="cb347-16"><a href="#cb347-16"></a>df_all &lt;-<span class="st"> </span>tidytweetjson<span class="op">::</span><span class="kw">jsonl_to_df_all</span>(dirpath)</span>
<span id="cb347-17"><a href="#cb347-17"></a><span class="kw">toc</span>()</span></code></pre></div>
</div>
<div id="tidyjson" class="section level5" number="6.5.3.2.3">
<h5 number="6.5.3.2.3"><span class="header-section-number">6.5.3.2.3</span> tidyjson</h5>
<p>The <a href="https://cran.r-project.org/web/packages/tidyjson/vignettes/introduction-to-tidyjson.html"><code>tidyjson</code></a> package helps to use tidyverse framework to JSON data.</p>
<ul>
<li>toy example</li>
</ul>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="#cb348-1"></a><span class="co"># JSON collection; nested structure + keys and values </span></span>
<span id="cb348-2"><a href="#cb348-2"></a>worldbank[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] &quot;{\&quot;_id\&quot;:{\&quot;$oid\&quot;:\&quot;52b213b38594d8a2be17c780\&quot;},\&quot;boardapprovaldate\&quot;:\&quot;2013-11-12T00:00:00Z\&quot;,\&quot;closingdate\&quot;:\&quot;2018-07-07T00:00:00Z\&quot;,\&quot;countryshortname\&quot;:\&quot;Ethiopia\&quot;,\&quot;majorsector_percent\&quot;:[{\&quot;Name\&quot;:\&quot;Education\&quot;,\&quot;Percent\&quot;:46},{\&quot;Name\&quot;:\&quot;Education\&quot;,\&quot;Percent\&quot;:26},{\&quot;Name\&quot;:\&quot;Public Administration, Law, and Justice\&quot;,\&quot;Percent\&quot;:16},{\&quot;Name\&quot;:\&quot;Education\&quot;,\&quot;Percent\&quot;:12}],\&quot;project_name\&quot;:\&quot;Ethiopia General Education Quality Improvement Project II\&quot;,\&quot;regionname\&quot;:\&quot;Africa\&quot;,\&quot;totalamt\&quot;:130000000}&quot;</code></pre>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="#cb350-1"></a><span class="co"># Check out keys (objects)</span></span>
<span id="cb350-2"><a href="#cb350-2"></a>worldbank <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb350-3"><a href="#cb350-3"></a><span class="st">  </span><span class="kw">as.tbl_json</span>() <span class="op">%&gt;%</span></span>
<span id="cb350-4"><a href="#cb350-4"></a><span class="st">  </span><span class="kw">gather_object</span>() <span class="op">%&gt;%</span></span>
<span id="cb350-5"><a href="#cb350-5"></a><span class="st">  </span><span class="kw">filter</span>(document.id <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</span></code></pre></div>
<pre><code>## # A tbl_json: 8 x 3 tibble with a &quot;JSON&quot; attribute
##   ..JSON                  document.id name               
##   &lt;chr&gt;                         &lt;int&gt; &lt;chr&gt;              
## 1 &quot;{\&quot;$oid\&quot;:\&quot;52b213...&quot;           1 _id                
## 2 &quot;\&quot;2013-11-12T00:...&quot;             1 boardapprovaldate  
## 3 &quot;\&quot;2018-07-07T00:...&quot;             1 closingdate        
## 4 &quot;\&quot;Ethiopia\&quot;&quot;                    1 countryshortname   
## 5 &quot;[{\&quot;Name\&quot;:\&quot;Educa...&quot;           1 majorsector_percent
## 6 &quot;\&quot;Ethiopia Gener...&quot;             1 project_name       
## 7 &quot;\&quot;Africa\&quot;&quot;                      1 regionname         
## 8 &quot;130000000&quot;                       1 totalamt</code></pre>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="#cb352-1"></a><span class="co"># Get the values associated with the keys </span></span>
<span id="cb352-2"><a href="#cb352-2"></a>worldbank <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb352-3"><a href="#cb352-3"></a><span class="st">  </span><span class="kw">as.tbl_json</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Turn JSON into tbl_json object </span></span>
<span id="cb352-4"><a href="#cb352-4"></a><span class="st">  </span><span class="kw">enter_object</span>(<span class="st">&quot;project_name&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Enter the objects </span></span>
<span id="cb352-5"><a href="#cb352-5"></a><span class="st">  </span><span class="kw">append_values_string</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Append the values </span></span>
<span id="cb352-6"><a href="#cb352-6"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="co"># To reduce the size of the file </span></span></code></pre></div>
<pre><code>## # A tibble: 500 x 2
##    document.id string                                                           
##          &lt;int&gt; &lt;chr&gt;                                                            
##  1           1 Ethiopia General Education Quality Improvement Project II        
##  2           2 TN: DTF Social Protection Reforms Support                        
##  3           3 Tuvalu Aviation Investment Project - Additional Financing        
##  4           4 Gov&#39;t and Civil Society Organization Partnership                 
##  5           5 Second Private Sector Competitiveness and Economic Diversificati…
##  6           6 Additional Financing for Cash Transfers for Orphans and Vulnerab…
##  7           7 National Highways Interconnectivity Improvement Project          
##  8           8 China Renewable Energy Scale-Up Program Phase II                 
##  9           9 Rajasthan Road Sector Modernization Project                      
## 10          10 MA Accountability and Transparency DPL                           
## # … with 490 more rows</code></pre>
<ul>
<li>The following example draws on my <a href="https://github.com/jaeyk/tidytweetjson">tidytweetjson</a> R package. The package applies <code>tidyjson</code> to Tweets.</li>
</ul>
<div id="individual-file" class="section level6" number="6.5.3.2.3.1">
<h6 number="6.5.3.2.3.1"><span class="header-section-number">6.5.3.2.3.1</span> Individual file</h6>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="#cb354-1"></a>jsonl_to_df &lt;-<span class="st"> </span><span class="cf">function</span>(file_path){</span>
<span id="cb354-2"><a href="#cb354-2"></a></span>
<span id="cb354-3"><a href="#cb354-3"></a><span class="co"># Save file name </span></span>
<span id="cb354-4"><a href="#cb354-4"></a></span>
<span id="cb354-5"><a href="#cb354-5"></a>file_name &lt;-<span class="st"> </span><span class="kw">strsplit</span>(<span class="dt">x =</span> file_path, </span>
<span id="cb354-6"><a href="#cb354-6"></a>                     <span class="dt">split =</span> <span class="st">&quot;[/]&quot;</span>) </span>
<span id="cb354-7"><a href="#cb354-7"></a></span>
<span id="cb354-8"><a href="#cb354-8"></a>file_name &lt;-<span class="st"> </span>file_name[[<span class="dv">1</span>]][<span class="kw">length</span>(file_name[[<span class="dv">1</span>]])]</span>
<span id="cb354-9"><a href="#cb354-9"></a></span>
<span id="cb354-10"><a href="#cb354-10"></a><span class="co"># Import a Tweet JSON file</span></span>
<span id="cb354-11"><a href="#cb354-11"></a></span>
<span id="cb354-12"><a href="#cb354-12"></a>listed &lt;-<span class="st"> </span><span class="kw">read_json</span>(file_path, <span class="dt">format =</span> <span class="kw">c</span>(<span class="st">&quot;jsonl&quot;</span>))</span>
<span id="cb354-13"><a href="#cb354-13"></a></span>
<span id="cb354-14"><a href="#cb354-14"></a><span class="co"># IDs of the tweets with country codes</span></span>
<span id="cb354-15"><a href="#cb354-15"></a></span>
<span id="cb354-16"><a href="#cb354-16"></a>ccodes &lt;-<span class="st"> </span>listed <span class="op">%&gt;%</span></span>
<span id="cb354-17"><a href="#cb354-17"></a><span class="st">  </span><span class="kw">enter_object</span>(<span class="st">&quot;place&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb354-18"><a href="#cb354-18"></a><span class="st">  </span><span class="kw">enter_object</span>(<span class="st">&quot;country_code&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb354-19"><a href="#cb354-19"></a><span class="st">  </span><span class="kw">append_values_string</span>() <span class="op">%&gt;%</span></span>
<span id="cb354-20"><a href="#cb354-20"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></span>
<span id="cb354-21"><a href="#cb354-21"></a><span class="st">  </span><span class="kw">rename</span>(<span class="st">&quot;country_code&quot;</span> =<span class="st"> &quot;string&quot;</span>)</span>
<span id="cb354-22"><a href="#cb354-22"></a></span>
<span id="cb354-23"><a href="#cb354-23"></a><span class="co"># IDs of the tweets with location</span></span>
<span id="cb354-24"><a href="#cb354-24"></a></span>
<span id="cb354-25"><a href="#cb354-25"></a>locations &lt;-<span class="st"> </span>listed <span class="op">%&gt;%</span></span>
<span id="cb354-26"><a href="#cb354-26"></a><span class="st">  </span><span class="kw">enter_object</span>(<span class="st">&quot;user&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb354-27"><a href="#cb354-27"></a><span class="st">  </span><span class="kw">enter_object</span>(<span class="st">&quot;location&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb354-28"><a href="#cb354-28"></a><span class="st">  </span><span class="kw">append_values_string</span>() <span class="op">%&gt;%</span></span>
<span id="cb354-29"><a href="#cb354-29"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></span>
<span id="cb354-30"><a href="#cb354-30"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">location =</span> <span class="st">&quot;string&quot;</span>)</span>
<span id="cb354-31"><a href="#cb354-31"></a></span>
<span id="cb354-32"><a href="#cb354-32"></a><span class="co"># Extract other key elements from the JSON file</span></span>
<span id="cb354-33"><a href="#cb354-33"></a></span>
<span id="cb354-34"><a href="#cb354-34"></a>df &lt;-<span class="st"> </span>listed <span class="op">%&gt;%</span></span>
<span id="cb354-35"><a href="#cb354-35"></a><span class="st">  </span><span class="kw">spread_values</span>(</span>
<span id="cb354-36"><a href="#cb354-36"></a>    <span class="dt">id =</span> <span class="kw">jnumber</span>(<span class="st">&quot;id&quot;</span>),</span>
<span id="cb354-37"><a href="#cb354-37"></a>    <span class="dt">created_at =</span> <span class="kw">jstring</span>(<span class="st">&quot;created_at&quot;</span>),</span>
<span id="cb354-38"><a href="#cb354-38"></a>    <span class="dt">full_text =</span> <span class="kw">jstring</span>(<span class="st">&quot;full_text&quot;</span>),</span>
<span id="cb354-39"><a href="#cb354-39"></a>    <span class="dt">retweet_count =</span> <span class="kw">jnumber</span>(<span class="st">&quot;retweet_count&quot;</span>),</span>
<span id="cb354-40"><a href="#cb354-40"></a>    <span class="dt">favorite_count =</span> <span class="kw">jnumber</span>(<span class="st">&quot;favorite_count&quot;</span>),</span>
<span id="cb354-41"><a href="#cb354-41"></a>    <span class="dt">user.followers_count =</span> <span class="kw">jnumber</span>(<span class="st">&quot;user.followers_count&quot;</span>),</span>
<span id="cb354-42"><a href="#cb354-42"></a>    <span class="dt">user.friends_count =</span> <span class="kw">jnumber</span>(<span class="st">&quot;user.friends_count&quot;</span>)</span>
<span id="cb354-43"><a href="#cb354-43"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb354-44"><a href="#cb354-44"></a>	  as_tibble</span>
<span id="cb354-45"><a href="#cb354-45"></a></span>
<span id="cb354-46"><a href="#cb354-46"></a><span class="kw">message</span>(<span class="kw">paste</span>(<span class="st">&quot;Parsing&quot;</span>, file_name, <span class="st">&quot;done.&quot;</span>))</span>
<span id="cb354-47"><a href="#cb354-47"></a></span>
<span id="cb354-48"><a href="#cb354-48"></a><span class="co"># Full join</span></span>
<span id="cb354-49"><a href="#cb354-49"></a>outcome &lt;-<span class="st"> </span><span class="kw">full_join</span>(ccodes, df) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">full_join</span>(locations)</span>
<span id="cb354-50"><a href="#cb354-50"></a></span>
<span id="cb354-51"><a href="#cb354-51"></a><span class="co"># Or you can write this way: outcome &lt;- reduce(list(df, ccodes, locations), full_join)</span></span>
<span id="cb354-52"><a href="#cb354-52"></a></span>
<span id="cb354-53"><a href="#cb354-53"></a><span class="co"># Select</span></span>
<span id="cb354-54"><a href="#cb354-54"></a>outcome <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="st">&quot;document.id&quot;</span>))}</span></code></pre></div>
</div>
<div id="many-files" class="section level6" number="6.5.3.2.3.2">
<h6 number="6.5.3.2.3.2"><span class="header-section-number">6.5.3.2.3.2</span> Many files</h6>
<ul>
<li>Set up parallel processing.</li>
</ul>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="#cb355-1"></a>n_cores &lt;-<span class="st"> </span><span class="kw">availableCores</span>() <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb355-2"><a href="#cb355-2"></a></span>
<span id="cb355-3"><a href="#cb355-3"></a>n_cores <span class="co"># This number depends on your computer spec.</span></span></code></pre></div>
<pre><code>## system 
##      7</code></pre>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="#cb357-1"></a><span class="kw">plan</span>(multiprocess, <span class="co"># multicore, if supported, otherwise multisession</span></span>
<span id="cb357-2"><a href="#cb357-2"></a>     <span class="dt">workers =</span> n_cores) <span class="co"># the maximum number of workers</span></span></code></pre></div>
<pre><code>## Warning: [ONE-TIME WARNING] Forked processing (&#39;multicore&#39;) is disabled
## in future (&gt;= 1.13.0) when running R from RStudio, because it is
## considered unstable. Because of this, plan(&quot;multicore&quot;) will fall
## back to plan(&quot;sequential&quot;), and plan(&quot;multiprocess&quot;) will fall back to
## plan(&quot;multisession&quot;) - not plan(&quot;multicore&quot;) as in the past. For more details,
## how to control forked processing or not, and how to silence this warning in
## future R sessions, see ?future::supportsMulticore</code></pre>
<ul>
<li>Parsing in parallel.</li>
</ul>
<p><strong>Review</strong></p>
<p>There are at least three ways you can use function + <code>purrr::map()</code>.</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="#cb359-1"></a>squared &lt;-<span class="st"> </span><span class="cf">function</span>(x){</span>
<span id="cb359-2"><a href="#cb359-2"></a>  x<span class="op">*</span><span class="dv">2</span> </span>
<span id="cb359-3"><a href="#cb359-3"></a>}</span>
<span id="cb359-4"><a href="#cb359-4"></a></span>
<span id="cb359-5"><a href="#cb359-5"></a><span class="co"># Named function </span></span>
<span id="cb359-6"><a href="#cb359-6"></a><span class="kw">map</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, squared)</span>
<span id="cb359-7"><a href="#cb359-7"></a></span>
<span id="cb359-8"><a href="#cb359-8"></a><span class="co"># Anonymous function </span></span>
<span id="cb359-9"><a href="#cb359-9"></a><span class="kw">map</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(x){ x <span class="op">*</span><span class="dv">2</span> })</span>
<span id="cb359-10"><a href="#cb359-10"></a></span>
<span id="cb359-11"><a href="#cb359-11"></a><span class="co"># Using formula; ~ = formula, .x = input </span></span>
<span id="cb359-12"><a href="#cb359-12"></a><span class="kw">map</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,<span class="op">~</span>.x<span class="op">*</span><span class="dv">2</span>)</span></code></pre></div>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="#cb360-1"></a><span class="co"># Create a list of file paths </span></span>
<span id="cb360-2"><a href="#cb360-2"></a>filename &lt;-<span class="st"> </span><span class="kw">list.files</span>(dir_path,</span>
<span id="cb360-3"><a href="#cb360-3"></a>          <span class="dt">pattern =</span> <span class="st">&#39;^x&#39;</span>,</span>
<span id="cb360-4"><a href="#cb360-4"></a>          <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb360-5"><a href="#cb360-5"></a></span>
<span id="cb360-6"><a href="#cb360-6"></a>df &lt;-<span class="st"> </span>filename <span class="op">%&gt;%</span></span>
<span id="cb360-7"><a href="#cb360-7"></a></span>
<span id="cb360-8"><a href="#cb360-8"></a><span class="co"># Apply jsonl_to_df function to items on the list</span></span>
<span id="cb360-9"><a href="#cb360-9"></a><span class="kw">future_map</span>(<span class="op">~</span><span class="kw">jsonl_to_df</span>(.)) <span class="op">%&gt;%</span></span>
<span id="cb360-10"><a href="#cb360-10"></a></span>
<span id="cb360-11"><a href="#cb360-11"></a><span class="co"># Full join the list of dataframes</span></span>
<span id="cb360-12"><a href="#cb360-12"></a><span class="kw">reduce</span>(full_join,</span>
<span id="cb360-13"><a href="#cb360-13"></a>       <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;id&quot;</span>,</span>
<span id="cb360-14"><a href="#cb360-14"></a>              <span class="st">&quot;location&quot;</span>,</span>
<span id="cb360-15"><a href="#cb360-15"></a>              <span class="st">&quot;country_code&quot;</span>,</span>
<span id="cb360-16"><a href="#cb360-16"></a>              <span class="st">&quot;created_at&quot;</span>,</span>
<span id="cb360-17"><a href="#cb360-17"></a>              <span class="st">&quot;full_text&quot;</span>,</span>
<span id="cb360-18"><a href="#cb360-18"></a>              <span class="st">&quot;retweet_count&quot;</span>,</span>
<span id="cb360-19"><a href="#cb360-19"></a>              <span class="st">&quot;favorite_count&quot;</span>,</span>
<span id="cb360-20"><a href="#cb360-20"></a>              <span class="st">&quot;user.followers_count&quot;</span>,</span>
<span id="cb360-21"><a href="#cb360-21"></a>              <span class="st">&quot;user.friends_count&quot;</span>))</span>
<span id="cb360-22"><a href="#cb360-22"></a></span>
<span id="cb360-23"><a href="#cb360-23"></a><span class="co"># Output</span></span>
<span id="cb360-24"><a href="#cb360-24"></a>df</span></code></pre></div>
<!--chapter:end:04_semi_structured_data.Rmd-->
</div>
</div>
</div>
</div>
</div>
</div>
<div id="machine_learning" class="section level1" number="7">
<h1 number="7"><span class="header-section-number">7</span> High-dimensional data</h1>
<div id="overview" class="section level2" number="7.1">
<h2 number="7.1"><span class="header-section-number">7.1</span> Overview</h2>
<ul>
<li><p>The rise of high-dimensional data. The new data frontiers in social sciences—text (<a href="https://web.stanford.edu/~gentzkow/research/text-as-data.pdf">Gentzkow et al. 2019</a>; <a href="https://www.jstor.org/stable/pdf/24572662.pdf?casa_token=SQdSI4R_VdwAAAAA:4QiVLhCXqr9f0qNMM9U75EL5JbDxxnXxUxyIfDf0U8ZzQx9szc0xVqaU6DXG4nHyZiNkvcwGlgD6H0Lxj3y0ULHwgkf1MZt8-9TPVtkEH9I4AHgbTg">Grimmer and Stewart 2013</a>) and and image (<a href="https://arxiv.org/pdf/1810.01544">Joo and Steinert-Threlkeld 2018</a>)—are all high-dimensional data.</p>
<ul>
<li><p>1000 common English words for 30-word tweets: <span class="math inline">\(1000^{30}\)</span> similar to N of atoms in the universe (<a href="https://web.stanford.edu/~gentzkow/research/text-as-data.pdf">Gentzkow et al. 2019</a>)</p></li>
<li><p>Belloni, Alexandre, Victor Chernozhukov, and Christian Hansen. <a href="https://pubs.aeaweb.org/doi/pdfplus/10.1257/jep.28.2.29">“High-dimensional methods and inference on structural and treatment effects.”</a> <em>Journal of Economic Perspectives 28</em>, no. 2 (2014): 29-50.</p></li>
</ul></li>
<li><p>The rise of new approach: statistics + computer science = machine learning</p></li>
<li><p>Statistical inference</p>
<ul>
<li><p><span class="math inline">\(y\)</span> &lt;- some probability models (e.g., linear regression, logistic regression) &lt;- <span class="math inline">\(x\)</span></p></li>
<li><p><span class="math inline">\(y\)</span> = <span class="math inline">\(X\beta\)</span> + <span class="math inline">\(\epsilon\)</span></p></li>
<li><p>The goal is to estimate <span class="math inline">\(\beta\)</span></p></li>
</ul></li>
<li><p>Machine learning</p>
<ul>
<li><p><span class="math inline">\(y\)</span> &lt;- unknown &lt;- <span class="math inline">\(x\)</span></p></li>
<li><p><span class="math inline">\(y\)</span> &lt;-&gt; decision trees, neutral nets &lt;-&gt; <span class="math inline">\(x\)</span></p></li>
<li><p>For the main idea behind prediction modeling, see Breiman, Leo (Berkeley stat faculty who passed away in 2005). <a href="https://projecteuclid.org/euclid.ss/1009213726">“Statistical modeling: The two cultures (with comments and a rejoinder by the author).”</a> <em>Statistical science</em> 16, no. 3 (2001): 199-231.</p></li>
<li><p>“The problem is to find an algorithm <span class="math inline">\(f(x)\)</span> such that for future <span class="math inline">\(x\)</span> in a test set, <span class="math inline">\(f(x)\)</span> will be a good predictor of <span class="math inline">\(y\)</span>.”</p></li>
<li><p>“There are <strong>two cultures</strong> in the use of statistical modeling to reach conclusions from data. One assumes that the data are generated by a <strong>given</strong> <strong>stochastic data model</strong>. The other uses <strong>algorithmic models</strong> and treats the data mechanism as <strong>unknown</strong>.”</p></li>
</ul></li>
</ul>
<blockquote>
<p>Algorithmic models, both in theory and practice, has developed rapidly in fields of outside statistics. It can be used on large complex data sets and as a more accurate and informative alternative to data modeling on smaller data sets. - Leo Breiman</p>
</blockquote>
<ul>
<li><p>How ML differs from econometrics?</p></li>
<li><p>A review by Athey, Susan, and Guido W. Imbens. <a href="https://www.annualreviews.org/doi/full/10.1146/annurev-economics-080217-053433">“Machine learning methods that economists should know about.”</a> <em>Annual Review of Economics</em> 11 (2019): 685-725.</p></li>
<li><p>Stat:</p>
<ul>
<li><p>Specifying a target (i.e., an estimand)</p></li>
<li><p>Fitting a model to data using an objective function (e.g., the sum of squared errors)</p></li>
<li><p>Reporting point estimates (effect size) and standard errors (uncertainty)</p></li>
<li><p>Validation by yes-no using goodness-of-fit tests and residual examination</p></li>
</ul></li>
<li><p>ML:</p>
<ul>
<li><p>Developing algorithms (estimating <em>f(x)</em>)</p></li>
<li><p>Prediction power not structural/causal parameters</p></li>
<li><p>Basically, high-dimensional data statistics (N &lt; P)</p></li>
<li><p>The major problem is to avoid <a href="https://en.wikipedia.org/wiki/Curse_of_dimensionality">“the curse of dimensionality”</a> (<a href="https://towardsdatascience.com/the-curse-of-dimensionality-50dc6e49aa1e">too many features - &gt; overfitting</a>)</p></li>
<li><p>Validation: out-of-sample comparisons (cross-validation) not in-sample goodness-of-fit measures</p></li>
<li><p>So, it’s curve-fitting but the primary focus is unseen (test data) not seen data (training data)</p></li>
</ul></li>
<li><p>A quick review on ML lingos for those trained in econometrics</p>
<ul>
<li><p>Sample to estimate parameters = Training sample</p></li>
<li><p>Estimating the model = Being trained</p></li>
<li><p>Regressors, covariates, or predictors = Features</p></li>
<li><p>Regression parameters = weights</p></li>
<li><p>Prediction problems = Supervised (some <span class="math inline">\(y\)</span> are known) + Unsupervised (<span class="math inline">\(y\)</span> unknown)</p></li>
</ul></li>
</ul>
<div class="figure">
<img src="https://i.vas3k.ru/7w9.jpg" alt="" />
<p class="caption">How to teach machines. Based on <a href="https://vas3k.com/blog/machine_learning/">vas3k blog</a>. Many images in this chapter come from vas3k blog.</p>
</div>
<div class="figure">
<img src="https://i.vas3k.ru/7vz.jpg" alt="" />
<p class="caption">The main types of machine learning. Based on <a href="https://vas3k.com/blog/machine_learning/">vas3k blog</a></p>
</div>
<div class="figure">
<img src="https://i.vas3k.ru/7vx.jpg" alt="" />
<p class="caption">The map of the machine learning universe. Based on <a href="https://vas3k.com/blog/machine_learning/">vas3k blog</a></p>
</div>
<div class="figure">
<img src="https://i.vas3k.ru/7w1.jpg" alt="" />
<p class="caption">Classical machine learning. Based on <a href="https://vas3k.com/blog/machine_learning/">vas3k blog</a></p>
</div>
</div>
<div id="dataset" class="section level2" number="7.2">
<h2 number="7.2"><span class="header-section-number">7.2</span> Dataset</h2>
<ul>
<li><p><a href="https://archive.ics.uci.edu/ml/datasets/heart+Disease">Heart disease data from UCI</a></p></li>
<li><p>One of the popular datasets used in machine learning competitions</p></li>
</ul>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="#cb361-1"></a><span class="co"># Load packages </span></span>
<span id="cb361-2"><a href="#cb361-2"></a></span>
<span id="cb361-3"><a href="#cb361-3"></a><span class="co">## CRAN packages </span></span>
<span id="cb361-4"><a href="#cb361-4"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(here,</span>
<span id="cb361-5"><a href="#cb361-5"></a>               tidyverse, </span>
<span id="cb361-6"><a href="#cb361-6"></a>               tidymodels,</span>
<span id="cb361-7"><a href="#cb361-7"></a>               doParallel, <span class="co"># parallel processing </span></span>
<span id="cb361-8"><a href="#cb361-8"></a>               patchwork) <span class="co"># arranging ggplots </span></span>
<span id="cb361-9"><a href="#cb361-9"></a></span>
<span id="cb361-10"><a href="#cb361-10"></a><span class="co">## Jae&#39;s custom functions </span></span>
<span id="cb361-11"><a href="#cb361-11"></a><span class="kw">source</span>(<span class="kw">here</span>(<span class="st">&quot;functions&quot;</span>, <span class="st">&quot;ml_utils.r&quot;</span>))</span>
<span id="cb361-12"><a href="#cb361-12"></a></span>
<span id="cb361-13"><a href="#cb361-13"></a><span class="co"># Import the dataset </span></span>
<span id="cb361-14"><a href="#cb361-14"></a></span>
<span id="cb361-15"><a href="#cb361-15"></a>data_original &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;heart.csv&quot;</span>))</span></code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   age = col_double(),
##   sex = col_double(),
##   cp = col_double(),
##   trestbps = col_double(),
##   chol = col_double(),
##   fbs = col_double(),
##   restecg = col_double(),
##   thalach = col_double(),
##   exang = col_double(),
##   oldpeak = col_double(),
##   slope = col_double(),
##   ca = col_double(),
##   thal = col_double(),
##   target = col_double()
## )</code></pre>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="#cb363-1"></a><span class="kw">glimpse</span>(data_original)</span></code></pre></div>
<pre><code>## Rows: 303
## Columns: 14
## $ age      &lt;dbl&gt; 63, 37, 41, 56, 57, 57, 56, 44, 52, 57, 54, 48, 49, 64, 58, …
## $ sex      &lt;dbl&gt; 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, …
## $ cp       &lt;dbl&gt; 3, 2, 1, 1, 0, 0, 1, 1, 2, 2, 0, 2, 1, 3, 3, 2, 2, 3, 0, 3, …
## $ trestbps &lt;dbl&gt; 145, 130, 130, 120, 120, 140, 140, 120, 172, 150, 140, 130, …
## $ chol     &lt;dbl&gt; 233, 250, 204, 236, 354, 192, 294, 263, 199, 168, 239, 275, …
## $ fbs      &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, …
## $ restecg  &lt;dbl&gt; 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, …
## $ thalach  &lt;dbl&gt; 150, 187, 172, 178, 163, 148, 153, 173, 162, 174, 160, 139, …
## $ exang    &lt;dbl&gt; 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, …
## $ oldpeak  &lt;dbl&gt; 2.3, 3.5, 1.4, 0.8, 0.6, 0.4, 1.3, 0.0, 0.5, 1.6, 1.2, 0.2, …
## $ slope    &lt;dbl&gt; 0, 0, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 1, 2, 1, 2, 0, 2, 2, …
## $ ca       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, …
## $ thal     &lt;dbl&gt; 1, 2, 2, 2, 2, 1, 2, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ target   &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</code></pre>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="#cb365-1"></a><span class="co"># Createa a copy </span></span>
<span id="cb365-2"><a href="#cb365-2"></a>data &lt;-<span class="st"> </span>data_original</span>
<span id="cb365-3"><a href="#cb365-3"></a></span>
<span id="cb365-4"><a href="#cb365-4"></a><span class="kw">theme_set</span>(<span class="kw">theme_minimal</span>())</span></code></pre></div>
<ul>
<li>For more information on the Iowa housing data, read <a href="http://jse.amstat.org/v19n3/decock.pdf">Cook (2011)</a>. This is one of the famous datastets used in many prediction modeling competitions.</li>
</ul>
</div>
<div id="workflow" class="section level2" number="7.3">
<h2 number="7.3"><span class="header-section-number">7.3</span> Workflow</h2>
<ul>
<li><ol style="list-style-type: decimal">
<li>Preprocessing</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>Model building</li>
</ol></li>
<li><ol start="3" style="list-style-type: decimal">
<li>Model fitting</li>
</ol></li>
<li><ol start="4" style="list-style-type: decimal">
<li>Model evaluation</li>
</ol></li>
<li><ol start="5" style="list-style-type: decimal">
<li>Model tuning</li>
</ol></li>
<li><ol start="6" style="list-style-type: decimal">
<li>Prediction</li>
</ol></li>
</ul>
</div>
<div id="tidymodels" class="section level2" number="7.4">
<h2 number="7.4"><span class="header-section-number">7.4</span> Tidymodels</h2>
<ul>
<li><p>Like <code>tidyverse</code>, <code>tidymodels</code> is a collection of packages.</p>
<ul>
<li><p><a href="https://rsample.tidymodels.org/"><code>rsample</code></a>: for data splitting</p></li>
<li><p><a href="https://recipes.tidymodels.org/index.html"><code>recipes</code></a>: for pre-processing</p></li>
<li><p><a href="https://www.tidyverse.org/blog/2018/11/parsnip-0-0-1/"><code>parsnip</code></a>: for model building</p>
<ul>
<li><a href="https://github.com/tidymodels/tune"><code>tune</code></a>: parameter tuning</li>
</ul></li>
<li><p><a href="https://github.com/tidymodels/yardstick"><code>yardstick</code></a>: for model evaluations</p></li>
<li><p><a href="https://github.com/tidymodels/workflows"><code>workflows</code></a>: for bundling a pieplne that bundles together pre-processing, modeling, and post-processing requests</p></li>
</ul></li>
<li><p>Why taking a tidyverse approach to machine learning?</p></li>
<li><p>Benefits</p>
<ul>
<li><p>Readable code</p></li>
<li><p>Reusable data structures</p></li>
<li><p>Extendable code</p></li>
</ul></li>
</ul>
<div class="figure">
<img src="https://rviews.rstudio.com/post/2019-06-14-a-gentle-intro-to-tidymodels_files/figure-html/ds.png" alt="" />
<p class="caption">Tidymodels. From RStudio.</p>
</div>
<blockquote>
<p>tidymodels are an <strong>integrated, modular, extensible</strong> set of packages that implement a framework that facilitates creating predicative stochastic models. - Joseph <a href="mailto:Rickert@RStudio" class="email">Rickert@RStudio</a></p>
</blockquote>
<ul>
<li><p>Currently, 238 models are <a href="https://topepo.github.io/caret/available-models.html">available</a></p></li>
<li><p>The following materials are based on <a href="https://github.com/dlab-berkeley/Machine-Learning-with-tidymodels">the machine learning with tidymodels workshop</a> I developed for D-Lab. <a href="https://github.com/dlab-berkeley/Machine-Learning-in-R">The original workshop</a> was designed by <a href="https://ck37.com/">Chris Kennedy</a> and [Evan Muzzall](<a href="https://dlab.berkeley.edu/people/evan-muzzall" class="uri">https://dlab.berkeley.edu/people/evan-muzzall</a>.</p></li>
</ul>
</div>
<div id="pre-processing" class="section level2" number="7.5">
<h2 number="7.5"><span class="header-section-number">7.5</span> Pre-processing</h2>
<ul>
<li><p><a href="https://recipes.tidymodels.org/index.html"><code>recipes</code></a>: for pre-processing</p></li>
<li><p><a href="https://github.com/tidymodels/textrecipes"><code>textrecipes</code></a> for text pre-processing</p></li>
<li><p>Step 1: <code>recipe()</code> defines target and predictor variables (ingredients).</p></li>
<li><p>Step 2: <code>step_*()</code> defines preprocessing steps to be taken (recipe).</p>
<p>The list of the preprocessing steps draws on the vignette of the <a href="https://www.tidymodels.org/find/parsnip/"><code>parsnip</code></a> package.</p>
<ul>
<li><p>dummy: Also called one-hot encoding</p></li>
<li><p>zero variance: Removing columns (or features) with a single unique value</p></li>
<li><p>impute: Imputing missing values</p></li>
<li><p>decorrelate: Mitigating correlated predictors (e.g., principal component analysis)</p></li>
<li><p>normalize: Centering and/or scaling predictors (e.g., log scaling)</p></li>
<li><p>transform: Making predictors symmetric</p></li>
</ul></li>
<li><p>Step 3: <code>prep()</code> prepares a dataset to base each step on.</p></li>
<li><p>Step 4: <code>bake()</code> applies the pre-processing steps to your datasets.</p></li>
</ul>
<p>In this course, we focus on two preprocessing tasks.</p>
<ul>
<li>One-hot encoding (creating dummy/indicator variables)</li>
</ul>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="#cb366-1"></a><span class="co"># Turn selected numeric variables into factor variables </span></span>
<span id="cb366-2"><a href="#cb366-2"></a>data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span></span>
<span id="cb366-3"><a href="#cb366-3"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="kw">across</span>(<span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;ca&quot;</span>, <span class="st">&quot;cp&quot;</span>, <span class="st">&quot;slope&quot;</span>, <span class="st">&quot;thal&quot;</span>), as.factor)) </span>
<span id="cb366-4"><a href="#cb366-4"></a></span>
<span id="cb366-5"><a href="#cb366-5"></a><span class="kw">glimpse</span>(data) </span></code></pre></div>
<pre><code>## Rows: 303
## Columns: 14
## $ age      &lt;dbl&gt; 63, 37, 41, 56, 57, 57, 56, 44, 52, 57, 54, 48, 49, 64, 58, …
## $ sex      &lt;fct&gt; 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, …
## $ cp       &lt;fct&gt; 3, 2, 1, 1, 0, 0, 1, 1, 2, 2, 0, 2, 1, 3, 3, 2, 2, 3, 0, 3, …
## $ trestbps &lt;dbl&gt; 145, 130, 130, 120, 120, 140, 140, 120, 172, 150, 140, 130, …
## $ chol     &lt;dbl&gt; 233, 250, 204, 236, 354, 192, 294, 263, 199, 168, 239, 275, …
## $ fbs      &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, …
## $ restecg  &lt;dbl&gt; 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, …
## $ thalach  &lt;dbl&gt; 150, 187, 172, 178, 163, 148, 153, 173, 162, 174, 160, 139, …
## $ exang    &lt;dbl&gt; 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, …
## $ oldpeak  &lt;dbl&gt; 2.3, 3.5, 1.4, 0.8, 0.6, 0.4, 1.3, 0.0, 0.5, 1.6, 1.2, 0.2, …
## $ slope    &lt;fct&gt; 0, 0, 2, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 1, 2, 1, 2, 0, 2, 2, …
## $ ca       &lt;fct&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, …
## $ thal     &lt;fct&gt; 1, 2, 2, 2, 2, 1, 2, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
## $ target   &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</code></pre>
<ul>
<li>Imputation</li>
</ul>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="#cb368-1"></a><span class="co"># Check missing values </span></span>
<span id="cb368-2"><a href="#cb368-2"></a></span>
<span id="cb368-3"><a href="#cb368-3"></a><span class="kw">map_df</span>(data, <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>())</span></code></pre></div>
<pre><code>## # A tibble: 1 x 14
##     age   sex    cp trestbps  chol   fbs restecg thalach exang oldpeak slope
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt;
## 1     0     0     0        0     0     0       0       0     0       0     0
## # … with 3 more variables: ca &lt;int&gt;, thal &lt;int&gt;, target &lt;int&gt;</code></pre>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb370-1"><a href="#cb370-1"></a><span class="co"># Add missing values </span></span>
<span id="cb370-2"><a href="#cb370-2"></a></span>
<span id="cb370-3"><a href="#cb370-3"></a>data<span class="op">$</span>oldpeak[<span class="kw">sample</span>(<span class="kw">seq</span>(data), <span class="dt">size =</span> <span class="dv">10</span>)] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb370-4"><a href="#cb370-4"></a></span>
<span id="cb370-5"><a href="#cb370-5"></a><span class="co"># Check missing values </span></span>
<span id="cb370-6"><a href="#cb370-6"></a></span>
<span id="cb370-7"><a href="#cb370-7"></a><span class="co"># Check the number of missing values </span></span>
<span id="cb370-8"><a href="#cb370-8"></a>data <span class="op">%&gt;%</span></span>
<span id="cb370-9"><a href="#cb370-9"></a><span class="st">  </span><span class="kw">map_df</span>(<span class="op">~</span><span class="kw">is.na</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>())</span></code></pre></div>
<pre><code>## # A tibble: 1 x 14
##     age   sex    cp trestbps  chol   fbs restecg thalach exang oldpeak slope
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt;
## 1     0     0     0        0     0     0       0       0     0      10     0
## # … with 3 more variables: ca &lt;int&gt;, thal &lt;int&gt;, target &lt;int&gt;</code></pre>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="#cb372-1"></a><span class="co"># Check the rate of missing values</span></span>
<span id="cb372-2"><a href="#cb372-2"></a>data <span class="op">%&gt;%</span></span>
<span id="cb372-3"><a href="#cb372-3"></a><span class="st">  </span><span class="kw">map_df</span>(<span class="op">~</span><span class="kw">is.na</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mean</span>())</span></code></pre></div>
<pre><code>## # A tibble: 1 x 14
##     age   sex    cp trestbps  chol   fbs restecg thalach exang oldpeak slope
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1     0     0     0        0     0     0       0       0     0  0.0330     0
## # … with 3 more variables: ca &lt;dbl&gt;, thal &lt;dbl&gt;, target &lt;dbl&gt;</code></pre>
<div id="regression-setup" class="section level3" number="7.5.1">
<h3 number="7.5.1"><span class="header-section-number">7.5.1</span> Regression setup</h3>
<div id="outcome-variable" class="section level4" number="7.5.1.1">
<h4 number="7.5.1.1"><span class="header-section-number">7.5.1.1</span> Outcome variable</h4>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb374-1"><a href="#cb374-1"></a><span class="co"># Continuous variable </span></span>
<span id="cb374-2"><a href="#cb374-2"></a>data<span class="op">$</span>age <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">class</span>()</span></code></pre></div>
<pre><code>## [1] &quot;numeric&quot;</code></pre>
</div>
<div id="data-splitting-using-random-sampling" class="section level4" number="7.5.1.2">
<h4 number="7.5.1.2"><span class="header-section-number">7.5.1.2</span> Data splitting using random sampling</h4>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb376-1"><a href="#cb376-1"></a><span class="co"># for reproducibility </span></span>
<span id="cb376-2"><a href="#cb376-2"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>) </span>
<span id="cb376-3"><a href="#cb376-3"></a></span>
<span id="cb376-4"><a href="#cb376-4"></a><span class="co"># split </span></span>
<span id="cb376-5"><a href="#cb376-5"></a>split_reg &lt;-<span class="st"> </span><span class="kw">initial_split</span>(data, <span class="dt">prop =</span> <span class="fl">0.7</span>)</span>
<span id="cb376-6"><a href="#cb376-6"></a></span>
<span id="cb376-7"><a href="#cb376-7"></a><span class="co"># training set </span></span>
<span id="cb376-8"><a href="#cb376-8"></a>raw_train_x_reg &lt;-<span class="st"> </span><span class="kw">training</span>(split_reg)</span>
<span id="cb376-9"><a href="#cb376-9"></a></span>
<span id="cb376-10"><a href="#cb376-10"></a><span class="co"># test set </span></span>
<span id="cb376-11"><a href="#cb376-11"></a>raw_test_x_reg &lt;-<span class="st"> </span><span class="kw">testing</span>(split_reg)</span></code></pre></div>
</div>
<div id="recipe" class="section level4" number="7.5.1.3">
<h4 number="7.5.1.3"><span class="header-section-number">7.5.1.3</span> recipe</h4>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb377-1"><a href="#cb377-1"></a><span class="co"># Regression recipe </span></span>
<span id="cb377-2"><a href="#cb377-2"></a>rec_reg &lt;-<span class="st"> </span>raw_train_x_reg <span class="op">%&gt;%</span></span>
<span id="cb377-3"><a href="#cb377-3"></a><span class="st">  </span><span class="co"># Define the outcome variable </span></span>
<span id="cb377-4"><a href="#cb377-4"></a><span class="st">  </span><span class="kw">recipe</span>(age <span class="op">~</span><span class="st"> </span>.) <span class="op">%&gt;%</span></span>
<span id="cb377-5"><a href="#cb377-5"></a><span class="st">  </span><span class="co"># Median impute oldpeak column </span></span>
<span id="cb377-6"><a href="#cb377-6"></a><span class="st">  </span><span class="kw">step_medianimpute</span>(oldpeak) <span class="op">%&gt;%</span></span>
<span id="cb377-7"><a href="#cb377-7"></a><span class="st">  </span><span class="co"># Expand &quot;sex&quot;, &quot;ca&quot;, &quot;cp&quot;, &quot;slope&quot;, and &quot;thal&quot; features out into dummy variables (indicators). </span></span>
<span id="cb377-8"><a href="#cb377-8"></a><span class="st">  </span><span class="kw">step_dummy</span>(<span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;ca&quot;</span>, <span class="st">&quot;cp&quot;</span>, <span class="st">&quot;slope&quot;</span>, <span class="st">&quot;thal&quot;</span>))</span>
<span id="cb377-9"><a href="#cb377-9"></a></span>
<span id="cb377-10"><a href="#cb377-10"></a><span class="co"># Prepare a dataset to base each step on</span></span>
<span id="cb377-11"><a href="#cb377-11"></a>prep_reg &lt;-<span class="st"> </span>rec_reg <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">prep</span>(<span class="dt">retain =</span> <span class="ot">TRUE</span>) </span></code></pre></div>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb378-1"><a href="#cb378-1"></a><span class="co"># x features </span></span>
<span id="cb378-2"><a href="#cb378-2"></a>train_x_reg &lt;-<span class="st"> </span><span class="kw">juice</span>(prep_reg, <span class="kw">all_predictors</span>())</span>
<span id="cb378-3"><a href="#cb378-3"></a></span>
<span id="cb378-4"><a href="#cb378-4"></a>test_x_reg &lt;-<span class="st"> </span><span class="kw">bake</span>(<span class="dt">object =</span> prep_reg, </span>
<span id="cb378-5"><a href="#cb378-5"></a>                   <span class="dt">new_data =</span> raw_test_x_reg, <span class="kw">all_predictors</span>())</span>
<span id="cb378-6"><a href="#cb378-6"></a></span>
<span id="cb378-7"><a href="#cb378-7"></a><span class="co"># y variables </span></span>
<span id="cb378-8"><a href="#cb378-8"></a>train_y_reg &lt;-<span class="st"> </span><span class="kw">juice</span>(prep_reg, <span class="kw">all_outcomes</span>())<span class="op">$</span>age <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()</span>
<span id="cb378-9"><a href="#cb378-9"></a>test_y_reg &lt;-<span class="st"> </span><span class="kw">bake</span>(prep_reg, raw_test_x_reg, <span class="kw">all_outcomes</span>())<span class="op">$</span>age <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()</span>
<span id="cb378-10"><a href="#cb378-10"></a></span>
<span id="cb378-11"><a href="#cb378-11"></a><span class="co"># Checks</span></span>
<span id="cb378-12"><a href="#cb378-12"></a><span class="kw">names</span>(train_x_reg) <span class="co"># Make sure there&#39;s no age variable!</span></span></code></pre></div>
<pre><code>##  [1] &quot;trestbps&quot; &quot;chol&quot;     &quot;fbs&quot;      &quot;restecg&quot;  &quot;thalach&quot;  &quot;exang&quot;   
##  [7] &quot;oldpeak&quot;  &quot;target&quot;   &quot;sex_X1&quot;   &quot;ca_X1&quot;    &quot;ca_X2&quot;    &quot;ca_X3&quot;   
## [13] &quot;ca_X4&quot;    &quot;cp_X1&quot;    &quot;cp_X2&quot;    &quot;cp_X3&quot;    &quot;slope_X1&quot; &quot;slope_X2&quot;
## [19] &quot;thal_X1&quot;  &quot;thal_X2&quot;  &quot;thal_X3&quot;</code></pre>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb380-1"><a href="#cb380-1"></a><span class="kw">class</span>(train_y_reg) <span class="co"># Make sure this is a continuous variable!</span></span></code></pre></div>
<pre><code>## [1] &quot;numeric&quot;</code></pre>
<ul>
<li>Note that other imputation methods are also available.</li>
</ul>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb382-1"><a href="#cb382-1"></a><span class="kw">grep</span>(<span class="st">&quot;impute&quot;</span>, <span class="kw">ls</span>(<span class="st">&quot;package:recipes&quot;</span>), <span class="dt">value =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;step_bagimpute&quot;          &quot;step_knnimpute&quot;         
##  [3] &quot;step_lowerimpute&quot;        &quot;step_meanimpute&quot;        
##  [5] &quot;step_medianimpute&quot;       &quot;step_modeimpute&quot;        
##  [7] &quot;step_rollimpute&quot;         &quot;tunable.step_bagimpute&quot; 
##  [9] &quot;tunable.step_knnimpute&quot;  &quot;tunable.step_meanimpute&quot;
## [11] &quot;tunable.step_rollimpute&quot;</code></pre>
<ul>
<li>You can also create your own <code>step_</code> functions. For more information, see <a href="https://www.tidymodels.org/learn/develop/recipes/">tidymodels.org</a>.</li>
</ul>
</div>
</div>
<div id="classification-setup" class="section level3" number="7.5.2">
<h3 number="7.5.2"><span class="header-section-number">7.5.2</span> Classification setup</h3>
<div id="outcome-variable-1" class="section level4" number="7.5.2.1">
<h4 number="7.5.2.1"><span class="header-section-number">7.5.2.1</span> Outcome variable</h4>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb384-1"><a href="#cb384-1"></a>data<span class="op">$</span>target <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">class</span>() </span></code></pre></div>
<pre><code>## [1] &quot;numeric&quot;</code></pre>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb386-1"><a href="#cb386-1"></a>data<span class="op">$</span>target &lt;-<span class="st"> </span><span class="kw">as.factor</span>(data<span class="op">$</span>target)</span>
<span id="cb386-2"><a href="#cb386-2"></a></span>
<span id="cb386-3"><a href="#cb386-3"></a>data<span class="op">$</span>target <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">class</span>()</span></code></pre></div>
<pre><code>## [1] &quot;factor&quot;</code></pre>
</div>
<div id="data-splitting-using-stratified-random-sampling" class="section level4" number="7.5.2.2">
<h4 number="7.5.2.2"><span class="header-section-number">7.5.2.2</span> Data splitting using stratified random sampling</h4>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb388-1"><a href="#cb388-1"></a><span class="co"># split </span></span>
<span id="cb388-2"><a href="#cb388-2"></a>split_class &lt;-<span class="st"> </span><span class="kw">initial_split</span>(data <span class="op">%&gt;%</span></span>
<span id="cb388-3"><a href="#cb388-3"></a><span class="st">                             </span><span class="kw">mutate</span>(<span class="dt">target =</span> <span class="kw">as.factor</span>(target)), </span>
<span id="cb388-4"><a href="#cb388-4"></a>                             <span class="dt">prop =</span> <span class="fl">0.7</span>, </span>
<span id="cb388-5"><a href="#cb388-5"></a>                             <span class="dt">strata =</span> target)</span>
<span id="cb388-6"><a href="#cb388-6"></a></span>
<span id="cb388-7"><a href="#cb388-7"></a><span class="co"># training set </span></span>
<span id="cb388-8"><a href="#cb388-8"></a>raw_train_x_class &lt;-<span class="st"> </span><span class="kw">training</span>(split_class)</span>
<span id="cb388-9"><a href="#cb388-9"></a></span>
<span id="cb388-10"><a href="#cb388-10"></a><span class="co"># testing set </span></span>
<span id="cb388-11"><a href="#cb388-11"></a>raw_test_x_class &lt;-<span class="st"> </span><span class="kw">testing</span>(split_class)</span></code></pre></div>
</div>
<div id="recipe-1" class="section level4" number="7.5.2.3">
<h4 number="7.5.2.3"><span class="header-section-number">7.5.2.3</span> recipe</h4>
<div class="sourceCode" id="cb389"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb389-1"><a href="#cb389-1"></a><span class="co"># Classification recipe </span></span>
<span id="cb389-2"><a href="#cb389-2"></a>rec_class &lt;-<span class="st"> </span>raw_train_x_class <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb389-3"><a href="#cb389-3"></a><span class="st">  </span><span class="co"># Define the outcome variable </span></span>
<span id="cb389-4"><a href="#cb389-4"></a><span class="st">  </span><span class="kw">recipe</span>(target <span class="op">~</span><span class="st"> </span>.) <span class="op">%&gt;%</span></span>
<span id="cb389-5"><a href="#cb389-5"></a><span class="st">  </span><span class="co"># Median impute oldpeak column </span></span>
<span id="cb389-6"><a href="#cb389-6"></a><span class="st">  </span><span class="kw">step_medianimpute</span>(oldpeak) <span class="op">%&gt;%</span></span>
<span id="cb389-7"><a href="#cb389-7"></a><span class="st">  </span><span class="co"># Expand &quot;sex&quot;, &quot;ca&quot;, &quot;cp&quot;, &quot;slope&quot;, and &quot;thal&quot; features out into dummy variables (indicators).</span></span>
<span id="cb389-8"><a href="#cb389-8"></a><span class="st">  </span><span class="kw">step_normalize</span>(age) <span class="op">%&gt;%</span></span>
<span id="cb389-9"><a href="#cb389-9"></a><span class="st">  </span><span class="kw">step_dummy</span>(<span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;ca&quot;</span>, <span class="st">&quot;cp&quot;</span>, <span class="st">&quot;slope&quot;</span>, <span class="st">&quot;thal&quot;</span>)) </span>
<span id="cb389-10"><a href="#cb389-10"></a></span>
<span id="cb389-11"><a href="#cb389-11"></a><span class="co"># Prepare a dataset to base each step on</span></span>
<span id="cb389-12"><a href="#cb389-12"></a>prep_class &lt;-<span class="st"> </span>rec_class <span class="op">%&gt;%</span><span class="kw">prep</span>(<span class="dt">retain =</span> <span class="ot">TRUE</span>) </span></code></pre></div>
<div class="sourceCode" id="cb390"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb390-1"><a href="#cb390-1"></a><span class="co"># x features </span></span>
<span id="cb390-2"><a href="#cb390-2"></a>train_x_class &lt;-<span class="st"> </span><span class="kw">juice</span>(prep_class, <span class="kw">all_predictors</span>()) </span>
<span id="cb390-3"><a href="#cb390-3"></a>test_x_class &lt;-<span class="st"> </span><span class="kw">bake</span>(prep_class, raw_test_x_class, <span class="kw">all_predictors</span>())</span>
<span id="cb390-4"><a href="#cb390-4"></a></span>
<span id="cb390-5"><a href="#cb390-5"></a><span class="co"># y variables </span></span>
<span id="cb390-6"><a href="#cb390-6"></a>train_y_class &lt;-<span class="st"> </span><span class="kw">juice</span>(prep_class, <span class="kw">all_outcomes</span>())<span class="op">$</span>target <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.factor</span>()</span>
<span id="cb390-7"><a href="#cb390-7"></a>test_y_class &lt;-<span class="st"> </span><span class="kw">bake</span>(prep_class, raw_test_x_class, <span class="kw">all_outcomes</span>())<span class="op">$</span>target <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.factor</span>()</span>
<span id="cb390-8"><a href="#cb390-8"></a></span>
<span id="cb390-9"><a href="#cb390-9"></a><span class="co"># Checks </span></span>
<span id="cb390-10"><a href="#cb390-10"></a><span class="kw">names</span>(train_x_class) <span class="co"># Make sure there&#39;s no target variable!</span></span></code></pre></div>
<pre><code>##  [1] &quot;age&quot;      &quot;trestbps&quot; &quot;chol&quot;     &quot;fbs&quot;      &quot;restecg&quot;  &quot;thalach&quot; 
##  [7] &quot;exang&quot;    &quot;oldpeak&quot;  &quot;sex_X1&quot;   &quot;ca_X1&quot;    &quot;ca_X2&quot;    &quot;ca_X3&quot;   
## [13] &quot;ca_X4&quot;    &quot;cp_X1&quot;    &quot;cp_X2&quot;    &quot;cp_X3&quot;    &quot;slope_X1&quot; &quot;slope_X2&quot;
## [19] &quot;thal_X1&quot;  &quot;thal_X2&quot;  &quot;thal_X3&quot;</code></pre>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb392-1"><a href="#cb392-1"></a><span class="kw">class</span>(train_y_class) <span class="co"># Make sure this is a factor variable!</span></span></code></pre></div>
<pre><code>## [1] &quot;factor&quot;</code></pre>
</div>
</div>
</div>
<div id="supervised-learning" class="section level2" number="7.6">
<h2 number="7.6"><span class="header-section-number">7.6</span> Supervised learning</h2>
<p>x -&gt; f - &gt; y (defined)</p>
<div id="ols-and-lasso" class="section level3" number="7.6.1">
<h3 number="7.6.1"><span class="header-section-number">7.6.1</span> OLS and Lasso</h3>
<div id="parsnip" class="section level4" number="7.6.1.1">
<h4 number="7.6.1.1"><span class="header-section-number">7.6.1.1</span> parsnip</h4>
<ul>
<li>Build models (<code>parsnip</code>)</li>
</ul>
<ol style="list-style-type: decimal">
<li>Specify a model</li>
<li>Specify an engine</li>
<li>Specify a mode</li>
</ol>
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb394-1"><a href="#cb394-1"></a><span class="co"># OLS spec </span></span>
<span id="cb394-2"><a href="#cb394-2"></a>ols_spec &lt;-<span class="st"> </span><span class="kw">linear_reg</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Specify a model </span></span>
<span id="cb394-3"><a href="#cb394-3"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;lm&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Specify an engine: lm, glmnet, stan, keras, spark </span></span>
<span id="cb394-4"><a href="#cb394-4"></a><span class="st">  </span><span class="kw">set_mode</span>(<span class="st">&quot;regression&quot;</span>) <span class="co"># Declare a mode: regression or classification </span></span>
<span id="cb394-5"><a href="#cb394-5"></a></span>
<span id="cb394-6"><a href="#cb394-6"></a><span class="co"># Lasso spec </span></span>
<span id="cb394-7"><a href="#cb394-7"></a>lasso_spec &lt;-<span class="st"> </span><span class="kw">linear_reg</span>(<span class="dt">penalty =</span> <span class="fl">0.1</span>, <span class="co"># tuning parameter </span></span>
<span id="cb394-8"><a href="#cb394-8"></a>                         <span class="dt">mixture =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># 1 = lasso, 0 = ridge </span></span>
<span id="cb394-9"><a href="#cb394-9"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;glmnet&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb394-10"><a href="#cb394-10"></a><span class="st">  </span><span class="kw">set_mode</span>(<span class="st">&quot;regression&quot;</span>) </span>
<span id="cb394-11"><a href="#cb394-11"></a></span>
<span id="cb394-12"><a href="#cb394-12"></a><span class="co"># If you don&#39;t understand parsnip arguments </span></span>
<span id="cb394-13"><a href="#cb394-13"></a>lasso_spec <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">translate</span>() <span class="co"># See the documentation</span></span></code></pre></div>
<pre><code>## Linear Regression Model Specification (regression)
## 
## Main Arguments:
##   penalty = 0.1
##   mixture = 1
## 
## Computational engine: glmnet 
## 
## Model fit template:
## glmnet::glmnet(x = missing_arg(), y = missing_arg(), weights = missing_arg(), 
##     alpha = 1, family = &quot;gaussian&quot;)</code></pre>
<ul>
<li>Fit models</li>
</ul>
<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb396-1"><a href="#cb396-1"></a>ols_fit &lt;-<span class="st"> </span>ols_spec <span class="op">%&gt;%</span></span>
<span id="cb396-2"><a href="#cb396-2"></a><span class="st">  </span><span class="kw">fit_xy</span>(<span class="dt">x =</span> train_x_reg, <span class="dt">y=</span> train_y_reg) </span>
<span id="cb396-3"><a href="#cb396-3"></a>  <span class="co"># fit(train_y_reg ~ ., train_x_reg) # When you data are not preprocessed </span></span>
<span id="cb396-4"><a href="#cb396-4"></a></span>
<span id="cb396-5"><a href="#cb396-5"></a>lasso_fit &lt;-<span class="st"> </span>lasso_spec <span class="op">%&gt;%</span></span>
<span id="cb396-6"><a href="#cb396-6"></a><span class="st">  </span><span class="kw">fit_xy</span>(<span class="dt">x =</span> train_x_reg, <span class="dt">y=</span> train_y_reg) </span></code></pre></div>
</div>
<div id="yardstick" class="section level4" number="7.6.1.2">
<h4 number="7.6.1.2"><span class="header-section-number">7.6.1.2</span> yardstick</h4>
<ul>
<li>Visualize model fits</li>
</ul>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb397-1"><a href="#cb397-1"></a><span class="kw">map2</span>(<span class="kw">list</span>(ols_fit, lasso_fit), <span class="kw">c</span>(<span class="st">&quot;OLS&quot;</span>, <span class="st">&quot;Lasso&quot;</span>), visualize_fit) </span></code></pre></div>
<pre><code>## [[1]]</code></pre>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-16-2.png" width="672" /></p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb400-1"><a href="#cb400-1"></a><span class="co"># Define performance metrics </span></span>
<span id="cb400-2"><a href="#cb400-2"></a>metrics &lt;-<span class="st"> </span>yardstick<span class="op">::</span><span class="kw">metric_set</span>(rmse, mae, rsq)</span>
<span id="cb400-3"><a href="#cb400-3"></a></span>
<span id="cb400-4"><a href="#cb400-4"></a><span class="co"># Evaluate many models </span></span>
<span id="cb400-5"><a href="#cb400-5"></a>evals &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="kw">list</span>(ols_fit, lasso_fit), evaluate_reg) <span class="op">%&gt;%</span></span>
<span id="cb400-6"><a href="#cb400-6"></a><span class="st">  </span><span class="kw">reduce</span>(bind_rows) <span class="op">%&gt;%</span></span>
<span id="cb400-7"><a href="#cb400-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;OLS&quot;</span>, <span class="st">&quot;Lasso&quot;</span>), <span class="dt">each =</span> <span class="dv">3</span>))</span>
<span id="cb400-8"><a href="#cb400-8"></a></span>
<span id="cb400-9"><a href="#cb400-9"></a><span class="co"># Visualize the test results </span></span>
<span id="cb400-10"><a href="#cb400-10"></a>evals <span class="op">%&gt;%</span></span>
<span id="cb400-11"><a href="#cb400-11"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">fct_reorder</span>(type, .estimate), <span class="dt">y =</span> .estimate)) <span class="op">+</span></span>
<span id="cb400-12"><a href="#cb400-12"></a><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb400-13"><a href="#cb400-13"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Model&quot;</span>,</span>
<span id="cb400-14"><a href="#cb400-14"></a>         <span class="dt">y =</span> <span class="st">&quot;Estimate&quot;</span>) <span class="op">+</span></span>
<span id="cb400-15"><a href="#cb400-15"></a><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">glue</span>(<span class="st">&quot;{toupper(.metric)}&quot;</span>), <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>) </span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-17-1.png" width="672" />
- For more information, read <a href="https://www.tmwr.org/">Tidy Modeling with R</a> by Max Kuhn and Julia Silge.</p>
</div>
<div id="tune" class="section level4" number="7.6.1.3">
<h4 number="7.6.1.3"><span class="header-section-number">7.6.1.3</span> tune</h4>
<div id="tune-ingredients" class="section level5" number="7.6.1.3.1">
<h5 number="7.6.1.3.1"><span class="header-section-number">7.6.1.3.1</span> tune ingredients</h5>
<div class="sourceCode" id="cb401"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb401-1"><a href="#cb401-1"></a><span class="co"># tune() = placeholder </span></span>
<span id="cb401-2"><a href="#cb401-2"></a></span>
<span id="cb401-3"><a href="#cb401-3"></a>tune_spec &lt;-<span class="st"> </span><span class="kw">linear_reg</span>(<span class="dt">penalty =</span> <span class="kw">tune</span>(), <span class="co"># tuning parameter </span></span>
<span id="cb401-4"><a href="#cb401-4"></a>                         <span class="dt">mixture =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># 1 = lasso, 0 = ridge </span></span>
<span id="cb401-5"><a href="#cb401-5"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;glmnet&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb401-6"><a href="#cb401-6"></a><span class="st">  </span><span class="kw">set_mode</span>(<span class="st">&quot;regression&quot;</span>) </span>
<span id="cb401-7"><a href="#cb401-7"></a></span>
<span id="cb401-8"><a href="#cb401-8"></a>tune_spec</span></code></pre></div>
<pre><code>## Linear Regression Model Specification (regression)
## 
## Main Arguments:
##   penalty = tune()
##   mixture = 1
## 
## Computational engine: glmnet</code></pre>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb403-1"><a href="#cb403-1"></a><span class="co"># penalty() searches 50 possible combinations </span></span>
<span id="cb403-2"><a href="#cb403-2"></a></span>
<span id="cb403-3"><a href="#cb403-3"></a>lambda_grid &lt;-<span class="st"> </span><span class="kw">grid_regular</span>(<span class="kw">penalty</span>(), <span class="dt">levels =</span> <span class="dv">50</span>)</span>
<span id="cb403-4"><a href="#cb403-4"></a></span>
<span id="cb403-5"><a href="#cb403-5"></a><span class="co"># 10-fold cross-validation</span></span>
<span id="cb403-6"><a href="#cb403-6"></a></span>
<span id="cb403-7"><a href="#cb403-7"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>) <span class="co"># for reproducibility </span></span>
<span id="cb403-8"><a href="#cb403-8"></a></span>
<span id="cb403-9"><a href="#cb403-9"></a>rec_folds &lt;-<span class="st"> </span><span class="kw">vfold_cv</span>(train_x_reg <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">age =</span> train_y_reg)))</span></code></pre></div>
</div>
<div id="add-these-elements-to-a-workflow" class="section level5" number="7.6.1.3.2">
<h5 number="7.6.1.3.2"><span class="header-section-number">7.6.1.3.2</span> Add these elements to a workflow</h5>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb404-1"><a href="#cb404-1"></a><span class="co"># Workflow </span></span>
<span id="cb404-2"><a href="#cb404-2"></a>rec_wf &lt;-<span class="st"> </span><span class="kw">workflow</span>() <span class="op">%&gt;%</span></span>
<span id="cb404-3"><a href="#cb404-3"></a><span class="st">  </span><span class="kw">add_model</span>(tune_spec) <span class="op">%&gt;%</span></span>
<span id="cb404-4"><a href="#cb404-4"></a><span class="st">  </span><span class="kw">add_formula</span>(age<span class="op">~</span>.)</span></code></pre></div>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb405-1"><a href="#cb405-1"></a><span class="co"># Tuning results </span></span>
<span id="cb405-2"><a href="#cb405-2"></a>rec_res &lt;-<span class="st"> </span>rec_wf <span class="op">%&gt;%</span></span>
<span id="cb405-3"><a href="#cb405-3"></a><span class="st">  </span><span class="kw">tune_grid</span>(</span>
<span id="cb405-4"><a href="#cb405-4"></a>    <span class="dt">resamples =</span> rec_folds, </span>
<span id="cb405-5"><a href="#cb405-5"></a>    <span class="dt">grid =</span> lambda_grid</span>
<span id="cb405-6"><a href="#cb405-6"></a>  )</span></code></pre></div>
</div>
<div id="visualize" class="section level5" number="7.6.1.3.3">
<h5 number="7.6.1.3.3"><span class="header-section-number">7.6.1.3.3</span> Visualize</h5>
<div class="sourceCode" id="cb406"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb406-1"><a href="#cb406-1"></a><span class="co"># Visualize</span></span>
<span id="cb406-2"><a href="#cb406-2"></a></span>
<span id="cb406-3"><a href="#cb406-3"></a>rec_res <span class="op">%&gt;%</span></span>
<span id="cb406-4"><a href="#cb406-4"></a><span class="st">  </span><span class="kw">collect_metrics</span>() <span class="op">%&gt;%</span></span>
<span id="cb406-5"><a href="#cb406-5"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(penalty, mean, <span class="dt">col =</span> .metric)) <span class="op">+</span></span>
<span id="cb406-6"><a href="#cb406-6"></a><span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(</span>
<span id="cb406-7"><a href="#cb406-7"></a>    <span class="dt">ymin =</span> mean <span class="op">-</span><span class="st"> </span>std_err,</span>
<span id="cb406-8"><a href="#cb406-8"></a>    <span class="dt">ymax =</span> mean <span class="op">+</span><span class="st"> </span>std_err</span>
<span id="cb406-9"><a href="#cb406-9"></a>  ),</span>
<span id="cb406-10"><a href="#cb406-10"></a>  <span class="dt">alpha =</span> <span class="fl">0.3</span></span>
<span id="cb406-11"><a href="#cb406-11"></a>  ) <span class="op">+</span></span>
<span id="cb406-12"><a href="#cb406-12"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb406-13"><a href="#cb406-13"></a><span class="st">  </span><span class="kw">scale_x_log10</span>() <span class="op">+</span></span>
<span id="cb406-14"><a href="#cb406-14"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;log(lambda)&quot;</span>) <span class="op">+</span></span>
<span id="cb406-15"><a href="#cb406-15"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">glue</span>(<span class="st">&quot;{toupper(.metric)}&quot;</span>), </span>
<span id="cb406-16"><a href="#cb406-16"></a>             <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>,</span>
<span id="cb406-17"><a href="#cb406-17"></a>             <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb406-18"><a href="#cb406-18"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
</div>
<div id="select" class="section level5" number="7.6.1.3.4">
<h5 number="7.6.1.3.4"><span class="header-section-number">7.6.1.3.4</span> Select</h5>
<div class="sourceCode" id="cb407"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb407-1"><a href="#cb407-1"></a>top_rmse &lt;-<span class="st"> </span><span class="kw">show_best</span>(rec_res, <span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb407-2"><a href="#cb407-2"></a></span>
<span id="cb407-3"><a href="#cb407-3"></a>best_rmse &lt;-<span class="st"> </span><span class="kw">select_best</span>(rec_res, <span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb407-4"><a href="#cb407-4"></a></span>
<span id="cb407-5"><a href="#cb407-5"></a>best_rmse </span></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   penalty .config
##     &lt;dbl&gt; &lt;chr&gt;  
## 1   0.153 Model46</code></pre>
<div class="sourceCode" id="cb409"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb409-1"><a href="#cb409-1"></a><span class="kw">glue</span>(<span class="st">&#39;The RMSE of the intiail model is </span></span>
<span id="cb409-2"><a href="#cb409-2"></a><span class="st">     {evals %&gt;%</span></span>
<span id="cb409-3"><a href="#cb409-3"></a><span class="st">  filter(type == &quot;Lasso&quot;, .metric == &quot;rmse&quot;) %&gt;%</span></span>
<span id="cb409-4"><a href="#cb409-4"></a><span class="st">  select(.estimate) %&gt;%</span></span>
<span id="cb409-5"><a href="#cb409-5"></a><span class="st">  round(2)}&#39;</span>)</span></code></pre></div>
<pre><code>## The RMSE of the intiail model is 
##    7.87</code></pre>
<div class="sourceCode" id="cb411"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb411-1"><a href="#cb411-1"></a><span class="kw">glue</span>(<span class="st">&#39;The RMSE of the tuned model is {rec_res %&gt;%</span></span>
<span id="cb411-2"><a href="#cb411-2"></a><span class="st">  collect_metrics() %&gt;%</span></span>
<span id="cb411-3"><a href="#cb411-3"></a><span class="st">  filter(.metric == &quot;rmse&quot;) %&gt;%</span></span>
<span id="cb411-4"><a href="#cb411-4"></a><span class="st">  arrange(mean) %&gt;%</span></span>
<span id="cb411-5"><a href="#cb411-5"></a><span class="st">  dplyr::slice(1) %&gt;%</span></span>
<span id="cb411-6"><a href="#cb411-6"></a><span class="st">  select(mean) %&gt;%</span></span>
<span id="cb411-7"><a href="#cb411-7"></a><span class="st">  round(2)}&#39;</span>)</span></code></pre></div>
<pre><code>## The RMSE of the tuned model is 7.71</code></pre>
<ul>
<li>Finalize your workflow and visualize <a href="https://koalaverse.github.io/vip/articles/vip.html">variable importance</a></li>
</ul>
<div class="sourceCode" id="cb413"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb413-1"><a href="#cb413-1"></a>finalize_lasso &lt;-<span class="st"> </span>rec_wf <span class="op">%&gt;%</span></span>
<span id="cb413-2"><a href="#cb413-2"></a><span class="st">  </span><span class="kw">finalize_workflow</span>(best_rmse)</span>
<span id="cb413-3"><a href="#cb413-3"></a></span>
<span id="cb413-4"><a href="#cb413-4"></a>finalize_lasso <span class="op">%&gt;%</span></span>
<span id="cb413-5"><a href="#cb413-5"></a><span class="st">  </span><span class="kw">fit</span>(train_x_reg <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">age =</span> train_y_reg))) <span class="op">%&gt;%</span></span>
<span id="cb413-6"><a href="#cb413-6"></a><span class="st">  </span><span class="kw">pull_workflow_fit</span>() <span class="op">%&gt;%</span></span>
<span id="cb413-7"><a href="#cb413-7"></a><span class="st">  </span>vip<span class="op">::</span><span class="kw">vip</span>()</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
</div>
<div id="test-fit" class="section level5" number="7.6.1.3.5">
<h5 number="7.6.1.3.5"><span class="header-section-number">7.6.1.3.5</span> Test fit</h5>
<ul>
<li>Apply the tuned model to the test dataset</li>
</ul>
<div class="sourceCode" id="cb414"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb414-1"><a href="#cb414-1"></a>test_fit &lt;-<span class="st"> </span>finalize_lasso <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb414-2"><a href="#cb414-2"></a><span class="st">  </span><span class="kw">fit</span>(test_x_reg <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">age =</span> test_y_reg)))</span>
<span id="cb414-3"><a href="#cb414-3"></a></span>
<span id="cb414-4"><a href="#cb414-4"></a><span class="kw">evaluate_reg</span>(test_fit)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 rmse    standard       7.09 
## 2 mae     standard       5.84 
## 3 rsq     standard       0.414</code></pre>
</div>
</div>
</div>
<div id="decision-tree" class="section level3" number="7.6.2">
<h3 number="7.6.2"><span class="header-section-number">7.6.2</span> Decision tree</h3>
<div id="parsnip-1" class="section level4" number="7.6.2.1">
<h4 number="7.6.2.1"><span class="header-section-number">7.6.2.1</span> parsnip</h4>
<ul>
<li>Build a model</li>
</ul>
<ol style="list-style-type: decimal">
<li>Specify a model</li>
<li>Specify an engine</li>
<li>Specify a mode</li>
</ol>
<div class="sourceCode" id="cb416"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb416-1"><a href="#cb416-1"></a><span class="co"># workflow </span></span>
<span id="cb416-2"><a href="#cb416-2"></a>tree_wf &lt;-<span class="st"> </span><span class="kw">workflow</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_formula</span>(target<span class="op">~</span>.)</span>
<span id="cb416-3"><a href="#cb416-3"></a></span>
<span id="cb416-4"><a href="#cb416-4"></a><span class="co"># spec </span></span>
<span id="cb416-5"><a href="#cb416-5"></a>tree_spec &lt;-<span class="st"> </span><span class="kw">decision_tree</span>(</span>
<span id="cb416-6"><a href="#cb416-6"></a>  </span>
<span id="cb416-7"><a href="#cb416-7"></a>           <span class="co"># Mode </span></span>
<span id="cb416-8"><a href="#cb416-8"></a>           <span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,</span>
<span id="cb416-9"><a href="#cb416-9"></a>           </span>
<span id="cb416-10"><a href="#cb416-10"></a>           <span class="co"># Tuning parameters</span></span>
<span id="cb416-11"><a href="#cb416-11"></a>           <span class="dt">cost_complexity =</span> <span class="ot">NULL</span>, </span>
<span id="cb416-12"><a href="#cb416-12"></a>           <span class="dt">tree_depth =</span> <span class="ot">NULL</span>) <span class="op">%&gt;%</span></span>
<span id="cb416-13"><a href="#cb416-13"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;rpart&quot;</span>) <span class="co"># rpart, c5.0, spark</span></span>
<span id="cb416-14"><a href="#cb416-14"></a></span>
<span id="cb416-15"><a href="#cb416-15"></a>tree_wf &lt;-<span class="st"> </span>tree_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_model</span>(tree_spec)</span></code></pre></div>
<ul>
<li>Fit a model</li>
</ul>
<div class="sourceCode" id="cb417"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb417-1"><a href="#cb417-1"></a>tree_fit &lt;-<span class="st"> </span>tree_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)))</span></code></pre></div>
</div>
<div id="yardstick-1" class="section level4" number="7.6.2.2">
<h4 number="7.6.2.2"><span class="header-section-number">7.6.2.2</span> yardstick</h4>
<ul>
<li>Let’s formally test prediction performance.</li>
</ul>
<p><strong>Metrics</strong></p>
<ul>
<li><p><code>accuracy</code>: The proportion of the data predicted correctly</p></li>
<li><p><code>precision</code>: Positive predictive value</p></li>
<li><p><code>recall</code> (specificity): True positive rate (e.g., healthy people really healthy)</p></li>
</ul>
<div class="figure">
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Precisionrecall.svg/525px-Precisionrecall.svg.png" alt="" />
<p class="caption">From wikipedia</p>
</div>
<ul>
<li>To learn more about other metrics, check out the yardstick package <a href="https://yardstick.tidymodels.org/reference/index.html">references</a>.</li>
</ul>
<div class="sourceCode" id="cb418"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb418-1"><a href="#cb418-1"></a><span class="co"># Define performance metrics </span></span>
<span id="cb418-2"><a href="#cb418-2"></a></span>
<span id="cb418-3"><a href="#cb418-3"></a>metrics &lt;-<span class="st"> </span>yardstick<span class="op">::</span><span class="kw">metric_set</span>(accuracy, precision, recall)</span>
<span id="cb418-4"><a href="#cb418-4"></a></span>
<span id="cb418-5"><a href="#cb418-5"></a><span class="co"># Visualize</span></span>
<span id="cb418-6"><a href="#cb418-6"></a></span>
<span id="cb418-7"><a href="#cb418-7"></a>tree_fit_viz_metr &lt;-<span class="st"> </span><span class="kw">visualize_class_eval</span>(tree_fit)</span>
<span id="cb418-8"><a href="#cb418-8"></a></span>
<span id="cb418-9"><a href="#cb418-9"></a>tree_fit_viz_metr</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<div class="sourceCode" id="cb419"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb419-1"><a href="#cb419-1"></a>tree_fit_viz_mat &lt;-<span class="st"> </span><span class="kw">visualize_class_conf</span>(tree_fit)</span>
<span id="cb419-2"><a href="#cb419-2"></a></span>
<span id="cb419-3"><a href="#cb419-3"></a>tree_fit_viz_mat</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-27-2.png" width="672" /></p>
</div>
<div id="tune-1" class="section level4" number="7.6.2.3">
<h4 number="7.6.2.3"><span class="header-section-number">7.6.2.3</span> tune</h4>
<div id="tune-ingredients-1" class="section level5" number="7.6.2.3.1">
<h5 number="7.6.2.3.1"><span class="header-section-number">7.6.2.3.1</span> tune ingredients</h5>
<ul>
<li><p><strong>complexity parameter</strong>: a high CP means a simple decision tree with few splits.</p></li>
<li><p><strong>tree_depth</strong></p></li>
</ul>
<div class="sourceCode" id="cb420"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb420-1"><a href="#cb420-1"></a>tune_spec &lt;-<span class="st"> </span></span>
<span id="cb420-2"><a href="#cb420-2"></a><span class="st">  </span><span class="kw">decision_tree</span>(</span>
<span id="cb420-3"><a href="#cb420-3"></a>    <span class="dt">cost_complexity =</span> <span class="kw">tune</span>(), </span>
<span id="cb420-4"><a href="#cb420-4"></a>    <span class="dt">tree_depth =</span> <span class="kw">tune</span>(),</span>
<span id="cb420-5"><a href="#cb420-5"></a>    <span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span></span>
<span id="cb420-6"><a href="#cb420-6"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb420-7"><a href="#cb420-7"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;rpart&quot;</span>)</span>
<span id="cb420-8"><a href="#cb420-8"></a></span>
<span id="cb420-9"><a href="#cb420-9"></a>tree_grid &lt;-<span class="st"> </span><span class="kw">grid_regular</span>(<span class="kw">cost_complexity</span>(),</span>
<span id="cb420-10"><a href="#cb420-10"></a>                          <span class="kw">tree_depth</span>(),</span>
<span id="cb420-11"><a href="#cb420-11"></a>                          <span class="dt">levels =</span> <span class="dv">5</span>) <span class="co"># 2 parameters -&gt; 5*5 = 25 combinations </span></span>
<span id="cb420-12"><a href="#cb420-12"></a></span>
<span id="cb420-13"><a href="#cb420-13"></a>tree_grid <span class="op">%&gt;%</span></span>
<span id="cb420-14"><a href="#cb420-14"></a><span class="st">  </span><span class="kw">count</span>(tree_depth)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 2
##   tree_depth     n
##        &lt;int&gt; &lt;int&gt;
## 1          1     5
## 2          4     5
## 3          8     5
## 4         11     5
## 5         15     5</code></pre>
<div class="sourceCode" id="cb422"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb422-1"><a href="#cb422-1"></a><span class="co"># 10-fold cross-validation</span></span>
<span id="cb422-2"><a href="#cb422-2"></a></span>
<span id="cb422-3"><a href="#cb422-3"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>) <span class="co"># for reproducibility </span></span>
<span id="cb422-4"><a href="#cb422-4"></a></span>
<span id="cb422-5"><a href="#cb422-5"></a>tree_folds &lt;-<span class="st"> </span><span class="kw">vfold_cv</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)),</span>
<span id="cb422-6"><a href="#cb422-6"></a>                       <span class="dt">strata =</span> target)</span></code></pre></div>
</div>
<div id="add-these-elements-to-a-workflow-1" class="section level5" number="7.6.2.3.2">
<h5 number="7.6.2.3.2"><span class="header-section-number">7.6.2.3.2</span> Add these elements to a workflow</h5>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb423-1"><a href="#cb423-1"></a><span class="co"># Update workflow </span></span>
<span id="cb423-2"><a href="#cb423-2"></a>tree_wf &lt;-<span class="st"> </span>tree_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_model</span>(tune_spec)</span>
<span id="cb423-3"><a href="#cb423-3"></a></span>
<span id="cb423-4"><a href="#cb423-4"></a><span class="co"># Determine the number of cores</span></span>
<span id="cb423-5"><a href="#cb423-5"></a>no_cores &lt;-<span class="st"> </span><span class="kw">detectCores</span>() <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb423-6"><a href="#cb423-6"></a></span>
<span id="cb423-7"><a href="#cb423-7"></a><span class="co"># Initiate</span></span>
<span id="cb423-8"><a href="#cb423-8"></a>cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(no_cores)</span>
<span id="cb423-9"><a href="#cb423-9"></a></span>
<span id="cb423-10"><a href="#cb423-10"></a><span class="kw">registerDoParallel</span>(cl)</span>
<span id="cb423-11"><a href="#cb423-11"></a></span>
<span id="cb423-12"><a href="#cb423-12"></a><span class="co"># Tuning results </span></span>
<span id="cb423-13"><a href="#cb423-13"></a>tree_res &lt;-<span class="st"> </span>tree_wf <span class="op">%&gt;%</span></span>
<span id="cb423-14"><a href="#cb423-14"></a><span class="st">  </span><span class="kw">tune_grid</span>(</span>
<span id="cb423-15"><a href="#cb423-15"></a>    <span class="dt">resamples =</span> tree_folds, </span>
<span id="cb423-16"><a href="#cb423-16"></a>    <span class="dt">grid =</span> tree_grid,</span>
<span id="cb423-17"><a href="#cb423-17"></a>    <span class="dt">metrics =</span> metrics</span>
<span id="cb423-18"><a href="#cb423-18"></a>  )</span></code></pre></div>
</div>
<div id="visualize-1" class="section level5" number="7.6.2.3.3">
<h5 number="7.6.2.3.3"><span class="header-section-number">7.6.2.3.3</span> Visualize</h5>
<ul>
<li>The following plot draws on the <a href="https://www.tidymodels.org/start/tuning/">vignette</a> of the tidymodels package.</li>
</ul>
<div class="sourceCode" id="cb424"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb424-1"><a href="#cb424-1"></a>tree_res <span class="op">%&gt;%</span></span>
<span id="cb424-2"><a href="#cb424-2"></a><span class="st">  </span><span class="kw">collect_metrics</span>() <span class="op">%&gt;%</span></span>
<span id="cb424-3"><a href="#cb424-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tree_depth =</span> <span class="kw">factor</span>(tree_depth)) <span class="op">%&gt;%</span></span>
<span id="cb424-4"><a href="#cb424-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(cost_complexity, mean, <span class="dt">col =</span> .metric)) <span class="op">+</span></span>
<span id="cb424-5"><a href="#cb424-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span></span>
<span id="cb424-6"><a href="#cb424-6"></a><span class="st">  </span><span class="co"># Subplots </span></span>
<span id="cb424-7"><a href="#cb424-7"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>tree_depth, </span>
<span id="cb424-8"><a href="#cb424-8"></a>             <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>, </span>
<span id="cb424-9"><a href="#cb424-9"></a>             <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb424-10"><a href="#cb424-10"></a><span class="st">  </span><span class="co"># Log scale x </span></span>
<span id="cb424-11"><a href="#cb424-11"></a><span class="st">  </span><span class="kw">scale_x_log10</span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">label_number</span>()) <span class="op">+</span></span>
<span id="cb424-12"><a href="#cb424-12"></a><span class="st">  </span><span class="co"># Discrete color scale </span></span>
<span id="cb424-13"><a href="#cb424-13"></a><span class="st">  </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="dt">begin =</span> <span class="fl">.9</span>, <span class="dt">end =</span> <span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb424-14"><a href="#cb424-14"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Cost complexity&quot;</span>,</span>
<span id="cb424-15"><a href="#cb424-15"></a>       <span class="dt">col =</span> <span class="st">&quot;Tree depth&quot;</span>,</span>
<span id="cb424-16"><a href="#cb424-16"></a>       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb424-17"><a href="#cb424-17"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-30-1.png" width="672" />
##### Select</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb425-1"><a href="#cb425-1"></a><span class="co"># Optimal parameter</span></span>
<span id="cb425-2"><a href="#cb425-2"></a>best_tree &lt;-<span class="st"> </span><span class="kw">select_best</span>(tree_res, <span class="st">&quot;recall&quot;</span>)</span>
<span id="cb425-3"><a href="#cb425-3"></a></span>
<span id="cb425-4"><a href="#cb425-4"></a><span class="co"># Add the parameter to the workflow </span></span>
<span id="cb425-5"><a href="#cb425-5"></a>finalize_tree &lt;-<span class="st"> </span>tree_wf <span class="op">%&gt;%</span></span>
<span id="cb425-6"><a href="#cb425-6"></a><span class="st">  </span><span class="kw">finalize_workflow</span>(best_tree)</span></code></pre></div>
<div class="sourceCode" id="cb426"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb426-1"><a href="#cb426-1"></a>tree_fit_tuned &lt;-<span class="st"> </span>finalize_tree <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb426-2"><a href="#cb426-2"></a><span class="st">  </span><span class="kw">fit</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)))</span>
<span id="cb426-3"><a href="#cb426-3"></a></span>
<span id="cb426-4"><a href="#cb426-4"></a><span class="co"># Metrics </span></span>
<span id="cb426-5"><a href="#cb426-5"></a>(tree_fit_viz_metr <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Non-tuned&quot;</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">visualize_class_eval</span>(tree_fit_tuned) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Tuned&quot;</span>))</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb427-1"><a href="#cb427-1"></a><span class="co"># Confusion matrix </span></span>
<span id="cb427-2"><a href="#cb427-2"></a>(tree_fit_viz_mat <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Non-tuned&quot;</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">visualize_class_conf</span>(tree_fit_tuned) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Tuned&quot;</span>))</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-32-2.png" width="672" /></p>
<ul>
<li>Visualize variable importance</li>
</ul>
<div class="sourceCode" id="cb428"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb428-1"><a href="#cb428-1"></a>tree_fit_tuned <span class="op">%&gt;%</span></span>
<span id="cb428-2"><a href="#cb428-2"></a><span class="st">  </span><span class="kw">pull_workflow_fit</span>() <span class="op">%&gt;%</span></span>
<span id="cb428-3"><a href="#cb428-3"></a><span class="st">  </span>vip<span class="op">::</span><span class="kw">vip</span>()</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
</div>
<div id="test-fit-1" class="section level5" number="7.6.2.3.4">
<h5 number="7.6.2.3.4"><span class="header-section-number">7.6.2.3.4</span> Test fit</h5>
<ul>
<li>Apply the tuned model to the test dataset</li>
</ul>
<div class="sourceCode" id="cb429"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb429-1"><a href="#cb429-1"></a>test_fit &lt;-<span class="st"> </span>finalize_tree <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb429-2"><a href="#cb429-2"></a><span class="st">  </span><span class="kw">fit</span>(test_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> test_y_class)))</span>
<span id="cb429-3"><a href="#cb429-3"></a></span>
<span id="cb429-4"><a href="#cb429-4"></a><span class="kw">evaluate_class</span>(test_fit)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric   .estimator .estimate
##   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy  binary         0.744
## 2 precision binary         0.705
## 3 recall    binary         0.756</code></pre>
</div>
</div>
</div>
<div id="random-forest" class="section level3" number="7.6.3">
<h3 number="7.6.3"><span class="header-section-number">7.6.3</span> Random forest</h3>
<div id="parsnip-2" class="section level4" number="7.6.3.1">
<h4 number="7.6.3.1"><span class="header-section-number">7.6.3.1</span> parsnip</h4>
<ul>
<li>Build a model</li>
</ul>
<ol style="list-style-type: decimal">
<li>Specify a model</li>
<li>Specify an engine</li>
<li>Specify a mode</li>
</ol>
<div class="sourceCode" id="cb431"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb431-1"><a href="#cb431-1"></a><span class="co"># workflow </span></span>
<span id="cb431-2"><a href="#cb431-2"></a>rand_wf &lt;-<span class="st"> </span><span class="kw">workflow</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_formula</span>(target<span class="op">~</span>.)</span>
<span id="cb431-3"><a href="#cb431-3"></a></span>
<span id="cb431-4"><a href="#cb431-4"></a><span class="co"># spec </span></span>
<span id="cb431-5"><a href="#cb431-5"></a>rand_spec &lt;-<span class="st"> </span><span class="kw">rand_forest</span>(</span>
<span id="cb431-6"><a href="#cb431-6"></a>  </span>
<span id="cb431-7"><a href="#cb431-7"></a>           <span class="co"># Mode </span></span>
<span id="cb431-8"><a href="#cb431-8"></a>           <span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,</span>
<span id="cb431-9"><a href="#cb431-9"></a>           </span>
<span id="cb431-10"><a href="#cb431-10"></a>           <span class="co"># Tuning parameters</span></span>
<span id="cb431-11"><a href="#cb431-11"></a>           <span class="dt">mtry =</span> <span class="ot">NULL</span>, <span class="co"># The number of predictors to available for splitting at each node  </span></span>
<span id="cb431-12"><a href="#cb431-12"></a>           <span class="dt">min_n =</span> <span class="ot">NULL</span>, <span class="co"># The minimum number of data points needed to keep splitting nodes</span></span>
<span id="cb431-13"><a href="#cb431-13"></a>           <span class="dt">trees =</span> <span class="dv">500</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># The number of trees</span></span>
<span id="cb431-14"><a href="#cb431-14"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>, </span>
<span id="cb431-15"><a href="#cb431-15"></a>             <span class="co"># We want the importance of predictors to be assessed.</span></span>
<span id="cb431-16"><a href="#cb431-16"></a>             <span class="dt">seed =</span> <span class="dv">1234</span>, </span>
<span id="cb431-17"><a href="#cb431-17"></a>             <span class="dt">importance =</span> <span class="st">&quot;permutation&quot;</span>) </span>
<span id="cb431-18"><a href="#cb431-18"></a></span>
<span id="cb431-19"><a href="#cb431-19"></a>rand_wf &lt;-<span class="st"> </span>rand_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_model</span>(rand_spec)</span></code></pre></div>
<ul>
<li>Fit a model</li>
</ul>
<div class="sourceCode" id="cb432"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb432-1"><a href="#cb432-1"></a>rand_fit &lt;-<span class="st"> </span>rand_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)))</span></code></pre></div>
</div>
<div id="yardstick-2" class="section level4" number="7.6.3.2">
<h4 number="7.6.3.2"><span class="header-section-number">7.6.3.2</span> yardstick</h4>
<ul>
<li>Let’s formally test prediction performance.</li>
</ul>
<p><strong>Metrics</strong></p>
<ul>
<li><p><code>accuracy</code>: The proportion of the data predicted correctly</p></li>
<li><p><code>precision</code>: Positive predictive value</p></li>
<li><p><code>recall</code> (specificity): True positive rate (e.g., healthy people really healthy)</p></li>
</ul>
<div class="sourceCode" id="cb433"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb433-1"><a href="#cb433-1"></a><span class="co"># Define performance metrics </span></span>
<span id="cb433-2"><a href="#cb433-2"></a>metrics &lt;-<span class="st"> </span>yardstick<span class="op">::</span><span class="kw">metric_set</span>(accuracy, precision, recall)</span>
<span id="cb433-3"><a href="#cb433-3"></a></span>
<span id="cb433-4"><a href="#cb433-4"></a>rand_fit_viz_metr &lt;-<span class="st"> </span><span class="kw">visualize_class_eval</span>(rand_fit)</span>
<span id="cb433-5"><a href="#cb433-5"></a></span>
<span id="cb433-6"><a href="#cb433-6"></a>rand_fit_viz_metr</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<ul>
<li>Visualize the confusion matrix.</li>
</ul>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb434-1"><a href="#cb434-1"></a>rand_fit_viz_mat &lt;-<span class="st"> </span><span class="kw">visualize_class_conf</span>(rand_fit)</span>
<span id="cb434-2"><a href="#cb434-2"></a></span>
<span id="cb434-3"><a href="#cb434-3"></a>rand_fit_viz_mat</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
</div>
<div id="tune-2" class="section level4" number="7.6.3.3">
<h4 number="7.6.3.3"><span class="header-section-number">7.6.3.3</span> tune</h4>
<div id="tune-ingredients-2" class="section level5" number="7.6.3.3.1">
<h5 number="7.6.3.3.1"><span class="header-section-number">7.6.3.3.1</span> tune ingredients</h5>
<p>We focus on the following two parameters:</p>
<ul>
<li><p><code>mtry</code>: The number of predictors to available for splitting at each node.</p></li>
<li><p><code>min_n</code>: The minimum number of data points needed to keep splitting nodes.</p></li>
</ul>
<div class="sourceCode" id="cb435"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb435-1"><a href="#cb435-1"></a>tune_spec &lt;-<span class="st"> </span></span>
<span id="cb435-2"><a href="#cb435-2"></a><span class="st">  </span><span class="kw">rand_forest</span>(</span>
<span id="cb435-3"><a href="#cb435-3"></a>           <span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,</span>
<span id="cb435-4"><a href="#cb435-4"></a>           </span>
<span id="cb435-5"><a href="#cb435-5"></a>           <span class="co"># Tuning parameters</span></span>
<span id="cb435-6"><a href="#cb435-6"></a>           <span class="dt">mtry =</span> <span class="kw">tune</span>(), </span>
<span id="cb435-7"><a href="#cb435-7"></a>           <span class="dt">min_n =</span> <span class="kw">tune</span>()) <span class="op">%&gt;%</span></span>
<span id="cb435-8"><a href="#cb435-8"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>,</span>
<span id="cb435-9"><a href="#cb435-9"></a>             <span class="dt">seed =</span> <span class="dv">1234</span>, </span>
<span id="cb435-10"><a href="#cb435-10"></a>             <span class="dt">importance =</span> <span class="st">&quot;permutation&quot;</span>)</span>
<span id="cb435-11"><a href="#cb435-11"></a></span>
<span id="cb435-12"><a href="#cb435-12"></a>rand_grid &lt;-<span class="st"> </span><span class="kw">grid_regular</span>(<span class="kw">mtry</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>)),</span>
<span id="cb435-13"><a href="#cb435-13"></a>                          <span class="kw">min_n</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">10</span>)),</span>
<span id="cb435-14"><a href="#cb435-14"></a>                          <span class="dt">levels =</span> <span class="dv">5</span>)</span>
<span id="cb435-15"><a href="#cb435-15"></a></span>
<span id="cb435-16"><a href="#cb435-16"></a>rand_grid <span class="op">%&gt;%</span></span>
<span id="cb435-17"><a href="#cb435-17"></a><span class="st">  </span><span class="kw">count</span>(min_n)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 2
##   min_n     n
##   &lt;int&gt; &lt;int&gt;
## 1     2     5
## 2     4     5
## 3     6     5
## 4     8     5
## 5    10     5</code></pre>
<div class="sourceCode" id="cb437"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb437-1"><a href="#cb437-1"></a><span class="co"># 10-fold cross-validation</span></span>
<span id="cb437-2"><a href="#cb437-2"></a></span>
<span id="cb437-3"><a href="#cb437-3"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>) <span class="co"># for reproducibility </span></span>
<span id="cb437-4"><a href="#cb437-4"></a></span>
<span id="cb437-5"><a href="#cb437-5"></a>rand_folds &lt;-<span class="st"> </span><span class="kw">vfold_cv</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)),</span>
<span id="cb437-6"><a href="#cb437-6"></a>                       <span class="dt">strata =</span> target)</span></code></pre></div>
</div>
<div id="add-these-elements-to-a-workflow-2" class="section level5" number="7.6.3.3.2">
<h5 number="7.6.3.3.2"><span class="header-section-number">7.6.3.3.2</span> Add these elements to a workflow</h5>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb438-1"><a href="#cb438-1"></a><span class="co"># Update workflow </span></span>
<span id="cb438-2"><a href="#cb438-2"></a>rand_wf &lt;-<span class="st"> </span>rand_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_model</span>(tune_spec)</span>
<span id="cb438-3"><a href="#cb438-3"></a></span>
<span id="cb438-4"><a href="#cb438-4"></a><span class="co"># Tuning results </span></span>
<span id="cb438-5"><a href="#cb438-5"></a>rand_res &lt;-<span class="st"> </span>rand_wf <span class="op">%&gt;%</span></span>
<span id="cb438-6"><a href="#cb438-6"></a><span class="st">  </span><span class="kw">tune_grid</span>(</span>
<span id="cb438-7"><a href="#cb438-7"></a>    <span class="dt">resamples =</span> rand_folds, </span>
<span id="cb438-8"><a href="#cb438-8"></a>    <span class="dt">grid =</span> rand_grid,</span>
<span id="cb438-9"><a href="#cb438-9"></a>    <span class="dt">metrics =</span> metrics</span>
<span id="cb438-10"><a href="#cb438-10"></a>  )</span></code></pre></div>
</div>
<div id="visualize-2" class="section level5" number="7.6.3.3.3">
<h5 number="7.6.3.3.3"><span class="header-section-number">7.6.3.3.3</span> Visualize</h5>
<div class="sourceCode" id="cb439"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb439-1"><a href="#cb439-1"></a>rand_res <span class="op">%&gt;%</span></span>
<span id="cb439-2"><a href="#cb439-2"></a><span class="st">  </span><span class="kw">collect_metrics</span>() <span class="op">%&gt;%</span></span>
<span id="cb439-3"><a href="#cb439-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">min_n =</span> <span class="kw">factor</span>(min_n)) <span class="op">%&gt;%</span></span>
<span id="cb439-4"><a href="#cb439-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(mtry, mean, <span class="dt">color =</span> min_n)) <span class="op">+</span></span>
<span id="cb439-5"><a href="#cb439-5"></a><span class="st">  </span><span class="co"># Line + Point plot </span></span>
<span id="cb439-6"><a href="#cb439-6"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="fl">1.5</span>, <span class="dt">alpha =</span> <span class="fl">0.6</span>) <span class="op">+</span></span>
<span id="cb439-7"><a href="#cb439-7"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb439-8"><a href="#cb439-8"></a><span class="st">  </span><span class="co"># Subplots </span></span>
<span id="cb439-9"><a href="#cb439-9"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>.metric, </span>
<span id="cb439-10"><a href="#cb439-10"></a>             <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>, </span>
<span id="cb439-11"><a href="#cb439-11"></a>             <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb439-12"><a href="#cb439-12"></a><span class="st">  </span><span class="co"># Log scale x </span></span>
<span id="cb439-13"><a href="#cb439-13"></a><span class="st">  </span><span class="kw">scale_x_log10</span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">label_number</span>()) <span class="op">+</span></span>
<span id="cb439-14"><a href="#cb439-14"></a><span class="st">  </span><span class="co"># Discrete color scale </span></span>
<span id="cb439-15"><a href="#cb439-15"></a><span class="st">  </span><span class="kw">scale_color_viridis_d</span>(<span class="dt">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="dt">begin =</span> <span class="fl">.9</span>, <span class="dt">end =</span> <span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb439-16"><a href="#cb439-16"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;The number of predictors to be sampled&quot;</span>,</span>
<span id="cb439-17"><a href="#cb439-17"></a>       <span class="dt">col =</span> <span class="st">&quot;The minimum number of data points needed for splitting&quot;</span>,</span>
<span id="cb439-18"><a href="#cb439-18"></a>       <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb439-19"><a href="#cb439-19"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<div class="sourceCode" id="cb440"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb440-1"><a href="#cb440-1"></a><span class="co"># Optimal parameter</span></span>
<span id="cb440-2"><a href="#cb440-2"></a>best_tree &lt;-<span class="st"> </span><span class="kw">select_best</span>(rand_res, <span class="st">&quot;accuracy&quot;</span>)</span>
<span id="cb440-3"><a href="#cb440-3"></a></span>
<span id="cb440-4"><a href="#cb440-4"></a>best_tree</span></code></pre></div>
<pre><code>## # A tibble: 1 x 3
##    mtry min_n .config
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;  
## 1     1     2 Model01</code></pre>
<div class="sourceCode" id="cb442"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb442-1"><a href="#cb442-1"></a><span class="co"># Add the parameter to the workflow </span></span>
<span id="cb442-2"><a href="#cb442-2"></a>finalize_tree &lt;-<span class="st"> </span>rand_wf <span class="op">%&gt;%</span></span>
<span id="cb442-3"><a href="#cb442-3"></a><span class="st">  </span><span class="kw">finalize_workflow</span>(best_tree)</span></code></pre></div>
<div class="sourceCode" id="cb443"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb443-1"><a href="#cb443-1"></a>rand_fit_tuned &lt;-<span class="st"> </span>finalize_tree <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb443-2"><a href="#cb443-2"></a><span class="st">  </span><span class="kw">fit</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)))</span>
<span id="cb443-3"><a href="#cb443-3"></a></span>
<span id="cb443-4"><a href="#cb443-4"></a><span class="co"># Metrics </span></span>
<span id="cb443-5"><a href="#cb443-5"></a>(rand_fit_viz_metr <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Non-tuned&quot;</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">visualize_class_eval</span>(rand_fit_tuned) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Tuned&quot;</span>))</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<div class="sourceCode" id="cb444"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb444-1"><a href="#cb444-1"></a><span class="co"># Confusion matrix </span></span>
<span id="cb444-2"><a href="#cb444-2"></a>(rand_fit_viz_mat <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Non-tuned&quot;</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">visualize_class_conf</span>(rand_fit_tuned) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Tuned&quot;</span>))</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-44-2.png" width="672" /></p>
<ul>
<li>Visualize variable importance</li>
</ul>
<div class="sourceCode" id="cb445"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb445-1"><a href="#cb445-1"></a>rand_fit_tuned <span class="op">%&gt;%</span></span>
<span id="cb445-2"><a href="#cb445-2"></a><span class="st">  </span><span class="kw">pull_workflow_fit</span>() <span class="op">%&gt;%</span></span>
<span id="cb445-3"><a href="#cb445-3"></a><span class="st">  </span>vip<span class="op">::</span><span class="kw">vip</span>()</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
</div>
<div id="test-fit-2" class="section level5" number="7.6.3.3.4">
<h5 number="7.6.3.3.4"><span class="header-section-number">7.6.3.3.4</span> Test fit</h5>
<ul>
<li>Apply the tuned model to the test dataset</li>
</ul>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb446-1"><a href="#cb446-1"></a>test_fit &lt;-<span class="st"> </span>finalize_tree <span class="op">%&gt;%</span></span>
<span id="cb446-2"><a href="#cb446-2"></a><span class="st">  </span><span class="kw">fit</span>(test_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> test_y_class)))</span>
<span id="cb446-3"><a href="#cb446-3"></a></span>
<span id="cb446-4"><a href="#cb446-4"></a><span class="kw">evaluate_class</span>(test_fit)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric   .estimator .estimate
##   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy  binary         0.933
## 2 precision binary         0.973
## 3 recall    binary         0.878</code></pre>
</div>
</div>
</div>
<div id="xgboost" class="section level3" number="7.6.4">
<h3 number="7.6.4"><span class="header-section-number">7.6.4</span> XGboost</h3>
<div id="parsnip-3" class="section level4" number="7.6.4.1">
<h4 number="7.6.4.1"><span class="header-section-number">7.6.4.1</span> parsnip</h4>
<ul>
<li>Build a model</li>
</ul>
<ol style="list-style-type: decimal">
<li>Specify a model</li>
<li>Specify an engine</li>
<li>Specify a mode</li>
</ol>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb448-1"><a href="#cb448-1"></a><span class="co"># workflow </span></span>
<span id="cb448-2"><a href="#cb448-2"></a>xg_wf &lt;-<span class="st"> </span><span class="kw">workflow</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_formula</span>(target<span class="op">~</span>.)</span>
<span id="cb448-3"><a href="#cb448-3"></a></span>
<span id="cb448-4"><a href="#cb448-4"></a><span class="co"># spec </span></span>
<span id="cb448-5"><a href="#cb448-5"></a>xg_spec &lt;-<span class="st"> </span><span class="kw">boost_tree</span>(</span>
<span id="cb448-6"><a href="#cb448-6"></a>  </span>
<span id="cb448-7"><a href="#cb448-7"></a>           <span class="co"># Mode </span></span>
<span id="cb448-8"><a href="#cb448-8"></a>           <span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,</span>
<span id="cb448-9"><a href="#cb448-9"></a>           </span>
<span id="cb448-10"><a href="#cb448-10"></a>           <span class="co"># Tuning parameters</span></span>
<span id="cb448-11"><a href="#cb448-11"></a>           </span>
<span id="cb448-12"><a href="#cb448-12"></a>           <span class="co"># The number of trees to fit, aka boosting iterations</span></span>
<span id="cb448-13"><a href="#cb448-13"></a>           <span class="dt">trees =</span> <span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">700</span>, <span class="dv">900</span>),</span>
<span id="cb448-14"><a href="#cb448-14"></a>           <span class="co"># The depth of the decision tree (how many levels of splits).</span></span>
<span id="cb448-15"><a href="#cb448-15"></a>	         <span class="dt">tree_depth =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">6</span>), </span>
<span id="cb448-16"><a href="#cb448-16"></a>           <span class="co"># Learning rate: lower means the ensemble will adapt more slowly.</span></span>
<span id="cb448-17"><a href="#cb448-17"></a>           <span class="dt">learn_rate =</span> <span class="kw">c</span>(<span class="fl">0.0001</span>, <span class="fl">0.01</span>, <span class="fl">0.2</span>),</span>
<span id="cb448-18"><a href="#cb448-18"></a>           <span class="co"># Stop splitting a tree if we only have this many obs in a tree node.</span></span>
<span id="cb448-19"><a href="#cb448-19"></a>	         <span class="dt">min_n =</span> 10L</span>
<span id="cb448-20"><a href="#cb448-20"></a>          ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb448-21"><a href="#cb448-21"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) </span>
<span id="cb448-22"><a href="#cb448-22"></a></span>
<span id="cb448-23"><a href="#cb448-23"></a>xg_wf &lt;-<span class="st"> </span>xg_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_model</span>(xg_spec)</span></code></pre></div>
<ul>
<li>Fit a model</li>
</ul>
<div class="sourceCode" id="cb449"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb449-1"><a href="#cb449-1"></a>xg_fit &lt;-<span class="st"> </span>xg_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)))</span></code></pre></div>
<pre><code>## Warning in begin_iteration:end_iteration: numerical expression has 5 elements:
## only the first used</code></pre>
</div>
<div id="yardstick-3" class="section level4" number="7.6.4.2">
<h4 number="7.6.4.2"><span class="header-section-number">7.6.4.2</span> yardstick</h4>
<ul>
<li>Let’s formally test prediction performance.</li>
</ul>
<p><strong>Metrics</strong></p>
<ul>
<li><p><code>accuracy</code>: The proportion of the data predicted correctly</p></li>
<li><p><code>precision</code>: Positive predictive value</p></li>
<li><p><code>recall</code> (specificity): True positive rate (e.g., healthy people really healthy)</p></li>
</ul>
<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb451-1"><a href="#cb451-1"></a>metrics &lt;-<span class="st"> </span><span class="kw">metric_set</span>(yardstick<span class="op">::</span>accuracy, </span>
<span id="cb451-2"><a href="#cb451-2"></a>                      yardstick<span class="op">::</span>precision, </span>
<span id="cb451-3"><a href="#cb451-3"></a>                      yardstick<span class="op">::</span>recall)</span>
<span id="cb451-4"><a href="#cb451-4"></a></span>
<span id="cb451-5"><a href="#cb451-5"></a><span class="kw">evaluate_class</span>(xg_fit)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric   .estimator .estimate
##   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy  binary         0.733
## 2 precision binary         0.730
## 3 recall    binary         0.659</code></pre>
<div class="sourceCode" id="cb453"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb453-1"><a href="#cb453-1"></a>xg_fit_viz_metr &lt;-<span class="st"> </span><span class="kw">visualize_class_eval</span>(xg_fit)</span>
<span id="cb453-2"><a href="#cb453-2"></a></span>
<span id="cb453-3"><a href="#cb453-3"></a>xg_fit_viz_metr</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
<ul>
<li>Visualize the confusion matrix.</li>
</ul>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb454-1"><a href="#cb454-1"></a>xg_fit_viz_mat &lt;-<span class="st"> </span><span class="kw">visualize_class_conf</span>(xg_fit)</span>
<span id="cb454-2"><a href="#cb454-2"></a></span>
<span id="cb454-3"><a href="#cb454-3"></a>xg_fit_viz_mat</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
</div>
<div id="tune-3" class="section level4" number="7.6.4.3">
<h4 number="7.6.4.3"><span class="header-section-number">7.6.4.3</span> tune</h4>
<div id="tune-ingredients-3" class="section level5" number="7.6.4.3.1">
<h5 number="7.6.4.3.1"><span class="header-section-number">7.6.4.3.1</span> tune ingredients</h5>
<ul>
<li>We focus on the following parameters: <code>trees,</code> <code>tree_depth,</code> <code>learn_rate,</code> <code>min_n,</code> <code>mtry,</code> <code>loss_reduction,</code> and <code>sample_size</code></li>
</ul>
<div class="sourceCode" id="cb455"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb455-1"><a href="#cb455-1"></a>tune_spec &lt;-<span class="st"> </span></span>
<span id="cb455-2"><a href="#cb455-2"></a><span class="st">  </span>xg_spec &lt;-<span class="st"> </span><span class="kw">boost_tree</span>(</span>
<span id="cb455-3"><a href="#cb455-3"></a>  </span>
<span id="cb455-4"><a href="#cb455-4"></a>           <span class="co"># Mode </span></span>
<span id="cb455-5"><a href="#cb455-5"></a>           <span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>,</span>
<span id="cb455-6"><a href="#cb455-6"></a>           </span>
<span id="cb455-7"><a href="#cb455-7"></a>           <span class="co"># Tuning parameters</span></span>
<span id="cb455-8"><a href="#cb455-8"></a>           </span>
<span id="cb455-9"><a href="#cb455-9"></a>           <span class="co"># The number of trees to fit, aka boosting iterations</span></span>
<span id="cb455-10"><a href="#cb455-10"></a>           <span class="dt">trees =</span> <span class="kw">tune</span>(),</span>
<span id="cb455-11"><a href="#cb455-11"></a>           <span class="co"># The depth of the decision tree (how many levels of splits).</span></span>
<span id="cb455-12"><a href="#cb455-12"></a>	         <span class="dt">tree_depth =</span> <span class="kw">tune</span>(), </span>
<span id="cb455-13"><a href="#cb455-13"></a>           <span class="co"># Learning rate: lower means the ensemble will adapt more slowly.</span></span>
<span id="cb455-14"><a href="#cb455-14"></a>           <span class="dt">learn_rate =</span> <span class="kw">tune</span>(),</span>
<span id="cb455-15"><a href="#cb455-15"></a>           <span class="co"># Stop splitting a tree if we only have this many obs in a tree node.</span></span>
<span id="cb455-16"><a href="#cb455-16"></a>	         <span class="dt">min_n =</span> <span class="kw">tune</span>(),</span>
<span id="cb455-17"><a href="#cb455-17"></a>           <span class="dt">loss_reduction =</span> <span class="kw">tune</span>(),</span>
<span id="cb455-18"><a href="#cb455-18"></a>           <span class="co"># The number of randomly selected parameters </span></span>
<span id="cb455-19"><a href="#cb455-19"></a>           <span class="dt">mtry =</span> <span class="kw">tune</span>(), </span>
<span id="cb455-20"><a href="#cb455-20"></a>           <span class="co"># The size of the data set used for modeling within an iteration</span></span>
<span id="cb455-21"><a href="#cb455-21"></a>           <span class="dt">sample_size =</span> <span class="kw">tune</span>()</span>
<span id="cb455-22"><a href="#cb455-22"></a>          ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb455-23"><a href="#cb455-23"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) </span>
<span id="cb455-24"><a href="#cb455-24"></a></span>
<span id="cb455-25"><a href="#cb455-25"></a><span class="co"># Space-filling parameter grids </span></span>
<span id="cb455-26"><a href="#cb455-26"></a>xg_grid &lt;-<span class="st"> </span><span class="kw">grid_latin_hypercube</span>(</span>
<span id="cb455-27"><a href="#cb455-27"></a>  <span class="kw">trees</span>(),</span>
<span id="cb455-28"><a href="#cb455-28"></a>  <span class="kw">tree_depth</span>(),</span>
<span id="cb455-29"><a href="#cb455-29"></a>  <span class="kw">learn_rate</span>(),</span>
<span id="cb455-30"><a href="#cb455-30"></a>  <span class="kw">min_n</span>(),</span>
<span id="cb455-31"><a href="#cb455-31"></a>  <span class="kw">loss_reduction</span>(), </span>
<span id="cb455-32"><a href="#cb455-32"></a>  <span class="dt">sample_size =</span> <span class="kw">sample_prop</span>(),</span>
<span id="cb455-33"><a href="#cb455-33"></a>  <span class="kw">finalize</span>(<span class="kw">mtry</span>(), train_x_class),</span>
<span id="cb455-34"><a href="#cb455-34"></a>  <span class="dt">size =</span> <span class="dv">30</span></span>
<span id="cb455-35"><a href="#cb455-35"></a>  )</span>
<span id="cb455-36"><a href="#cb455-36"></a></span>
<span id="cb455-37"><a href="#cb455-37"></a><span class="co"># 10-fold cross-validation</span></span>
<span id="cb455-38"><a href="#cb455-38"></a></span>
<span id="cb455-39"><a href="#cb455-39"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>) <span class="co"># for reproducibility </span></span>
<span id="cb455-40"><a href="#cb455-40"></a></span>
<span id="cb455-41"><a href="#cb455-41"></a>xg_folds &lt;-<span class="st"> </span><span class="kw">vfold_cv</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)),</span>
<span id="cb455-42"><a href="#cb455-42"></a>                     <span class="dt">strata =</span> target)</span></code></pre></div>
</div>
<div id="add-these-elements-to-a-workflow-3" class="section level5" number="7.6.4.3.2">
<h5 number="7.6.4.3.2"><span class="header-section-number">7.6.4.3.2</span> Add these elements to a workflow</h5>
<div class="sourceCode" id="cb456"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb456-1"><a href="#cb456-1"></a><span class="co"># Update workflow </span></span>
<span id="cb456-2"><a href="#cb456-2"></a>xg_wf &lt;-<span class="st"> </span>xg_wf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_model</span>(tune_spec)</span>
<span id="cb456-3"><a href="#cb456-3"></a></span>
<span id="cb456-4"><a href="#cb456-4"></a><span class="co"># Tuning results </span></span>
<span id="cb456-5"><a href="#cb456-5"></a>xg_res &lt;-<span class="st"> </span>xg_wf <span class="op">%&gt;%</span></span>
<span id="cb456-6"><a href="#cb456-6"></a><span class="st">  </span><span class="kw">tune_grid</span>(</span>
<span id="cb456-7"><a href="#cb456-7"></a>    <span class="dt">resamples =</span> xg_folds, </span>
<span id="cb456-8"><a href="#cb456-8"></a>    <span class="dt">grid =</span> xg_grid,</span>
<span id="cb456-9"><a href="#cb456-9"></a>    <span class="dt">control =</span> <span class="kw">control_grid</span>(<span class="dt">save_pred =</span> <span class="ot">TRUE</span>)</span>
<span id="cb456-10"><a href="#cb456-10"></a>  )</span></code></pre></div>
</div>
<div id="visualize-3" class="section level5" number="7.6.4.3.3">
<h5 number="7.6.4.3.3"><span class="header-section-number">7.6.4.3.3</span> Visualize</h5>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb457-1"><a href="#cb457-1"></a>xg_res <span class="op">%&gt;%</span></span>
<span id="cb457-2"><a href="#cb457-2"></a><span class="st">  </span><span class="kw">collect_metrics</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb457-3"><a href="#cb457-3"></a><span class="st">  </span><span class="kw">filter</span>(.metric <span class="op">==</span><span class="st"> &quot;roc_auc&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb457-4"><a href="#cb457-4"></a><span class="st">  </span><span class="kw">pivot_longer</span>(mtry<span class="op">:</span>sample_size,</span>
<span id="cb457-5"><a href="#cb457-5"></a>               <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb457-6"><a href="#cb457-6"></a>               <span class="dt">names_to =</span> <span class="st">&quot;parameter&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb457-7"><a href="#cb457-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> mean, <span class="dt">color =</span> parameter)) <span class="op">+</span></span>
<span id="cb457-8"><a href="#cb457-8"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.8</span>, <span class="dt">show.legend =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb457-9"><a href="#cb457-9"></a><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>parameter, <span class="dt">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="op">+</span></span>
<span id="cb457-10"><a href="#cb457-10"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;AUC&quot;</span>,</span>
<span id="cb457-11"><a href="#cb457-11"></a>         <span class="dt">x =</span> <span class="ot">NULL</span>)</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-54-1.png" width="672" /></p>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb458-1"><a href="#cb458-1"></a><span class="co"># Optimal parameter</span></span>
<span id="cb458-2"><a href="#cb458-2"></a>best_xg &lt;-<span class="st"> </span><span class="kw">select_best</span>(xg_res, <span class="st">&quot;roc_auc&quot;</span>)</span>
<span id="cb458-3"><a href="#cb458-3"></a></span>
<span id="cb458-4"><a href="#cb458-4"></a>best_xg </span></code></pre></div>
<pre><code>## # A tibble: 1 x 8
##    mtry trees min_n tree_depth  learn_rate loss_reduction sample_size .config
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;int&gt;       &lt;dbl&gt;          &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;  
## 1     6    98     4         13 0.000000211  0.00000000336       0.422 Model26</code></pre>
<div class="sourceCode" id="cb460"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb460-1"><a href="#cb460-1"></a><span class="co"># Add the parameter to the workflow </span></span>
<span id="cb460-2"><a href="#cb460-2"></a>finalize_xg &lt;-<span class="st"> </span>xg_wf <span class="op">%&gt;%</span></span>
<span id="cb460-3"><a href="#cb460-3"></a><span class="st">  </span><span class="kw">finalize_workflow</span>(best_xg)</span></code></pre></div>
<div class="sourceCode" id="cb461"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb461-1"><a href="#cb461-1"></a>xg_fit_tuned &lt;-<span class="st"> </span>finalize_xg <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb461-2"><a href="#cb461-2"></a><span class="st">  </span><span class="kw">fit</span>(train_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> train_y_class)))</span>
<span id="cb461-3"><a href="#cb461-3"></a></span>
<span id="cb461-4"><a href="#cb461-4"></a><span class="co"># Metrics </span></span>
<span id="cb461-5"><a href="#cb461-5"></a>(xg_fit_viz_metr <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Non-tuned&quot;</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">visualize_class_eval</span>(xg_fit_tuned) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Tuned&quot;</span>))</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-56-1.png" width="672" /></p>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb462-1"><a href="#cb462-1"></a><span class="co"># Confusion matrix </span></span>
<span id="cb462-2"><a href="#cb462-2"></a>(xg_fit_viz_mat <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Non-tuned&quot;</span>)) <span class="op">/</span><span class="st"> </span>(<span class="kw">visualize_class_conf</span>(xg_fit_tuned) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Tuned&quot;</span>))</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-56-2.png" width="672" /></p>
<ul>
<li>Visualize variable importance</li>
</ul>
<div class="sourceCode" id="cb463"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb463-1"><a href="#cb463-1"></a>xg_fit_tuned <span class="op">%&gt;%</span></span>
<span id="cb463-2"><a href="#cb463-2"></a><span class="st">  </span><span class="kw">pull_workflow_fit</span>() <span class="op">%&gt;%</span></span>
<span id="cb463-3"><a href="#cb463-3"></a><span class="st">  </span>vip<span class="op">::</span><span class="kw">vip</span>()</span></code></pre></div>
<pre><code>## Warning: `as.tibble()` is deprecated as of tibble 2.0.0.
## Please use `as_tibble()` instead.
## The signature and semantics have changed, see `?as_tibble`.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-57-1.png" width="672" /></p>
</div>
<div id="test-fit-3" class="section level5" number="7.6.4.3.4">
<h5 number="7.6.4.3.4"><span class="header-section-number">7.6.4.3.4</span> Test fit</h5>
<ul>
<li>Apply the tuned model to the test dataset</li>
</ul>
<div class="sourceCode" id="cb465"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb465-1"><a href="#cb465-1"></a>test_fit &lt;-<span class="st"> </span>finalize_xg <span class="op">%&gt;%</span></span>
<span id="cb465-2"><a href="#cb465-2"></a><span class="st">  </span><span class="kw">fit</span>(test_x_class <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_cols</span>(<span class="kw">tibble</span>(<span class="dt">target =</span> test_y_class)))</span>
<span id="cb465-3"><a href="#cb465-3"></a></span>
<span id="cb465-4"><a href="#cb465-4"></a><span class="kw">evaluate_class</span>(test_fit)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric   .estimator .estimate
##   &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy  binary         0.8  
## 2 precision binary         0.795
## 3 recall    binary         0.756</code></pre>
</div>
</div>
</div>
<div id="applications" class="section level3" number="7.6.5">
<h3 number="7.6.5"><span class="header-section-number">7.6.5</span> Applications</h3>
<div id="bandit-algorithm-optimizing-an-experiment" class="section level4" number="7.6.5.1">
<h4 number="7.6.5.1"><span class="header-section-number">7.6.5.1</span> Bandit algorithm (optimizing an experiment)</h4>
</div>
<div id="causal-forest-estimating-heterogeneous-treatment-effect" class="section level4" number="7.6.5.2">
<h4 number="7.6.5.2"><span class="header-section-number">7.6.5.2</span> Causal forest (estimating heterogeneous treatment effect)</h4>
</div>
</div>
</div>
<div id="unsupervised-learning" class="section level2" number="7.7">
<h2 number="7.7"><span class="header-section-number">7.7</span> Unsupervised learning</h2>
<p>x -&gt; f - &gt; y (not defined)</p>
<div id="dimension-reduction" class="section level3" number="7.7.1">
<h3 number="7.7.1"><span class="header-section-number">7.7.1</span> Dimension reduction</h3>
<div class="figure">
<img src="https://i.stack.imgur.com/Q7HIP.gif" alt="" />
<p class="caption">Projecting 2D-data to a line (PCA). From vas3k.com</p>
</div>
<div id="correlation-analysis" class="section level4" number="7.7.1.1">
<h4 number="7.7.1.1"><span class="header-section-number">7.7.1.1</span> Correlation analysis</h4>
<ul>
<li><p>Notice some problems?</p>
<ul>
<li><p>NAs</p></li>
<li><p>Scaling issues</p></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb467-1"><a href="#cb467-1"></a>data_original <span class="op">%&gt;%</span></span>
<span id="cb467-2"><a href="#cb467-2"></a><span class="st">  </span>corrr<span class="op">::</span><span class="kw">correlate</span>()</span></code></pre></div>
<pre><code>## 
## Correlation method: &#39;pearson&#39;
## Missing treated using: &#39;pairwise.complete.obs&#39;</code></pre>
<pre><code>## # A tibble: 14 x 15
##    rowname     age     sex      cp trestbps     chol      fbs restecg  thalach
##    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
##  1 age     NA      -0.0984 -0.0687   0.279   0.214    0.121   -0.116  -0.399  
##  2 sex     -0.0984 NA      -0.0494  -0.0568 -0.198    0.0450  -0.0582 -0.0440 
##  3 cp      -0.0687 -0.0494 NA        0.0476 -0.0769   0.0944   0.0444  0.296  
##  4 trestb…  0.279  -0.0568  0.0476  NA       0.123    0.178   -0.114  -0.0467 
##  5 chol     0.214  -0.198  -0.0769   0.123  NA        0.0133  -0.151  -0.00994
##  6 fbs      0.121   0.0450  0.0944   0.178   0.0133  NA       -0.0842 -0.00857
##  7 restecg -0.116  -0.0582  0.0444  -0.114  -0.151   -0.0842  NA       0.0441 
##  8 thalach -0.399  -0.0440  0.296   -0.0467 -0.00994 -0.00857  0.0441 NA      
##  9 exang    0.0968  0.142  -0.394    0.0676  0.0670   0.0257  -0.0707 -0.379  
## 10 oldpeak  0.210   0.0961 -0.149    0.193   0.0540   0.00575 -0.0588 -0.344  
## 11 slope   -0.169  -0.0307  0.120   -0.121  -0.00404 -0.0599   0.0930  0.387  
## 12 ca       0.276   0.118  -0.181    0.101   0.0705   0.138   -0.0720 -0.213  
## 13 thal     0.0680  0.210  -0.162    0.0622  0.0988  -0.0320  -0.0120 -0.0964 
## 14 target  -0.225  -0.281   0.434   -0.145  -0.0852  -0.0280   0.137   0.422  
## # … with 6 more variables: exang &lt;dbl&gt;, oldpeak &lt;dbl&gt;, slope &lt;dbl&gt;, ca &lt;dbl&gt;,
## #   thal &lt;dbl&gt;, target &lt;dbl&gt;</code></pre>
</div>
<div id="preprocessing" class="section level4" number="7.7.1.2">
<h4 number="7.7.1.2"><span class="header-section-number">7.7.1.2</span> Preprocessing</h4>
<p><code>recipe</code> is essential for preprocesssing multiple features at once.</p>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb470-1"><a href="#cb470-1"></a>pca_recipe &lt;-<span class="st"> </span><span class="kw">recipe</span>(<span class="op">~</span>., <span class="dt">data =</span> data_original) <span class="op">%&gt;%</span></span>
<span id="cb470-2"><a href="#cb470-2"></a><span class="st">  </span><span class="co"># Imputing NAs using mean </span></span>
<span id="cb470-3"><a href="#cb470-3"></a><span class="st">  </span><span class="kw">step_meanimpute</span>(<span class="kw">all_predictors</span>()) <span class="op">%&gt;%</span></span>
<span id="cb470-4"><a href="#cb470-4"></a><span class="st">  </span><span class="co"># Normalize some numeric variables </span></span>
<span id="cb470-5"><a href="#cb470-5"></a><span class="st">  </span><span class="kw">step_normalize</span>(<span class="kw">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;trestbps&quot;</span>, <span class="st">&quot;chol&quot;</span>, <span class="st">&quot;thalach&quot;</span>, <span class="st">&quot;oldpeak&quot;</span>)) </span></code></pre></div>
</div>
<div id="pca-analysis" class="section level4" number="7.7.1.3">
<h4 number="7.7.1.3"><span class="header-section-number">7.7.1.3</span> PCA analysis</h4>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb471-1"><a href="#cb471-1"></a>pca_res &lt;-<span class="st"> </span>pca_recipe <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb471-2"><a href="#cb471-2"></a><span class="st">  </span><span class="kw">step_pca</span>(<span class="kw">all_predictors</span>(), </span>
<span id="cb471-3"><a href="#cb471-3"></a>           <span class="dt">id =</span> <span class="st">&quot;pca&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># id argument identifies each PCA step </span></span>
<span id="cb471-4"><a href="#cb471-4"></a><span class="st">  </span><span class="kw">prep</span>()</span>
<span id="cb471-5"><a href="#cb471-5"></a></span>
<span id="cb471-6"><a href="#cb471-6"></a>pca_res <span class="op">%&gt;%</span></span>
<span id="cb471-7"><a href="#cb471-7"></a><span class="st">  </span><span class="kw">tidy</span>(<span class="dt">id =</span> <span class="st">&quot;pca&quot;</span>) </span></code></pre></div>
<pre><code>## # A tibble: 196 x 4
##    terms        value component id   
##    &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;
##  1 age      -0.00101  PC1       pca  
##  2 sex       0.216    PC1       pca  
##  3 cp        0.321    PC1       pca  
##  4 trestbps  0.00118  PC1       pca  
##  5 chol     -0.000292 PC1       pca  
##  6 fbs       0.0468   PC1       pca  
##  7 restecg   0.166    PC1       pca  
##  8 thalach   0.0137   PC1       pca  
##  9 exang     0.0962   PC1       pca  
## 10 oldpeak  -0.00863  PC1       pca  
## # … with 186 more rows</code></pre>
<div id="screeplot" class="section level5" number="7.7.1.3.1">
<h5 number="7.7.1.3.1"><span class="header-section-number">7.7.1.3.1</span> Screeplot</h5>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb473-1"><a href="#cb473-1"></a>pca_recipe <span class="op">%&gt;%</span></span>
<span id="cb473-2"><a href="#cb473-2"></a><span class="st">  </span><span class="kw">step_pca</span>(<span class="kw">all_predictors</span>(), </span>
<span id="cb473-3"><a href="#cb473-3"></a>           <span class="dt">id =</span> <span class="st">&quot;pca&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># id argument identifies each PCA step </span></span>
<span id="cb473-4"><a href="#cb473-4"></a><span class="st">  </span><span class="kw">prep</span>() <span class="op">%&gt;%</span></span>
<span id="cb473-5"><a href="#cb473-5"></a><span class="st">  </span><span class="kw">tidy</span>(<span class="dt">id =</span> <span class="st">&quot;pca&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;variance&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb473-6"><a href="#cb473-6"></a><span class="st">  </span><span class="kw">filter</span>(terms <span class="op">==</span><span class="st"> &quot;percent variance&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb473-7"><a href="#cb473-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> component, <span class="dt">y =</span> value)) <span class="op">+</span></span>
<span id="cb473-8"><a href="#cb473-8"></a><span class="st">    </span><span class="kw">geom_col</span>() <span class="op">+</span></span>
<span id="cb473-9"><a href="#cb473-9"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;PCAs of heart disease&quot;</span>,</span>
<span id="cb473-10"><a href="#cb473-10"></a>         <span class="dt">y =</span> <span class="st">&quot;% of variance&quot;</span>,</span>
<span id="cb473-11"><a href="#cb473-11"></a>         <span class="dt">title =</span> <span class="st">&quot;Scree plot&quot;</span>)</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-62-1.png" width="672" /></p>
</div>
<div id="view-factor-loadings" class="section level5" number="7.7.1.3.2">
<h5 number="7.7.1.3.2"><span class="header-section-number">7.7.1.3.2</span> View factor loadings</h5>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb474-1"><a href="#cb474-1"></a>pca_recipe <span class="op">%&gt;%</span></span>
<span id="cb474-2"><a href="#cb474-2"></a><span class="st">  </span><span class="kw">step_pca</span>(<span class="kw">all_predictors</span>(), </span>
<span id="cb474-3"><a href="#cb474-3"></a>           <span class="dt">id =</span> <span class="st">&quot;pca&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># id argument identifies each PCA step </span></span>
<span id="cb474-4"><a href="#cb474-4"></a><span class="st">  </span><span class="kw">prep</span>() <span class="op">%&gt;%</span></span>
<span id="cb474-5"><a href="#cb474-5"></a><span class="st">  </span><span class="kw">tidy</span>(<span class="dt">id =</span> <span class="st">&quot;pca&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb474-6"><a href="#cb474-6"></a><span class="st">  </span><span class="kw">filter</span>(component <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;PC1&quot;</span>, <span class="st">&quot;PC2&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb474-7"><a href="#cb474-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">fct_reorder</span>(terms, value), <span class="dt">y =</span> value, </span>
<span id="cb474-8"><a href="#cb474-8"></a>             <span class="dt">fill =</span> component)) <span class="op">+</span></span>
<span id="cb474-9"><a href="#cb474-9"></a><span class="st">    </span><span class="kw">geom_col</span>(<span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="op">+</span></span>
<span id="cb474-10"><a href="#cb474-10"></a><span class="st">    </span><span class="kw">coord_flip</span>() <span class="op">+</span></span>
<span id="cb474-11"><a href="#cb474-11"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Terms&quot;</span>,</span>
<span id="cb474-12"><a href="#cb474-12"></a>         <span class="dt">y =</span> <span class="st">&quot;Contribtutions&quot;</span>,</span>
<span id="cb474-13"><a href="#cb474-13"></a>         <span class="dt">fill =</span> <span class="st">&quot;PCAs&quot;</span>) </span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-63-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="topic-modeling" class="section level3" number="7.7.2">
<h3 number="7.7.2"><span class="header-section-number">7.7.2</span> Topic modeling</h3>
<div id="setup" class="section level4" number="7.7.2.1">
<h4 number="7.7.2.1"><span class="header-section-number">7.7.2.1</span> Setup</h4>
<div class="sourceCode" id="cb475"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb475-1"><a href="#cb475-1"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(tidytext, <span class="co"># tidy text analysis</span></span>
<span id="cb475-2"><a href="#cb475-2"></a>               glue, <span class="co"># paste string and objects                </span></span>
<span id="cb475-3"><a href="#cb475-3"></a>               stm, <span class="co"># structural topic modeling</span></span>
<span id="cb475-4"><a href="#cb475-4"></a>               gutenbergr) <span class="co"># toy datasets </span></span></code></pre></div>
</div>
<div id="dataset-1" class="section level4" number="7.7.2.2">
<h4 number="7.7.2.2"><span class="header-section-number">7.7.2.2</span> Dataset</h4>
<p>The data munging process draws on <a href="https://juliasilge.com/blog/sherlock-holmes-stm/">Julia Silge’s blog post</a>.</p>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb476-1"><a href="#cb476-1"></a>sherlock_raw &lt;-<span class="st"> </span><span class="kw">gutenberg_download</span>(<span class="dv">1661</span>)</span></code></pre></div>
<pre><code>## Determining mirror for Project Gutenberg from http://www.gutenberg.org/robot/harvest</code></pre>
<pre><code>## Using mirror http://aleph.gutenberg.org</code></pre>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb479-1"><a href="#cb479-1"></a><span class="kw">glimpse</span>(sherlock_raw)</span></code></pre></div>
<pre><code>## Rows: 12,648
## Columns: 2
## $ gutenberg_id &lt;int&gt; 1661, 1661, 1661, 1661, 1661, 1661, 1661, 1661, 1661, 16…
## $ text         &lt;chr&gt; &quot;THE ADVENTURES OF SHERLOCK HOLMES&quot;, &quot;&quot;, &quot;by&quot;, &quot;&quot;, &quot;SIR …</code></pre>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb481-1"><a href="#cb481-1"></a>sherlock &lt;-<span class="st"> </span>sherlock_raw <span class="op">%&gt;%</span></span>
<span id="cb481-2"><a href="#cb481-2"></a><span class="st">  </span><span class="co"># Mutate story using a conditional statement </span></span>
<span id="cb481-3"><a href="#cb481-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">story =</span> <span class="kw">ifelse</span>(<span class="kw">str_starts</span>(text, <span class="st">&quot;ADVENTURE&quot;</span>), </span>
<span id="cb481-4"><a href="#cb481-4"></a>                                   text, <span class="ot">NA</span>)) <span class="op">%&gt;%</span></span>
<span id="cb481-5"><a href="#cb481-5"></a><span class="st">  </span><span class="co"># Fill in missing values with next value  </span></span>
<span id="cb481-6"><a href="#cb481-6"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw">fill</span>(story, <span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb481-7"><a href="#cb481-7"></a><span class="st">  </span><span class="co"># Filter </span></span>
<span id="cb481-8"><a href="#cb481-8"></a><span class="st">  </span><span class="kw">filter</span>(story <span class="op">!=</span><span class="st"> &quot;THE ADVENTURES OF SHERLOCK HOLMES&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb481-9"><a href="#cb481-9"></a><span class="st">  </span><span class="co"># Factor </span></span>
<span id="cb481-10"><a href="#cb481-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">story =</span> <span class="kw">factor</span>(story, <span class="dt">levels =</span> <span class="kw">unique</span>(story)))</span>
<span id="cb481-11"><a href="#cb481-11"></a></span>
<span id="cb481-12"><a href="#cb481-12"></a>sherlock &lt;-<span class="st"> </span>sherlock[,<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>]</span></code></pre></div>
</div>
<div id="key-ideas" class="section level4" number="7.7.2.3">
<h4 number="7.7.2.3"><span class="header-section-number">7.7.2.3</span> Key ideas</h4>
<ul>
<li><p>Topics as <strong>distributions</strong> of words</p></li>
<li><p>Documents as <strong>distributions</strong> of topics</p></li>
<li><p>What distributions?</p>
<ul>
<li><p>Probability</p></li>
<li><p>Multinominal (e.g., Latent Dirichlet Distribution)</p></li>
</ul></li>
<li><p>Words lie on a lower dimensional space (dimension reduction)</p></li>
<li><p>Co-occurrence of words (clustering)</p></li>
<li><p>Bag of words (feature engineering)</p>
<ul>
<li>Upside: easy and fast (also quite working well)</li>
<li>Downside: ignored grammatical structures and rich interactions among words (Alternative: word embeddings. Please check out <a href="http://text2vec.org/">text2vec</a>)</li>
</ul></li>
</ul>
</div>
<div id="exploratory-data-analysis" class="section level4" number="7.7.2.4">
<h4 number="7.7.2.4"><span class="header-section-number">7.7.2.4</span> Exploratory data analysis</h4>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb482-1"><a href="#cb482-1"></a>sherlock_n &lt;-<span class="st"> </span>sherlock <span class="op">%&gt;%</span></span>
<span id="cb482-2"><a href="#cb482-2"></a><span class="st">  </span><span class="kw">unnest_tokens</span>(<span class="dt">output =</span> word,</span>
<span id="cb482-3"><a href="#cb482-3"></a>                <span class="dt">input =</span> text) <span class="op">%&gt;%</span></span>
<span id="cb482-4"><a href="#cb482-4"></a><span class="st">  </span><span class="kw">count</span>(story, word, <span class="dt">sort =</span> <span class="ot">TRUE</span>)</span>
<span id="cb482-5"><a href="#cb482-5"></a></span>
<span id="cb482-6"><a href="#cb482-6"></a>sherlock_total_n &lt;-<span class="st"> </span>sherlock_n <span class="op">%&gt;%</span></span>
<span id="cb482-7"><a href="#cb482-7"></a><span class="st">  </span><span class="kw">group_by</span>(story) <span class="op">%&gt;%</span></span>
<span id="cb482-8"><a href="#cb482-8"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">total =</span> <span class="kw">sum</span>(n))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<div class="sourceCode" id="cb484"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb484-1"><a href="#cb484-1"></a>sherlock_words &lt;-<span class="st"> </span>sherlock_n <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(sherlock_total_n)</span></code></pre></div>
<pre><code>## Joining, by = &quot;story&quot;</code></pre>
<div class="sourceCode" id="cb486"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb486-1"><a href="#cb486-1"></a>sherlock_words <span class="op">%&gt;%</span></span>
<span id="cb486-2"><a href="#cb486-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">freq =</span> n<span class="op">/</span>total) <span class="op">%&gt;%</span></span>
<span id="cb486-3"><a href="#cb486-3"></a><span class="st">  </span><span class="kw">group_by</span>(story) <span class="op">%&gt;%</span></span>
<span id="cb486-4"><a href="#cb486-4"></a><span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb486-5"><a href="#cb486-5"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">fct_reorder</span>(word, freq), </span>
<span id="cb486-6"><a href="#cb486-6"></a>             <span class="dt">y =</span> freq, </span>
<span id="cb486-7"><a href="#cb486-7"></a>             <span class="dt">fill =</span> story)) <span class="op">+</span></span>
<span id="cb486-8"><a href="#cb486-8"></a><span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span></span>
<span id="cb486-9"><a href="#cb486-9"></a><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></span>
<span id="cb486-10"><a href="#cb486-10"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>story, </span>
<span id="cb486-11"><a href="#cb486-11"></a>             <span class="dt">ncol =</span> <span class="dv">2</span>, </span>
<span id="cb486-12"><a href="#cb486-12"></a>             <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="op">+</span></span>
<span id="cb486-13"><a href="#cb486-13"></a><span class="st">  </span><span class="kw">scale_fill_viridis_d</span>() <span class="op">+</span></span>
<span id="cb486-14"><a href="#cb486-14"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<pre><code>## Selecting by freq</code></pre>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-66-1.png" width="672" /></p>
</div>
<div id="stm" class="section level4" number="7.7.2.5">
<h4 number="7.7.2.5"><span class="header-section-number">7.7.2.5</span> STM</h4>
<div id="turn-text-into-document-term-matrix" class="section level5" number="7.7.2.5.1">
<h5 number="7.7.2.5.1"><span class="header-section-number">7.7.2.5.1</span> Turn text into document-term matrix</h5>
<p><code>stm</code> package has its own preprocessing function.</p>
<div class="sourceCode" id="cb488"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb488-1"><a href="#cb488-1"></a>dtm &lt;-<span class="st"> </span><span class="kw">textProcessor</span>(<span class="dt">documents =</span> sherlock<span class="op">$</span>text,</span>
<span id="cb488-2"><a href="#cb488-2"></a>                     <span class="dt">metadata =</span> sherlock, </span>
<span id="cb488-3"><a href="#cb488-3"></a>                     <span class="dt">removestopwords =</span> <span class="ot">TRUE</span>,</span>
<span id="cb488-4"><a href="#cb488-4"></a>                     <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
</div>
<div id="tuning-k" class="section level5" number="7.7.2.5.2">
<h5 number="7.7.2.5.2"><span class="header-section-number">7.7.2.5.2</span> Tuning K</h5>
<ul>
<li>K is the number of topics.</li>
<li>Let’s try K = 5, 10, 15.</li>
</ul>
<div class="sourceCode" id="cb489"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb489-1"><a href="#cb489-1"></a>test_res &lt;-<span class="st"> </span><span class="kw">searchK</span>(dtm<span class="op">$</span>documents, dtm<span class="op">$</span>vocab, </span>
<span id="cb489-2"><a href="#cb489-2"></a>                   <span class="dt">K =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>),</span>
<span id="cb489-3"><a href="#cb489-3"></a>                   <span class="dt">prevalence =</span><span class="op">~</span><span class="st"> </span>story, </span>
<span id="cb489-4"><a href="#cb489-4"></a>                   <span class="dt">data =</span> dtm<span class="op">$</span>meta)</span></code></pre></div>
<pre><code>## Beginning Spectral Initialization 
## 	 Calculating the gram matrix...
## 	 Finding anchor words...
##  	.....
## 	 Recovering initialization...
##  	........................................................
## Initialization complete.
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 1 (approx. per word bound = -7.570) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 2 (approx. per word bound = -7.481, relative change = 1.176e-02) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 3 (approx. per word bound = -7.400, relative change = 1.090e-02) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 4 (approx. per word bound = -7.381, relative change = 2.581e-03) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 5 (approx. per word bound = -7.375, relative change = 8.290e-04) 
## Topic 1: come, time, might, know, must 
##  Topic 2: one, said, well, matter, came 
##  Topic 3: holm, upon, said, may, just 
##  Topic 4: littl, will, man, see, think 
##  Topic 5: case, yes, remark, noth, put 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 6 (approx. per word bound = -7.371, relative change = 4.271e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 7 (approx. per word bound = -7.370, relative change = 2.175e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 8 (approx. per word bound = -7.369, relative change = 7.176e-05) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Model Converged 
## Beginning Spectral Initialization 
## 	 Calculating the gram matrix...
## 	 Finding anchor words...
##  	..........
## 	 Recovering initialization...
##  	........................................................
## Initialization complete.
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 1 (approx. per word bound = -7.651) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 2 (approx. per word bound = -7.480, relative change = 2.234e-02) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 3 (approx. per word bound = -7.378, relative change = 1.356e-02) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 4 (approx. per word bound = -7.354, relative change = 3.251e-03) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 5 (approx. per word bound = -7.347, relative change = 1.040e-03) 
## Topic 1: holm, one, will, eye, across 
##  Topic 2: may, upon, case, shall, remark 
##  Topic 3: well, know, father, call, mind 
##  Topic 4: littl, see, like, yes, might 
##  Topic 5: said, man, see, watson, hard 
##  Topic 6: hous, room, hand, man, without 
##  Topic 7: come, came, even, back, tell 
##  Topic 8: upon, day, door, look, may 
##  Topic 9: said, ask, matter, noth, answer 
##  Topic 10: sherlock, hand, glanc, howev, anoth 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 6 (approx. per word bound = -7.344, relative change = 3.512e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 7 (approx. per word bound = -7.342, relative change = 2.888e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 8 (approx. per word bound = -7.340, relative change = 2.464e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 9 (approx. per word bound = -7.339, relative change = 1.991e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 10 (approx. per word bound = -7.338, relative change = 1.230e-04) 
## Topic 1: holm, one, will, eye, chair 
##  Topic 2: may, case, shall, say, remark 
##  Topic 3: know, well, never, thought, cri 
##  Topic 4: littl, yes, like, might, see 
##  Topic 5: said, man, see, can, watson 
##  Topic 6: hous, room, young, ladi, without 
##  Topic 7: come, came, back, even, just 
##  Topic 8: upon, door, day, open, look 
##  Topic 9: ask, matter, must, take, noth 
##  Topic 10: hand, howev, sherlock, glanc, head 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 11 (approx. per word bound = -7.337, relative change = 5.576e-05) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Model Converged 
## Beginning Spectral Initialization 
## 	 Calculating the gram matrix...
## 	 Finding anchor words...
##  	...............
## 	 Recovering initialization...
##  	........................................................
## Initialization complete.
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 1 (approx. per word bound = -7.737) 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 2 (approx. per word bound = -7.500, relative change = 3.056e-02) 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 3 (approx. per word bound = -7.388, relative change = 1.494e-02) 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 4 (approx. per word bound = -7.356, relative change = 4.344e-03) 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 5 (approx. per word bound = -7.345, relative change = 1.583e-03) 
## Topic 1: holm, know, well, can, might 
##  Topic 2: small, lay, known, form, power 
##  Topic 3: time, seen, two, sherlock, anyth 
##  Topic 4: said, man, shall, miss, word 
##  Topic 5: look, face, man, first, eye 
##  Topic 6: room, man, must, open, took 
##  Topic 7: back, ask, came, way, come 
##  Topic 8: littl, said, noth, last, sir 
##  Topic 9: now, see, yes, like, think 
##  Topic 10: street, hand, found, sudden, pass 
##  Topic 11: someth, sure, went, mind, live 
##  Topic 12: come, call, busi, gentleman, may 
##  Topic 13: will, may, case, littl, find 
##  Topic 14: one, side, two, year, famili 
##  Topic 15: upon, tabl, finger, depend, wrist 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 6 (approx. per word bound = -7.340, relative change = 5.712e-04) 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 7 (approx. per word bound = -7.338, relative change = 2.704e-04) 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 8 (approx. per word bound = -7.336, relative change = 2.640e-04) 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 9 (approx. per word bound = -7.335, relative change = 1.952e-04) 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 10 (approx. per word bound = -7.333, relative change = 2.106e-04) 
## Topic 1: holm, know, well, can, might 
##  Topic 2: small, work, told, lay, fire 
##  Topic 3: time, howev, day, sherlock, turn 
##  Topic 4: said, man, miss, young, word 
##  Topic 5: look, face, eye, tell, first 
##  Topic 6: room, must, open, father, made 
##  Topic 7: back, came, door, ask, way 
##  Topic 8: littl, noth, last, paper, read 
##  Topic 9: now, see, think, yes, like 
##  Topic 10: found, street, hand, sudden, light 
##  Topic 11: went, place, someth, mind, son 
##  Topic 12: come, away, busi, call, reason 
##  Topic 13: will, may, case, find, interest 
##  Topic 14: one, side, year, thing, two 
##  Topic 15: upon, tabl, besid, finger, bear 
## ....................................................................................................
## Completed E-Step (2 seconds). 
## Completed M-Step. 
## Completing Iteration 11 (approx. per word bound = -7.332, relative change = 2.243e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 12 (approx. per word bound = -7.331, relative change = 1.713e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 13 (approx. per word bound = -7.330, relative change = 1.282e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 14 (approx. per word bound = -7.329, relative change = 1.167e-04) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 15 (approx. per word bound = -7.328, relative change = 6.326e-05) 
## Topic 1: holm, know, well, can, might 
##  Topic 2: small, work, told, lay, fire 
##  Topic 3: time, day, much, howev, turn 
##  Topic 4: said, man, miss, say, right 
##  Topic 5: look, face, eye, tell, first 
##  Topic 6: must, room, open, made, morn 
##  Topic 7: door, came, back, ask, way 
##  Topic 8: littl, noth, last, paper, sir 
##  Topic 9: now, see, think, yes, like 
##  Topic 10: found, street, hand, long, light 
##  Topic 11: place, went, someth, mind, son 
##  Topic 12: come, away, busi, call, certain 
##  Topic 13: will, may, case, find, take 
##  Topic 14: one, side, year, thing, two 
##  Topic 15: upon, tabl, besid, sever, finger 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 16 (approx. per word bound = -7.328, relative change = 5.296e-05) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Completing Iteration 17 (approx. per word bound = -7.328, relative change = 3.663e-05) 
## ....................................................................................................
## Completed E-Step (1 seconds). 
## Completed M-Step. 
## Model Converged</code></pre>
</div>
<div id="evaludating-models" class="section level5" number="7.7.2.5.3">
<h5 number="7.7.2.5.3"><span class="header-section-number">7.7.2.5.3</span> Evaludating models</h5>
<p>There are several metrics to assess the performance of topic models: the held-out likelihood, residuals, semantic coherence, and exclusivity. In this course, we examine the relationship between semantic coherence and exclusivity to understand the trade-off involved in selecting K.</p>
<div class="sourceCode" id="cb491"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb491-1"><a href="#cb491-1"></a>test_res<span class="op">$</span>results <span class="op">%&gt;%</span></span>
<span id="cb491-2"><a href="#cb491-2"></a><span class="st">  </span><span class="kw">unnest</span>(K, exclus, semcoh) <span class="op">%&gt;%</span></span>
<span id="cb491-3"><a href="#cb491-3"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(K, exclus, semcoh) <span class="op">%&gt;%</span></span>
<span id="cb491-4"><a href="#cb491-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">K =</span> <span class="kw">as.factor</span>(K)) <span class="op">%&gt;%</span></span>
<span id="cb491-5"><a href="#cb491-5"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> exclus, <span class="dt">y =</span> semcoh)) <span class="op">+</span></span>
<span id="cb491-6"><a href="#cb491-6"></a><span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">label =</span> <span class="kw">glue</span>(<span class="st">&quot;K = {test_res$results$K}&quot;</span>),</span>
<span id="cb491-7"><a href="#cb491-7"></a>              <span class="dt">size =</span> <span class="dv">5</span>,</span>
<span id="cb491-8"><a href="#cb491-8"></a>              <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: unnest() has a new interface. See ?unnest for details.
## Try `df %&gt;% unnest(c(K, exclus, semcoh))`, with `mutate()` if needed</code></pre>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-69-1.png" width="672" /></p>
</div>
<div id="finalize" class="section level5" number="7.7.2.5.4">
<h5 number="7.7.2.5.4"><span class="header-section-number">7.7.2.5.4</span> Finalize</h5>
<div class="sourceCode" id="cb493"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb493-1"><a href="#cb493-1"></a>final_stm &lt;-<span class="st"> </span><span class="kw">stm</span>(dtm<span class="op">$</span>documents, </span>
<span id="cb493-2"><a href="#cb493-2"></a>                 dtm<span class="op">$</span>vocab, </span>
<span id="cb493-3"><a href="#cb493-3"></a>                 <span class="dt">K =</span> <span class="dv">10</span>, <span class="dt">prevalence =</span><span class="op">~</span><span class="st"> </span>story,</span>
<span id="cb493-4"><a href="#cb493-4"></a>                 <span class="dt">max.em.its =</span> <span class="dv">75</span>, </span>
<span id="cb493-5"><a href="#cb493-5"></a>                 <span class="dt">data =</span> dtm<span class="op">$</span>meta, </span>
<span id="cb493-6"><a href="#cb493-6"></a>                 <span class="dt">init.type=</span><span class="st">&quot;Spectral&quot;</span>,</span>
<span id="cb493-7"><a href="#cb493-7"></a>                 <span class="dt">seed =</span> <span class="dv">1234567</span>,</span>
<span id="cb493-8"><a href="#cb493-8"></a>                 <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
</div>
<div id="explore-the-results" class="section level5" number="7.7.2.5.5">
<h5 number="7.7.2.5.5"><span class="header-section-number">7.7.2.5.5</span> Explore the results</h5>
<ul>
<li>Using the <code>stm</code> pacakge.</li>
</ul>
<div class="sourceCode" id="cb494"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb494-1"><a href="#cb494-1"></a><span class="co"># plot</span></span>
<span id="cb494-2"><a href="#cb494-2"></a><span class="kw">plot</span>(final_stm)</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-71-1.png" width="672" /></p>
<ul>
<li>Using ggplot2</li>
</ul>
<div class="sourceCode" id="cb495"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb495-1"><a href="#cb495-1"></a><span class="co"># tidy  </span></span>
<span id="cb495-2"><a href="#cb495-2"></a>tidy_stm &lt;-<span class="st"> </span><span class="kw">tidy</span>(final_stm)</span>
<span id="cb495-3"><a href="#cb495-3"></a></span>
<span id="cb495-4"><a href="#cb495-4"></a><span class="co"># top terms</span></span>
<span id="cb495-5"><a href="#cb495-5"></a>tidy_stm <span class="op">%&gt;%</span></span>
<span id="cb495-6"><a href="#cb495-6"></a><span class="st">    </span><span class="kw">group_by</span>(topic) <span class="op">%&gt;%</span></span>
<span id="cb495-7"><a href="#cb495-7"></a><span class="st">    </span><span class="kw">top_n</span>(<span class="dv">10</span>, beta) <span class="op">%&gt;%</span></span>
<span id="cb495-8"><a href="#cb495-8"></a><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb495-9"><a href="#cb495-9"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">fct_reorder</span>(term, beta), beta, <span class="dt">fill =</span> <span class="kw">as.factor</span>(topic))) <span class="op">+</span></span>
<span id="cb495-10"><a href="#cb495-10"></a><span class="st">    </span><span class="kw">geom_col</span>(<span class="dt">alpha =</span> <span class="fl">0.8</span>, <span class="dt">show.legend =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb495-11"><a href="#cb495-11"></a><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>topic, <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="op">+</span></span>
<span id="cb495-12"><a href="#cb495-12"></a><span class="st">    </span><span class="kw">coord_flip</span>() <span class="op">+</span></span>
<span id="cb495-13"><a href="#cb495-13"></a><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></span>
<span id="cb495-14"><a href="#cb495-14"></a><span class="st">    </span><span class="kw">scale_fill_viridis_d</span>()</span></code></pre></div>
<p><img src="05_high_dimensional_data_files/figure-html/unnamed-chunk-72-1.png" width="672" /></p>
</div>
</div>
</div>
</div>
<div id="bias-and-fairness-in-machine-learning" class="section level2" number="7.8">
<h2 number="7.8"><span class="header-section-number">7.8</span> Bias and fairness in machine learning</h2>
</div>
<div id="resources" class="section level2" number="7.9">
<h2 number="7.9"><span class="header-section-number">7.9</span> Resources</h2>
<div id="books" class="section level3" number="7.9.1">
<h3 number="7.9.1"><span class="header-section-number">7.9.1</span> Books</h3>
<ul>
<li><p><em>An Introduction to Statistical Learning - with Applications in R (2013)</em> by Gareth James, Daniela Witten, Trevor Hastie, Robert Tibshirani. Springer: New York. <a href="https://www.amazon.com/Introduction-Statistical-Learning-Applications-Statistics/dp/1461471370">Amazon</a> or <a href="http://www-bcf.usc.edu/~gareth/ISL/">free PDF</a>.</p></li>
<li><p><em>Hands-On Machine Learning with R (2020)</em> by Bradley Boehmke &amp; Brandon Greenwell. <a href="https://www.routledge.com/Hands-On-Machine-Learning-with-R/Boehmke-Greenwell/p/book/9781138495685">CRC Press</a> or <a href="https://www.amazon.com/gp/product/1138495689?pf_rd_p=ab873d20-a0ca-439b-ac45-cd78f07a84d8&amp;pf_rd_r=JBRX0ZJ1WFSR9T3JPTQE">Amazon</a></p></li>
<li><p><em>Applied Predictive Modeling (2013)</em> by Max Kuhn and Kjell Johnson. Springer: New York. <a href="https://www.amazon.com/Applied-Predictive-Modeling-Max-Kuhn/dp/1461468485?SubscriptionId=0ENGV10E9K9QDNSJ5C82&amp;tag=apm0a-20&amp;linkCode=xm2&amp;camp=2025&amp;creative=165953&amp;creativeASIN=1461468485">Amazon</a></p></li>
<li><p><em>Feature Engineering and Selection: A Practical Approach for Predictive Models (2019)</em> by Kjell Johnson and Max Kuhn. Taylor &amp; Francis. <a href="http://www.feat.engineering/">Amazon</a> or <a href="http://www.feat.engineering/">free HTML</a>.</p></li>
<li><p><em><a href="https://www.tmwr.org/">Tidy Modeling with R</a> (2020)</em> by Max Kuhn and Julia Silge (work-in-progress)</p></li>
</ul>
</div>
<div id="lecture-slides" class="section level3" number="7.9.2">
<h3 number="7.9.2"><span class="header-section-number">7.9.2</span> Lecture slides</h3>
<ul>
<li><p><a href="https://www.nber.org/econometrics_minicourse_2015/nber_slides11.pdf">An introduction to supervised and unsupervised learning (2015)</a> by Susan Athey and Guido Imbens</p></li>
<li><p><a href="https://education.rstudio.com/blog/2020/02/conf20-intro-ml/">Introduction Machine Learning with the Tidyverse</a> by Alison Hill</p></li>
</ul>
</div>
<div id="blog-posts" class="section level3" number="7.9.3">
<h3 number="7.9.3"><span class="header-section-number">7.9.3</span> Blog posts</h3>
<ul>
<li><a href="http://www.rebeccabarter.com/blog/2019-06-06_pre_processing/">“Using the recipes package for easy pre-processing”</a> by Rebecca Barter</li>
</ul>
<!--chapter:end:05_high_dimensional_data.Rmd-->
</div>
</div>
</div>
<div id="big_data" class="section level1" number="8">
<h1 number="8"><span class="header-section-number">8</span> Big data</h1>
<div id="motivation" class="section level2" number="8.1">
<h2 number="8.1"><span class="header-section-number">8.1</span> Motivation</h2>
<ul>
<li>Big data problem: data is too big to fit into memory (=local environment).</li>
<li>R reads data into random-access memory (RAM) at once and this object lives in memory entirely. So, object &gt; memory will crash R.</li>
<li>So, the key to deal with big data in R is reducing the size of data you want to bring into it.</li>
</ul>
<p><strong>Techniques to deal with big data</strong></p>
<ul>
<li>Medium sized file (1-2 GB)
<ul>
<li>Try to reduce the size of the file using slicing and dicing</li>
<li>Tools:
<ul>
<li>R:<code>data.table::fread(file path, select = c("column 1", "column 2"))</code>. This command imports data faster than <code>read.csv()</code> does.</li>
<li>Command line: <a href="https://csvkit.readthedocs.io/en/latest/"><code>csvkit</code></a> - a suite of command-line tools to and working with CSV</li>
</ul></li>
</ul></li>
<li>Large file (&gt; 2-10 GB)
<ul>
<li>Put the data into a database and <strong>ACCESS</strong> it</li>
<li>Explore the data and pull the objects of interest</li>
<li>Types of databases
<ul>
<li>Relational database = a collection of tables (fixed columns and rows): SQL is a staple tool to define and <strong>query</strong> (focus of the workshop today) this type of database</li>
<li>Non-relational database = a collection of documents (MongoDB), key-values (Redis and DyanoDB), wide-column stores (Cassandra and HBase), or graph (Neo4j and JanusGraph). This type of database does not preclude SQL. Note that NoSQL stands for <a href="https://www.mongodb.com/nosql-explained">“not only SQL.”</a></li>
</ul></li>
</ul></li>
</ul>
<p><strong>Relational database</strong></p>
<div class="figure">
<img src="https://sp.mysqltutorial.org/wp-content/uploads/2009/12/MySQL-Sample-Database-Schema.png" alt="" />
<p class="caption">Relational Database. Source: MySQL Tutorial</p>
</div>
</div>
<div id="what-is-sql" class="section level2" number="8.2">
<h2 number="8.2"><span class="header-section-number">8.2</span> What is SQL?</h2>
<ul>
<li><p>Structured Query Language. Called SEQUEL and developed by IBM Corporation in the 1970s.</p></li>
<li><p>Remains the standard language for a relational database management system.</p></li>
<li><p>It’s a DECLARATIVE language (<a href="https://www.sqlite.org/queryplanner.html">what to do &gt; how to do</a>)</p>
<ul>
<li>Database management systems figures optimal way to execute query (query optimization)</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb496"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb496-1"><a href="#cb496-1"></a><span class="kw">SELECT</span> <span class="kw">COLUMN</span> <span class="kw">FROM</span> <span class="kw">TABLE</span> </span></code></pre></div>
</div>
<div id="learning-objectives" class="section level2" number="8.3">
<h2 number="8.3"><span class="header-section-number">8.3</span> Learning objectives</h2>
<ul>
<li><p>Embracing a new mindset: shifting from ownership (opening CSVs in your laptop) to access (accessing data stored in a database)</p></li>
<li><p>Learning how to use R and SQL to access and query a database</p></li>
</ul>
</div>
<div id="quick-overview" class="section level2" number="8.4">
<h2 number="8.4"><span class="header-section-number">8.4</span> Quick overview</h2>
<ul>
<li>SQL and R</li>
</ul>
<table>
<colgroup>
<col width="14%" />
<col width="85%" />
</colgroup>
<thead>
<tr class="header">
<th>SQL</th>
<th>R</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SELECT</td>
<td>select() for columns, mutate() for expressions, summarise() for aggregates</td>
</tr>
<tr class="even">
<td>FROM</td>
<td>which data frame</td>
</tr>
<tr class="odd">
<td>WHERE</td>
<td>filter()</td>
</tr>
<tr class="even">
<td>GROUP BY</td>
<td>group_by()</td>
</tr>
<tr class="odd">
<td>HAVING</td>
<td>filter() <strong>after group_by()</strong></td>
</tr>
<tr class="even">
<td>ORDER BY</td>
<td>arrange()</td>
</tr>
<tr class="odd">
<td>LIMIT</td>
<td>head()</td>
</tr>
</tbody>
</table>
<p><strong>Challenge 1</strong>
1. Can you tell me the difference in the order in which the following <code>R</code> and <code>SQL</code> code were written to wrangle data? For instance, in R, what command comes first? In contrast, in SQL, what command comes first?</p>
<ul>
<li>R example</li>
</ul>
<div class="sourceCode" id="cb497"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb497-1"><a href="#cb497-1"></a></span>
<span id="cb497-2"><a href="#cb497-2"></a>data <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Data </span></span>
<span id="cb497-3"><a href="#cb497-3"></a><span class="st">  </span><span class="kw">select</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Column</span></span>
<span id="cb497-4"><a href="#cb497-4"></a><span class="st">  </span><span class="kw">filter</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Row </span></span>
<span id="cb497-5"><a href="#cb497-5"></a><span class="st">  </span><span class="kw">group_by</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Group by </span></span>
<span id="cb497-6"><a href="#cb497-6"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Aggregation</span></span>
<span id="cb497-7"><a href="#cb497-7"></a><span class="st">  </span><span class="kw">filter</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Row </span></span>
<span id="cb497-8"><a href="#cb497-8"></a><span class="st">  </span><span class="kw">order_by</span>() <span class="co"># Arrange </span></span></code></pre></div>
<ul>
<li>SQL example</li>
</ul>
<div class="sourceCode" id="cb498"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb498-1"><a href="#cb498-1"></a></span>
<span id="cb498-2"><a href="#cb498-2"></a><span class="kw">SELECT</span> <span class="kw">column</span>, aggregation (<span class="fu">count</span>())` # <span class="kw">Column</span></span>
<span id="cb498-3"><a href="#cb498-3"></a></span>
<span id="cb498-4"><a href="#cb498-4"></a><span class="kw">FROM</span> <span class="kw">data</span> # <span class="kw">Data</span> </span>
<span id="cb498-5"><a href="#cb498-5"></a></span>
<span id="cb498-6"><a href="#cb498-6"></a><span class="kw">WHERE</span> condition # <span class="kw">Row</span> </span>
<span id="cb498-7"><a href="#cb498-7"></a></span>
<span id="cb498-8"><a href="#cb498-8"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">column</span> # <span class="kw">Group</span> <span class="kw">by</span></span>
<span id="cb498-9"><a href="#cb498-9"></a></span>
<span id="cb498-10"><a href="#cb498-10"></a><span class="kw">HAVING</span> condition # <span class="kw">Row</span>  </span>
<span id="cb498-11"><a href="#cb498-11"></a></span>
<span id="cb498-12"><a href="#cb498-12"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">column</span> # Arrange </span></code></pre></div>
<div class="figure">
<img src="https://wizardzines.com/zines/sql/samples/from.png" alt="" />
<p class="caption">SQL Zine by by <a href="https://jvns.ca/">Julia Evans</a></p>
</div>
</div>
<div id="setup" class="section level2" number="8.5">
<h2 number="8.5"><span class="header-section-number">8.5</span> Setup</h2>
<p>Let’s get to work.</p>
</div>
<div id="packages" class="section level2" number="8.6">
<h2 number="8.6"><span class="header-section-number">8.6</span> Packages</h2>
<ul>
<li><code>pacman::p_load()</code> reduces steps for installing and loading several packages simultaneously.</li>
</ul>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb499-1"><a href="#cb499-1"></a><span class="co"># pacman </span></span>
<span id="cb499-2"><a href="#cb499-2"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;pacman&quot;</span>)) <span class="kw">install.packages</span>(<span class="st">&quot;pacman&quot;</span>)</span></code></pre></div>
<pre><code>## Loading required package: pacman</code></pre>
<div class="sourceCode" id="cb501"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb501-1"><a href="#cb501-1"></a><span class="co"># The rest of pkgs </span></span>
<span id="cb501-2"><a href="#cb501-2"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(</span>
<span id="cb501-3"><a href="#cb501-3"></a> </span>
<span id="cb501-4"><a href="#cb501-4"></a> tidyverse, <span class="co"># tidyverse packages </span></span>
<span id="cb501-5"><a href="#cb501-5"></a> </span>
<span id="cb501-6"><a href="#cb501-6"></a> DBI, <span class="co"># using SQL queries</span></span>
<span id="cb501-7"><a href="#cb501-7"></a> </span>
<span id="cb501-8"><a href="#cb501-8"></a> RSQLite, <span class="co"># SQLite</span></span>
<span id="cb501-9"><a href="#cb501-9"></a> </span>
<span id="cb501-10"><a href="#cb501-10"></a> dbplyr, <span class="co"># use database with dplyr </span></span>
<span id="cb501-11"><a href="#cb501-11"></a> </span>
<span id="cb501-12"><a href="#cb501-12"></a> glue, <span class="co"># glue to automate workflow </span></span>
<span id="cb501-13"><a href="#cb501-13"></a> </span>
<span id="cb501-14"><a href="#cb501-14"></a> nycflights13 <span class="co"># toy data </span></span>
<span id="cb501-15"><a href="#cb501-15"></a>)</span></code></pre></div>
</div>
<div id="datasets" class="section level2" number="8.7">
<h2 number="8.7"><span class="header-section-number">8.7</span> Datasets</h2>
<ul>
<li><a href="https://www.transtats.bts.gov/DL_SelectFields.asp?Table_ID=236">The flight on-time performance data</a> from the Bureau of Transpiration Statistics of the U.S. government. The data goes back to 1987 and its size is more than 20 gigabytes. For practice, we only use a small subset of the original data (flight data departing NYC in 2013) provided by RStudio.</li>
</ul>
<div class="figure">
<img src="https://d33wubrfki0l68.cloudfront.net/245292d1ea724f6c3fd8a92063dcd7bfb9758d02/5751b/diagrams/relational-nycflights.png" alt="" />
<p class="caption">From RStudio.</p>
</div>
</div>
<div id="workflow" class="section level2" number="8.8">
<h2 number="8.8"><span class="header-section-number">8.8</span> Workflow</h2>
<ol style="list-style-type: decimal">
<li>Create/connect to a database</li>
</ol>
<ul>
<li><p>Note that server also can be your laptop (called <a href="https://en.wikipedia.org/wiki/Localhost#:~:text=In%20computer%20networking%2C%20localhost%20is,via%20the%20loopback%20network%20interface.">localhost</a>).</p></li>
<li><p>Short answer: To do so, you need interfaces between R and a database. We use <a href="https://github.com/r-dbi/RSQLite"><code>RSQLite</code></a> in this tutorial because it’s easy to set up.</p></li>
<li><p>Long answer: The <code>DBI</code> package in R provides a client-side interface that allows <code>dplyr</code> to work with databases. DBI is automatically installed when you installed <code>dbplyr</code>. However, you need to install a specific backend engine (a tool for communication between R and a database management system) for the database (e.g., <code>RMariaDB</code>, <code>RPostgres</code>, <code>RSQLite</code>). In this workshop, we use SQLite because it is the easiest to get started with. Personally, I love PostgreSQL because it’s an open-source and also powerful to do <a href="https://www.postgresql.org/docs/current/functions.html">many amazing things</a> (e.g., text mining, geospatial analysis).</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Copy a table to the database</li>
</ol>
<ul>
<li><p>Option 1: You can create a table and insert rows manually.</p></li>
<li><p>Table</p>
<ul>
<li>Collection of rows</li>
<li>Collection of columns (fields or attributes)</li>
<li>Each col has a type:
<ul>
<li>String: <code>VARCHAR(20)</code></li>
<li>Integer: <code>INTEGER</code></li>
<li>Floating-point: <code>FLOAT</code>, <code>DOUBLE</code></li>
<li>Date/time: <code>DATE</code>, <code>TIME</code>, <code>DATETIME</code></li>
</ul></li>
<li><strong>Schema</strong>: the structure of the database
<ul>
<li>The table name</li>
<li>The names and types of its columns</li>
<li>Various optional additional information (e.g., constraints)</li>
</ul></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb502"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb502-1"><a href="#cb502-1"></a></span>
<span id="cb502-2"><a href="#cb502-2"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> students (</span>
<span id="cb502-3"><a href="#cb502-3"></a>    <span class="kw">id</span> <span class="dt">INT</span> AUTO_INCREMENT,</span>
<span id="cb502-4"><a href="#cb502-4"></a>    name <span class="dt">VARCHAR</span>(<span class="dv">30</span>),</span>
<span id="cb502-5"><a href="#cb502-5"></a>    birth <span class="dt">DATE</span>,</span>
<span id="cb502-6"><a href="#cb502-6"></a>    gpa <span class="dt">FLOAT</span>,</span>
<span id="cb502-7"><a href="#cb502-7"></a>    grad <span class="dt">INT</span>,</span>
<span id="cb502-8"><a href="#cb502-8"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(<span class="kw">id</span>));</span>
<span id="cb502-9"><a href="#cb502-9"></a>    </span>
<span id="cb502-10"><a href="#cb502-10"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> students(name, birth, gpa, grad)</span>
<span id="cb502-11"><a href="#cb502-11"></a>      <span class="kw">VALUES</span> (<span class="st">&#39;Adam&#39;</span>, <span class="st">&#39;2000-08-04&#39;</span>, <span class="fl">4.0</span>, <span class="dv">2020</span>);</span></code></pre></div>
<ul>
<li>Option 2: Copy a file (object) to a table in a database using <code>copy_to</code>). We take this option as it’s fast and we would like to focus on querying in this workshop.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Query the table</li>
</ol>
<ul>
<li>Main focus</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li><p>Pull the results of interests (<strong>data</strong>) using <code>collect()</code></p></li>
<li><p>Disconnect the database</p></li>
</ol>
<div id="create-a-database" class="section level3" number="8.8.1">
<h3 number="8.8.1"><span class="header-section-number">8.8.1</span> Create a database</h3>
<div class="sourceCode" id="cb503"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb503-1"><a href="#cb503-1"></a><span class="co"># Define a backend engine </span></span>
<span id="cb503-2"><a href="#cb503-2"></a></span>
<span id="cb503-3"><a href="#cb503-3"></a>drv &lt;-<span class="st"> </span>RSQLite<span class="op">::</span><span class="kw">SQLite</span>()</span>
<span id="cb503-4"><a href="#cb503-4"></a></span>
<span id="cb503-5"><a href="#cb503-5"></a><span class="co"># Create an empty in-memory database </span></span>
<span id="cb503-6"><a href="#cb503-6"></a>con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(drv, </span>
<span id="cb503-7"><a href="#cb503-7"></a>                      <span class="dt">dbname =</span> <span class="st">&quot;:memory:&quot;</span>)</span>
<span id="cb503-8"><a href="#cb503-8"></a></span>
<span id="cb503-9"><a href="#cb503-9"></a><span class="co"># Connect to an existing database </span></span>
<span id="cb503-10"><a href="#cb503-10"></a><span class="co">#con &lt;- DBI::dbConnect(RMariaDB::MariaDB(), </span></span>
<span id="cb503-11"><a href="#cb503-11"></a> <span class="co"># host = &quot;database.rstudio.com&quot;,</span></span>
<span id="cb503-12"><a href="#cb503-12"></a> <span class="co"># user = &quot;hadley&quot;,</span></span>
<span id="cb503-13"><a href="#cb503-13"></a> <span class="co"># password = rstudioapi::askForPassword(&quot;Database password&quot;)</span></span>
<span id="cb503-14"><a href="#cb503-14"></a><span class="co">#)</span></span>
<span id="cb503-15"><a href="#cb503-15"></a></span>
<span id="cb503-16"><a href="#cb503-16"></a><span class="kw">dbListTables</span>(con)</span></code></pre></div>
<pre><code>## character(0)</code></pre>
<ul>
<li>Note that con is empty at this stage.</li>
</ul>
</div>
<div id="copy-an-object-as-a-table-to-the-database-push" class="section level3" number="8.8.2">
<h3 number="8.8.2"><span class="header-section-number">8.8.2</span> Copy an object as a table to the database (push)</h3>
<div class="sourceCode" id="cb505"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb505-1"><a href="#cb505-1"></a><span class="co"># Copy objects to the data </span></span>
<span id="cb505-2"><a href="#cb505-2"></a><span class="kw">copy_to</span>(<span class="dt">dest =</span> con, </span>
<span id="cb505-3"><a href="#cb505-3"></a>        <span class="dt">df =</span> flights)</span>
<span id="cb505-4"><a href="#cb505-4"></a></span>
<span id="cb505-5"><a href="#cb505-5"></a><span class="kw">copy_to</span>(<span class="dt">dest =</span> con, </span>
<span id="cb505-6"><a href="#cb505-6"></a>        <span class="dt">df =</span> airports)</span>
<span id="cb505-7"><a href="#cb505-7"></a></span>
<span id="cb505-8"><a href="#cb505-8"></a><span class="kw">copy_to</span>(<span class="dt">dest =</span> con,</span>
<span id="cb505-9"><a href="#cb505-9"></a>        <span class="dt">df =</span> planes)</span>
<span id="cb505-10"><a href="#cb505-10"></a></span>
<span id="cb505-11"><a href="#cb505-11"></a><span class="kw">copy_to</span>(<span class="dt">dest =</span> con, </span>
<span id="cb505-12"><a href="#cb505-12"></a>        <span class="dt">df =</span> weather)</span>
<span id="cb505-13"><a href="#cb505-13"></a></span>
<span id="cb505-14"><a href="#cb505-14"></a><span class="co"># If you want you can also decide what columns you want to copy:</span></span>
<span id="cb505-15"><a href="#cb505-15"></a></span>
<span id="cb505-16"><a href="#cb505-16"></a><span class="co"># copy_to(dest = con, </span></span>
<span id="cb505-17"><a href="#cb505-17"></a><span class="co">#          df = flights, </span></span>
<span id="cb505-18"><a href="#cb505-18"></a><span class="co">#          name = &quot;flights&quot;,</span></span>
<span id="cb505-19"><a href="#cb505-19"></a><span class="co">#          indexes = list(c(&quot;year&quot;, &quot;tailnum&quot;, &quot;dest&quot;)))</span></span></code></pre></div>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb506-1"><a href="#cb506-1"></a><span class="co"># Show two tables in the database </span></span>
<span id="cb506-2"><a href="#cb506-2"></a></span>
<span id="cb506-3"><a href="#cb506-3"></a><span class="kw">dbListTables</span>(con)</span></code></pre></div>
<pre><code>## [1] &quot;airports&quot;     &quot;flights&quot;      &quot;planes&quot;       &quot;sqlite_stat1&quot; &quot;sqlite_stat4&quot;
## [6] &quot;weather&quot;</code></pre>
<div class="sourceCode" id="cb508"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb508-1"><a href="#cb508-1"></a><span class="co"># Show the columns/attributes/fields of a table </span></span>
<span id="cb508-2"><a href="#cb508-2"></a></span>
<span id="cb508-3"><a href="#cb508-3"></a><span class="kw">dbListFields</span>(con, <span class="st">&quot;flights&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;year&quot;           &quot;month&quot;          &quot;day&quot;            &quot;dep_time&quot;      
##  [5] &quot;sched_dep_time&quot; &quot;dep_delay&quot;      &quot;arr_time&quot;       &quot;sched_arr_time&quot;
##  [9] &quot;arr_delay&quot;      &quot;carrier&quot;        &quot;flight&quot;         &quot;tailnum&quot;       
## [13] &quot;origin&quot;         &quot;dest&quot;           &quot;air_time&quot;       &quot;distance&quot;      
## [17] &quot;hour&quot;           &quot;minute&quot;         &quot;time_hour&quot;</code></pre>
<div class="sourceCode" id="cb510"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb510-1"><a href="#cb510-1"></a><span class="kw">dbListFields</span>(con, <span class="st">&quot;weather&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] &quot;origin&quot;     &quot;year&quot;       &quot;month&quot;      &quot;day&quot;        &quot;hour&quot;      
##  [6] &quot;temp&quot;       &quot;dewp&quot;       &quot;humid&quot;      &quot;wind_dir&quot;   &quot;wind_speed&quot;
## [11] &quot;wind_gust&quot;  &quot;precip&quot;     &quot;pressure&quot;   &quot;visib&quot;      &quot;time_hour&quot;</code></pre>
</div>
<div id="quick-demonstrations" class="section level3" number="8.8.3">
<h3 number="8.8.3"><span class="header-section-number">8.8.3</span> Quick demonstrations:</h3>
<ul>
<li><p>SELECT desired columns</p></li>
<li><p>FROM tables</p></li>
<li><p>Select all columns (*) from <code>flights</code> table and show the <code>first ten rows</code></p></li>
<li><p>Note that you can combine SQL and R commands thanks to <code>dbplyr</code>.</p></li>
<li><p>Option 1</p></li>
</ul>
<div class="sourceCode" id="cb512"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb512-1"><a href="#cb512-1"></a>DBI<span class="op">::</span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT * FROM flights;&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb512-2"><a href="#cb512-2"></a><span class="st">  </span><span class="kw">head</span>(<span class="dv">10</span>) </span></code></pre></div>
<pre><code>##    year month day dep_time sched_dep_time dep_delay arr_time sched_arr_time
## 1  2013     1   1      517            515         2      830            819
## 2  2013     1   1      533            529         4      850            830
## 3  2013     1   1      542            540         2      923            850
## 4  2013     1   1      544            545        -1     1004           1022
## 5  2013     1   1      554            600        -6      812            837
## 6  2013     1   1      554            558        -4      740            728
## 7  2013     1   1      555            600        -5      913            854
## 8  2013     1   1      557            600        -3      709            723
## 9  2013     1   1      557            600        -3      838            846
## 10 2013     1   1      558            600        -2      753            745
##    arr_delay carrier flight tailnum origin dest air_time distance hour minute
## 1         11      UA   1545  N14228    EWR  IAH      227     1400    5     15
## 2         20      UA   1714  N24211    LGA  IAH      227     1416    5     29
## 3         33      AA   1141  N619AA    JFK  MIA      160     1089    5     40
## 4        -18      B6    725  N804JB    JFK  BQN      183     1576    5     45
## 5        -25      DL    461  N668DN    LGA  ATL      116      762    6      0
## 6         12      UA   1696  N39463    EWR  ORD      150      719    5     58
## 7         19      B6    507  N516JB    EWR  FLL      158     1065    6      0
## 8        -14      EV   5708  N829AS    LGA  IAD       53      229    6      0
## 9         -8      B6     79  N593JB    JFK  MCO      140      944    6      0
## 10         8      AA    301  N3ALAA    LGA  ORD      138      733    6      0
##     time_hour
## 1  1357034400
## 2  1357034400
## 3  1357034400
## 4  1357034400
## 5  1357038000
## 6  1357034400
## 7  1357038000
## 8  1357038000
## 9  1357038000
## 10 1357038000</code></pre>
<ul>
<li>Option 2 (works faster)</li>
</ul>
<div class="sourceCode" id="cb514"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb514-1"><a href="#cb514-1"></a></span>
<span id="cb514-2"><a href="#cb514-2"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb514-3"><a href="#cb514-3"></a><span class="kw">FROM</span> flights </span>
<span id="cb514-4"><a href="#cb514-4"></a><span class="kw">LIMIT</span> <span class="dv">5</span></span></code></pre></div>
<div class="knitsql-table">
<table style="width:100%;">
<caption>(#tab:unnamed-chunk-5)5 records</caption>
<colgroup>
<col width="3%" />
<col width="3%" />
<col width="2%" />
<col width="5%" />
<col width="9%" />
<col width="6%" />
<col width="5%" />
<col width="9%" />
<col width="6%" />
<col width="5%" />
<col width="4%" />
<col width="5%" />
<col width="4%" />
<col width="3%" />
<col width="5%" />
<col width="5%" />
<col width="3%" />
<col width="4%" />
<col width="6%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">year</th>
<th align="right">month</th>
<th align="right">day</th>
<th align="right">dep_time</th>
<th align="right">sched_dep_time</th>
<th align="right">dep_delay</th>
<th align="right">arr_time</th>
<th align="right">sched_arr_time</th>
<th align="right">arr_delay</th>
<th align="left">carrier</th>
<th align="right">flight</th>
<th align="left">tailnum</th>
<th align="left">origin</th>
<th align="left">dest</th>
<th align="right">air_time</th>
<th align="right">distance</th>
<th align="right">hour</th>
<th align="right">minute</th>
<th align="right">time_hour</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2013</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">517</td>
<td align="right">515</td>
<td align="right">2</td>
<td align="right">830</td>
<td align="right">819</td>
<td align="right">11</td>
<td align="left">UA</td>
<td align="right">1545</td>
<td align="left">N14228</td>
<td align="left">EWR</td>
<td align="left">IAH</td>
<td align="right">227</td>
<td align="right">1400</td>
<td align="right">5</td>
<td align="right">15</td>
<td align="right">1357034400</td>
</tr>
<tr class="even">
<td align="right">2013</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">533</td>
<td align="right">529</td>
<td align="right">4</td>
<td align="right">850</td>
<td align="right">830</td>
<td align="right">20</td>
<td align="left">UA</td>
<td align="right">1714</td>
<td align="left">N24211</td>
<td align="left">LGA</td>
<td align="left">IAH</td>
<td align="right">227</td>
<td align="right">1416</td>
<td align="right">5</td>
<td align="right">29</td>
<td align="right">1357034400</td>
</tr>
<tr class="odd">
<td align="right">2013</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">542</td>
<td align="right">540</td>
<td align="right">2</td>
<td align="right">923</td>
<td align="right">850</td>
<td align="right">33</td>
<td align="left">AA</td>
<td align="right">1141</td>
<td align="left">N619AA</td>
<td align="left">JFK</td>
<td align="left">MIA</td>
<td align="right">160</td>
<td align="right">1089</td>
<td align="right">5</td>
<td align="right">40</td>
<td align="right">1357034400</td>
</tr>
<tr class="even">
<td align="right">2013</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">544</td>
<td align="right">545</td>
<td align="right">-1</td>
<td align="right">1004</td>
<td align="right">1022</td>
<td align="right">-18</td>
<td align="left">B6</td>
<td align="right">725</td>
<td align="left">N804JB</td>
<td align="left">JFK</td>
<td align="left">BQN</td>
<td align="right">183</td>
<td align="right">1576</td>
<td align="right">5</td>
<td align="right">45</td>
<td align="right">1357034400</td>
</tr>
<tr class="odd">
<td align="right">2013</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">554</td>
<td align="right">600</td>
<td align="right">-6</td>
<td align="right">812</td>
<td align="right">837</td>
<td align="right">-25</td>
<td align="left">DL</td>
<td align="right">461</td>
<td align="left">N668DN</td>
<td align="left">LGA</td>
<td align="left">ATL</td>
<td align="right">116</td>
<td align="right">762</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">1357038000</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>Option 3 (automating workflow)</p>
<ul>
<li>When local variables are updated, the SQL query is also automatically updated.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb515-1"><a href="#cb515-1"></a><span class="co"># Local variables </span></span>
<span id="cb515-2"><a href="#cb515-2"></a>tbl &lt;-<span class="st"> &quot;flights&quot;</span></span>
<span id="cb515-3"><a href="#cb515-3"></a>var &lt;-<span class="st"> &quot;dep_delay&quot;</span></span>
<span id="cb515-4"><a href="#cb515-4"></a>num &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb515-5"><a href="#cb515-5"></a></span>
<span id="cb515-6"><a href="#cb515-6"></a><span class="co"># Glue SQL query string </span></span>
<span id="cb515-7"><a href="#cb515-7"></a><span class="co"># Note that to indicate a numeric value, you don&#39;t need ``</span></span>
<span id="cb515-8"><a href="#cb515-8"></a></span>
<span id="cb515-9"><a href="#cb515-9"></a>sql_query &lt;-<span class="st"> </span><span class="kw">glue_sql</span>(<span class="st">&quot;</span></span>
<span id="cb515-10"><a href="#cb515-10"></a><span class="st">  SELECT {`var`}</span></span>
<span id="cb515-11"><a href="#cb515-11"></a><span class="st">  FROM {`tbl`}</span></span>
<span id="cb515-12"><a href="#cb515-12"></a><span class="st">  LIMIT {num} </span></span>
<span id="cb515-13"><a href="#cb515-13"></a><span class="st">  &quot;</span>, <span class="dt">.con =</span> con)</span>
<span id="cb515-14"><a href="#cb515-14"></a></span>
<span id="cb515-15"><a href="#cb515-15"></a><span class="co"># Run the query </span></span>
<span id="cb515-16"><a href="#cb515-16"></a><span class="kw">dbGetQuery</span>(con, sql_query)</span></code></pre></div>
<pre><code>##   dep_delay
## 1         2
## 2         4
## 3         2
## 4        -1
## 5        -6</code></pre>
<p><strong>Challenge 2</strong>
Can you rewrite the above code using <code>LIMIT</code> instead of <code>head(10)</code></p>
<ul>
<li><p>You may notice that using only SQL code makes querying faster.</p></li>
<li><p>Select dep_delay and arr_delay from flights table, show the first ten rows, then turn the result into a tibble.</p></li>
</ul>
<p><strong>Challenge 3</strong>
Could you remind me how to see the list of attributes of a table? Let’s say you want to see the attributes of <code>flights</code> table.</p>
<ul>
<li>Collect the selected columns and filtered rows</li>
</ul>
<div class="sourceCode" id="cb517"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb517-1"><a href="#cb517-1"></a>df &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(con, <span class="st">&quot;SELECT dep_delay, arr_delay FROM flights;&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb517-2"><a href="#cb517-2"></a><span class="st">  </span><span class="kw">head</span>(<span class="dv">10</span>) <span class="op">%&gt;%</span></span>
<span id="cb517-3"><a href="#cb517-3"></a><span class="st">  </span><span class="kw">collect</span>()</span></code></pre></div>
<ul>
<li><p>Counting rows</p>
<ul>
<li>Count all (*)</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb518"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb518-1"><a href="#cb518-1"></a><span class="kw">dbGetQuery</span>(con, </span>
<span id="cb518-2"><a href="#cb518-2"></a>          <span class="st">&quot;SELECT COUNT(*) </span></span>
<span id="cb518-3"><a href="#cb518-3"></a><span class="st">           FROM flights;&quot;</span>) </span></code></pre></div>
<pre><code>##   COUNT(*)
## 1   336776</code></pre>
<div class="sourceCode" id="cb520"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb520-1"><a href="#cb520-1"></a><span class="kw">dbGetQuery</span>(con, </span>
<span id="cb520-2"><a href="#cb520-2"></a>           <span class="st">&quot;SELECT COUNT(dep_delay)</span></span>
<span id="cb520-3"><a href="#cb520-3"></a><span class="st">           FROM flights;&quot;</span>)</span></code></pre></div>
<pre><code>##   COUNT(dep_delay)
## 1           328521</code></pre>
<ul>
<li>Count distinct values</li>
</ul>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb522-1"><a href="#cb522-1"></a><span class="kw">dbGetQuery</span>(con, </span>
<span id="cb522-2"><a href="#cb522-2"></a>           <span class="st">&quot;SELECT COUNT(DISTINCT dep_delay)</span></span>
<span id="cb522-3"><a href="#cb522-3"></a><span class="st">           FROM flights;&quot;</span>)</span></code></pre></div>
<pre><code>##   COUNT(DISTINCT dep_delay)
## 1                       527</code></pre>
</div>
<div id="tidy-way-dplyr---sql" class="section level3" number="8.8.4">
<h3 number="8.8.4"><span class="header-section-number">8.8.4</span> Tidy-way: dplyr -&gt; SQL</h3>
<p>Thanks to the <code>dbplyr</code> package you can use the <code>dplyr</code> syntax to query SQL.</p>
<ul>
<li>Note that pipe (%) works.</li>
</ul>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb524-1"><a href="#cb524-1"></a><span class="co"># tbl select tables</span></span>
<span id="cb524-2"><a href="#cb524-2"></a>flights &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;flights&quot;</span>)</span>
<span id="cb524-3"><a href="#cb524-3"></a>airports &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;airports&quot;</span>)</span>
<span id="cb524-4"><a href="#cb524-4"></a>planes &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;planes&quot;</span>)</span>
<span id="cb524-5"><a href="#cb524-5"></a>weather &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tbl</span>(<span class="st">&quot;weather&quot;</span>)</span></code></pre></div>
<ul>
<li><code>select</code> = <code>SELECT</code></li>
</ul>
<div class="sourceCode" id="cb525"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb525-1"><a href="#cb525-1"></a>flights <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb525-2"><a href="#cb525-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">contains</span>(<span class="st">&quot;delay&quot;</span>))</span></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 2]
## # Database: sqlite 3.30.1 [:memory:]
##    dep_delay arr_delay
##        &lt;dbl&gt;     &lt;dbl&gt;
##  1         2        11
##  2         4        20
##  3         2        33
##  4        -1       -18
##  5        -6       -25
##  6        -4        12
##  7        -5        19
##  8        -3       -14
##  9        -3        -8
## 10        -2         8
## # … with more rows</code></pre>
<p><strong>Challenge 4</strong>
Your turn: write the same code in SQL</p>
<ul>
<li><code>mutate</code> = <code>SELECT</code> <code>AS</code></li>
</ul>
<div class="sourceCode" id="cb527"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb527-1"><a href="#cb527-1"></a>flights <span class="op">%&gt;%</span></span>
<span id="cb527-2"><a href="#cb527-2"></a><span class="st">  </span><span class="kw">select</span>(distance, air_time) <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb527-3"><a href="#cb527-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">speed =</span> distance <span class="op">/</span><span class="st"> </span>(air_time <span class="op">/</span><span class="st"> </span><span class="dv">60</span>)) </span></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: sqlite 3.30.1 [:memory:]
##    distance air_time speed
##       &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
##  1     1400      227  370.
##  2     1416      227  374.
##  3     1089      160  408.
##  4     1576      183  517.
##  5      762      116  394.
##  6      719      150  288.
##  7     1065      158  404.
##  8      229       53  259.
##  9      944      140  405.
## 10      733      138  319.
## # … with more rows</code></pre>
<p><strong>Challenge 5</strong>
Your turn: write the same code in SQL (hint: <code>mutate(new_var = var 1 * var2</code> = <code>SELECT var1 * var2 AS near_var</code>)</p>
<ul>
<li><code>filter</code> = <code>WHERE</code></li>
</ul>
<div class="sourceCode" id="cb529"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb529-1"><a href="#cb529-1"></a>flights <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb529-2"><a href="#cb529-2"></a><span class="st">  </span><span class="kw">filter</span>(month <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</span></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 19]
## # Database: sqlite 3.30.1 [:memory:]
##     year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
##  1  2013     1     1      517            515         2      830            819
##  2  2013     1     1      533            529         4      850            830
##  3  2013     1     1      542            540         2      923            850
##  4  2013     1     1      544            545        -1     1004           1022
##  5  2013     1     1      554            600        -6      812            837
##  6  2013     1     1      554            558        -4      740            728
##  7  2013     1     1      555            600        -5      913            854
##  8  2013     1     1      557            600        -3      709            723
##  9  2013     1     1      557            600        -3      838            846
## 10  2013     1     1      558            600        -2      753            745
## # … with more rows, and 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,
## #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,
## #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dbl&gt;</code></pre>
<p><strong>Challenge 6</strong>
Your turn: write the same code in SQL (hint: <code>filter(condition1, condition2)</code> = <code>WHERE condition1 and condition2</code>)</p>
<ul>
<li><p>Note that R and SQL operators are not exactly alike. R uses <code>!=</code> for <code>Not equal to</code>. SQL uses <code>&lt;&gt;</code> or <code>!=</code>. Furthermore, there are some cautions about using <code>NULL</code> (NA; unknown or missing): it should be <code>IS NULL</code> or <code>IS NOT NULL</code> not <code>=NULL</code> or <code>!=NULL</code>.</p></li>
<li><p><code>arrange</code> = <code>ORDER BY</code></p></li>
</ul>
<div class="sourceCode" id="cb531"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb531-1"><a href="#cb531-1"></a>flights <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb531-2"><a href="#cb531-2"></a><span class="st">  </span><span class="kw">arrange</span>(carrier, <span class="kw">desc</span>(arr_delay)) <span class="op">%&gt;%</span></span>
<span id="cb531-3"><a href="#cb531-3"></a><span class="st">  </span><span class="kw">show_query</span>()</span></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT *
## FROM `flights`
## ORDER BY `carrier`, `arr_delay` DESC</code></pre>
<p><strong>Challenge 7</strong>
Your turn: write the same code in SQL (hint: <code>arrange(var1, desc(var2)) = ORDER BY var1, var2 DESC</code>)</p>
<ul>
<li><code>summarise</code> = <code>SELECT</code> <code>AS</code> and <code>group by</code> = <code>GROUP BY</code></li>
</ul>
<div class="sourceCode" id="cb533"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb533-1"><a href="#cb533-1"></a>flights <span class="op">%&gt;%</span></span>
<span id="cb533-2"><a href="#cb533-2"></a><span class="st">  </span><span class="kw">group_by</span>(month, day) <span class="op">%&gt;%</span></span>
<span id="cb533-3"><a href="#cb533-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">delay =</span> <span class="kw">mean</span>(dep_delay)) </span></code></pre></div>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `mean(x, na.rm = TRUE)` to silence this warning
## This warning is displayed only once per session.</code></pre>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: sqlite 3.30.1 [:memory:]
## # Groups:   month
##    month   day delay
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
##  1     1     1 11.5 
##  2     1     2 13.9 
##  3     1     3 11.0 
##  4     1     4  8.95
##  5     1     5  5.73
##  6     1     6  7.15
##  7     1     7  5.42
##  8     1     8  2.55
##  9     1     9  2.28
## 10     1    10  2.84
## # … with more rows</code></pre>
<p><strong>Challenge 8</strong>
Your turn: write the same code in SQL (hint: in SQL the order should be <code>SELECT group_var1, group_var2, AVG(old_var) AS new_var</code> -&gt; <code>FROM</code> -&gt; <code>GROUP BY</code>)</p>
<ul>
<li>If you feel too much challenged, here’s a help.</li>
</ul>
<div class="sourceCode" id="cb536"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb536-1"><a href="#cb536-1"></a>flights <span class="op">%&gt;%</span></span>
<span id="cb536-2"><a href="#cb536-2"></a><span class="st">  </span><span class="kw">group_by</span>(month, day) <span class="op">%&gt;%</span></span>
<span id="cb536-3"><a href="#cb536-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">delay =</span> <span class="kw">mean</span>(dep_delay)) <span class="op">%&gt;%</span></span>
<span id="cb536-4"><a href="#cb536-4"></a><span class="st">  </span><span class="kw">show_query</span>() <span class="co"># Show the SQL equivalent!</span></span></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT `month`, `day`, AVG(`dep_delay`) AS `delay`
## FROM `flights`
## GROUP BY `month`, `day`</code></pre>
<ul>
<li><p>Joins</p></li>
<li><p>Using joins is simpler in R than it is in SQL.</p></li>
<li><p>However, more flexible joins exist in SQL and they are not available in R.</p>
<ul>
<li>Joins involving 3+ tables are not supported.</li>
<li>Some advanced joins available in SQL are not supported.</li>
<li>For more information, check out <a href="https://github.com/ianmcook/tidyquery/issues"><code>tidyquery</code></a> to see the latest developments.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb538"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb538-1"><a href="#cb538-1"></a>flights <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb538-2"><a href="#cb538-2"></a><span class="st">  </span><span class="kw">left_join</span>(weather, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;month&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb538-3"><a href="#cb538-3"></a><span class="st">  </span><span class="kw">show_query</span>()</span></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT `LHS`.`year` AS `year`, `LHS`.`month` AS `month`, `LHS`.`day` AS `day.x`, `LHS`.`dep_time` AS `dep_time`, `LHS`.`sched_dep_time` AS `sched_dep_time`, `LHS`.`dep_delay` AS `dep_delay`, `LHS`.`arr_time` AS `arr_time`, `LHS`.`sched_arr_time` AS `sched_arr_time`, `LHS`.`arr_delay` AS `arr_delay`, `LHS`.`carrier` AS `carrier`, `LHS`.`flight` AS `flight`, `LHS`.`tailnum` AS `tailnum`, `LHS`.`origin` AS `origin.x`, `LHS`.`dest` AS `dest`, `LHS`.`air_time` AS `air_time`, `LHS`.`distance` AS `distance`, `LHS`.`hour` AS `hour.x`, `LHS`.`minute` AS `minute`, `LHS`.`time_hour` AS `time_hour.x`, `RHS`.`origin` AS `origin.y`, `RHS`.`day` AS `day.y`, `RHS`.`hour` AS `hour.y`, `RHS`.`temp` AS `temp`, `RHS`.`dewp` AS `dewp`, `RHS`.`humid` AS `humid`, `RHS`.`wind_dir` AS `wind_dir`, `RHS`.`wind_speed` AS `wind_speed`, `RHS`.`wind_gust` AS `wind_gust`, `RHS`.`precip` AS `precip`, `RHS`.`pressure` AS `pressure`, `RHS`.`visib` AS `visib`, `RHS`.`time_hour` AS `time_hour.y`
## FROM `flights` AS `LHS`
## LEFT JOIN `weather` AS `RHS`
## ON (`LHS`.`year` = `RHS`.`year` AND `LHS`.`month` = `RHS`.`month`)</code></pre>
</div>
<div id="collect-pull" class="section level3" number="8.8.5">
<h3 number="8.8.5"><span class="header-section-number">8.8.5</span> Collect (pull)</h3>
<ul>
<li><p><code>collect()</code> is used to pull the data. Depending on the data size, it may take a long time to run.</p></li>
<li><p>The following code won’t work.</p></li>
</ul>
<blockquote>
<p>Error in UseMethod(“collect”) : no applicable method for ‘collect’ applied to an object of class “c(‘LayerInstance’, ‘Layer’, ‘ggproto’, ‘gg’)”</p>
</blockquote>
<div class="sourceCode" id="cb540"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb540-1"><a href="#cb540-1"></a>origin_flights_plot &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span></span>
<span id="cb540-2"><a href="#cb540-2"></a><span class="st">  </span><span class="kw">group_by</span>(origin) <span class="op">%&gt;%</span></span>
<span id="cb540-3"><a href="#cb540-3"></a><span class="st">  </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></span>
<span id="cb540-4"><a href="#cb540-4"></a><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb540-5"><a href="#cb540-5"></a><span class="st">  </span><span class="kw">geom_col</span>(<span class="kw">aes</span>(<span class="dt">x =</span> origin, <span class="dt">y =</span> n)) <span class="op">%&gt;%</span></span>
<span id="cb540-6"><a href="#cb540-6"></a><span class="st">  </span><span class="kw">collect</span>()</span></code></pre></div>
<ul>
<li>This works.</li>
</ul>
<div class="sourceCode" id="cb541"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb541-1"><a href="#cb541-1"></a>df &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span></span>
<span id="cb541-2"><a href="#cb541-2"></a><span class="st">  </span><span class="kw">group_by</span>(origin) <span class="op">%&gt;%</span></span>
<span id="cb541-3"><a href="#cb541-3"></a><span class="st">  </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></span>
<span id="cb541-4"><a href="#cb541-4"></a><span class="st">  </span><span class="kw">collect</span>()</span>
<span id="cb541-5"><a href="#cb541-5"></a></span>
<span id="cb541-6"><a href="#cb541-6"></a>origin_flights_plot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df) <span class="op">+</span></span>
<span id="cb541-7"><a href="#cb541-7"></a><span class="st">  </span><span class="kw">geom_col</span>(<span class="kw">aes</span>(<span class="dt">x =</span> origin, <span class="dt">y =</span> n))</span>
<span id="cb541-8"><a href="#cb541-8"></a></span>
<span id="cb541-9"><a href="#cb541-9"></a>origin_flights_plot</span></code></pre></div>
<p><img src="06_big_data_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
</div>
<div id="disconnect" class="section level3" number="8.8.6">
<h3 number="8.8.6"><span class="header-section-number">8.8.6</span> Disconnect</h3>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb542-1"><a href="#cb542-1"></a>DBI<span class="op">::</span><span class="kw">dbDisconnect</span>(con)</span></code></pre></div>
</div>
</div>
<div id="references" class="section level2" number="8.9">
<h2 number="8.9"><span class="header-section-number">8.9</span> References</h2>
<ul>
<li><a href="https://github.com/csv2db/csv2db">csv2db</a> - for loading large CSV files in to a database</li>
<li>R Studio, <a href="https://db.rstudio.com/">Database using R</a></li>
<li>Ian Cook, <a href="https://github.com/ianmcook/rstudioconf2020/blob/master/bridging_the_gap_between_sql_and_r.pdf">“Bridging the Gap between SQL and R”</a> rstudio::conf 2020 slides
<ul>
<li><a href="https://www.youtube.com/watch?v=JwP5KdWSgqE&amp;ab_channel=RStudio">Video recording</a></li>
</ul></li>
<li>Data Carpentry contributors, <a href="https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html">SQL database and R</a>, Data Carpentry, September 10, 2019.</li>
<li><a href="https://cran.r-project.org/web/packages/dbplyr/vignettes/dbplyr.html">Introduction to dbplyr</a></li>
<li>Josh Erickson, <a href="http://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/sql.html">SQL in R</a>, STAT 701, University of Michigan</li>
<li><a href="https://wizardzines.com/zines/sql/">SQL zine</a> by Julia Evans</li>
<li><a href="http://harelba.github.io/q/">q</a> - a command line tool that allows direct execution of SQL-like queries on CSVs/TSVs (and any other tabular text files)</li>
</ul>
<!--chapter:end:06_big_data.Rmd-->
</div>
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
